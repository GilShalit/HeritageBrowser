import{r as a,j as o,R as Se,M as ve,a as I,b as N,c as m,H as xe,d as ke,e as z,f as oe,I as T,F as K,g as we,h as Ee,C as Ne,W as Pe,i as D,k as ne,D as Ie,o as Le,S as Oe,L as B,l as Re,u as se,T as Ae,m as Me,n as Te,p as $e,q as De,s as Be,t as Fe,v as F,w as ze,x as Ve,y as W,z as Q,A as Ke,B as Ge,E as He,G as re,J as ie,K as Ue,N as _e,O as je,P as We,Q as Qe,U as Ze,V as qe,X as Je,Y as Ye}from"./vendor.0d794a92.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerpolicy&&(i.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?i.credentials="include":r.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();var x=(e=>(e.MOBILE="MOBILE",e.DESKTOP="DESKTOP",e))(x||{});const ae="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,ce=a.exports.createContext({size:x.DESKTOP,isTouchDevice:ae}),Xe=e=>{const[t,n]=a.exports.useState({size:window.innerWidth>e.breakPoint?x.DESKTOP:x.MOBILE,isTouchDevice:ae});return a.exports.useLayoutEffect(()=>{const s=r=>{const i=window.innerWidth;i>e.breakPoint&&t.size===x.MOBILE?n({...t,size:x.DESKTOP}):i<e.breakPoint&&t.size===x.DESKTOP&&n({...t,size:x.MOBILE})};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[e.breakPoint,t]),o(ce.Provider,{value:t,children:e.children})},O=()=>a.exports.useContext(ce),et=e=>o(Se,{children:o(Xe,{breakPoint:e.breakPoint||540,children:o(ve,{children:e.children})})});const tt=a.exports.createContext({}),le=()=>a.exports.useContext(tt);var G=(e=>(e.PENDING="PENDING",e.OK="OK",e.FAILED="FAILED",e))(G||{});const ot=I({key:"search",default:{args:{},status:G.OK}}),H=()=>{const[e,t]=N(ot),n=(c={})=>t({args:c,status:G.PENDING,result:e.result});return{changeSearchQuery:c=>n({...e.args,query:c}),clearSearchQuery:()=>n({...e.args,query:void 0}),refreshSearch:()=>n({...e.args}),search:e,setActiveAggregation:c=>t({args:{...e.args,activeAggregation:c},status:e.status,result:e.result}),setFilter:c=>{const u=[...(e.args.filters||[]).filter(h=>h.name!==c.name),c];n({...e.args,filters:u})},setSearchState:t}},nt=e=>{const t=e.activeAggregation||e.aggregations[0]||"",n=s=>()=>{const{length:r}=e.aggregations,d=(e.aggregations.indexOf(t)+s+r)%r;e.onChangeAggregation(e.aggregations[d])};return m("div",{className:"p6o-aggs-carousel",children:[o("button",{tabIndex:4,"aria-label":"Previous filter category",onClick:n(-1),children:o(xe,{})}),o("h3",{"aria-live":"polite","aria-atomic":!0,children:t}),o("button",{tabIndex:5,"aria-label":"Next filter category",onClick:n(1),children:o(ke,{})})]})},st=e=>e>1e3?(e/1e3).toFixed(1)+"k":e>1e6?(e/1e6).toFixed(1)+"M":e,rt=e=>o("div",{className:"p6o-aggs-values",children:o("ul",{children:e.buckets.map(({label:t,count:n})=>o("li",{className:e.filterValues.length>0&&!e.filterValues.includes(t)?"p6o-value-unselected":"",onClick:e.onToggleFilterValue(t),children:m("div",{className:"p6o-agg-value-wrapper",children:[o("span",{className:"p6o-agg-value-count",style:{backgroundColor:e.colors&&e.colors[t],borderColor:e.colors&&e.colors[t]&&z(e.colors[t]).alpha(.8).hex()},children:st(n)}),o("span",{className:"p6o-agg-value-label",children:t})]})},t))})});const Z=e=>{var u,h,p,f;const{search:t,setFilter:n,setActiveAggregation:s}=H(),r=(u=t.result)!=null&&u.aggregations?Object.keys(t.result.aggregations):[],i=e.displayFacets||r,d=t.args.activeAggregation||i[0]||"",l=((p=(h=t.args.filters)==null?void 0:h.find(g=>g.name===d))==null?void 0:p.values)||[],c=g=>()=>{const b=l.includes(g)?{name:d,values:l.filter(v=>v!==g)}:{name:d,values:[...l,g]};n(b)};return m("div",{className:e.fullscreen?"p6o-aggs p6o-aggs-overlay fullscreen":"p6o-aggs p6o-aggs-overlay",children:[o(nt,{aggregations:i,activeAggregation:d,onChangeAggregation:s}),((f=t.result)==null?void 0:f.aggregations)&&o(rt,{buckets:t.result.aggregations[d].buckets,colors:e.colors,filterValues:l,onToggleFilterValue:c})]})},q=e=>O().size===x.DESKTOP?e.children:null,it=e=>{const t=a.exports.useRef(null);a.exports.useEffect(()=>{const s=r=>{r.key==="Escape"&&e.onClose(null)};return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]);const n=s=>{s.target===t.current&&e.onClose(s)};return oe.createPortal(m("div",{ref:t,className:e.className?`p6o-info-modal-bg ${e.className}`:"p6o-info-modal-bg",onClick:n,children:[o("button",{className:"p6o-info-modal-close",onClick:e.onClose,children:o(T,{})}),o("main",{className:"p6o-info-modal-main",children:e.children})]}),document.body)};const at=e=>{const[t,n]=a.exports.useState(!1);return m(K,{children:[o("button",{className:"p6o-controls-btn p6o-info",tabIndex:41,"aria-label":"Information",onClick:()=>n(!0),children:o(we,{})}),t&&o(it,{className:e.className,onClose:()=>n(!1),children:e.children})]})},J=e=>O().size===x.MOBILE?e.children:null;const ct=e=>{const[t,n]=a.exports.useState(!1);return m(K,{children:[o("button",{className:"p6o-controls-btn p6o-mobile-menu-btn",tabIndex:42,"aria-label":"Open menu",onClick:()=>n(!0),children:o(Ee,{})}),o(Ne,{in:t,className:"p6o-mobile-menu",classNames:"p6o-mobile-menu",timeout:200,unmountOnExit:!0,children:m("div",{className:"p6o-mobile-menu",children:[o("button",{className:"p6o-mobile-menu-close",onClick:()=>n(!1),children:o(T,{})}),o("main",{children:e.items.length===1?e.items[0]:null})]})})]})},$=I({key:"mapView",default:{}}),A=e=>{const{longitude:t,latitude:n,zoom:s}=e,r=i=>i!==void 0;return r(t)&&r(n)&&r(s)},lt=I({key:"selected",default:null}),de=(e,t)=>{const{offsetWidth:n,offsetHeight:s}=t;return new Pe({width:n,height:s}).fitBounds(e,{})};const dt=e=>{const t=a.exports.useRef(null),n=a.exports.useRef(null),s=O(),[r,i]=N($),[d,l]=N(lt),{search:c}=H(),u=le(),[h,p]=a.exports.useState();a.exports.useEffect(()=>{if(t.current&&!A(r)){const y=de(e.defaultBounds,t.current);i(y)}},[t.current]);const f=a.exports.useMemo(()=>{var y;return(c==null?void 0:c.status)==="OK"&&((y=c.result)==null?void 0:y.items.length)?{type:"FeatureCollection",features:c.result.items.map(C=>({...C,properties:{id:C.id,...C.properties}}))}:null},[c]),g=a.exports.useMemo(()=>D.Children.map(e.children,y=>y.props.id)||[],[e.children]),b=a.exports.useCallback(y=>{var w;if(!n.current)return;const C=n.current.queryRenderedFeatures(y).filter(S=>g.find(L=>S.layer.id.startsWith(L)));if(C.length>0){const S=C[0];return{node:u.getNodeById((w=S.properties)==null?void 0:w.id),feature:S}}},[e.children,u,n.current,g]),v=a.exports.useCallback(y=>{var S,L;const{point:C}=y,w=b(C);if(w){const{node:R,feature:ye}=w,Ce=h&&(R==null?void 0:R.id)===(h==null?void 0:h.node.id)?{...h,...C}:{node:R,feature:ye,...C};(S=t.current)==null||S.classList.add("hover"),p(Ce)}else(L=t.current)==null||L.classList.remove("hover"),p(void 0)},[b,h]),k=y=>{const C=b(y.point);if(C){const w=JSON.parse(JSON.stringify(C));p(null),l(w)}else l(null)};return m("div",{ref:t,className:"p6o-map-container",children:[A(r)&&o(ne,{clickTolerance:s.isTouchDevice?10:3,ref:n,initialViewState:r,mapStyle:e.mapStyle,onClick:k,onMouseMove:v,onMove:y=>i(y.viewState),children:D.Children.map(e.children,y=>D.cloneElement(y,{data:f}))}),e.tooltip&&h&&o(St,{...h,tooltip:e.tooltip}),e.popup&&n.current&&d&&o(Ct,{selected:d,viewState:r,map:n.current,popup:e.popup,onClose:()=>l(null)})]})},ut=e=>{const t=a.exports.useRef(null),{search:n}=H(),s=le(),r=a.exports.useMemo(()=>(n==null?void 0:n.result)&&n.status==="OK"&&n.result.items.length>0?n.result.items:null,[n]),i=a.exports.useMemo(()=>e.layers&&r?e.layers.reduce((l,c)=>{const u=c(r,s);return Array.isArray(u)?[...l,...u]:[...l,u]},[]):[],[r,e.layers]),d=a.exports.useCallback(l=>{const{offsetX:c,offsetY:u}=l.nativeEvent,h=t.current.pickObject({x:c,y:u,radius:3});h&&e.onClick&&e.onClick(h)},[e.onClick,t]);return o("div",{onClick:d,children:o(Ie,{ref:t,initialViewState:e.initialViewState,controller:!0,onViewStateChange:e.onViewStateChange,layers:i,getTooltip:e.tooltip?l=>e.tooltip({...l,graph:s,search:n}):null,children:o(ne,{mapStyle:e.mapStyle})})})},ht=e=>{const t=a.exports.useRef(null),[n,s]=N($),[r,i]=a.exports.useState(A(n)?n:null),[d,l]=a.exports.useState(),[c]=Le(d,200);return a.exports.useEffect(()=>{c&&s(c)},[c]),a.exports.useEffect(()=>{if(t.current&&!r){const u=de(e.defaultBounds,t.current);i(u)}},[t.current]),a.exports.useEffect(()=>{t.current&&r&&A(n)&&i(n)},[n]),o("div",{ref:t,className:"p6o-map-container",children:r&&o(ut,{...e,initialViewState:r,onViewStateChange:u=>l(u.viewState)})})},mt=[0,"rgba(49, 54, 149, 0)",.1,"#313695",.2,"#4575b4",.3,"#74add1",.4,"#abd9e9",.5,"#e0f3f8",.6,"#fee090",.7,"#fdae61",.8,"#f46d43",.9,"#d73027",1,"#a50026"],gt=e=>({type:"heatmap",paint:{"heatmap-weight":1,"heatmap-intensity":["interpolate",["linear"],["zoom"],0,.2,9,2.5],"heatmap-color":["interpolate",["linear"],["heatmap-density"],...e],"heatmap-radius":["interpolate",["linear"],["zoom"],0,1,12,28],"heatmap-opacity":["interpolate",["linear"],["zoom"],8,1,10,0]}}),pt=e=>({type:"circle",paint:{"circle-radius":["interpolate",["linear"],["number",["get","count"],0],0,5,4e3,20],"circle-color":["case",["==",["get","is_centroid"],!0],"#808080",e],"circle-stroke-color":["case",["==",["get","is_centroid"],!0],z("#808080").darken().hex(),z(e).darken().hex()],"circle-stroke-width":1,"circle-opacity":["interpolate",["linear"],["zoom"],7,0,10,["case",["==",["get","is_centroid"],!0],.5,1]],"circle-stroke-opacity":["interpolate",["linear"],["zoom"],7,0,10,["case",["==",["get","is_centroid"],!0],.5,1]]}}),ft=e=>({type:"circle",paint:{"circle-radius":e,"circle-color":"transparent","circle-stroke-width":0,"circle-opacity":.5,"circle-stroke-opacity":0}}),bt=e=>{const t=O(),n=gt(mt),s=pt(e.color),r=t.isTouchDevice?ft(15):null;return m(Oe,{type:"geojson",data:e.data,children:[r&&o(B,{id:`${e.id}-clickbuffer`,...r}),o(B,{id:`${e.id}-ht`,...n}),o(B,{id:`${e.id}-pt`,...s})]})},yt={MapLibre:dt,MapLibreDeckGL:ht};const ue=(e,t,n,s=[15,0,0,15])=>{var c;const[r,i]=a.exports.useState(t+s[3]),[d,l]=a.exports.useState(n+s[0]);return a.exports.useEffect(()=>i(t),[t]),a.exports.useEffect(()=>l(n),[n]),a.exports.useEffect(()=>{var u,h;if(e.current){const p=(u=e.current.firstChild)==null?void 0:u.getBoundingClientRect(),f=(h=e.current.closest(".p6o-map-container"))==null?void 0:h.getBoundingClientRect();if(p&&f){const g=p.right+s[1]>f.right,b=p.bottom+s[2]>f.bottom;g&&i(f.right-p.width-s[1]-s[3]),b&&l(f.bottom-p.height-s[0]-s[2])}}},[(c=e.current)==null?void 0:c.getBoundingClientRect()]),{top:d,left:r}},Ct=e=>{const t=O(),n=a.exports.useRef(null),{selected:s,viewState:r,map:i,popup:d}=e,[l,c]=a.exports.useState({left:0,top:0}),{top:u,left:h}=t.size===x.DESKTOP?ue(n,l.left,l.top):{top:0,left:0};a.exports.useEffect(()=>{var f;if(s&&t.size===x.DESKTOP){const g=(f=Re(s.feature))==null?void 0:f.geometry.coordinates,{x:b,y:v}=i.project(g);c({left:b,top:v})}else s&&c({left:0,top:0})},[s,r,t.size]);const p=a.exports.useMemo(()=>s?d({...e,onClose:e.onClose}):null,[s]);return p&&m("div",{className:t.size===x.DESKTOP?"p6o-map-popup-container":"p6o-map-popup-container-mobile",style:{zIndex:9,position:"absolute",top:u,left:h},children:[o("button",{className:"p6o-map-popup-close",onClick:e.onClose,children:o(T,{})}),o("main",{ref:n,children:p})]})},St=e=>{const t=a.exports.useRef(null),{x:n,y:s,node:r,feature:i,tooltip:d}=e,{left:l,top:c}=ue(t,n,s),u=a.exports.useMemo(()=>r?d({node:r,feature:i}):null,[r,i]);return u&&o("div",{ref:t,className:"p6o-map-tooltip-container",style:{left:l,top:c,zIndex:1},children:u})},U=()=>{const{current:e,...t}=se();return Object.values(t)[0]},vt=()=>{const e=U(),[t,n]=N($);return{viewState:t,setViewState:n,getMapBounds:()=>{if(e)return e.getBounds().toArray()}}};const xt=()=>{const e=U(),{setViewState:t}=vt(),n=i=>{const{latitude:d,longitude:l}=i.coords;t({latitude:d,longitude:l,zoom:12}),e==null||e.easeTo({center:[l,d],zoom:12})},s=i=>console.warn("Error fetching location: "+i.message);return o("button",{className:"p6o-controls-btn p6o-my-location",tabIndex:40,"aria-label":"Go to my location",onClick:()=>navigator.geolocation.getCurrentPosition(n,s,{enableHighAccuracy:!0}),children:o(Ae,{})})};const kt=e=>o("div",{className:"p6o-controls-container",children:e.children});const wt=()=>{const e=U(),[t,n]=N($),s=r=>()=>{e&&n({...t,zoom:t.zoom+r,transitionDuration:200}),e==null||e.easeTo({zoom:e.getZoom()+r})};return m("div",{className:"p6o-zoom-container",children:[o("button",{className:"p6o-controls-btn p6o-zoom p6o-zoom-in",tabIndex:31,"aria-label":"Zoom in",onClick:s(1),children:o(Me,{})}),o("button",{className:"p6o-controls-btn p6o-zoom p6o-zoom-out",tabIndex:32,"aria-label":"Zoom out",onClick:s(-1),children:o(Te,{})})]})};var V;(function(e){e.MOBILE="MOBILE",e.DESKTOP="DESKTOP"})(V||(V={}));const Et="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,Nt=a.exports.createContext({size:V.DESKTOP,isTouchDevice:Et}),_=()=>a.exports.useContext(Nt);const he=a.exports.createContext({}),me=()=>a.exports.useContext(he);var E;(function(e){e.PENDING="PENDING",e.OK="OK",e.FAILED="FAILED"})(E||(E={}));const Pt=I({key:"search",default:{args:{},status:E.OK}}),ge=()=>{const[e,t]=N(Pt),n=(c={})=>t({args:c,status:E.PENDING,result:e.result});return{changeSearchQuery:c=>n({...e.args,query:c}),clearSearchQuery:()=>n({...e.args,query:void 0}),refreshSearch:()=>n({...e.args}),search:e,setActiveAggregation:c=>t({args:{...e.args,activeAggregation:c},status:e.status,result:e.result}),setFilter:c=>{const u=[...(e.args.filters||[]).filter(h=>h.name!==c.name),c];n({...e.args,filters:u})},setSearchState:t}};const It=e=>{const t=a.exports.useRef(null);a.exports.useEffect(()=>{const s=r=>{r.key==="Escape"&&e.onClose(null)};return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]);const n=s=>{s.target===t.current&&e.onClose(s)};return oe.createPortal(m("div",{ref:t,className:e.className?`p6o-info-modal-bg ${e.className}`:"p6o-info-modal-bg",onClick:n,children:[o("button",{className:"p6o-info-modal-close",onClick:e.onClose,children:o(T,{})}),o("main",{className:"p6o-info-modal-main",children:e.children})]}),document.body)};const Lt=I({key:"mapView",default:{}});I({key:"selected",default:null});const pe=()=>{const{current:e,...t}=se();return Object.values(t)[0]},Ot=()=>{const e=pe(),[t,n]=N(Lt);return{viewState:t,setViewState:n,getMapBounds:()=>{if(e)return e.getBounds().toArray()}}};const M={ARCHIVE:"#7eb0d5",BOOK:"#ede15b",EPHEMERA:"#ef9b20","GENIZA MANUSCRIPT":"#8a3800",KETUBBA:"#b2e061",MANUSCRIPT:"#bdcf32",MAP:"#edbf33",MOVIE:"#b33dc6",MUSIC:"#f46a9b",NEWSPAPER:"#bd7ebe",ORAL:"#87bc45",PHOTOGRAPH:"#ea5545",PICTURE:"#fd7f6f",SCORE:"#27aeef"};const Rt=e=>/^[\u04c7-\u0591\u05D0-\u05EA\u05F0-\u05F4\u0600-\u06FF\u0750-\u077f]/.test(e),At=e=>{const{record:t}=e,{title:n,thumbnailURI:s,type:r}=t;return m("div",{className:"kima-listpreview-card",onClick:e.onClick,children:[o("h5",{style:Rt(n)?{direction:"rtl"}:null,children:n}),s&&o("div",{className:"kima-listpreview-image-wrapper",style:{backgroundImage:`url(${s})`,borderColor:M[r.label]}})]})},Y=[45,25],Mt=(e,t,n)=>{var c;const s=_(),[r,i]=a.exports.useState(t),[d,l]=a.exports.useState(n);return a.exports.useEffect(()=>i(t),[t]),a.exports.useEffect(()=>l(n),[n]),a.exports.useEffect(()=>{e.current&&s.size==="DESKTOP"&&setTimeout(()=>{var p,f;const u=(p=e.current)==null?void 0:p.getBoundingClientRect(),h=(f=e.current.closest(".p6o-map-container"))==null?void 0:f.getBoundingClientRect();if(u&&h){const g=u.right>h.right,b=u.bottom>h.bottom;g&&i(h.right-u.width-Y[0]),b&&l(h.bottom-u.bottom-Y[1])}},1)},[(c=e.current)==null?void 0:c.getBoundingClientRect()]),{top:d,left:r}};const Tt=e=>{const{image:t}=e;return o($e,{mainSrc:t,onCloseRequest:e.onClose})},$t=e=>{if(!!e.descriptions&&!!Array.isArray(e.descriptions))return e.descriptions[0].value},X={ARCHIVE:o(De,{}),BOOK:o(Be,{}),EPHEMERA:o(Fe,{}),"GENIZA MANUSCRIPT":o(F,{}),KETUBBA:o(F,{}),MANUSCRIPT:o(F,{}),MAP:o(ze,{}),MOVIE:o(Ve,{}),MUSIC:o(W,{}),NEWSPAPER:o(Q,{}),"NEWSPAPER ARTICLE":o(Q,{}),ORAL:o(Ke,{}),PHOTOGRAPH:o(Ge,{}),PICTURE:o(He,{}),SCORE:o(W,{})};const ee=e=>/^[\u04c7-\u0591\u05D0-\u05EA\u05F0-\u05F4\u0600-\u06FF\u0750-\u077f]/.test(e),te=e=>{const t=a.exports.useRef(),{record:n}=e,{id:s,presentationURI:r,thumbnailURI:i,title:d,type:l}=n,c=a.exports.useMemo(()=>$t(n),[n]),[u,h]=a.exports.useState(!1),[p,f]=a.exports.useState(!1),[g,b]=a.exports.useState(),v=(l==null?void 0:l.label)==="ORAL"||(l==null?void 0:l.label)==="MUSIC",[k,y]=a.exports.useState(!1),{top:C,left:w}=Mt(t,10,-10);return a.exports.useEffect(()=>{if(v&&r&&fetch("https://kimanli.azurewebsites.net/api/cors-proxy",{method:"POST",body:r}).then(S=>S.text()).then(S=>{console.log("proxy response",S),window.setTimeout(()=>b(S),2e3)}),r||i){const S=document.createElement("img");S.onerror=()=>y(!0),S.src=r||i}},[r]),o("div",{className:"kima-selected-card-wrapper",children:m("div",{ref:t,className:"kima-selected-card",style:{top:C,left:w},onClick:e.onClick,children:[o("header",{children:(r||i)&&!k?v&&g?o("audio",{controls:!0,crossOrigin:"anonymous",children:o("source",{src:g})}):m(K,{children:[o("div",{className:"kima-selected-preview-loading",children:o(re,{})}),o("div",{className:"kima-selected-preview",style:{backgroundImage:`url("${r||i}")`}}),r&&o("button",{className:"kima-selected-fullscreen",onClick:()=>h(!0),children:o(ie,{})})]}):o("div",{className:"kima-selected-preview",children:X[l.label]})}),m("main",{children:[m("div",{style:ee(d)?{direction:"rtl"}:null,children:[o("h1",{children:d}),m("h2",{className:"type",children:[X[l.label],o("span",{className:"label",children:l.label})]})]}),c&&o("p",{style:ee(c)?{direction:"rtl"}:null,children:c})]}),m("footer",{children:[o("a",{href:s,target:"_blank",children:m("section",{className:"details",children:[o("span",{children:"Details"}),o("span",{children:o(Ue,{})})]})}),m("section",{className:"close",style:{borderBottomColor:M[l.label]},children:[o("button",{className:"share",onClick:()=>f(!0),children:o(_e,{})}),o("button",{className:"close",onClick:e.onClose,children:"Close"})]})]}),r&&u&&o(Tt,{image:r,onClose:()=>h(!1)}),p&&o(It,{onClose:()=>f(!1),children:o("div",{className:"easter-egg",children:m("main",{children:[o("h1",{children:"Vote for us!"}),o("p",{children:"If the NLI Heritage Browser makes it to the winner's podium, we will build lots of additional great features - such as the ability to share items and maps on social media."})]})})})]})})},Dt=e=>{var c;const t=me(),{node:n}=e.selected,[s,r]=a.exports.useState([]),[i,d]=a.exports.useState(),l=((c=n.descriptions)==null?void 0:c.length)>0?n.descriptions[0].value:null;return a.exports.useEffect(()=>{d(null),r([]);const u=p=>{const f=new Set(h.map(b=>b.id)),g=p.records.filter(b=>!f.has(b.id));g.length>0&&r([...h,...g.slice(0,500)])},h=t.getConnected(n.id,!0,u);r(h)},[n]),m("div",{className:"kima-popup-wrapper",children:[m("div",{className:"kima-popup-expanded",children:[s.length===1&&o(te,{record:s[0],onClose:e.onClose}),i&&o(te,{record:i,onClose:()=>d(null)})]}),s.length>1&&m("div",{className:"kima-popup-multilist",children:[m("header",{children:[m("h1",{children:[o("a",{href:n.id,target:"_blank",title:"This place in KIMA",children:n.properties.title}),n.externalURI&&o("a",{href:n.externalURI,target:"_blank",title:"This place in Wikidata",children:o(je,{title:"This place in Wikidata"})})]}),o("p",{className:"kima-description",children:l})]}),o("div",{className:"kima-popup-multilist-list",children:s.map(u=>o(At,{record:u,onClick:()=>d(u)},u.id))})]})]})},fe={headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST"};class Bt extends Error{constructor(t,n){super(t),this.status=n}}const P=e=>{if(e.status===200)return e.json();throw new Bt("API Error",e.status)},j=e=>{const t={};return e.forEach(({name:n,values:s})=>t[n]=s),Object.keys(t.length>0)?t:null},Ft=e=>(t=null,n=[],s)=>{if(t){const[[r,i],[d,l]]=t;return n.length>0?fetch(`${e}/BoxPlaces/${r}/${i}/${d}/${l}`,{signal:s,...fe,body:JSON.stringify(j(n))}).then(P):new Promise(c=>setTimeout(c,50)).then(()=>fetch(`${e}/BoxPlaces/${r}/${i}/${d}/${l}`,{signal:s})).then(P)}else return fetch(`${e}/Places`,{signal:s}).then(P)},zt=e=>(t=null,n=[],s)=>{if(t){const[[r,i],[d,l]]=t;return n.length>0?fetch(`${e}/BoxRecords/${r}/${i}/${d}/${l}`,{signal:s,...fe,body:JSON.stringify(j(n))}).then(P):fetch(`${e}/BoxRecords/${r}/${i}/${d}/${l}`,{signal:s}).then(P)}else return fetch(`${e}/Records`,{signal:s}).then(P)},Vt=e=>{const{search:t,setSearchState:n}=ge(),[s,r]=a.exports.useState(),i=Ft(e.api),d=zt(e.api);return a.exports.useEffect(()=>{if(t.status===E.PENDING){e.onLoad(),s&&s.abort();const l=new AbortController;r(l),console.log("Running search");const{signal:c}=l;Promise.all([i(e.bounds,t.args.filters,c),d(e.bounds,t.args.filters,c)]).then(([u,h])=>{r(null),console.log("Places",u),console.log("Records",h);const p=u.features.reduce((g,b)=>g+(b.properties.total_records||1),0),f=u.features.map(g=>({...g,properties:{id:g.id,count:g.properties.total_records,...g.properties}}));n({args:{...t.args},status:E.OK,result:{total:p,items:f,aggregations:Object.entries(h.facetsInfo).reduce((g,[b,v])=>(g[b]={buckets:v.map(k=>({label:k.label,count:k.countFaceted}))},g),{})}}),e.onLoadDone(),e.onSearchResult({places:u,records:h})}).catch(u=>{console.log(u),u.status===500&&n({...t,status:E.PENDING})})}},[t]),a.exports.useEffect(()=>{e.bounds&&n({args:t.args,status:E.PENDING,result:t.result})},[e.bounds]),e.children},be=e=>e.substring(e.lastIndexOf("=")+1),Kt=e=>{const{records:t}=e,n={};return t.forEach(s=>{const{places:r}=s;r.forEach(i=>{const d=be(i.id);n[d]?n[d].push(s):n[d]=[s]})}),n},Gt=e=>{const[t,n]=a.exports.useState(),{search:s}=ge(),{results:r}=e,i=r==null?void 0:r.places.features,d=r==null?void 0:r.records,l=a.exports.useMemo(()=>d?Kt(d):null,[e.results]),c=u=>l?l[u]||[]:[];return a.exports.useEffect(()=>{n({getNodeById:p=>i==null?void 0:i.find(f=>f.id===p),getConnected:(p,f,g)=>{var v;const b=be(p);return f?((((v=s.args.filters)==null?void 0:v.length)>0?fetch("https://kimanli.azurewebsites.net/api/Records/"+b,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",body:JSON.stringify(j(s.args.filters))}):fetch("https://kimanli.azurewebsites.net/api/Records/"+b)).then(y=>y.json()).then(y=>g(y)),c(b)):new Promise(k=>k(c(b)))}})},[e.results]),o(he.Provider,{value:t,children:e.children})},Ht=e=>{const{longitude:t,latitude:n,zoom:s}=e;return!!(t&&n&&s)},Ut=e=>{const{viewState:t,setViewState:n,getMapBounds:s}=Ot(),[r]=We(t,250),i=pe(),d=a.exports.useMemo(()=>{if(Ht(r))return s()},[i,r]),[l,c]=a.exports.useState();return o(Vt,{api:e.api,bounds:d,onLoad:e.onLoad,onLoadDone:e.onLoadDone,onSearchResult:u=>c(u),children:o(Gt,{api:e.api,bounds:d,results:l,children:e.children})})},_t=e=>{var c,u;const t=me(),n=_(),[s,r]=a.exports.useState([]),{node:i}=e;a.exports.useEffect(()=>{t.getConnected(i.id,!1).then(r)},[]);const d=((c=i.descriptions)==null?void 0:c.length)>0?i.descriptions[0].value:null,l=i.properties.total_records;return n.size==="DESKTOP"?m("div",{dir:"rtl",className:"kima-tooltip",children:[m("main",{children:[o("h1",{children:i.properties.title}),o("p",{className:"kima-description",children:d})]}),l===1&&s.length>0&&m("div",{className:"kima-tooltip-footer kima-first-connected",children:[s[0].title," ",((u=s[0].type)==null?void 0:u.label)&&m("span",{children:["(",s[0].type.label,")"]})]}),l>1&&s.length>0&&m("div",{className:"kima-tooltip-footer kima-connected-count",dir:"ltr",children:[l.toLocaleString()," Objects"]})]}):null};const jt=e=>{const t=_();return o("div",{className:t.size==="DESKTOP"?"kima-load-indicator p6o-controls-btn":"kima-load-indicator p6o-controls-btn mobile",children:o(re,{})})};window.global||(window.global=window);const Wt=new Qe,Qt=()=>{const[e,t]=a.exports.useState(!0);return o(qe,{client:Wt,children:o(et,{children:m(Ut,{api:"https://kimanli.azurewebsites.net/api",onLoad:()=>t(!0),onLoadDone:()=>t(!1),children:[o(yt.MapLibre,{mapStyle:"https://api.maptiler.com/maps/voyager/style.json?key=RFavxpVJ82EHyrN2kxsF",defaultBounds:[[32,27.1],[38.2,35.7]],tooltip:n=>o(_t,{...n}),popup:n=>o(Dt,{...n}),children:o(bt,{id:"kima-layer-places",color:"#9d00d1"})}),m(kt,{children:[o(J,{children:o(ct,{items:[o(Z,{colors:M,fullscreen:!0,displayFacets:["RecordTypes","RelationshipTypes"],facetLabels:["Record Types","Relationships"]})]})}),o(q,{children:o(Z,{colors:M,responsive:!0,displayFacets:["RecordTypes","RelationshipTypes"],facetLabels:["Record Types","Relationships"]})}),o(wt,{}),o(xt,{}),m(at,{className:"kima-welcome",children:[o("h1",{children:"Welcome to the Heritage Browser!"}),o("p",{children:"Discover the digitally available treasures of the National Library of Israel displayed on a map according to where they were created or locations they describe."}),m("ul",{children:[o("li",{children:"Move the map around by dragging it and use the buttons on the right or your mouse to zoom in and out."}),o("li",{children:"Click on a place to see the number of items related to it, as well as links to wikidata and the Kima Gazetteer. Another click will open a list of related items."}),m("li",{children:["After opening an item, use the ",o(ie,{})," icon to enlarge the image. Click Details to view the item's details at the library's website."]}),o(q,{children:o("li",{children:"Use the left bar to filter the types of items that interest you, or change the bar from Record Types to Relationship Types to filter items according to their relation to the place."})}),o(J,{children:m("li",{children:["Click the ",o(Je,{})," icon to filter the types of items that interest you, or change the bar from Record Types to Relationship Types to filter items according to their relation to the place."]})}),m("li",{children:["The ",o(Ye,{})," button on the right of the screen will focus the map on your current location."]})]}),m("p",{children:["Created by ",o("a",{href:"mailto:sinai.rusinek@mail.huji.ac.il",children:"Sinai Rusinek"}),", ",o("a",{href:"mailto:gil.shalit@gmail.com",children:"Gil Shalit"})," and ",o("a",{href:"mailto:hello@rainersimon.io",children:"Rainer Simon"})," and was a finalist in the ",o("a",{href:"https://tarboot.org/",target:"_blank",children:"tarboot"})," competition's general track."]})]}),e&&o(jt,{})]})]})})})};window.onload=function(){Ze.createRoot(document.getElementById("app")).render(o(Qt,{}))};
