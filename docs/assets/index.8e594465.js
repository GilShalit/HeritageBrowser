import{r as L,j as w,R as Th,M as wh,a as ws,b as He,c as B,H as Ah,d as Sh,e as qi,f as xh,I as As,F as Ss,g as Ph,h as Oc,C as Mh,i as gi,k as kc,o as Nc,S as Lh,L as pi,l as Rh,u as Ih,T as Dc,m as Ch,n as Oh,p as kh,q as Nh,s as Dh,t as Fh,v as mi,w as Bh,x as Uh,y as Po,z as Mo,A as Vh,B as jh,D as zh,E as Gh,G as Fc,J as Bc,K as Hh,N as Wh,O as Xh,Q as Yh,P as qh,U as $h}from"./vendor.db3efe46.js";function Zh(n,t){for(var e=0;e<t.length;e++){const r=t[e];if(typeof r!="string"&&!Array.isArray(r)){for(const i in r)if(i!=="default"&&!(i in n)){const s=Object.getOwnPropertyDescriptor(r,i);s&&Object.defineProperty(n,i,s.get?s:{enumerable:!0,get:()=>r[i]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();var gt=(n=>(n.MOBILE="MOBILE",n.DESKTOP="DESKTOP",n))(gt||{});const Uc="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,Vc=L.exports.createContext({size:gt.DESKTOP,isTouchDevice:Uc}),Kh=n=>{const[t,e]=L.exports.useState({size:window.innerWidth>n.breakPoint?gt.DESKTOP:gt.MOBILE,isTouchDevice:Uc});return L.exports.useLayoutEffect(()=>{const r=i=>{const s=window.innerWidth;s>n.breakPoint&&t.size===gt.MOBILE?e({...t,size:gt.DESKTOP}):s<n.breakPoint&&t.size===gt.DESKTOP&&e({...t,size:gt.MOBILE})};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[n.breakPoint,t]),w(Vc.Provider,{value:t,children:n.children})},Jt=()=>L.exports.useContext(Vc),Qh=n=>w(Th,{children:w(Kh,{breakPoint:n.breakPoint||540,children:w(wh,{children:n.children})})});const jc=L.exports.createContext({}),Gr=()=>L.exports.useContext(jc);var be=(n=>(n.PENDING="PENDING",n.OK="OK",n.FAILED="FAILED",n))(be||{});const Jh=ws({key:"search",default:{args:{},status:be.OK}}),In=()=>{const[n,t]=He(Jh),e=(c={})=>t({args:c,status:be.PENDING,result:n.result});return{changeSearchQuery:c=>e({...n.args,query:c}),clearSearchQuery:()=>e({...n.args,query:void 0}),refreshSearch:()=>e({...n.args}),search:n,setActiveAggregation:c=>t({args:{...n.args,activeAggregation:c},status:n.status,result:n.result}),setFilter:c=>{const l=[...(n.args.filters||[]).filter(u=>u.name!==c.name),c];e({...n.args,filters:l})},setSearchState:t}},tf=n=>{const t=n.activeAggregation||n.aggregations[0]||"",e=n.labels?n.labels[n.aggregations.indexOf(t)]:t,r=i=>()=>{const{length:s}=n.aggregations,a=(n.aggregations.indexOf(t)+i+s)%s;n.onChangeAggregation(n.aggregations[a])};return B("div",{className:"p6o-aggs-carousel",children:[w("button",{tabIndex:4,"aria-label":"Previous filter category",onClick:r(-1),children:w(Ah,{})}),w("h3",{"aria-live":"polite","aria-atomic":!0,children:e}),w("button",{tabIndex:5,"aria-label":"Next filter category",onClick:r(1),children:w(Sh,{})})]})},ef=n=>n>1e3?(n/1e3).toFixed(1)+"k":n>1e6?(n/1e6).toFixed(1)+"M":n,nf=n=>w("div",{className:"p6o-aggs-values",children:w("ul",{children:n.buckets.map(({label:t,count:e})=>w("li",{className:n.filterValues.length>0&&!n.filterValues.includes(t)?"p6o-value-unselected":"",onClick:n.onToggleFilterValue(t),children:w("div",{className:"p6o-agg-value-wrapper",children:B("div",{className:"p6o-agg-value",children:[w("span",{className:"p6o-agg-value-count",style:{backgroundColor:n.colors&&n.colors[t],borderColor:n.colors&&n.colors[t]&&qi(n.colors[t]).alpha(.8).hex()},children:ef(e)}),w("span",{className:"p6o-agg-value-label",children:t})]})})},t))})});const Lo=n=>{var l,u,h,g;const{search:t,setFilter:e,setActiveAggregation:r}=In(),i=(l=t.result)!=null&&l.aggregations?Object.keys(t.result.aggregations):[],s=n.displayFacets||i,o=t.args.activeAggregation||s[0]||"",a=((h=(u=t.args.filters)==null?void 0:u.find(m=>m.name===o))==null?void 0:h.values)||[],c=m=>()=>{const b=a.includes(m)?{name:o,values:a.filter(y=>y!==m)}:{name:o,values:[...a,m]};e(b)};return B("div",{className:n.fullscreen?"p6o-aggs p6o-aggs-overlay fullscreen":"p6o-aggs p6o-aggs-overlay",children:[w(tf,{aggregations:s,labels:n.facetLabels,activeAggregation:o,onChangeAggregation:r}),((g=t.result)==null?void 0:g.aggregations)&&w(nf,{buckets:t.result.aggregations[o].buckets,colors:n.colors,filterValues:a,onToggleFilterValue:c})]})},Ro=n=>Jt().size===gt.DESKTOP?n.children:null,zc=n=>{const t=L.exports.useRef(null),e=Jt();L.exports.useEffect(()=>{const i=s=>{s.key==="Escape"&&n.onClose(null)};return document.addEventListener("keydown",i),()=>document.removeEventListener("keydown",i)},[]);const r=i=>{i.target===t.current&&n.onClose(i)};return xh.createPortal(B("div",{ref:t,className:n.className?`p6o-info-modal-bg ${n.className}`:"p6o-info-modal-bg",onClick:r,children:[w("button",{className:e.size===gt.DESKTOP?"p6o-info-modal-close":"p6o-info-modal-close mobile",onClick:n.onClose,children:w(As,{})}),w("main",{className:"p6o-info-modal-main",children:n.children})]}),document.body)};const rf=n=>{const[t,e]=L.exports.useState(!1);return B(Ss,{children:[w("button",{className:"p6o-controls-btn p6o-info",tabIndex:41,"aria-label":"Information",onClick:()=>e(!0),children:w(Ph,{})}),t&&w(zc,{className:n.className,onClose:()=>e(!1),children:n.children})]})},Io=n=>Jt().size===gt.MOBILE?n.children:null;const sf=n=>{const[t,e]=L.exports.useState(!1);return B(Ss,{children:[w("button",{className:"p6o-controls-btn p6o-mobile-menu-btn",tabIndex:42,"aria-label":"Open menu",onClick:()=>e(!0),children:w(Oc,{})}),w(Mh,{in:t,className:"p6o-mobile-menu",classNames:"p6o-mobile-menu",timeout:200,unmountOnExit:!0,children:B("div",{className:"p6o-mobile-menu",children:[w("button",{className:"p6o-mobile-menu-close",onClick:()=>e(!1),children:w(As,{})}),w("main",{children:n.items.length===1?n.items[0]:null})]})})]})},Hr=ws({key:"mapView",default:{}}),Tr=n=>{const{longitude:t,latitude:e,zoom:r}=n,i=s=>s!==void 0;return i(t)&&i(e)&&i(r)},of=ws({key:"selected",default:null});function wr(n,t){if(!n)throw new Error(t||"loader assertion failed.")}const xs=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser),Co=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Co&&parseFloat(Co[1]);const af="3.4.14";function qt(n,t){if(!n)throw new Error(t||"loaders.gl assertion failed.")}const dr=typeof process!="object"||String(process)!=="[object process]"||process.browser,cf=typeof window<"u"&&typeof window.orientation<"u",Oo=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Oo&&parseFloat(Oo[1]);function An(n){return An=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},An(n)}function lf(n,t){if(An(n)!="object"||!n)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var r=e.call(n,t||"default");if(An(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(n)}function uf(n){var t=lf(n,"string");return An(t)=="symbol"?t:String(t)}function f(n,t,e){return t=uf(t),t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}class hf{constructor(t,e){f(this,"name",void 0),f(this,"workerThread",void 0),f(this,"isRunning",!0),f(this,"result",void 0),f(this,"_resolve",()=>{}),f(this,"_reject",()=>{}),this.name=t,this.workerThread=e,this.result=new Promise((r,i)=>{this._resolve=r,this._reject=i})}postMessage(t,e){this.workerThread.postMessage({source:"loaders.gl",type:t,payload:e})}done(t){qt(this.isRunning),this.isRunning=!1,this._resolve(t)}error(t){qt(this.isRunning),this.isRunning=!1,this._reject(t)}}class _i{terminate(){}}const bi=new Map;function ff(n){qt(n.source&&!n.url||!n.source&&n.url);let t=bi.get(n.source||n.url);return t||(n.url&&(t=df(n.url),bi.set(n.url,t)),n.source&&(t=Gc(n.source),bi.set(n.source,t))),qt(t),t}function df(n){if(!n.startsWith("http"))return n;const t=gf(n);return Gc(t)}function Gc(n){const t=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(t)}function gf(n){return`try {
  importScripts('`.concat(n,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function Hc(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,e=arguments.length>2?arguments[2]:void 0;const r=e||new Set;if(n){if(ko(n))r.add(n);else if(ko(n.buffer))r.add(n.buffer);else if(!ArrayBuffer.isView(n)){if(t&&typeof n=="object")for(const i in n)Hc(n[i],t,r)}}return e===void 0?Array.from(r):[]}function ko(n){return n?n instanceof ArrayBuffer||typeof MessagePort<"u"&&n instanceof MessagePort||typeof ImageBitmap<"u"&&n instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas:!1}const yi=()=>{};class $i{static isSupported(){return typeof Worker<"u"&&dr||typeof _i<"u"&&!dr}constructor(t){f(this,"name",void 0),f(this,"source",void 0),f(this,"url",void 0),f(this,"terminated",!1),f(this,"worker",void 0),f(this,"onMessage",void 0),f(this,"onError",void 0),f(this,"_loadableURL","");const{name:e,source:r,url:i}=t;qt(r||i),this.name=e,this.source=r,this.url=i,this.onMessage=yi,this.onError=s=>console.log(s),this.worker=dr?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=yi,this.onError=yi,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(t,e){e=e||Hc(t),this.worker.postMessage(t,e)}_getErrorFromErrorEvent(t){let e="Failed to load ";return e+="worker ".concat(this.name," from ").concat(this.url,". "),t.message&&(e+="".concat(t.message," in ")),t.lineno&&(e+=":".concat(t.lineno,":").concat(t.colno)),new Error(e)}_createBrowserWorker(){this._loadableURL=ff({source:this.source,url:this.url});const t=new Worker(this._loadableURL,{name:this.name});return t.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},t.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},t.onmessageerror=e=>console.error(e),t}_createNodeWorker(){let t;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);t=new _i(r,{eval:!1})}else if(this.source)t=new _i(this.source,{eval:!0});else throw new Error("no worker");return t.on("message",e=>{this.onMessage(e)}),t.on("error",e=>{this.onError(e)}),t.on("exit",e=>{}),t}}class pf{static isSupported(){return $i.isSupported()}constructor(t){f(this,"name","unnamed"),f(this,"source",void 0),f(this,"url",void 0),f(this,"maxConcurrency",1),f(this,"maxMobileConcurrency",1),f(this,"onDebug",()=>{}),f(this,"reuseWorkers",!0),f(this,"props",{}),f(this,"jobQueue",[]),f(this,"idleQueue",[]),f(this,"count",0),f(this,"isDestroyed",!1),this.source=t.source,this.url=t.url,this.setProps(t)}destroy(){this.idleQueue.forEach(t=>t.destroy()),this.isDestroyed=!0}setProps(t){this.props={...this.props,...t},t.name!==void 0&&(this.name=t.name),t.maxConcurrency!==void 0&&(this.maxConcurrency=t.maxConcurrency),t.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=t.maxMobileConcurrency),t.reuseWorkers!==void 0&&(this.reuseWorkers=t.reuseWorkers),t.onDebug!==void 0&&(this.onDebug=t.onDebug)}async startJob(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:(s,o,a)=>s.done(a),r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(s,o)=>s.error(o);const i=new Promise(s=>(this.jobQueue.push({name:t,onMessage:e,onError:r,onStart:s}),this));return this._startQueuedJob(),await i}async _startQueuedJob(){if(!this.jobQueue.length)return;const t=this._getAvailableWorker();if(!t)return;const e=this.jobQueue.shift();if(e){this.onDebug({message:"Starting job",name:e.name,workerThread:t,backlog:this.jobQueue.length});const r=new hf(e.name,t);t.onMessage=i=>e.onMessage(r,i.type,i.payload),t.onError=i=>e.onError(r,i),e.onStart(r);try{await r.result}finally{this.returnWorkerToQueue(t)}}}returnWorkerToQueue(t){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(t.destroy(),this.count--):this.idleQueue.push(t),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const t="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new $i({name:t,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return cf?this.maxMobileConcurrency:this.maxConcurrency}}const mf={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class Xt{static isSupported(){return $i.isSupported()}static getWorkerFarm(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Xt._workerFarm=Xt._workerFarm||new Xt({}),Xt._workerFarm.setProps(t),Xt._workerFarm}constructor(t){f(this,"props",void 0),f(this,"workerPools",new Map),this.props={...mf},this.setProps(t),this.workerPools=new Map}destroy(){for(const t of this.workerPools.values())t.destroy();this.workerPools=new Map}setProps(t){this.props={...this.props,...t};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(t){const{name:e,source:r,url:i}=t;let s=this.workerPools.get(e);return s||(s=new pf({name:e,source:r,url:i}),s.setProps(this._getWorkerPoolProps()),this.workerPools.set(e,s)),s}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}f(Xt,"_workerFarm",void 0);const _f="latest";function bf(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const e=t[n.id]||{},r="".concat(n.id,"-worker.js");let i=e.workerUrl;if(!i&&n.id==="compression"&&(i=t.workerUrl),t._workerType==="test"&&(i="modules/".concat(n.module,"/dist/").concat(r)),!i){let s=n.version;s==="latest"&&(s=_f);const o=s?"@".concat(s):"";i="https://unpkg.com/@loaders.gl/".concat(n.module).concat(o,"/dist/").concat(r)}return qt(i),i}function yf(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:af;qt(n,"no worker provided");const e=n.version;return!(!t||!e)}function vf(n,t){return!Xt.isSupported()||!dr&&!(t!=null&&t._nodeWorkers)?!1:n.worker&&(t==null?void 0:t.worker)}async function Ef(n,t,e,r,i){const s=n.id,o=bf(n,e),c=Xt.getWorkerFarm(e).getWorkerPool({name:s,url:o});e=JSON.parse(JSON.stringify(e)),r=JSON.parse(JSON.stringify(r||{}));const l=await c.startJob("process-on-worker",Tf.bind(null,i));return l.postMessage("process",{input:t,options:e,context:r}),await(await l.result).result}async function Tf(n,t,e,r){switch(e){case"done":t.done(r);break;case"error":t.error(new Error(r.error));break;case"process":const{id:i,input:s,options:o}=r;try{const a=await n(s,o);t.postMessage("done",{id:i,result:a})}catch(a){const c=a instanceof Error?a.message:"unknown error";t.postMessage("error",{id:i,error:c})}break;default:console.warn("parse-with-worker unknown message ".concat(e))}}function wf(n,t,e){if(e=e||n.byteLength,n.byteLength<e||t.byteLength<e)return!1;const r=new Uint8Array(n),i=new Uint8Array(t);for(let s=0;s<r.length;++s)if(r[s]!==i[s])return!1;return!0}function Af(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];const r=t.map(a=>a instanceof ArrayBuffer?new Uint8Array(a):a),i=r.reduce((a,c)=>a+c.byteLength,0),s=new Uint8Array(i);let o=0;for(const a of r)s.set(a,o),o+=a.byteLength;return s.buffer}async function Sf(n){const t=[];for await(const e of n)t.push(e);return Af(...t)}let xf="";const No={};function Pf(n){for(const t in No)if(n.startsWith(t)){const e=No[t];n=n.replace(t,e)}return!n.startsWith("http://")&&!n.startsWith("https://")&&(n="".concat(xf).concat(n)),n}function Mf(n){return n&&typeof n=="object"&&n.isBuffer}function Wc(n){if(Mf(n))return n;if(n instanceof ArrayBuffer)return n;if(ArrayBuffer.isView(n))return n.byteOffset===0&&n.byteLength===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength);if(typeof n=="string"){const t=n;return new TextEncoder().encode(t).buffer}if(n&&typeof n=="object"&&n._toArrayBuffer)return n._toArrayBuffer();throw new Error("toArrayBuffer")}function Xc(n){const t=n?n.lastIndexOf("/"):-1;return t>=0?n.substr(t+1):""}function Lf(n){const t=n?n.lastIndexOf("/"):-1;return t>=0?n.substr(0,t):""}const Rf=n=>typeof n=="boolean",vn=n=>typeof n=="function",Cn=n=>n!==null&&typeof n=="object",Do=n=>Cn(n)&&n.constructor==={}.constructor,If=n=>n&&typeof n[Symbol.iterator]=="function",Cf=n=>n&&typeof n[Symbol.asyncIterator]=="function",we=n=>typeof Response<"u"&&n instanceof Response||n&&n.arrayBuffer&&n.text&&n.json,Ae=n=>typeof Blob<"u"&&n instanceof Blob,Of=n=>n&&typeof n=="object"&&n.isBuffer,kf=n=>typeof ReadableStream<"u"&&n instanceof ReadableStream||Cn(n)&&vn(n.tee)&&vn(n.cancel)&&vn(n.getReader),Nf=n=>Cn(n)&&vn(n.read)&&vn(n.pipe)&&Rf(n.readable),Yc=n=>kf(n)||Nf(n),Df=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Ff=/^([-\w.]+\/[-\w.+]+)/;function Bf(n){const t=Ff.exec(n);return t?t[1]:n}function Fo(n){const t=Df.exec(n);return t?t[1]:""}const qc=/\?.*/;function Uf(n){const t=n.match(qc);return t&&t[0]}function Ps(n){return n.replace(qc,"")}function Wr(n){return we(n)?n.url:Ae(n)?n.name||"":typeof n=="string"?n:""}function Ms(n){if(we(n)){const t=n,e=t.headers.get("content-type")||"",r=Ps(t.url);return Bf(e)||Fo(r)}return Ae(n)?n.type||"":typeof n=="string"?Fo(n):""}function Vf(n){return we(n)?n.headers["content-length"]||-1:Ae(n)?n.size:typeof n=="string"?n.length:n instanceof ArrayBuffer||ArrayBuffer.isView(n)?n.byteLength:-1}async function $c(n){if(we(n))return n;const t={},e=Vf(n);e>=0&&(t["content-length"]=String(e));const r=Wr(n),i=Ms(n);i&&(t["content-type"]=i);const s=await Gf(n);s&&(t["x-first-bytes"]=s),typeof n=="string"&&(n=new TextEncoder().encode(n));const o=new Response(n,{headers:t});return Object.defineProperty(o,"url",{value:r}),o}async function jf(n){if(!n.ok){const t=await zf(n);throw new Error(t)}}async function zf(n){let t="Failed to fetch resource ".concat(n.url," (").concat(n.status,"): ");try{const e=n.headers.get("Content-Type");let r=n.statusText;e.includes("application/json")&&(r+=" ".concat(await n.text())),t+=r,t=t.length>60?"".concat(t.slice(0,60),"..."):t}catch{}return t}async function Gf(n){if(typeof n=="string")return"data:,".concat(n.slice(0,5));if(n instanceof Blob){const e=n.slice(0,5);return await new Promise(r=>{const i=new FileReader;i.onload=s=>{var o;return r(s==null||(o=s.target)===null||o===void 0?void 0:o.result)},i.readAsDataURL(e)})}if(n instanceof ArrayBuffer){const e=n.slice(0,5),r=Hf(e);return"data:base64,".concat(r)}return null}function Hf(n){let t="";const e=new Uint8Array(n);for(let r=0;r<e.byteLength;r++)t+=String.fromCharCode(e[r]);return btoa(t)}async function Bo(n,t){if(typeof n=="string"){n=Pf(n);let e=t;return t!=null&&t.fetch&&typeof(t==null?void 0:t.fetch)!="function"&&(e=t.fetch),await fetch(n,e)}return await $c(n)}function Wf(n){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;const t=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,e=n||t;return!!(e&&e.indexOf("Electron")>=0)}function On(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||Wf()}const Qn=globalThis.window||globalThis.self||globalThis.global,un=globalThis.process||{},Zc=typeof __VERSION__<"u"?__VERSION__:"untranspiled source";On();function Xf(n){try{const t=window[n],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),t}catch{return null}}class Yf{constructor(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";this.storage=void 0,this.id=void 0,this.config=void 0,this.storage=Xf(r),this.id=t,this.config=e,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(t){if(Object.assign(this.config,t),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}}_loadConfiguration(){let t={};if(this.storage){const e=this.storage.getItem(this.id);t=e?JSON.parse(e):{}}return Object.assign(this.config,t),this}}function qf(n){let t;return n<10?t="".concat(n.toFixed(2),"ms"):n<100?t="".concat(n.toFixed(1),"ms"):n<1e3?t="".concat(n.toFixed(0),"ms"):t="".concat((n/1e3).toFixed(2),"s"),t}function $f(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;const e=Math.max(t-n.length,0);return"".concat(" ".repeat(e)).concat(n)}function vi(n,t,e){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600;const i=n.src.replace(/\(/g,"%28").replace(/\)/g,"%29");n.width>r&&(e=Math.min(e,r/n.width));const s=n.width*e,o=n.height*e,a=["font-size:1px;","padding:".concat(Math.floor(o/2),"px ").concat(Math.floor(s/2),"px;"),"line-height:".concat(o,"px;"),"background:url(".concat(i,");"),"background-size:".concat(s,"px ").concat(o,"px;"),"color:transparent;"].join("");return["".concat(t," %c+"),a]}let Ar;(function(n){n[n.BLACK=30]="BLACK",n[n.RED=31]="RED",n[n.GREEN=32]="GREEN",n[n.YELLOW=33]="YELLOW",n[n.BLUE=34]="BLUE",n[n.MAGENTA=35]="MAGENTA",n[n.CYAN=36]="CYAN",n[n.WHITE=37]="WHITE",n[n.BRIGHT_BLACK=90]="BRIGHT_BLACK",n[n.BRIGHT_RED=91]="BRIGHT_RED",n[n.BRIGHT_GREEN=92]="BRIGHT_GREEN",n[n.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",n[n.BRIGHT_BLUE=94]="BRIGHT_BLUE",n[n.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",n[n.BRIGHT_CYAN=96]="BRIGHT_CYAN",n[n.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Ar||(Ar={}));const Zf=10;function Uo(n){return typeof n!="string"?n:(n=n.toUpperCase(),Ar[n]||Ar.WHITE)}function Kf(n,t,e){if(!On&&typeof n=="string"){if(t){const r=Uo(t);n="\x1B[".concat(r,"m").concat(n,"\x1B[39m")}if(e){const r=Uo(e);n="\x1B[".concat(r+Zf,"m").concat(n,"\x1B[49m")}}return n}function Qf(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"];const e=Object.getPrototypeOf(n),r=Object.getOwnPropertyNames(e),i=n;for(const s of r){const o=i[s];typeof o=="function"&&(t.find(a=>s===a)||(i[s]=o.bind(n)))}}function Sr(n,t){if(!n)throw new Error(t||"Assertion failed")}function Me(){let n;if(On()&&Qn.performance){var t,e;n=Qn==null||(t=Qn.performance)===null||t===void 0||(e=t.now)===null||e===void 0?void 0:e.call(t)}else if("hrtime"in un){var r;const i=un==null||(r=un.hrtime)===null||r===void 0?void 0:r.call(un);n=i[0]*1e3+i[1]/1e6}else n=Date.now();return n}const Le={debug:On()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Jf={enabled:!0,level:0};function St(){}const Vo={},jo={once:!0};class Ls{constructor(){let{id:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};this.id=void 0,this.VERSION=Zc,this._startTs=Me(),this._deltaTs=Me(),this._storage=void 0,this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=t,this.userData={},this._storage=new Yf("__probe-".concat(this.id,"__"),Jf),this.timeStamp("".concat(this.id," started")),Qf(this),Object.seal(this)}set level(t){this.setLevel(t)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Me()-this._startTs).toPrecision(10))}getDelta(){return Number((Me()-this._deltaTs).toPrecision(10))}set priority(t){this.level=t}get priority(){return this.level}getPriority(){return this.level}enable(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.setConfiguration({enabled:t}),this}setLevel(t){return this._storage.setConfiguration({level:t}),this}get(t){return this._storage.config[t]}set(t,e){this._storage.setConfiguration({[t]:e})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(t,e){Sr(t,e)}warn(t){return this._getLogFunction(0,t,Le.warn,arguments,jo)}error(t){return this._getLogFunction(0,t,Le.error,arguments)}deprecated(t,e){return this.warn("`".concat(t,"` is deprecated and will be removed in a later version. Use `").concat(e,"` instead"))}removed(t,e){return this.error("`".concat(t,"` has been removed. Use `").concat(e,"` instead"))}probe(t,e){return this._getLogFunction(t,e,Le.log,arguments,{time:!0,once:!0})}log(t,e){return this._getLogFunction(t,e,Le.debug,arguments)}info(t,e){return this._getLogFunction(t,e,console.info,arguments)}once(t,e){return this._getLogFunction(t,e,Le.debug||Le.info,arguments,jo)}table(t,e,r){return e?this._getLogFunction(t,e,console.table||St,r&&[r],{tag:rd(e)}):St}image(t){let{logLevel:e,priority:r,image:i,message:s="",scale:o=1}=t;return this._shouldLog(e||r)?On()?nd({image:i,message:s,scale:o}):ed():St}time(t,e){return this._getLogFunction(t,e,console.time?console.time:console.info)}timeEnd(t,e){return this._getLogFunction(t,e,console.timeEnd?console.timeEnd:console.info)}timeStamp(t,e){return this._getLogFunction(t,e,console.timeStamp||St)}group(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1};const i=zo({logLevel:t,message:e,opts:r}),{collapsed:s}=r;return i.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(t,e,Object.assign({},r,{collapsed:!0}))}groupEnd(t){return this._getLogFunction(t,"",console.groupEnd||St)}withGroup(t,e,r){this.group(t,e)();try{r()}finally{this.groupEnd(t)()}}trace(){console.trace&&console.trace()}_shouldLog(t){return this.isEnabled()&&this.getLevel()>=Kc(t)}_getLogFunction(t,e,r,i,s){if(this._shouldLog(t)){s=zo({logLevel:t,message:e,args:i,opts:s}),r=r||s.method,Sr(r),s.total=this.getTotal(),s.delta=this.getDelta(),this._deltaTs=Me();const o=s.tag||s.message;if(s.once&&o)if(!Vo[o])Vo[o]=Me();else return St;return e=td(this.id,s.message,s),r.bind(console,e,...s.args)}return St}}Ls.VERSION=Zc;function Kc(n){if(!n)return 0;let t;switch(typeof n){case"number":t=n;break;case"object":t=n.logLevel||n.priority||0;break;default:return 0}return Sr(Number.isFinite(t)&&t>=0),t}function zo(n){const{logLevel:t,message:e}=n;n.logLevel=Kc(t);const r=n.args?Array.from(n.args):[];for(;r.length&&r.shift()!==e;);switch(typeof t){case"string":case"function":e!==void 0&&r.unshift(e),n.message=t;break;case"object":Object.assign(n,t);break}typeof n.message=="function"&&(n.message=n.message());const i=typeof n.message;return Sr(i==="string"||i==="object"),Object.assign(n,{args:r},n.opts)}function td(n,t,e){if(typeof t=="string"){const r=e.time?$f(qf(e.total)):"";t=e.time?"".concat(n,": ").concat(r,"  ").concat(t):"".concat(n,": ").concat(t),t=Kf(t,e.color,e.background)}return t}function ed(n){return console.warn("removed"),St}function nd(n){let{image:t,message:e="",scale:r=1}=n;if(typeof t=="string"){const s=new Image;return s.onload=()=>{const o=vi(s,e,r);console.log(...o)},s.src=t,St}const i=t.nodeName||"";if(i.toLowerCase()==="img")return console.log(...vi(t,e,r)),St;if(i.toLowerCase()==="canvas"){const s=new Image;return s.onload=()=>console.log(...vi(s,e,r)),s.src=t.toDataURL(),St}return St}function rd(n){for(const t in n)for(const e in n[t])return e||"untitled";return"empty"}const Go=new Ls({id:"loaders.gl"});class id{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class sd{constructor(){f(this,"console",void 0),this.console=console}log(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.console.log.bind(this.console,...e)}info(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.console.info.bind(this.console,...e)}warn(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.console.warn.bind(this.console,...e)}error(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.console.error.bind(this.console,...e)}}const Qc={fetch:null,mimeType:void 0,nothrow:!1,log:new sd,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:xs,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},od={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Jc(){globalThis.loaders=globalThis.loaders||{};const{loaders:n}=globalThis;return n._state=n._state||{},n._state}const tl=()=>{const n=Jc();return n.globalOptions=n.globalOptions||{...Qc},n.globalOptions};function ad(n,t,e,r){return e=e||[],e=Array.isArray(e)?e:[e],cd(n,e),ud(t,n,r)}function cd(n,t){Ho(n,null,Qc,od,t);for(const e of t){const r=n&&n[e.id]||{},i=e.options&&e.options[e.id]||{},s=e.deprecatedOptions&&e.deprecatedOptions[e.id]||{};Ho(r,e.id,i,s,t)}}function Ho(n,t,e,r,i){const s=t||"Top level",o=t?"".concat(t,"."):"";for(const a in n){const c=!t&&Cn(n[a]),l=a==="baseUri"&&!t,u=a==="workerUrl"&&t;if(!(a in e)&&!l&&!u){if(a in r)Go.warn("".concat(s," loader option '").concat(o).concat(a,"' no longer supported, use '").concat(r[a],"'"))();else if(!c){const h=ld(a,i);Go.warn("".concat(s," loader option '").concat(o).concat(a,"' not recognized. ").concat(h))()}}}}function ld(n,t){const e=n.toLowerCase();let r="";for(const i of t)for(const s in i.options){if(n===s)return"Did you mean '".concat(i.id,".").concat(s,"'?");const o=s.toLowerCase();(e.startsWith(o)||o.startsWith(e))&&(r=r||"Did you mean '".concat(i.id,".").concat(s,"'?"))}return r}function ud(n,t,e){const i={...n.options||{}};return hd(i,e),i.log===null&&(i.log=new id),Wo(i,tl()),Wo(i,t),i}function Wo(n,t){for(const e in t)if(e in t){const r=t[e];Do(r)&&Do(n[e])?n[e]={...n[e],...t[e]}:n[e]=t[e]}}function hd(n,t){t&&!("baseUri"in n)&&(n.baseUri=t)}function Rs(n){var t;return n?(Array.isArray(n)&&(n=n[0]),Array.isArray((t=n)===null||t===void 0?void 0:t.extensions)):!1}function Is(n){var t,e;wr(n,"null loader"),wr(Rs(n),"invalid loader");let r;return Array.isArray(n)&&(r=n[1],n=n[0],n={...n,options:{...n.options,...r}}),((t=n)!==null&&t!==void 0&&t.parseTextSync||(e=n)!==null&&e!==void 0&&e.parseText)&&(n.text=!0),n.text||(n.binary=!0),n}const el=()=>{const n=Jc();return n.loaderRegistry=n.loaderRegistry||[],n.loaderRegistry};function fd(n){const t=el();n=Array.isArray(n)?n:[n];for(const e of n){const r=Is(e);t.find(i=>r===i)||t.unshift(r)}}function dd(){return el()}const gd=new Ls({id:"loaders.gl"}),pd=/\.([^.]+)$/;async function md(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],e=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;if(!nl(n))return null;let i=Xo(n,t,{...e,nothrow:!0},r);if(i)return i;if(Ae(n)&&(n=await n.slice(0,10).arrayBuffer(),i=Xo(n,t,e,r)),!i&&!(e!=null&&e.nothrow))throw new Error(rl(n));return i}function Xo(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],e=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;if(!nl(n))return null;if(t&&!Array.isArray(t))return Is(t);let i=[];t&&(i=i.concat(t)),e!=null&&e.ignoreRegisteredLoaders||i.push(...dd()),bd(i);const s=_d(n,i,e,r);if(!s&&!(e!=null&&e.nothrow))throw new Error(rl(n));return s}function _d(n,t,e,r){const i=Wr(n),s=Ms(n),o=Ps(i)||(r==null?void 0:r.url);let a=null,c="";if(e!=null&&e.mimeType&&(a=Ei(t,e==null?void 0:e.mimeType),c="match forced by supplied MIME type ".concat(e==null?void 0:e.mimeType)),a=a||yd(t,o),c=c||(a?"matched url ".concat(o):""),a=a||Ei(t,s),c=c||(a?"matched MIME type ".concat(s):""),a=a||Ed(t,n),c=c||(a?"matched initial data ".concat(il(n)):""),a=a||Ei(t,e==null?void 0:e.fallbackMimeType),c=c||(a?"matched fallback MIME type ".concat(s):""),c){var l;gd.log(1,"selectLoader selected ".concat((l=a)===null||l===void 0?void 0:l.name,": ").concat(c,"."))}return a}function nl(n){return!(n instanceof Response&&n.status===204)}function rl(n){const t=Wr(n),e=Ms(n);let r="No valid loader found (";r+=t?"".concat(Xc(t),", "):"no url provided, ",r+="MIME type: ".concat(e?'"'.concat(e,'"'):"not provided",", ");const i=n?il(n):"";return r+=i?' first bytes: "'.concat(i,'"'):"first bytes: not available",r+=")",r}function bd(n){for(const t of n)Is(t)}function yd(n,t){const e=t&&pd.exec(t),r=e&&e[1];return r?vd(n,r):null}function vd(n,t){t=t.toLowerCase();for(const e of n)for(const r of e.extensions)if(r.toLowerCase()===t)return e;return null}function Ei(n,t){for(const e of n)if(e.mimeTypes&&e.mimeTypes.includes(t)||t==="application/x.".concat(e.id))return e;return null}function Ed(n,t){if(!t)return null;for(const e of n)if(typeof t=="string"){if(Td(t,e))return e}else if(ArrayBuffer.isView(t)){if(Yo(t.buffer,t.byteOffset,e))return e}else if(t instanceof ArrayBuffer&&Yo(t,0,e))return e;return null}function Td(n,t){return t.testText?t.testText(n):(Array.isArray(t.tests)?t.tests:[t.tests]).some(r=>n.startsWith(r))}function Yo(n,t,e){return(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>wd(n,t,e,i))}function wd(n,t,e,r){if(r instanceof ArrayBuffer)return wf(r,n,r.byteLength);switch(typeof r){case"function":return r(n,e);case"string":const i=Zi(n,t,r.length);return r===i;default:return!1}}function il(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5;return typeof n=="string"?n.slice(0,t):ArrayBuffer.isView(n)?Zi(n.buffer,n.byteOffset,t):n instanceof ArrayBuffer?Zi(n,0,t):""}function Zi(n,t,e){if(n.byteLength<t+e)return"";const r=new DataView(n);let i="";for(let s=0;s<e;s++)i+=String.fromCharCode(r.getUint8(t+s));return i}const Ad=256*1024;function*Sd(n,t){const e=(t==null?void 0:t.chunkSize)||Ad;let r=0;const i=new TextEncoder;for(;r<n.length;){const s=Math.min(n.length-r,e),o=n.slice(r,r+s);r+=s,yield i.encode(o)}}const xd=256*1024;function Pd(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return function*(){const{chunkSize:e=xd}=t;let r=0;for(;r<n.byteLength;){const i=Math.min(n.byteLength-r,e),s=new ArrayBuffer(i),o=new Uint8Array(n,r,i);new Uint8Array(s).set(o),r+=i,yield s}}()}const Md=1024*1024;async function*Ld(n,t){const e=(t==null?void 0:t.chunkSize)||Md;let r=0;for(;r<n.size;){const i=r+e,s=await n.slice(r,i).arrayBuffer();r=i,yield s}}function qo(n,t){return xs?Rd(n,t):Id(n)}async function*Rd(n,t){const e=n.getReader();let r;try{for(;;){const i=r||e.read();t!=null&&t._streamReadAhead&&(r=e.read());const{done:s,value:o}=await i;if(s)return;yield Wc(o)}}catch{e.releaseLock()}}async function*Id(n,t){for await(const e of n)yield Wc(e)}function Cd(n,t){if(typeof n=="string")return Sd(n,t);if(n instanceof ArrayBuffer)return Pd(n,t);if(Ae(n))return Ld(n,t);if(Yc(n))return qo(n,t);if(we(n))return qo(n.body,t);throw new Error("makeIterator")}const sl="Cannot convert supplied data type";function Od(n,t,e){if(t.text&&typeof n=="string")return n;if(Of(n)&&(n=n.buffer),n instanceof ArrayBuffer){const r=n;return t.text&&!t.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(n)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(n);let r=n.buffer;const i=n.byteLength||n.length;return(n.byteOffset!==0||i!==r.byteLength)&&(r=r.slice(n.byteOffset,n.byteOffset+i)),r}throw new Error(sl)}async function kd(n,t,e){const r=n instanceof ArrayBuffer||ArrayBuffer.isView(n);if(typeof n=="string"||r)return Od(n,t);if(Ae(n)&&(n=await $c(n)),we(n)){const i=n;return await jf(i),t.binary?await i.arrayBuffer():await i.text()}if(Yc(n)&&(n=Cd(n,e)),If(n)||Cf(n))return Sf(n);throw new Error(sl)}function ol(n,t){const e=tl(),r=n||e;return typeof r.fetch=="function"?r.fetch:Cn(r.fetch)?i=>Bo(i,r):t!=null&&t.fetch?t==null?void 0:t.fetch:Bo}function Nd(n,t,e){if(e)return e;const r={fetch:ol(t,n),...n};if(r.url){const i=Ps(r.url);r.baseUrl=i,r.queryString=Uf(r.url),r.filename=Xc(i),r.baseUrl=Lf(i)}return Array.isArray(r.loaders)||(r.loaders=null),r}function Dd(n,t){if(!t&&n&&!Array.isArray(n))return n;let e;if(n&&(e=Array.isArray(n)?n:[n]),t&&t.loaders){const r=Array.isArray(t.loaders)?t.loaders:[t.loaders];e=e?[...e,...r]:r}return e&&e.length?e:null}async function Cs(n,t,e,r){qt(!r||typeof r=="object"),t&&!Array.isArray(t)&&!Rs(t)&&(r=void 0,e=t,t=void 0),n=await n,e=e||{};const i=Wr(n),o=Dd(t,r),a=await md(n,o,e);return a?(e=ad(e,a,o,i),r=Nd({url:i,parse:Cs,loaders:o},e,r||null),await Fd(a,n,e,r)):null}async function Fd(n,t,e,r){if(yf(n),we(t)){const i=t,{ok:s,redirected:o,status:a,statusText:c,type:l,url:u}=i,h=Object.fromEntries(i.headers.entries());r.response={headers:h,ok:s,redirected:o,status:a,statusText:c,type:l,url:u}}if(t=await kd(t,n,e),n.parseTextSync&&typeof t=="string")return e.dataType="text",n.parseTextSync(t,e,r,n);if(vf(n,e))return await Ef(n,t,e,r,Cs);if(n.parseText&&typeof t=="string")return await n.parseText(t,e,r,n);if(n.parse)return await n.parse(t,e,r,n);throw qt(!n.parseSync),new Error("".concat(n.id," loader - no parser found and worker is disabled"))}async function Ki(n,t,e,r){!Array.isArray(t)&&!Rs(t)&&(e=t,t=void 0);const i=ol(e);let s=n;return typeof n=="string"&&(s=await i(n)),Ae(n)&&(s=await i(n)),await Cs(s,t,e)}const Bd="3.4.14",{_parseImageNode:Ud}=globalThis,Qi=typeof Image<"u",Ji=typeof ImageBitmap<"u",Vd=Boolean(Ud),ts=xs?!0:Vd;function jd(n){switch(n){case"auto":return Ji||Qi||ts;case"imagebitmap":return Ji;case"image":return Qi;case"data":return ts;default:throw new Error("@loaders.gl/images: image ".concat(n," not supported in this environment"))}}function zd(){if(Ji)return"imagebitmap";if(Qi)return"image";if(ts)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function Gd(n){const t=Wd(n);if(!t)throw new Error("Not an image");return t}function Hd(n){switch(Gd(n)){case"data":return n;case"image":case"imagebitmap":const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("getImageData");return t.width=n.width,t.height=n.height,e.drawImage(n,0,0),e.getImageData(0,0,n.width,n.height);default:throw new Error("getImageData")}}function Wd(n){return typeof ImageBitmap<"u"&&n instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&n instanceof Image?"image":n&&typeof n=="object"&&n.data&&n.width&&n.height?"data":null}const Xd=/^data:image\/svg\+xml/,Yd=/\.svg((\?|#).*)?$/;function Os(n){return n&&(Xd.test(n)||Yd.test(n))}function qd(n,t){if(Os(t)){let r=new TextDecoder().decode(n);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(r=unescape(encodeURIComponent(r)))}catch(s){throw new Error(s.message)}return"data:image/svg+xml;base64,".concat(btoa(r))}return al(n,t)}function al(n,t){if(Os(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(n)])}async function cl(n,t,e){const r=qd(n,e),i=self.URL||self.webkitURL,s=typeof r!="string"&&i.createObjectURL(r);try{return await $d(s||r,t)}finally{s&&i.revokeObjectURL(s)}}async function $d(n,t){const e=new Image;return e.src=n,t.image&&t.image.decode&&e.decode?(await e.decode(),e):await new Promise((r,i)=>{try{e.onload=()=>r(e),e.onerror=s=>i(new Error("Could not load image ".concat(n,": ").concat(s)))}catch(s){i(s)}})}const Zd={};let $o=!0;async function Kd(n,t,e){let r;Os(e)?r=await cl(n,t,e):r=al(n,e);const i=t&&t.imagebitmap;return await Qd(r,i)}async function Qd(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if((Jd(t)||!$o)&&(t=null),t)try{return await createImageBitmap(n,t)}catch(e){console.warn(e),$o=!1}return await createImageBitmap(n)}function Jd(n){for(const t in n||Zd)return!1;return!0}function tg(n){return!ig(n,"ftyp",4)||(n[8]&96)===0?null:eg(n)}function eg(n){switch(ng(n,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function ng(n,t,e){return String.fromCharCode(...n.slice(t,e))}function rg(n){return[...n].map(t=>t.charCodeAt(0))}function ig(n,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=rg(t);for(let i=0;i<r.length;++i)if(r[i]!==n[i+e])return!1;return!0}const Ut=!1,En=!0;function ll(n){const t=kn(n);return og(t)||lg(t)||ag(t)||cg(t)||sg(t)}function sg(n){const t=new Uint8Array(n instanceof DataView?n.buffer:n),e=tg(t);return e?{mimeType:e.mimeType,width:0,height:0}:null}function og(n){const t=kn(n);return t.byteLength>=24&&t.getUint32(0,Ut)===2303741511?{mimeType:"image/png",width:t.getUint32(16,Ut),height:t.getUint32(20,Ut)}:null}function ag(n){const t=kn(n);return t.byteLength>=10&&t.getUint32(0,Ut)===1195984440?{mimeType:"image/gif",width:t.getUint16(6,En),height:t.getUint16(8,En)}:null}function cg(n){const t=kn(n);return t.byteLength>=14&&t.getUint16(0,Ut)===16973&&t.getUint32(2,En)===t.byteLength?{mimeType:"image/bmp",width:t.getUint32(18,En),height:t.getUint32(22,En)}:null}function lg(n){const t=kn(n);if(!(t.byteLength>=3&&t.getUint16(0,Ut)===65496&&t.getUint8(2)===255))return null;const{tableMarkers:r,sofMarkers:i}=ug();let s=2;for(;s+9<t.byteLength;){const o=t.getUint16(s,Ut);if(i.has(o))return{mimeType:"image/jpeg",height:t.getUint16(s+5,Ut),width:t.getUint16(s+7,Ut)};if(!r.has(o))return null;s+=2,s+=t.getUint16(s,Ut)}return null}function ug(){const n=new Set([65499,65476,65484,65501,65534]);for(let e=65504;e<65520;++e)n.add(e);return{tableMarkers:n,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function kn(n){if(n instanceof DataView)return n;if(ArrayBuffer.isView(n))return new DataView(n.buffer);if(n instanceof ArrayBuffer)return new DataView(n);throw new Error("toDataView")}async function hg(n,t){const{mimeType:e}=ll(n)||{},r=globalThis._parseImageNode;return wr(r),await r(n,e)}async function fg(n,t,e){t=t||{};const i=(t.image||{}).type||"auto",{url:s}=e||{},o=dg(i);let a;switch(o){case"imagebitmap":a=await Kd(n,t,s);break;case"image":a=await cl(n,t,s);break;case"data":a=await hg(n);break;default:wr(!1)}return i==="data"&&(a=Hd(a)),a}function dg(n){switch(n){case"auto":case"data":return zd();default:return jd(n),n}}const gg=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],pg=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],mg={image:{type:"auto",decode:!0}},_g={id:"image",module:"images",name:"Images",version:Bd,mimeTypes:pg,extensions:gg,parse:fg,tests:[n=>Boolean(ll(new DataView(n)))],options:mg};function ul(n){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;const t=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,e=n||t;return!!(e&&e.indexOf("Electron")>=0)}function te(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||ul()}const gr={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process},Jn=gr.window||gr.self||gr.global,hn=gr.process||{},hl=typeof __VERSION__<"u"?__VERSION__:"untranspiled source";te();const Ti=globalThis;function fl(n){if(!n&&!te())return"Node";if(ul(n))return"Electron";const e=n||(typeof navigator<"u"?navigator:{}).userAgent||"";if(e.indexOf("Edge")>-1)return"Edge";const r=e.indexOf("MSIE ")!==-1,i=e.indexOf("Trident/")!==-1;return r||i?"IE":Ti.chrome?"Chrome":Ti.safari?"Safari":Ti.mozInnerScreenX?"Firefox":"Unknown"}function bg(n){try{const t=window[n],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),t}catch{return null}}class yg{constructor(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";f(this,"storage",void 0),f(this,"id",void 0),f(this,"config",void 0),this.storage=bg(r),this.id=t,this.config=e,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(t){if(Object.assign(this.config,t),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}}_loadConfiguration(){let t={};if(this.storage){const e=this.storage.getItem(this.id);t=e?JSON.parse(e):{}}return Object.assign(this.config,t),this}}function vg(n){let t;return n<10?t="".concat(n.toFixed(2),"ms"):n<100?t="".concat(n.toFixed(1),"ms"):n<1e3?t="".concat(n.toFixed(0),"ms"):t="".concat((n/1e3).toFixed(2),"s"),t}function Eg(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;const e=Math.max(t-n.length,0);return"".concat(" ".repeat(e)).concat(n)}function wi(n,t,e){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600;const i=n.src.replace(/\(/g,"%28").replace(/\)/g,"%29");n.width>r&&(e=Math.min(e,r/n.width));const s=n.width*e,o=n.height*e,a=["font-size:1px;","padding:".concat(Math.floor(o/2),"px ").concat(Math.floor(s/2),"px;"),"line-height:".concat(o,"px;"),"background:url(".concat(i,");"),"background-size:".concat(s,"px ").concat(o,"px;"),"color:transparent;"].join("");return["".concat(t," %c+"),a]}let xr;(function(n){n[n.BLACK=30]="BLACK",n[n.RED=31]="RED",n[n.GREEN=32]="GREEN",n[n.YELLOW=33]="YELLOW",n[n.BLUE=34]="BLUE",n[n.MAGENTA=35]="MAGENTA",n[n.CYAN=36]="CYAN",n[n.WHITE=37]="WHITE",n[n.BRIGHT_BLACK=90]="BRIGHT_BLACK",n[n.BRIGHT_RED=91]="BRIGHT_RED",n[n.BRIGHT_GREEN=92]="BRIGHT_GREEN",n[n.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",n[n.BRIGHT_BLUE=94]="BRIGHT_BLUE",n[n.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",n[n.BRIGHT_CYAN=96]="BRIGHT_CYAN",n[n.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(xr||(xr={}));function Zo(n){return typeof n=="string"?xr[n.toUpperCase()]||xr.WHITE:n}function Tg(n,t,e){return!te&&typeof n=="string"&&(t&&(t=Zo(t),n="\x1B[".concat(t,"m").concat(n,"\x1B[39m")),e&&(t=Zo(e),n="\x1B[".concat(e+10,"m").concat(n,"\x1B[49m"))),n}function wg(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"];const e=Object.getPrototypeOf(n),r=Object.getOwnPropertyNames(e);for(const i of r)typeof n[i]=="function"&&(t.find(s=>i===s)||(n[i]=n[i].bind(n)))}function Pr(n,t){if(!n)throw new Error(t||"Assertion failed")}function Re(){let n;if(te&&"performance"in Jn){var t,e;n=Jn==null||(t=Jn.performance)===null||t===void 0||(e=t.now)===null||e===void 0?void 0:e.call(t)}else if("hrtime"in hn){var r;const i=hn==null||(r=hn.hrtime)===null||r===void 0?void 0:r.call(hn);n=i[0]*1e3+i[1]/1e6}else n=Date.now();return n}const Ie={debug:te&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Ag={enabled:!0,level:0};function xt(){}const Ko={},Qo={once:!0};class ks{constructor(){let{id:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};f(this,"id",void 0),f(this,"VERSION",hl),f(this,"_startTs",Re()),f(this,"_deltaTs",Re()),f(this,"_storage",void 0),f(this,"userData",{}),f(this,"LOG_THROTTLE_TIMEOUT",0),this.id=t,this.userData={},this._storage=new yg("__probe-".concat(this.id,"__"),Ag),this.timeStamp("".concat(this.id," started")),wg(this),Object.seal(this)}set level(t){this.setLevel(t)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Re()-this._startTs).toPrecision(10))}getDelta(){return Number((Re()-this._deltaTs).toPrecision(10))}set priority(t){this.level=t}get priority(){return this.level}getPriority(){return this.level}enable(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.setConfiguration({enabled:t}),this}setLevel(t){return this._storage.setConfiguration({level:t}),this}get(t){return this._storage.config[t]}set(t,e){this._storage.setConfiguration({[t]:e})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(t,e){Pr(t,e)}warn(t){return this._getLogFunction(0,t,Ie.warn,arguments,Qo)}error(t){return this._getLogFunction(0,t,Ie.error,arguments)}deprecated(t,e){return this.warn("`".concat(t,"` is deprecated and will be removed in a later version. Use `").concat(e,"` instead"))}removed(t,e){return this.error("`".concat(t,"` has been removed. Use `").concat(e,"` instead"))}probe(t,e){return this._getLogFunction(t,e,Ie.log,arguments,{time:!0,once:!0})}log(t,e){return this._getLogFunction(t,e,Ie.debug,arguments)}info(t,e){return this._getLogFunction(t,e,console.info,arguments)}once(t,e){for(var r=arguments.length,i=new Array(r>2?r-2:0),s=2;s<r;s++)i[s-2]=arguments[s];return this._getLogFunction(t,e,Ie.debug||Ie.info,arguments,Qo)}table(t,e,r){return e?this._getLogFunction(t,e,console.table||xt,r&&[r],{tag:Mg(e)}):xt}image(t){let{logLevel:e,priority:r,image:i,message:s="",scale:o=1}=t;return this._shouldLog(e||r)?te?Pg({image:i,message:s,scale:o}):xg():xt}time(t,e){return this._getLogFunction(t,e,console.time?console.time:console.info)}timeEnd(t,e){return this._getLogFunction(t,e,console.timeEnd?console.timeEnd:console.info)}timeStamp(t,e){return this._getLogFunction(t,e,console.timeStamp||xt)}group(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1};const i=Jo({logLevel:t,message:e,opts:r}),{collapsed:s}=r;return i.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(t,e,Object.assign({},r,{collapsed:!0}))}groupEnd(t){return this._getLogFunction(t,"",console.groupEnd||xt)}withGroup(t,e,r){this.group(t,e)();try{r()}finally{this.groupEnd(t)()}}trace(){console.trace&&console.trace()}_shouldLog(t){return this.isEnabled()&&this.getLevel()>=dl(t)}_getLogFunction(t,e,r,i,s){if(this._shouldLog(t)){s=Jo({logLevel:t,message:e,args:i,opts:s}),r=r||s.method,Pr(r),s.total=this.getTotal(),s.delta=this.getDelta(),this._deltaTs=Re();const o=s.tag||s.message;if(s.once)if(!Ko[o])Ko[o]=Re();else return xt;return e=Sg(this.id,s.message,s),r.bind(console,e,...s.args)}return xt}}f(ks,"VERSION",hl);function dl(n){if(!n)return 0;let t;switch(typeof n){case"number":t=n;break;case"object":t=n.logLevel||n.priority||0;break;default:return 0}return Pr(Number.isFinite(t)&&t>=0),t}function Jo(n){const{logLevel:t,message:e}=n;n.logLevel=dl(t);const r=n.args?Array.from(n.args):[];for(;r.length&&r.shift()!==e;);switch(typeof t){case"string":case"function":e!==void 0&&r.unshift(e),n.message=t;break;case"object":Object.assign(n,t);break}typeof n.message=="function"&&(n.message=n.message());const i=typeof n.message;return Pr(i==="string"||i==="object"),Object.assign(n,{args:r},n.opts)}function Sg(n,t,e){if(typeof t=="string"){const r=e.time?Eg(vg(e.total)):"";t=e.time?"".concat(n,": ").concat(r,"  ").concat(t):"".concat(n,": ").concat(t),t=Tg(t,e.color,e.background)}return t}function xg(n){return console.warn("removed"),xt}function Pg(n){let{image:t,message:e="",scale:r=1}=n;if(typeof t=="string"){const s=new Image;return s.onload=()=>{const o=wi(s,e,r);console.log(...o)},s.src=t,xt}const i=t.nodeName||"";if(i.toLowerCase()==="img")return console.log(...wi(t,e,r)),xt;if(i.toLowerCase()==="canvas"){const s=new Image;return s.onload=()=>console.log(...wi(s,e,r)),s.src=t.toDataURL(),xt}return xt}function Mg(n){for(const t in n)for(const e in n[t])return e||"untitled";return"empty"}const H=new ks({id:"deck"});let es={};function Lg(n){es=n}function at(n,t,e,r){H.level>0&&es[n]&&es[n].call(null,t,e,r)}function Rg(n){const t=n[0],e=n[n.length-1];return t==="{"&&e==="}"||t==="["&&e==="]"}const Ig={id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:Rg,parseTextSync:JSON.parse},Tn="8.8.16",pr=globalThis.deck&&globalThis.deck.VERSION;if(pr&&pr!==Tn)throw new Error("deck.gl - multiple versions detected: ".concat(pr," vs ").concat(Tn));pr||(H.log(1,"deck.gl ".concat(Tn))(),globalThis.deck={...globalThis.deck,VERSION:Tn,version:Tn,log:H,_registerLoggers:Lg},fd([Ig,[_g,{imagebitmap:{premultiplyAlpha:"none"}}]]));const Cg=globalThis.deck,O=new ks({id:"luma.gl"});function ht(n,t){if(!n)throw new Error(t||"luma.gl: assertion failed.")}const Og="Invalid WebGLRenderingContext",kg="Requires WebGL2";function Xr(n){return typeof WebGLRenderingContext<"u"&&n instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&Number.isFinite(n._version))}function j(n){return typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&n._version===2)}function Ng(n){return j(n)?n:null}function Yr(n){return ht(Xr(n),Og),n}function ft(n){return ht(j(n),kg),n}const bn={};function Dg(n){globalThis.console&&globalThis.console.error&&globalThis.console.error(n)}function Fg(n){globalThis.console&&globalThis.console.log&&globalThis.console.log(n)}function Bg(n,t){bn[n]=!0,t!==void 0&&Dg(t)}function Ug(n){const t=n.getError;n.getError=function(){let r;do r=t.apply(n),r!==0&&(bn[r]=!0);while(r!==0);for(r in bn)if(bn[r])return delete bn[r],parseInt(r,10);return 0}}const Nn=function n(t){const e=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(let r=0;r<this.attribs.length;r++){const i=new n.VertexAttrib(e);this.attribs[r]=i}this.maxAttrib=0};Nn.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};Nn.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};const Se=function(t){const e=this;this.gl=t,Ug(t);const r=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(s){return s===e.VERTEX_ARRAY_BINDING_OES?e.currentVertexArrayObject===e.defaultVertexArrayObject?null:e.currentVertexArrayObject:r.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(s){const o=e.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,s);const a=o.attribs[s];return a.enabled=!0,r.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(s){const o=e.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,s);const a=o.attribs[s];return a.enabled=!1,r.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(s,o){switch(s){case 34962:e.currentArrayBuffer=o;break;case 34963:e.currentVertexArrayObject.elementArrayBuffer=o;break}return r.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(s,o){const c=e.currentVertexArrayObject.attribs[s];switch(o){case 34975:return c.buffer;case 34338:return c.enabled;case 34339:return c.size;case 34340:return c.stride;case 34341:return c.type;case 34922:return c.normalized;default:return r.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(s,o,a,c,l,u){const h=e.currentVertexArrayObject;h.maxAttrib=Math.max(h.maxAttrib,s);const g=h.attribs[s];return g.buffer=e.currentArrayBuffer,g.size=o,g.type=a,g.normalized=c,g.stride=l,g.offset=u,g.recache(),r.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas&&t.canvas.addEventListener("webglcontextrestored",()=>{Fg("OESVertexArrayObject emulation library context restored"),e.reset_()},!0),this.reset_()};Se.prototype.VERTEX_ARRAY_BINDING_OES=34229;Se.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let r=0;r<this.vertexArrayObjects.length;++r)this.vertexArrayObjects.isAlive=!1;const e=this.gl;this.maxVertexAttribs=e.getParameter(34921),this.defaultVertexArrayObject=new Nn(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};Se.prototype.createVertexArrayOES=function(){const t=new Nn(this);return this.vertexArrayObjects.push(t),t};Se.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject===t&&this.bindVertexArrayOES(null)};Se.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof Nn&&t.hasBeenBound&&t.ext===this)};Se.prototype.bindVertexArrayOES=function(t){const e=this.gl;if(t&&!t.isAlive){Bg(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}const r=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;const s=this.currentVertexArrayObject;if(i===s)return;(!i||s.elementArrayBuffer!==i.elementArrayBuffer)&&r.bindBuffer.call(e,34963,s.elementArrayBuffer);let o=this.currentArrayBuffer;const a=Math.max(i?i.maxAttrib:0,s.maxAttrib);for(let c=0;c<=a;c++){const l=s.attribs[c],u=i?i.attribs[c]:null;if((!i||l.enabled!==u.enabled)&&(l.enabled?r.enableVertexAttribArray.call(e,c):r.disableVertexAttribArray.call(e,c)),l.enabled){let h=!1;(!i||l.buffer!==u.buffer)&&(o!==l.buffer&&(r.bindBuffer.call(e,34962,l.buffer),o=l.buffer),h=!0),(h||l.cached!==u.cached)&&r.vertexAttribPointer.call(e,c,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!==o&&r.bindBuffer.call(e,34962,this.currentArrayBuffer)};function Vg(n){if(typeof n.createVertexArray=="function")return;const t=n.getSupportedExtensions;n.getSupportedExtensions=function(){const i=t.call(this)||[];return i.indexOf("OES_vertex_array_object")<0&&i.push("OES_vertex_array_object"),i};const e=n.getExtension;n.getExtension=function(i){const s=e.call(this,i);return s||(i!=="OES_vertex_array_object"?null:(n.__OESVertexArrayObject||(this.__OESVertexArrayObject=new Se(this)),this.__OESVertexArrayObject))}}const ta="OES_element_index",ea="WEBGL_draw_buffers",jg="EXT_disjoint_timer_query",zg="EXT_disjoint_timer_query_webgl2",Gg="EXT_texture_filter_anisotropic",na="WEBGL_debug_renderer_info",Hg=35723,Wg=4352,Xg=36795,Yg=34047,qg=37445,$g=37446,X=n=>j(n)?void 0:0,Zg={[3074]:n=>j(n)?void 0:36064,[Hg]:n=>j(n)?void 0:Wg,[35977]:X,[32937]:X,[Xg]:(n,t)=>{const e=j(n)?n.getExtension(zg):n.getExtension(jg);return e&&e.GPU_DISJOINT_EXT?t(e.GPU_DISJOINT_EXT):0},[qg]:(n,t)=>{const e=n.getExtension(na);return t(e&&e.UNMASKED_VENDOR_WEBGL||7936)},[$g]:(n,t)=>{const e=n.getExtension(na);return t(e&&e.UNMASKED_RENDERER_WEBGL||7937)},[Yg]:(n,t)=>{const e=n.luma.extensions[Gg];return e?t(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:X,[35071]:X,[37447]:X,[36063]:(n,t)=>{if(!j(n)){const e=n.getExtension(ea);return e?t(e.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:X,[35374]:X,[35377]:X,[34852]:n=>{if(!j(n)){const t=n.getExtension(ea);return t?t.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:n=>n.getExtension(ta)?2147483647:65535,[33001]:n=>n.getExtension(ta)?16777216:65535,[33e3]:n=>16777216,[37157]:X,[35373]:X,[35657]:X,[36183]:X,[37137]:X,[34045]:X,[35978]:X,[35979]:X,[35968]:X,[35376]:X,[35375]:X,[35659]:X,[37154]:X,[35371]:X,[35658]:X,[35076]:X,[35077]:X,[35380]:X};function Kg(n,t,e){const r=Zg[e],i=typeof r=="function"?r(n,t,e):r;return i!==void 0?i:t(e)}const Qg="OES_vertex_array_object",gl="ANGLE_instanced_arrays",Jg="WEBGL_draw_buffers",tp="EXT_disjoint_timer_query",ep="EXT_texture_filter_anisotropic",np="VertexArray requires WebGL2 or OES_vertex_array_object extension";function rp(n,t){return{webgl2:j(n),ext:n.getExtension(t)}}const pl={[Qg]:{meta:{suffix:"OES"},createVertexArray:()=>{ht(!1,np)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[gl]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(n,t){ht(t===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[Jg]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{ht(!1)}},[tp]:{meta:{suffix:"EXT"},createQuery:()=>{ht(!1)},deleteQuery:()=>{ht(!1)},beginQuery:()=>{ht(!1)},endQuery:()=>{},getQuery(n,t){return this.getQueryObject(n,t)},getQueryParameter(n,t){return this.getQueryObject(n,t)},getQueryObject:()=>{}}},Ai={readBuffer:(n,t,e)=>{j(n)&&t(e)},getVertexAttrib:(n,t,e,r)=>{const{webgl2:i,ext:s}=rp(n,gl);let o;switch(r){case 35069:o=i?void 0:!1;break;case 35070:o=!i&&!s?0:void 0;break}return o!==void 0?o:t(e,r)},getProgramParameter:(n,t,e,r)=>{if(!j(n))switch(r){case 35967:return 35981;case 35971:return 0;case 35382:return 0}return t(e,r)},getInternalformatParameter:(n,t,e,r,i)=>{if(!j(n))switch(i){case 32937:return new Int32Array([0])}return n.getInternalformatParameter(e,r,i)},getTexParameter(n,t,e,r){switch(r){case 34046:const{extensions:i}=n.luma,s=i[ep];r=s&&s.TEXTURE_MAX_ANISOTROPY_EXT||34046;break}return t(e,r)},getParameter:Kg,hint(n,t,e,r){return t(e,r)}};function ip(n){n.luma=n.luma||{};const{luma:t}=n;return t.polyfilled||(Vg(n),sp(n),ap(n,pl),op(n,{target:t,target2:n}),t.polyfilled=!0),n}globalThis.polyfillContext=ip;function sp(n){n.luma.extensions={};const t=n.getSupportedExtensions()||[];for(const e of t)n.luma[e]=n.getExtension(e)}function op(n,t){let{target:e,target2:r}=t;Object.keys(Ai).forEach(i=>{if(typeof Ai[i]=="function"){const s=n[i]?n[i].bind(n):()=>{},o=Ai[i].bind(null,n,s);e[i]=o,r[i]=o}})}function ap(n,t){for(const e of Object.getOwnPropertyNames(t))e!=="overrides"&&cp(n,{extension:e,target:n.luma,target2:n})}function cp(n,t){let{extension:e,target:r,target2:i}=t;const s=pl[e];ht(s);const{meta:o={}}=s,{suffix:a=""}=o,c=n.getExtension(e);for(const l of Object.keys(s)){const u="".concat(l).concat(a);let h=null;l==="meta"||typeof n[l]=="function"||(c&&typeof c[u]=="function"?h=function(){return c[u](...arguments)}:typeof s[l]=="function"&&(h=s[l].bind(r))),h&&(r[l]=h,i[l]=h)}}const Ns={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},re=(n,t,e)=>t?n.enable(e):n.disable(e),ra=(n,t,e)=>n.hint(e,t),mt=(n,t,e)=>n.pixelStorei(e,t),lp=(n,t)=>{const e=j(n)?36009:36160;return n.bindFramebuffer(e,t)},up=(n,t)=>n.bindFramebuffer(36008,t);function fn(n){return Array.isArray(n)||ArrayBuffer.isView(n)}const hp={[3042]:re,[32773]:(n,t)=>n.blendColor(...t),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(n,t)=>n.clearColor(...t),[3107]:(n,t)=>n.colorMask(...t),[2884]:re,[2885]:(n,t)=>n.cullFace(t),[2929]:re,[2931]:(n,t)=>n.clearDepth(t),[2932]:(n,t)=>n.depthFunc(t),[2928]:(n,t)=>n.depthRange(...t),[2930]:(n,t)=>n.depthMask(t),[3024]:re,[35723]:ra,[36006]:lp,[2886]:(n,t)=>n.frontFace(t),[33170]:ra,[2849]:(n,t)=>n.lineWidth(t),[32823]:re,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:re,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:re,[3088]:(n,t)=>n.scissor(...t),[2960]:re,[2961]:(n,t)=>n.clearStencil(t),[2968]:(n,t)=>n.stencilMaskSeparate(1028,t),[36005]:(n,t)=>n.stencilMaskSeparate(1029,t),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(n,t)=>n.viewport(...t),[3333]:mt,[3317]:mt,[37440]:mt,[37441]:mt,[37443]:mt,[3330]:mt,[3332]:mt,[3331]:mt,[36010]:up,[3314]:mt,[32878]:mt,[3316]:mt,[3315]:mt,[32877]:mt,framebuffer:(n,t)=>{const e=t&&"handle"in t?t.handle:t;return n.bindFramebuffer(36160,e)},blend:(n,t)=>t?n.enable(3042):n.disable(3042),blendColor:(n,t)=>n.blendColor(...t),blendEquation:(n,t)=>{t=fn(t)?t:[t,t],n.blendEquationSeparate(...t)},blendFunc:(n,t)=>{t=fn(t)&&t.length===2?[...t,...t]:t,n.blendFuncSeparate(...t)},clearColor:(n,t)=>n.clearColor(...t),clearDepth:(n,t)=>n.clearDepth(t),clearStencil:(n,t)=>n.clearStencil(t),colorMask:(n,t)=>n.colorMask(...t),cull:(n,t)=>t?n.enable(2884):n.disable(2884),cullFace:(n,t)=>n.cullFace(t),depthTest:(n,t)=>t?n.enable(2929):n.disable(2929),depthFunc:(n,t)=>n.depthFunc(t),depthMask:(n,t)=>n.depthMask(t),depthRange:(n,t)=>n.depthRange(...t),dither:(n,t)=>t?n.enable(3024):n.disable(3024),derivativeHint:(n,t)=>{n.hint(35723,t)},frontFace:(n,t)=>n.frontFace(t),mipmapHint:(n,t)=>n.hint(33170,t),lineWidth:(n,t)=>n.lineWidth(t),polygonOffsetFill:(n,t)=>t?n.enable(32823):n.disable(32823),polygonOffset:(n,t)=>n.polygonOffset(...t),sampleCoverage:(n,t)=>n.sampleCoverage(...t),scissorTest:(n,t)=>t?n.enable(3089):n.disable(3089),scissor:(n,t)=>n.scissor(...t),stencilTest:(n,t)=>t?n.enable(2960):n.disable(2960),stencilMask:(n,t)=>{t=fn(t)?t:[t,t];const[e,r]=t;n.stencilMaskSeparate(1028,e),n.stencilMaskSeparate(1029,r)},stencilFunc:(n,t)=>{t=fn(t)&&t.length===3?[...t,...t]:t;const[e,r,i,s,o,a]=t;n.stencilFuncSeparate(1028,e,r,i),n.stencilFuncSeparate(1029,s,o,a)},stencilOp:(n,t)=>{t=fn(t)&&t.length===3?[...t,...t]:t;const[e,r,i,s,o,a]=t;n.stencilOpSeparate(1028,e,r,i),n.stencilOpSeparate(1029,s,o,a)},viewport:(n,t)=>n.viewport(...t)};function $(n,t,e){return t[n]!==void 0?t[n]:e[n]}const fp={blendEquation:(n,t,e)=>n.blendEquationSeparate($(32777,t,e),$(34877,t,e)),blendFunc:(n,t,e)=>n.blendFuncSeparate($(32969,t,e),$(32968,t,e),$(32971,t,e),$(32970,t,e)),polygonOffset:(n,t,e)=>n.polygonOffset($(32824,t,e),$(10752,t,e)),sampleCoverage:(n,t,e)=>n.sampleCoverage($(32938,t,e),$(32939,t,e)),stencilFuncFront:(n,t,e)=>n.stencilFuncSeparate(1028,$(2962,t,e),$(2967,t,e),$(2963,t,e)),stencilFuncBack:(n,t,e)=>n.stencilFuncSeparate(1029,$(34816,t,e),$(36003,t,e),$(36004,t,e)),stencilOpFront:(n,t,e)=>n.stencilOpSeparate(1028,$(2964,t,e),$(2965,t,e),$(2966,t,e)),stencilOpBack:(n,t,e)=>n.stencilOpSeparate(1029,$(34817,t,e),$(34818,t,e),$(34819,t,e))},ia={enable:(n,t)=>n({[t]:!0}),disable:(n,t)=>n({[t]:!1}),pixelStorei:(n,t,e)=>n({[t]:e}),hint:(n,t,e)=>n({[t]:e}),bindFramebuffer:(n,t,e)=>{switch(t){case 36160:return n({[36006]:e,[36010]:e});case 36009:return n({[36006]:e});case 36008:return n({[36010]:e});default:return null}},blendColor:(n,t,e,r,i)=>n({[32773]:new Float32Array([t,e,r,i])}),blendEquation:(n,t)=>n({[32777]:t,[34877]:t}),blendEquationSeparate:(n,t,e)=>n({[32777]:t,[34877]:e}),blendFunc:(n,t,e)=>n({[32969]:t,[32968]:e,[32971]:t,[32970]:e}),blendFuncSeparate:(n,t,e,r,i)=>n({[32969]:t,[32968]:e,[32971]:r,[32970]:i}),clearColor:(n,t,e,r,i)=>n({[3106]:new Float32Array([t,e,r,i])}),clearDepth:(n,t)=>n({[2931]:t}),clearStencil:(n,t)=>n({[2961]:t}),colorMask:(n,t,e,r,i)=>n({[3107]:[t,e,r,i]}),cullFace:(n,t)=>n({[2885]:t}),depthFunc:(n,t)=>n({[2932]:t}),depthRange:(n,t,e)=>n({[2928]:new Float32Array([t,e])}),depthMask:(n,t)=>n({[2930]:t}),frontFace:(n,t)=>n({[2886]:t}),lineWidth:(n,t)=>n({[2849]:t}),polygonOffset:(n,t,e)=>n({[32824]:t,[10752]:e}),sampleCoverage:(n,t,e)=>n({[32938]:t,[32939]:e}),scissor:(n,t,e,r,i)=>n({[3088]:new Int32Array([t,e,r,i])}),stencilMask:(n,t)=>n({[2968]:t,[36005]:t}),stencilMaskSeparate:(n,t,e)=>n({[t===1028?2968:36005]:e}),stencilFunc:(n,t,e,r)=>n({[2962]:t,[2967]:e,[2963]:r,[34816]:t,[36003]:e,[36004]:r}),stencilFuncSeparate:(n,t,e,r,i)=>n({[t===1028?2962:34816]:e,[t===1028?2967:36003]:r,[t===1028?2963:36004]:i}),stencilOp:(n,t,e,r)=>n({[2964]:t,[2965]:e,[2966]:r,[34817]:t,[34818]:e,[34819]:r}),stencilOpSeparate:(n,t,e,r,i)=>n({[t===1028?2964:34817]:e,[t===1028?2965:34818]:r,[t===1028?2966:34819]:i}),viewport:(n,t,e,r,i)=>n({[2978]:[t,e,r,i]})},Dt=(n,t)=>n.isEnabled(t),sa={[3042]:Dt,[2884]:Dt,[2929]:Dt,[3024]:Dt,[32823]:Dt,[32926]:Dt,[32928]:Dt,[3089]:Dt,[2960]:Dt,[35977]:Dt};function ml(n){for(const t in n)return!1;return!0}function dp(n,t){if(n===t)return!0;const e=Array.isArray(n)||ArrayBuffer.isView(n),r=Array.isArray(t)||ArrayBuffer.isView(t);if(e&&r&&n.length===t.length){for(let i=0;i<n.length;++i)if(n[i]!==t[i])return!1;return!0}return!1}function oa(n,t){const e=n[t].bind(n);n[t]=function(){const i=arguments.length<=0?void 0:arguments[0];return i in n.state.cache?n.state.enable?n.state.cache[i]:e(...arguments):e(...arguments)},Object.defineProperty(n[t],"name",{value:"".concat(t,"-from-cache"),configurable:!1})}function gp(n,t,e){const r=n[t].bind(n);n[t]=function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];const{valueChanged:c,oldValue:l}=e(n.state._updateCache,...o);return c&&r(...o),l},Object.defineProperty(n[t],"name",{value:"".concat(t,"-to-cache"),configurable:!1})}function pp(n){const t=n.useProgram.bind(n);n.useProgram=function(r){n.state.program!==r&&(t(r),n.state.program=r)}}class mp{constructor(t){let{copyState:e=!1,log:r=()=>{}}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=t,this.program=null,this.stateStack=[],this.enable=!0,this.cache=e?bp(t):Object.assign({},Ns),this.log=r,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){this.stateStack.push({})}pop(){ht(this.stateStack.length>0);const t=this.stateStack[this.stateStack.length-1];$t(this.gl,t),this.stateStack.pop()}_updateCache(t){let e=!1,r;const i=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(const s in t){ht(s!==void 0);const o=t[s],a=this.cache[s];dp(o,a)||(e=!0,r=a,i&&!(s in i)&&(i[s]=a),this.cache[s]=o)}return{valueChanged:e,oldValue:r}}}function _l(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{enable:e=!0,copyState:r}=t;if(ht(r!==void 0),!n.state){const{polyfillContext:i}=globalThis;i&&i(n),n.state=new mp(n,{copyState:r}),pp(n);for(const s in ia){const o=ia[s];gp(n,s,o)}oa(n,"getParameter"),oa(n,"isEnabled")}return n.state.enable=e,n}function _p(n){n.state||_l(n,{copyState:!1}),n.state.push()}function aa(n){ht(n.state),n.state.pop()}function $t(n,t){if(ht(Xr(n),"setParameters requires a WebGL context"),ml(t))return;const e={};for(const i in t){const s=Number(i),o=hp[i];o&&(typeof o=="string"?e[o]=!0:o(n,t[i],s))}const r=n.state&&n.state.cache;if(r)for(const i in e){const s=fp[i];s(n,t,r)}}function bp(n,t){if(t=t||Ns,typeof t=="number"){const i=t,s=sa[i];return s?s(n,i):n.getParameter(i)}const e=Array.isArray(t)?t:Object.keys(t),r={};for(const i of e){const s=sa[i];r[i]=s?s(n,Number(i)):n.getParameter(Number(i))}return r}function yp(n){$t(n,Ns)}function Pt(n,t,e){if(ml(t))return e(n);const{nocatch:r=!0}=t;_p(n),$t(n,t);let i;if(r)i=e(n),aa(n);else try{i=e(n)}finally{aa(n)}return i}function We(n){const{luma:t}=n;if(n.canvas&&t){const e=t.canvasSizeInfo,r="clientWidth"in e?e.clientWidth:n.canvas.clientWidth;return r?n.drawingBufferWidth/r:1}return 1}function Si(n,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;const r=We(n),i=n.drawingBufferWidth,s=n.drawingBufferHeight;return Ep(t,r,i,s,e)}function vp(n){const t=typeof window>"u"?1:window.devicePixelRatio||1;return Number.isFinite(n)?n<=0?1:n:n?t:1}function Ep(n,t,e,r,i){const s=ca(n[0],t,e);let o=la(n[1],t,r,i),a=ca(n[0]+1,t,e);const c=a===e-1?a:a-1;a=la(n[1]+1,t,r,i);let l;return i?(a=a===0?a:a+1,l=o,o=a):l=a===r-1?a:a-1,{x:s,y:o,width:Math.max(c-s+1,1),height:Math.max(l-o+1,1)}}function ca(n,t,e){return Math.min(Math.round(n*t),e-1)}function la(n,t,e,r){return r?Math.max(0,e-1-Math.round(n*t)):Math.min(Math.round(n*t),e-1)}const Ds=te(),Tp=Ds&&typeof document<"u",bl={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function yl(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};ht(Ds,`createGLContext only available in the browser.
Create your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils`),n=Object.assign({},bl,n);const{width:t,height:e}=n;function r(a){if(n.throwOnError)throw new Error(a);return console.error(a),null}n.onError=r;let i;const{canvas:s}=n,o=xp({canvas:s,width:t,height:e,onError:r});return i=Sp(o,n),i?(i=Fs(i,n),Pp(i),i):null}function Fs(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!n||n._instrumented)return n;n._version=n._version||Mp(n),n.luma=n.luma||{},n.luma.canvasSizeInfo=n.luma.canvasSizeInfo||{},t=Object.assign({},bl,t);const{manageState:e,debug:r}=t;return e&&_l(n,{copyState:!1,log:function(){for(var i=arguments.length,s=new Array(i),o=0;o<i;o++)s[o]=arguments[o];return O.log(1,...s)()}}),Ds&&r&&(globalThis.makeDebugContext?(n=globalThis.makeDebugContext(n,t),O.level=Math.max(O.level,1)):O.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),n._instrumented=!0,n}function wp(n){const t=n.getParameter(7936),e=n.getParameter(7937),r=n.getExtension("WEBGL_debug_renderer_info"),i=r&&n.getParameter(r.UNMASKED_VENDOR_WEBGL||7936),s=r&&n.getParameter(r.UNMASKED_RENDERER_WEBGL||7937);return{vendor:i||t,renderer:s||e,vendorMasked:t,rendererMasked:e,version:n.getParameter(7938),shadingLanguageVersion:n.getParameter(35724)}}function Ap(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(n.canvas){const r=vp(t.useDevicePixels);Lp(n,r,t);return}const e=n.getExtension("STACKGL_resize_drawingbuffer");e&&"width"in t&&"height"in t&&e.resize(t.width,t.height)}function Sp(n,t){const{onError:e}=t;let r=null;const i=c=>r=c.statusMessage||r;n.addEventListener("webglcontextcreationerror",i,!1);const{webgl1:s=!0,webgl2:o=!0}=t;let a=null;return o&&(a=a||n.getContext("webgl2",t),a=a||n.getContext("experimental-webgl2",t)),s&&(a=a||n.getContext("webgl",t),a=a||n.getContext("experimental-webgl",t)),n.removeEventListener("webglcontextcreationerror",i,!1),a?(t.onContextLost&&n.addEventListener("webglcontextlost",t.onContextLost,!1),t.onContextRestored&&n.addEventListener("webglcontextrestored",t.onContextRestored,!1),a):e("Failed to create ".concat(o&&!s?"WebGL2":"WebGL"," context: ").concat(r||"Unknown error"))}function xp(n){let{canvas:t,width:e=800,height:r=600,onError:i}=n,s;return typeof t=="string"?(Tp&&document.readyState==="complete"||i("createGLContext called on canvas '".concat(t,"' before page was loaded")),s=document.getElementById(t)):t?s=t:(s=document.createElement("canvas"),s.id="lumagl-canvas",s.style.width=Number.isFinite(e)?"".concat(e,"px"):"100%",s.style.height=Number.isFinite(r)?"".concat(r,"px"):"100%",document.body.insertBefore(s,document.body.firstChild)),s}function Pp(n){const t=j(n)?"WebGL2":"WebGL1",e=wp(n),r=e?"(".concat(e.vendor,",").concat(e.renderer,")"):"",i=n.debug?" debug":"";O.info(1,"".concat(t).concat(i," context ").concat(r))()}function Mp(n){return typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?2:1}function Lp(n,t,e){let r="width"in e?e.width:n.canvas.clientWidth,i="height"in e?e.height:n.canvas.clientHeight;(!r||!i)&&(O.log(1,"Canvas clientWidth/clientHeight is 0")(),t=1,r=n.canvas.width||1,i=n.canvas.height||1),n.luma=n.luma||{},n.luma.canvasSizeInfo=n.luma.canvasSizeInfo||{};const s=n.luma.canvasSizeInfo;if(s.clientWidth!==r||s.clientHeight!==i||s.devicePixelRatio!==t){let o=t;const a=Math.floor(r*o),c=Math.floor(i*o);n.canvas.width=a,n.canvas.height=c,(n.drawingBufferWidth!==a||n.drawingBufferHeight!==c)&&(O.warn("Device pixel ratio clamped")(),o=Math.min(n.drawingBufferWidth/r,n.drawingBufferHeight/i),n.canvas.width=Math.floor(r*o),n.canvas.height=Math.floor(i*o)),Object.assign(n.luma.canvasSizeInfo,{clientWidth:r,clientHeight:i,devicePixelRatio:t})}}function ua(){let n;if(typeof window<"u"&&window.performance)n=window.performance.now();else if(typeof process<"u"&&process.hrtime){const t=process.hrtime();n=t[0]*1e3+t[1]/1e6}else n=Date.now();return n}class ha{constructor(t,e){f(this,"name",void 0),f(this,"type",void 0),f(this,"sampleSize",1),f(this,"time",void 0),f(this,"count",void 0),f(this,"samples",void 0),f(this,"lastTiming",void 0),f(this,"lastSampleTime",void 0),f(this,"lastSampleCount",void 0),f(this,"_count",0),f(this,"_time",0),f(this,"_samples",0),f(this,"_startTime",0),f(this,"_timerPending",!1),this.name=t,this.type=e,this.reset()}setSampleSize(t){return this.sampleSize=t,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(t){return this._count+=t,this._samples++,this._checkSampling(),this}subtractCount(t){return this._count-=t,this._samples++,this._checkSampling(),this}addTime(t){return this._time+=t,this.lastTiming=t,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=ua(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(ua()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class Bs{constructor(t){f(this,"id",void 0),f(this,"stats",{}),this.id=t.id,this.stats={},this._initializeStats(t.stats),Object.seal(this)}get(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:t,type:e})}get size(){return Object.keys(this.stats).length}reset(){for(const t in this.stats)this.stats[t].reset();return this}forEach(t){for(const e in this.stats)t(this.stats[e])}getTable(){const t={};return this.forEach(e=>{t[e.name]={time:e.time||0,count:e.count||0,average:e.getAverageTime()||0,hz:e.getHz()||0}}),t}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(e=>this._getOrCreate(e))}_getOrCreate(t){if(!t||!t.name)return null;const{name:e,type:r}=t;return this.stats[e]||(t instanceof ha?this.stats[e]=t:this.stats[e]=new ha(e,r)),this.stats[e]}}const wn="8.5.21",Rp="set luma.log.level=1 (or higher) to trace rendering";class Ip{constructor(){this.stats=new Map}get(t){return this.stats.has(t)||this.stats.set(t,new Bs({id:t})),this.stats.get(t)}}const ye=new Ip;if(globalThis.luma&&globalThis.luma.VERSION!==wn)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(wn));globalThis.luma||(te()&&O.log(1,"luma.gl ".concat(wn," - ").concat(Rp))(),globalThis.luma=globalThis.luma||{VERSION:wn,version:wn,log:O,stats:ye,globals:{modules:{},nodeIO:{}}});function Cp(n){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(n):setTimeout(n,1e3/60)}function Op(n){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(n):clearTimeout(n)}function C(n,t){if(!n)throw new Error(t||"luma.gl: assertion failed.")}function xi(n,t){if(typeof t!="string")return t;const e=Number(t);if(!isNaN(e))return e;t=t.replace(/^.*\./,"");const r=n[t];return C(r!==void 0,"Accessing undefined constant GL.".concat(t)),r}function le(n,t){t=Number(t);for(const e in n)if(n[e]===t)return"GL.".concat(e);return String(t)}const Pi={};function Ee(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"id";Pi[n]=Pi[n]||1;const t=Pi[n]++;return"".concat(n,"-").concat(t)}function fa(n){return C(typeof n=="number","Input must be a number"),n&&(n&n-1)===0}function Xe(n){let t=!0;for(const e in n){t=!1;break}return t}function vl(n,t,e,r){const i="See luma.gl ".concat(e," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),s=Object.getPrototypeOf(n);r.forEach(o=>{s.methodName||(s[o]=()=>{throw O.removed("Calling removed method ".concat(t,".").concat(o,": "),i)(),new Error(o)})})}const Ce="Resource subclass must define virtual methods";class ee{get[Symbol.toStringTag](){return"Resource"}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Yr(t);const{id:r,userData:i={}}=e;this.gl=t,this.gl2=t,this.id=r||Ee(this[Symbol.toStringTag]),this.userData=i,this._bound=!1,this._handle=e.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:t=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,e&&t&&e.filter(Boolean).forEach(r=>r.delete()),this}bind(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.handle;if(typeof t!="function")return this._bindHandle(t),this;let e;return this._bound?e=t():(this._bindHandle(this.handle),this._bound=!0,e=t(),this._bound=!1,this._bindHandle(null)),e}unbind(){this.bind(null)}getParameter(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};t=xi(this.gl,t),C(t);const i=(this.constructor.PARAMETERS||{})[t];if(i){const s=j(this.gl);if(!((!("webgl2"in i)||s)&&(!("extension"in i)||this.gl.getExtension(i.extension)))){const a=i.webgl1,c="webgl2"in i?i.webgl2:i.webgl1;return s?c:a}}return this._getParameter(t,e)}getParameters(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{parameters:e,keys:r}=t,i=this.constructor.PARAMETERS||{},s=j(this.gl),o={},a=e||Object.keys(i);for(const c of a){const l=i[c];if(l&&(!("webgl2"in l)||s)&&(!("extension"in l)||this.gl.getExtension(l.extension))){const h=r?le(this.gl,c):c;o[h]=this.getParameter(c,t),r&&l.type==="GLenum"&&(o[h]=le(this.gl,o[h]))}}return o}setParameter(t,e){t=xi(this.gl,t),C(t);const i=(this.constructor.PARAMETERS||{})[t];if(i){const s=j(this.gl);if(!((!("webgl2"in i)||s)&&(!("extension"in i)||this.gl.getExtension(i.extension))))throw new Error("Parameter not available on this platform");i.type==="GLenum"&&(e=xi(e))}return this._setParameter(t,e),this}setParameters(t){for(const e in t)this.setParameter(e,t[e]);return this}stubRemovedMethods(t,e,r){return vl(this,t,e,r)}initialize(t){}_createHandle(){throw new Error(Ce)}_deleteHandle(){throw new Error(Ce)}_bindHandle(t){throw new Error(Ce)}_getOptsFromHandle(){throw new Error(Ce)}_getParameter(t,e){throw new Error(Ce)}_setParameter(t,e){throw new Error(Ce)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){const t=this[Symbol.toStringTag],e=ye.get("Resource Counts");e.get("Resources Created").incrementCount(),e.get("".concat(t,"s Created")).incrementCount(),e.get("".concat(t,"s Active")).incrementCount()}_removeStats(){const t=this[Symbol.toStringTag];ye.get("Resource Counts").get("".concat(t,"s Active")).decrementCount()}_trackAllocatedMemory(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag];this._trackAllocatedMemoryForContext(t,e),this._trackAllocatedMemoryForContext(t,e,this.gl.canvas&&this.gl.canvas.id),this.byteLength=t}_trackAllocatedMemoryForContext(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag],r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"";const i=ye.get("Memory Usage".concat(r));i.get("GPU Memory").addCount(t),i.get("".concat(e," Memory")).addCount(t)}_trackDeallocatedMemory(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag];this._trackDeallocatedMemoryForContext(t),this._trackDeallocatedMemoryForContext(t,this.gl.canvas&&this.gl.canvas.id),this.byteLength=0}_trackDeallocatedMemoryForContext(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";const r=ye.get("Memory Usage".concat(e));r.get("GPU Memory").subtractCount(this.byteLength),r.get("".concat(t," Memory")).subtractCount(this.byteLength)}}const kp="Failed to deduce GL constant from typed array";function ns(n){switch(ArrayBuffer.isView(n)?n.constructor:n){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(kp)}}function Sn(n){let{clamped:t=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};switch(n){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function Np(n){let{data:t,width:e,height:r,bytesPerPixel:i=4,temp:s}=n;const o=e*i;s=s||new Uint8Array(o);for(let a=0;a<r/2;++a){const c=a*o,l=(r-a-1)*o;s.set(t.subarray(c,c+o)),t.copyWithin(c,l,l+o),t.set(s,l)}}function Dp(n){let{data:t,width:e,height:r}=n;const i=Math.round(e/2),s=Math.round(r/2),o=new Uint8Array(i*s*4);for(let a=0;a<s;a++)for(let c=0;c<i;c++)for(let l=0;l<4;l++)o[(a*i+c)*4+l]=t[(a*2*e+c*2)*4+l];return{data:o,width:i,height:s}}function rs(n,t,e){const{removedProps:r={},deprecatedProps:i={},replacedProps:s={}}=e;for(const a in r)if(a in t){const l=r[a]?"".concat(n,".").concat(r[a]):"N/A";O.removed("".concat(n,".").concat(a),l)()}for(const a in i)if(a in t){const c=i[a];O.deprecated("".concat(n,".").concat(a),"".concat(n,".").concat(c))()}let o=null;for(const a in s)if(a in t){const c=s[a];O.deprecated("".concat(n,".").concat(a),"".concat(n,".").concat(c))(),o=o||Object.assign({},t),o[c]=t[a],delete o[a]}return o||t}const Fp={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},Bp={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class vt{static getBytesPerElement(t){return Sn(t.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(t){return C(t.size),Sn(t.type||5126).BYTES_PER_ELEMENT*t.size}static resolve(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return new vt(Fp,...e)}constructor(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];e.forEach(i=>this._assign(i)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return vt.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return vt.getBytesPerVertex(this)}_assign(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return t=rs("Accessor",t,Bp),t.type!==void 0&&(this.type=t.type,(t.type===5124||t.type===5125)&&(this.integer=!0)),t.size!==void 0&&(this.size=t.size),t.offset!==void 0&&(this.offset=t.offset),t.stride!==void 0&&(this.stride=t.stride),t.normalized!==void 0&&(this.normalized=t.normalized),t.integer!==void 0&&(this.integer=t.integer),t.divisor!==void 0&&(this.divisor=t.divisor),t.buffer!==void 0&&(this.buffer=t.buffer),t.index!==void 0&&(typeof t.index=="boolean"?this.index=t.index?1:0:this.index=t.index),t.instanced!==void 0&&(this.divisor=t.instanced?1:0),t.isInstanced!==void 0&&(this.divisor=t.isInstanced?1:0),this}}const da=10,El={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},Up={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:El},Vp={removedProps:El};class W extends ee{get[Symbol.toStringTag](){return"Buffer"}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(t,e),this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=e.target||(this.gl.webgl2?36662:34962),this.initialize(e),Object.seal(this)}getElementCount(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/vt.getBytesPerElement(t))}getVertexCount(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/vt.getBytesPerVertex(t))}initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ArrayBuffer.isView(t)&&(t={data:t}),Number.isFinite(t)&&(t={byteLength:t}),t=rs("Buffer",t,Up),this.usage=t.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},t,t.accessor)),t.data?this._setData(t.data,t.offset,t.byteLength):this._setByteLength(t.byteLength||0),this}setProps(t){return t=rs("Buffer",t,Vp),"accessor"in t&&this.setAccessor(t.accessor),this}setAccessor(t){return t=Object.assign({},t),delete t.buffer,this.accessor=new vt(t),this}reallocate(t){return t>this.byteLength?(this._setByteLength(t),!0):(this.bytesUsed=t,!1)}setData(t){return this.initialize(t)}subData(t){ArrayBuffer.isView(t)&&(t={data:t});const{data:e,offset:r=0,srcOffset:i=0}=t,s=t.byteLength||t.length;C(e);const o=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(o,this.handle),i!==0||s!==void 0?(ft(this.gl),this.gl.bufferSubData(this.target,r,e,i,s)):this.gl.bufferSubData(o,r,e),this.gl.bindBuffer(o,null),this.debugData=null,this._inferType(e),this}copyData(t){let{sourceBuffer:e,readOffset:r=0,writeOffset:i=0,size:s}=t;const{gl:o}=this;return ft(o),o.bindBuffer(36662,e.handle),o.bindBuffer(36663,this.handle),o.copyBufferSubData(36662,36663,r,i,s),o.bindBuffer(36662,null),o.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:t=null,srcByteOffset:e=0,dstOffset:r=0,length:i=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};ft(this.gl);const s=Sn(this.accessor.type||5126,{clamped:!1}),o=this._getAvailableElementCount(e),a=r;let c,l;t?(l=t.length,c=l-a):(c=Math.min(o,i||o),l=a+c);const u=Math.min(o,c);return i=i||u,C(i<=u),t=t||new s(l),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,t,r,i),this.gl.bindBuffer(36662,null),t}bind(){let{target:t=this.target,index:e=this.accessor&&this.accessor.index,offset:r=0,size:i}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return t===35345||t===35982?i!==void 0?this.gl.bindBufferRange(t,e,this.handle,r,i):(C(r===0),this.gl.bindBufferBase(t,e,this.handle)):this.gl.bindBuffer(t,this.handle),this}unbind(){let{target:t=this.target,index:e=this.accessor&&this.accessor.index}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return t===35345||t===35982?this.gl.bindBufferBase(t,e,null):this.gl.bindBuffer(t,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(da,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:t.byteLength+e;C(ArrayBuffer.isView(t)),this._trackDeallocatedMemory();const i=this._getTarget();this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,r,this.usage),this.gl.bufferSubData(i,e,t),this.gl.bindBuffer(i,null),this.debugData=t.slice(0,da),this.bytesUsed=r,this._trackAllocatedMemory(r);const s=ns(t);return C(s),this.setAccessor(new vt(this.accessor,{type:s})),this}_setByteLength(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.usage;C(t>=0),this._trackDeallocatedMemory();let r=t;t===0&&(r=new Float32Array(0));const i=this._getTarget();return this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,r,e),this.gl.bindBuffer(i,null),this.usage=e,this.debugData=null,this.bytesUsed=t,this._trackAllocatedMemory(t),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(t){const e=Sn(this.accessor.type||5126,{clamped:!1}),r=t/e.BYTES_PER_ELEMENT;return this.getElementCount()-r}_inferType(t){this.accessor.type||this.setAccessor(new vt(this.accessor,{type:ns(t)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(t){this.gl.bindBuffer(this.target,this.handle);const e=this.gl.getBufferParameter(this.target,t);return this.gl.bindBuffer(this.target,null),e}get type(){return O.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return O.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(t){return O.deprecated("setByteLength","reallocate")(),this.reallocate(t)}updateAccessor(t){return O.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new vt(this.accessor,t),this}}const Us={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},Tl={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},wl={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function jp(n,t){const e=Us[t];if(!e)return!1;if(e.gl1===void 0&&e.gl2===void 0)return!0;const r=j(n)&&e.gl2||e.gl1;return typeof r=="string"?n.getExtension(r):r}function zp(n,t){const e=Us[t];switch(e&&e.types[0]){case 5126:return n.getExtension("OES_texture_float_linear");case 5131:return n.getExtension("OES_texture_half_float_linear");default:return!0}}const Gp=[9729,9728],ga=globalThis.WebGLBuffer||function(){};class Ye extends ee{get[Symbol.toStringTag](){return"Texture"}static isSupported(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{format:r,linearFiltering:i}=e;let s=!0;return r&&(s=s&&jp(t,r),s=s&&(!i||zp(t,r))),s}constructor(t,e){const{id:r=Ee("texture"),handle:i,target:s}=e;super(t,{id:r,handle:i}),this.target=s,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=t.data;if(e instanceof Promise)return e.then(A=>this.initialize(Object.assign({},t,{pixels:A,data:A}))),this;const r=typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement;if(r&&e.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,e.addEventListener("loadeddata",()=>this.initialize(t)),this;const{pixels:i=null,format:s=6408,border:o=0,recreate:a=!1,parameters:c={},pixelStore:l={},textureUnit:u=void 0}=t;e||(e=i);let{width:h,height:g,dataFormat:m,type:b,compressed:y=!1,mipmaps:v=!0}=t;const{depth:T=0}=t;return{width:h,height:g,compressed:y,dataFormat:m,type:b}=this._deduceParameters({format:s,type:b,dataFormat:m,compressed:y,data:e,width:h,height:g}),this.width=h,this.height=g,this.depth=T,this.format=s,this.type=b,this.dataFormat=m,this.border=o,this.textureUnit=u,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),v&&this._isNPOT()&&(O.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),v=!1,this._updateForNPOT(c)),this.mipmaps=v,this.setImageData({data:e,width:h,height:g,depth:T,format:s,type:b,dataFormat:m,border:o,mipmaps:v,parameters:l,compressed:y}),v&&this.generateMipmap(),this.setParameters(c),a&&(this.data=e),r&&(this._video={video:e,parameters:c,lastTime:e.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?e.currentTime:-1}),this}update(){if(this._video){const{video:t,parameters:e,lastTime:r}=this._video;if(r===t.currentTime||t.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:t,parameters:e}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=t.currentTime}}resize(t){let{height:e,width:r,mipmaps:i=!1}=t;return r!==this.width||e!==this.height?this.initialize({width:r,height:e,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:i}):this}generateMipmap(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isNPOT()?(O.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),Pt(this.gl,t,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(t){this._trackDeallocatedMemory("Texture");const{target:e=this.target,pixels:r=null,level:i=0,format:s=this.format,border:o=this.border,offset:a=0,parameters:c={}}=t;let{data:l=null,type:u=this.type,width:h=this.width,height:g=this.height,dataFormat:m=this.dataFormat,compressed:b=!1}=t;l||(l=r),{type:u,dataFormat:m,compressed:b,width:h,height:g}=this._deduceParameters({format:s,type:u,dataFormat:m,compressed:b,data:l,width:h,height:g});const{gl:y}=this;y.bindTexture(this.target,this.handle);let v=null;({data:l,dataType:v}=this._getDataType({data:l,compressed:b}));let T,A=0;if(Pt(this.gl,c,()=>{switch(v){case"null":y.texImage2D(e,i,s,h,g,o,m,u,l);break;case"typed-array":y.texImage2D(e,i,s,h,g,o,m,u,l,a);break;case"buffer":T=ft(y),T.bindBuffer(35052,l.handle||l),T.texImage2D(e,i,s,h,g,o,m,u,a),T.bindBuffer(35052,null);break;case"browser-object":j(y)?y.texImage2D(e,i,s,h,g,o,m,u,l):y.texImage2D(e,i,s,m,u,l);break;case"compressed":for(const[S,x]of l.entries())y.compressedTexImage2D(e,S,x.format,x.width,x.height,o,x.data),A+=x.levelSize;break;default:C(!1,"Unknown image data type")}}),v==="compressed")this._trackAllocatedMemory(A,"Texture");else if(l&&l.byteLength)this._trackAllocatedMemory(l.byteLength,"Texture");else{const S=Tl[this.dataFormat]||4,x=wl[this.type]||1;this._trackAllocatedMemory(this.width*this.height*S*x,"Texture")}return this.loaded=!0,this}setSubImageData(t){let{target:e=this.target,pixels:r=null,data:i=null,x:s=0,y:o=0,width:a=this.width,height:c=this.height,level:l=0,format:u=this.format,type:h=this.type,dataFormat:g=this.dataFormat,compressed:m=!1,offset:b=0,border:y=this.border,parameters:v={}}=t;if({type:h,dataFormat:g,compressed:m,width:a,height:c}=this._deduceParameters({format:u,type:h,dataFormat:g,compressed:m,data:i,width:a,height:c}),C(this.depth===0,"texSubImage not supported for 3D textures"),i||(i=r),i&&i.data){const T=i;i=T.data,a=T.shape[0],c=T.shape[1]}i instanceof W&&(i=i.handle),this.gl.bindTexture(this.target,this.handle),Pt(this.gl,v,()=>{if(m)this.gl.compressedTexSubImage2D(e,l,s,o,a,c,u,i);else if(i===null)this.gl.texSubImage2D(e,l,s,o,a,c,g,h,null);else if(ArrayBuffer.isView(i))this.gl.texSubImage2D(e,l,s,o,a,c,g,h,i,b);else if(i instanceof ga){const T=ft(this.gl);T.bindBuffer(35052,i),T.texSubImage2D(e,l,s,o,a,c,g,h,b),T.bindBuffer(35052,null)}else j(this.gl)?ft(this.gl).texSubImage2D(e,l,s,o,a,c,g,h,i):this.gl.texSubImage2D(e,l,s,o,g,h,i)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(){return O.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit;const{gl:e}=this;return t!==void 0&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.target,this.handle),t}unbind(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit;const{gl:e}=this;return t!==void 0&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.target,null),t}_getDataType(t){let{data:e,compressed:r=!1}=t;return r?{data:e,dataType:"compressed"}:e===null?{data:e,dataType:"null"}:ArrayBuffer.isView(e)?{data:e,dataType:"typed-array"}:e instanceof W?{data:e.handle,dataType:"buffer"}:e instanceof ga?{data:e,dataType:"buffer"}:{data:e,dataType:"browser-object"}}_deduceParameters(t){const{format:e,data:r}=t;let{width:i,height:s,dataFormat:o,type:a,compressed:c}=t;const l=Us[e];return o=o||l&&l.dataFormat,a=a||l&&l.types[0],c=c||l&&l.compressed,{width:i,height:s}=this._deduceImageSize(r,i,s),{dataFormat:o,type:a,compressed:c,width:i,height:s,format:e,data:r}}_deduceImageSize(t,e,r){let i;return typeof ImageData<"u"&&t instanceof ImageData?i={width:t.width,height:t.height}:typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement?i={width:t.naturalWidth,height:t.naturalHeight}:typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement?i={width:t.width,height:t.height}:typeof ImageBitmap<"u"&&t instanceof ImageBitmap?i={width:t.width,height:t.height}:typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement?i={width:t.videoWidth,height:t.videoHeight}:t?i={width:e,height:r}:i={width:e>=0?e:1,height:r>=0?r:1},C(i,"Could not deduced texture size"),C(e===void 0||i.width===e,"Deduced texture width does not match supplied width"),C(r===void 0||i.height===r,"Deduced texture height does not match supplied height"),i}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(t){switch(t){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);const e=this.gl.getTexParameter(this.target,t);return this.gl.bindTexture(this.target,null),e}}_setParameter(t,e){switch(this.gl.bindTexture(this.target,this.handle),e=this._getNPOTParam(t,e),t){case 33082:case 33083:this.gl.texParameterf(this.handle,t,e);break;case 4096:case 4097:C(!1);break;default:this.gl.texParameteri(this.target,t,e);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return j(this.gl)||!this.width||!this.height?!1:!fa(this.width)||!fa(this.height)}_updateForNPOT(t){t[this.gl.TEXTURE_MIN_FILTER]===void 0&&(t[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),t[this.gl.TEXTURE_WRAP_S]===void 0&&(t[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),t[this.gl.TEXTURE_WRAP_T]===void 0&&(t[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(t,e){if(this._isNPOT())switch(t){case 10241:Gp.indexOf(e)===-1&&(e=9729);break;case 10242:case 10243:e!==33071&&(e=33071);break}return e}}let Hp="";function Wp(n,t){return C(typeof n=="string"),n=Hp+n,new Promise((e,r)=>{try{const i=new Image;i.onload=()=>e(i),i.onerror=()=>r(new Error("Could not load image ".concat(n,"."))),i.crossOrigin=t&&t.crossOrigin||"anonymous",i.src=n}catch(i){r(i)}})}class Tt extends Ye{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(t,e){return Ye.isSupported(t,e)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Yr(t),(e instanceof Promise||typeof e=="string")&&(e={data:e}),typeof e.data=="string"&&(e=Object.assign({},e,{data:Wp(e.data)})),super(t,Object.assign({},e,{target:3553})),this.initialize(e),Object.seal(this)}}const is=[34069,34070,34071,34072,34073,34074];class Al extends Ye{get[Symbol.toStringTag](){return"TextureCube"}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Yr(t),super(t,Object.assign({},e,{target:34067})),this.initialize(e),Object.seal(this)}initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{mipmaps:e=!0,parameters:r={}}=t;return this.opts=t,this.setCubeMapImageData(t).then(()=>{this.loaded=!0,e&&this.generateMipmap(t),this.setParameters(r)}),this}subImage(t){let{face:e,data:r,x:i=0,y:s=0,mipmapLevel:o=0}=t;return this._subImage({target:e,data:r,x:i,y:s,mipmapLevel:o})}async setCubeMapImageData(t){let{width:e,height:r,pixels:i,data:s,border:o=0,format:a=6408,type:c=5121}=t;const{gl:l}=this,u=i||s,h=await Promise.all(is.map(g=>{const m=u[g];return Promise.all(Array.isArray(m)?m:[m])}));this.bind(),is.forEach((g,m)=>{h[m].length>1&&this.opts.mipmaps!==!1&&O.warn("".concat(this.id," has mipmap and multiple LODs."))(),h[m].forEach((b,y)=>{e&&r?l.texImage2D(g,y,a,e,r,o,a,c,b):l.texImage2D(g,y,a,a,c,b)})}),this.unbind()}setImageDataForFace(t){const{face:e,width:r,height:i,pixels:s,data:o,border:a=0,format:c=6408,type:l=5121}=t,{gl:u}=this,h=s||o;return this.bind(),h instanceof Promise?h.then(g=>this.setImageDataForFace(Object.assign({},t,{face:e,data:g,pixels:g}))):this.width||this.height?u.texImage2D(e,0,c,r,i,a,c,l,h):u.texImage2D(e,0,c,c,l,h),this}}Al.FACES=is;class Xp extends Ye{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(t){return j(t)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};ft(t),e=Object.assign({depth:1},e,{target:32879,unpackFlipY:!1}),super(t,e),this.initialize(e),Object.seal(this)}setImageData(t){let{level:e=0,dataFormat:r=6408,width:i,height:s,depth:o=1,border:a=0,format:c,type:l=5121,offset:u=0,data:h,parameters:g={}}=t;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),Pt(this.gl,g,()=>{ArrayBuffer.isView(h)&&this.gl.texImage3D(this.target,e,r,i,s,o,a,c,l,h),h instanceof W&&(this.gl.bindBuffer(35052,h.handle),this.gl.texImage3D(this.target,e,r,i,s,o,a,c,l,u))}),h&&h.byteLength)this._trackAllocatedMemory(h.byteLength,"Texture");else{const m=Tl[this.dataFormat]||4,b=wl[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*m*b,"Texture")}return this.loaded=!0,this}}const ge="EXT_color_buffer_float",pa={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:ge,bpp:2},[33327]:{gl2:ge,bpp:4},[34842]:{gl2:ge,bpp:8},[33326]:{gl2:ge,bpp:4},[33328]:{gl2:ge,bpp:8},[34836]:{gl2:ge,bpp:16},[35898]:{gl2:ge,bpp:4}};function Yp(n,t,e){const r=e[t];if(!r)return!1;const i=j(n)&&r.gl2||r.gl1;return typeof i=="string"?n.getExtension(i):i}class Be extends ee{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(t){let{format:e}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{format:null};return!e||Yp(t,e,pa)}static getSamplesForFormat(t,e){let{format:r}=e;return t.getInternalformatParameter(36161,r,32937)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(t,e),this.initialize(e),Object.seal(this)}initialize(t){let{format:e,width:r=1,height:i=1,samples:s=0}=t;return C(e,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),s!==0&&j(this.gl)?this.gl.renderbufferStorageMultisample(36161,s,e,r,i):this.gl.renderbufferStorage(36161,e,r,i),this.format=e,this.width=r,this.height=i,this.samples=s,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*pa[this.format].bpp),this}resize(t){let{width:e,height:r}=t;return e!==this.width||r!==this.height?this.initialize({width:e,height:r,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(t){this.gl.bindRenderbuffer(36161,t)}_syncHandle(t){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(t){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,t)}}const qp=256,$p=1024,Zp=16384,ma=6144,_a=6145,ba=6146,ya=34041,Sl="clear: bad arguments";function Vs(n){let{framebuffer:t=null,color:e=null,depth:r=null,stencil:i=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const s={};t&&(s.framebuffer=t);let o=0;e&&(o|=Zp,e!==!0&&(s.clearColor=e)),r&&(o|=qp,r!==!0&&(s.clearDepth=r)),i&&(o|=$p,r!==!0&&(s.clearStencil=r)),C(o!==0,Sl),Pt(n,s,()=>{n.clear(o)})}function Kp(n){let{framebuffer:t=null,buffer:e=ma,drawBuffer:r=0,value:i=[0,0,0,0]}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};ft(n),Pt(n,{framebuffer:t},()=>{switch(e){case ma:switch(i.constructor){case Int32Array:n.clearBufferiv(e,r,i);break;case Uint32Array:n.clearBufferuiv(e,r,i);break;case Float32Array:default:n.clearBufferfv(e,r,i)}break;case _a:n.clearBufferfv(_a,0,[i]);break;case ba:n.clearBufferiv(ba,0,[i]);break;case ya:const[s,o]=i;n.clearBufferfi(ya,0,s,o);break;default:C(!1,Sl)}})}function Qp(n){switch(n){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return C(!1),0}}function qr(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{sourceX:e=0,sourceY:r=0,sourceFormat:i=6408}=t;let{sourceAttachment:s=36064,target:o=null,sourceWidth:a,sourceHeight:c,sourceType:l}=t;const{framebuffer:u,deleteFramebuffer:h}=Jp(n);C(u);const{gl:g,handle:m,attachments:b}=u;a=a||u.width,c=c||u.height,s===36064&&m===null&&(s=1028),C(b[s]),l=l||b[s].type,o=tm(o,l,i,a,c),l=l||ns(o);const y=g.bindFramebuffer(36160,m);return g.readPixels(e,r,a,c,i,l,o),g.bindFramebuffer(36160,y||null),h&&u.delete(),o}function va(n){let{sourceAttachment:t=36064,targetMaxHeight:e=Number.MAX_SAFE_INTEGER}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=qr(n,{sourceAttachment:t}),{width:i,height:s}=n;for(;s>e;)({data:r,width:i,height:s}=Dp({data:r,width:i,height:s}));Np({data:r,width:i,height:s});const o=document.createElement("canvas");o.width=i,o.height=s;const a=o.getContext("2d"),c=a.createImageData(i,s);return c.data.set(r),a.putImageData(c,0,0),o.toDataURL()}function Jp(n){return n instanceof Q?{framebuffer:n,deleteFramebuffer:!1}:{framebuffer:um(n),deleteFramebuffer:!0}}function tm(n,t,e,r,i){if(n)return n;t=t||5121;const s=Sn(t,{clamped:!1}),o=Qp(e);return new s(r*i*o)}const q={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function em(n){const t=new Tt(n,{format:6408,type:5126,dataFormat:6408}),e=new Q(n,{id:"test-framebuffer",check:!1,attachments:{[36064]:t}}),r=e.getStatus();return t.delete(),e.delete(),r===36053}const xl={[q.WEBGL2]:[!1,!0],[q.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[q.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[q.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[q.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[q.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[q.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[q.FLOAT_BLEND]:["EXT_float_blend"],[q.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[q.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[q.TEXTURE_FLOAT]:["OES_texture_float",!0],[q.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[q.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[q.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[q.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[q.COLOR_ATTACHMENT_RGBA32F]:[em,"EXT_color_buffer_float"],[q.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[q.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[q.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[q.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[q.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[q.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]},nm=2;function rm(n,t){return Pl(n,t)}function Pl(n,t){return t=Array.isArray(t)?t:[t],t.every(e=>Ml(n,e))}function im(n){n.luma=n.luma||{},n.luma.caps=n.luma.caps||{};for(const t in xl)n.luma.caps[t]===void 0&&(n.luma.caps[t]=Ml(n,t));return n.luma.caps}function Ml(n,t){return n.luma=n.luma||{},n.luma.caps=n.luma.caps||{},n.luma.caps[t]===void 0&&(n.luma.caps[t]=sm(n,t)),n.luma.caps[t]||O.log(nm,"Feature: ".concat(t," not supported"))(),n.luma.caps[t]}function sm(n,t){const e=xl[t];C(e,t);let r;const i=j(n)&&e[1]||e[0];if(typeof i=="function")r=i(n);else if(Array.isArray(i)){r=!0;for(const s of i)r=r&&Boolean(n.getExtension(s))}else typeof i=="string"?r=Boolean(n.getExtension(i)):typeof i=="boolean"?r=i:C(!1);return r}const Ea="Multiple render targets not supported";class Q extends ee{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{colorBufferFloat:r,colorBufferHalfFloat:i}=e;let s=!0;return r&&(s=Boolean(t.getExtension("EXT_color_buffer_float")||t.getExtension("WEBGL_color_buffer_float")||t.getExtension("OES_texture_float"))),i&&(s=s&&Boolean(t.getExtension("EXT_color_buffer_float")||t.getExtension("EXT_color_buffer_half_float"))),s}static getDefaultFramebuffer(t){return t.luma=t.luma||{},t.luma.defaultFramebuffer=t.luma.defaultFramebuffer||new Q(t,{id:"default-framebuffer",handle:null,attachments:{}}),t.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){const t=ft(this.gl);return t.getParameter(t.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){const t=ft(this.gl);return t.getParameter(t.MAX_DRAW_BUFFERS)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(t,e),this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(e),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(t){let{width:e=1,height:r=1,attachments:i=null,color:s=!0,depth:o=!0,stencil:a=!1,check:c=!0,readBuffer:l=void 0,drawBuffers:u=void 0}=t;if(C(e>=0&&r>=0,"Width and height need to be integers"),this.width=e,this.height=r,i)for(const h in i){const g=i[h];(Array.isArray(g)?g[0]:g).resize({width:e,height:r})}else i=this._createDefaultAttachments(s,o,a,e,r);this.update({clearAttachments:!0,attachments:i,readBuffer:l,drawBuffers:u}),i&&c&&this.checkStatus()}delete(){for(const t of this.ownResources)t.delete();return super.delete(),this}update(t){let{attachments:e={},readBuffer:r,drawBuffers:i,clearAttachments:s=!1,resizeAttachments:o=!0}=t;this.attach(e,{clearAttachments:s,resizeAttachments:o});const{gl:a}=this,c=a.bindFramebuffer(36160,this.handle);return r&&this._setReadBuffer(r),i&&this._setDrawBuffers(i),a.bindFramebuffer(36160,c||null),this}resize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{width:e,height:r}=t;if(this.handle===null)return C(e===void 0&&r===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;e===void 0&&(e=this.gl.drawingBufferWidth),r===void 0&&(r=this.gl.drawingBufferHeight),e!==this.width&&r!==this.height&&O.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(e,"x").concat(r))();for(const i in this.attachments)this.attachments[i].resize({width:e,height:r});return this.width=e,this.height=r,this}attach(t){let{clearAttachments:e=!1,resizeAttachments:r=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i={};e&&Object.keys(this.attachments).forEach(o=>{i[o]=null}),Object.assign(i,t);const s=this.gl.bindFramebuffer(36160,this.handle);for(const o in i){C(o!==void 0,"Misspelled framebuffer binding point?");const a=Number(o),c=i[a];let l=c;if(!l)this._unattach(a);else if(l instanceof Be)this._attachRenderbuffer({attachment:a,renderbuffer:l});else if(Array.isArray(c)){const[u,h=0,g=0]=c;l=u,this._attachTexture({attachment:a,texture:u,layer:h,level:g})}else this._attachTexture({attachment:a,texture:l,layer:0,level:0});r&&l&&l.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,s||null),Object.assign(this.attachments,t),Object.keys(this.attachments).filter(o=>!this.attachments[o]).forEach(o=>{delete this.attachments[o]})}checkStatus(){const t=this.getStatus();if(t!==36053)throw new Error(am(t));return this}getStatus(){const{gl:t}=this,e=t.bindFramebuffer(36160,this.handle),r=t.checkFramebufferStatus(36160);return t.bindFramebuffer(36160,e||null),r}clear(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{color:e,depth:r,stencil:i,drawBuffers:s=[]}=t,o=this.gl.bindFramebuffer(36160,this.handle);return(e||r||i)&&Vs(this.gl,{color:e,depth:r,stencil:i}),s.forEach((a,c)=>{Kp(this.gl,{drawBuffer:c,value:a})}),this.gl.bindFramebuffer(36160,o||null),this}readPixels(){return O.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(){return O.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(){return O.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(){return O.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(){return O.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(){return O.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate(t){let{attachments:e=[],x:r=0,y:i=0,width:s,height:o}=t;const a=ft(this.gl),c=a.bindFramebuffer(36008,this.handle);return r===0&&i===0&&s===void 0&&o===void 0?a.invalidateFramebuffer(36008,e):a.invalidateFramebuffer(36008,e,r,i,s,o),a.bindFramebuffer(36008,c),this}getAttachmentParameter(t,e,r){let i=this._getAttachmentParameterFallback(e);return i===null&&(this.gl.bindFramebuffer(36160,this.handle),i=this.gl.getFramebufferAttachmentParameter(36160,t,e),this.gl.bindFramebuffer(36160,null)),r&&i>1e3&&(i=le(this.gl,i)),i}getAttachmentParameters(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:36064,e=arguments.length>1?arguments[1]:void 0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[];const i={};for(const s of r){const o=e?le(this.gl,s):s;i[o]=this.getAttachmentParameter(t,s,e)}return i}getParameters(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;const e=Object.keys(this.attachments),r={};for(const i of e){const s=Number(i),o=t?le(this.gl,s):s;r[o]=this.getAttachmentParameters(s,t)}return r}show(){return typeof window<"u"&&window.open(va(this),"luma-debug-texture"),this}log(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";if(t>O.level||typeof window>"u")return this;e=e||"Framebuffer ".concat(this.id);const r=va(this,{targetMaxHeight:100});return O.image({logLevel:t,message:e,image:r},e)(),this}bind(){let{target:t=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(t,this.handle),this}unbind(){let{target:t=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(t,null),this}_createDefaultAttachments(t,e,r,i,s){let o=null;return t&&(o=o||{},o[36064]=new Tt(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:i,height:s,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(o[36064])),e&&r?(o=o||{},o[33306]=new Be(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:i,height:111}),this.ownResources.push(o[33306])):e?(o=o||{},o[36096]=new Be(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:i,height:s}),this.ownResources.push(o[36096])):r&&C(!1),o}_unattach(t){const e=this.attachments[t];!e||(e instanceof Be?this.gl.framebufferRenderbuffer(36160,t,36161,null):this.gl.framebufferTexture2D(36160,t,3553,null,0),delete this.attachments[t])}_attachRenderbuffer(t){let{attachment:e=36064,renderbuffer:r}=t;const{gl:i}=this;i.framebufferRenderbuffer(36160,e,36161,r.handle),this.attachments[e]=r}_attachTexture(t){let{attachment:e=36064,texture:r,layer:i,level:s}=t;const{gl:o}=this;switch(o.bindTexture(r.target,r.handle),r.target){case 35866:case 32879:ft(o).framebufferTextureLayer(36160,e,r.target,s,i);break;case 34067:const c=om(i);o.framebufferTexture2D(36160,e,c,r.handle,s);break;case 3553:o.framebufferTexture2D(36160,e,3553,r.handle,s);break;default:C(!1,"Illegal texture type")}o.bindTexture(r.target,null),this.attachments[e]=r}_setReadBuffer(t){const e=Ng(this.gl);e?e.readBuffer(t):C(t===36064||t===1029,Ea),this.readBuffer=t}_setDrawBuffers(t){const{gl:e}=this,r=ft(e);if(r)r.drawBuffers(t);else{const i=e.getExtension("WEBGL_draw_buffers");i?i.drawBuffersWEBGL(t):C(t.length===1&&(t[0]===36064||t[0]===1029),Ea)}this.drawBuffers=t}_getAttachmentParameterFallback(t){const e=im(this.gl);switch(t){case 36052:return e.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return e.WEBGL2?null:8;case 33297:return e.WEBGL2?null:5125;case 33296:return!e.WEBGL2&&!e.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(t){return this.gl.bindFramebuffer(36160,t)}}function om(n){return n<34069?n+34069:n}function am(n){return(Q.STATUS||{})[n]||"Framebuffer error ".concat(n)}const cm=[36049,36048,33296,33298,33299,33300,33301,33302,33303];Q.ATTACHMENT_PARAMETERS=cm;function lm(n,t){C(n instanceof Tt||n instanceof Al||n instanceof Xp);const e=n.constructor,{gl:r,width:i,height:s,format:o,type:a,dataFormat:c,border:l,mipmaps:u}=n,h=Object.assign({width:i,height:s,format:o,type:a,dataFormat:c,border:l,mipmaps:u},t);return new e(r,h)}function um(n,t){const{gl:e,width:r,height:i,id:s}=n;return new Q(e,Object.assign({},t,{id:"framebuffer-for-".concat(s),width:r,height:i,attachments:{[36064]:n}}))}function mr(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"unnamed";const e=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,r=n.match(e);return r?r[1]:t}const hm=35632,fm=35633;function dm(n){switch(n){case hm:return"fragment";case fm:return"vertex";default:return"unknown type"}}function gm(n,t,e,r){const i=n.split(/\r?\n/),s={},o={},a=r||mr(t)||"(unnamed)",c="".concat(dm(e)," shader ").concat(a);for(let u=0;u<i.length;u++){const h=i[u];if(h.length<=1)continue;const g=h.split(":"),m=g[0],b=parseInt(g[2],10);if(isNaN(b))throw new Error("GLSL compilation error in ".concat(c,": ").concat(n));m!=="WARNING"?s[b]=h:o[b]=h}const l=pm(t);return{shaderName:c,errors:Ta(s,l),warnings:Ta(o,l)}}function Ta(n,t){let e="";for(let r=0;r<t.length;r++){const i=t[r];if(!(!n[r+3]&&!n[r+2]&&!n[r+1])&&(e+="".concat(i,`
`),n[r+1])){const s=n[r+1],o=s.split(":",3),a=o[0],c=parseInt(o[1],10)||0,l=s.substring(o.join(":").length+1).trim();e+=Ll("^^^ ".concat(a,": ").concat(l,`

`),c)}}return e}function pm(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:": ";const r=n.split(/\r?\n/),i=String(r.length+t-1).length;return r.map((s,o)=>{const a=String(o+t),c=a.length;return Ll(a,i-c)+e+s})}function Ll(n,t){let e="";for(let r=0;r<t;++r)e+=" ";return"".concat(e).concat(n)}function Rl(n){let t=100;const e=n.match(/[^\s]+/g);if(e.length>=2&&e[0]==="#version"){const r=parseInt(e[1],10);Number.isFinite(r)&&(t=r)}return t}const mm="Shader: GLSL source code must be a JavaScript string";class xn extends ee{get[Symbol.toStringTag](){return"Shader"}static getTypeName(t){switch(t){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return C(!1),"unknown"}}constructor(t,e){Yr(t),C(typeof e.source=="string",mm);const r=mr(e.source,null)||e.id||Ee("unnamed ".concat(xn.getTypeName(e.shaderType)));super(t,{id:r}),this.shaderType=e.shaderType,this.source=e.source,this.initialize(e)}initialize(t){let{source:e}=t;const r=mr(e,null);r&&(this.id=Ee(r)),this._compile(e)}getParameter(t){return this.gl.getShaderParameter(this.handle,t)}toString(){return"".concat(xn.getTypeName(this.shaderType),":").concat(this.id)}getName(){return mr(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){const t=this.gl.getExtension("WEBGL_debug_shaders");return t?t.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.source;if(t.startsWith("#version ")||(t=`#version 100
`.concat(t)),this.source=t,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){const r=this.gl.getShaderInfoLog(this.handle),{shaderName:i,errors:s,warnings:o}=gm(r,this.source,this.shaderType,this.id);throw O.error("GLSL compilation errors in ".concat(i,`
`).concat(s))(),O.warn("GLSL compilation warnings in ".concat(i,`
`).concat(o))(),new Error("GLSL compilation errors in ".concat(i))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}}class Mi extends xn{get[Symbol.toStringTag](){return"VertexShader"}constructor(t,e){typeof e=="string"&&(e={source:e}),super(t,Object.assign({},e,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}}class Li extends xn{get[Symbol.toStringTag](){return"FragmentShader"}constructor(t,e){typeof e=="string"&&(e={source:e}),super(t,Object.assign({},e,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}}const _m={[5126]:Y.bind(null,"uniform1fv",_t,1,ot),[35664]:Y.bind(null,"uniform2fv",_t,2,ot),[35665]:Y.bind(null,"uniform3fv",_t,3,ot),[35666]:Y.bind(null,"uniform4fv",_t,4,ot),[5124]:Y.bind(null,"uniform1iv",ie,1,ot),[35667]:Y.bind(null,"uniform2iv",ie,2,ot),[35668]:Y.bind(null,"uniform3iv",ie,3,ot),[35669]:Y.bind(null,"uniform4iv",ie,4,ot),[35670]:Y.bind(null,"uniform1iv",ie,1,ot),[35671]:Y.bind(null,"uniform2iv",ie,2,ot),[35672]:Y.bind(null,"uniform3iv",ie,3,ot),[35673]:Y.bind(null,"uniform4iv",ie,4,ot),[35674]:Y.bind(null,"uniformMatrix2fv",_t,4,Wt),[35675]:Y.bind(null,"uniformMatrix3fv",_t,9,Wt),[35676]:Y.bind(null,"uniformMatrix4fv",_t,16,Wt),[35678]:it,[35680]:it,[5125]:Y.bind(null,"uniform1uiv",tr,1,ot),[36294]:Y.bind(null,"uniform2uiv",tr,2,ot),[36295]:Y.bind(null,"uniform3uiv",tr,3,ot),[36296]:Y.bind(null,"uniform4uiv",tr,4,ot),[35685]:Y.bind(null,"uniformMatrix2x3fv",_t,6,Wt),[35686]:Y.bind(null,"uniformMatrix2x4fv",_t,8,Wt),[35687]:Y.bind(null,"uniformMatrix3x2fv",_t,6,Wt),[35688]:Y.bind(null,"uniformMatrix3x4fv",_t,12,Wt),[35689]:Y.bind(null,"uniformMatrix4x2fv",_t,8,Wt),[35690]:Y.bind(null,"uniformMatrix4x3fv",_t,12,Wt),[35678]:it,[35680]:it,[35679]:it,[35682]:it,[36289]:it,[36292]:it,[36293]:it,[36298]:it,[36299]:it,[36300]:it,[36303]:it,[36306]:it,[36307]:it,[36308]:it,[36311]:it},bm={},ym={},vm={},wa=[0];function js(n,t,e,r){t===1&&typeof n=="boolean"&&(n=n?1:0),Number.isFinite(n)&&(wa[0]=n,n=wa);const i=n.length;if(i%t&&O.warn("Uniform size should be multiples of ".concat(t),n)(),n instanceof e)return n;let s=r[i];s||(s=new e(i),r[i]=s);for(let o=0;o<i;o++)s[o]=n[o];return s}function _t(n,t){return js(n,t,Float32Array,bm)}function ie(n,t){return js(n,t,Int32Array,ym)}function tr(n,t){return js(n,t,Uint32Array,vm)}function Aa(n,t,e){const r=_m[e.type];if(!r)throw new Error("Unknown GLSL uniform type ".concat(e.type));return r().bind(null,n,t)}function Em(n){if(n[n.length-1]!=="]")return{name:n,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/,e=n.match(t);if(!e||e.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(n));return{name:e[1],length:e[2]||1,isArray:Boolean(e[2])}}function Tm(n,t,e){for(const r in n){const i=n[r];if((!e||Boolean(e[r]))&&!wm(i))throw t=t?"".concat(t," "):"",console.error("".concat(t," Bad uniform ").concat(r),i),new Error("".concat(t," Bad uniform ").concat(r))}return!0}function wm(n){return Array.isArray(n)||ArrayBuffer.isView(n)?Sm(n):isFinite(n)||n===!0||n===!1||n instanceof Ye||n instanceof Be?!0:n instanceof Q?Boolean(n.texture):!1}function Am(n,t,e){if(Array.isArray(e)||ArrayBuffer.isView(e))if(n[t]){const r=n[t];for(let i=0,s=e.length;i<s;++i)r[i]=e[i]}else n[t]=e.slice();else n[t]=e}function Sm(n){if(n.length===0)return!1;const t=Math.min(n.length,16);for(let e=0;e<t;++e)if(!Number.isFinite(n[e]))return!1;return!0}function it(){let n=null;return(t,e,r)=>{const i=n!==r;return i&&(t.uniform1i(e,r),n=r),i}}function Y(n,t,e,r){let i=null,s=null;return(o,a,c)=>{const l=t(c,e),u=l.length;let h=!1;if(i===null)i=new Float32Array(u),s=u,h=!0;else{C(s===u,"Uniform length cannot change.");for(let g=0;g<u;++g)if(l[g]!==i[g]){h=!0;break}}return h&&(r(o,n,a,l),i.set(l)),h}}function ot(n,t,e,r){n[t](e,r)}function Wt(n,t,e,r){n[t](e,!1,r)}const xm=5120,Pm=5121,Mm=5122,Lm=5123,Sa=0,er=1,Rm=2,Im=3,nr=4,Cm=5,Om=6,tt=5126,km=35664,Nm=35665,Dm=35666,dn=5124,Fm=35667,Bm=35668,Um=35669,gn=5125,Vm=36294,jm=36295,zm=36296,Gm=35670,Hm=35671,Wm=35672,Xm=35673,Ym=35674,qm=35675,$m=35676,Zm=35685,Km=35686,Qm=35687,Jm=35688,t0=35689,e0=35690,ss={[tt]:[tt,1,"float"],[km]:[tt,2,"vec2"],[Nm]:[tt,3,"vec3"],[Dm]:[tt,4,"vec4"],[dn]:[dn,1,"int"],[Fm]:[dn,2,"ivec2"],[Bm]:[dn,3,"ivec3"],[Um]:[dn,4,"ivec4"],[gn]:[gn,1,"uint"],[Vm]:[gn,2,"uvec2"],[jm]:[gn,3,"uvec3"],[zm]:[gn,4,"uvec4"],[Gm]:[tt,1,"bool"],[Hm]:[tt,2,"bvec2"],[Wm]:[tt,3,"bvec3"],[Xm]:[tt,4,"bvec4"],[Ym]:[tt,8,"mat2"],[Zm]:[tt,8,"mat2x3"],[Km]:[tt,8,"mat2x4"],[qm]:[tt,12,"mat3"],[Qm]:[tt,12,"mat3x2"],[Jm]:[tt,12,"mat3x4"],[$m]:[tt,16,"mat4"],[t0]:[tt,16,"mat4x2"],[e0]:[tt,16,"mat4x3"]};function n0(n){switch(n){case Sa:return Sa;case er:return er;case Im:return er;case Rm:return er;case nr:return nr;case Cm:return nr;case Om:return nr;default:return C(!1),0}}function xa(n){const t=ss[n];if(!t)return null;const[e,r]=t;return{type:e,components:r}}function Il(n,t){switch(n){case xm:case Pm:case Mm:case Lm:n=tt;break}for(const e in ss){const[r,i,s]=ss[e];if(r===n&&i===t)return{glType:e,name:s}}return null}class r0{constructor(t){this.id=t.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(t),this._readVaryingsFromProgram(t)}getAttributeInfo(t){const e=Number(t);return Number.isFinite(e)?this.attributeInfosByLocation[e]:this.attributeInfosByName[t]||null}getAttributeLocation(t){const e=this.getAttributeInfo(t);return e?e.location:-1}getAttributeAccessor(t){const e=this.getAttributeInfo(t);return e?e.accessor:null}getVaryingInfo(t){const e=Number(t);return Number.isFinite(e)?this.varyingInfos[e]:this.varyingInfosByName[t]||null}getVaryingIndex(t){const e=this.getVaryingInfo();return e?e.location:-1}getVaryingAccessor(t){const e=this.getVaryingInfo();return e?e.accessor:null}_readAttributesFromProgram(t){const{gl:e}=t,r=e.getProgramParameter(t.handle,35721);for(let i=0;i<r;i++){const{name:s,type:o,size:a}=e.getActiveAttrib(t.handle,i),c=e.getAttribLocation(t.handle,s);c>=0&&this._addAttribute(c,s,o,a)}this.attributeInfos.sort((i,s)=>i.location-s.location)}_readVaryingsFromProgram(t){const{gl:e}=t;if(!j(e))return;const r=e.getProgramParameter(t.handle,35971);for(let i=0;i<r;i++){const{name:s,type:o,size:a}=e.getTransformFeedbackVarying(t.handle,i);this._addVarying(i,s,o,a)}this.varyingInfos.sort((i,s)=>i.location-s.location)}_addAttribute(t,e,r,i){const{type:s,components:o}=xa(r),a={type:s,size:i*o};this._inferProperties(t,e,a);const c={location:t,name:e,accessor:new vt(a)};this.attributeInfos.push(c),this.attributeInfosByLocation[t]=c,this.attributeInfosByName[c.name]=c}_inferProperties(t,e,r){/instance/i.test(e)&&(r.divisor=1)}_addVarying(t,e,r,i){const{type:s,components:o}=xa(r),a=new vt({type:s,size:i*o}),c={location:t,name:e,accessor:a};this.varyingInfos.push(c),this.varyingInfosByName[c.name]=c}}const Pa=4,i0=35981,s0=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"];class Cl extends ee{get[Symbol.toStringTag](){return"Program"}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(t,e),this.stubRemovedMethods("Program","v6.0",s0),this._isCached=!1,this.initialize(e),Object.seal(this),this._setId(e.id)}initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{hash:e,vs:r,fs:i,varyings:s,bufferMode:o=i0}=t;return this.hash=e||"",this.vs=typeof r=="string"?new Mi(this.gl,{id:"".concat(t.id,"-vs"),source:r}):r,this.fs=typeof i=="string"?new Li(this.gl,{id:"".concat(t.id,"-fs"),source:i}):i,C(this.vs instanceof Mi),C(this.fs instanceof Li),this.uniforms={},this._textureUniforms={},s&&s.length>0&&(ft(this.gl),this.varyings=s,this.gl2.transformFeedbackVaryings(this.handle,s,o)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new r0(this),this.setProps(t)}delete(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isCached?this:super.delete(t)}setProps(t){return"uniforms"in t&&this.setUniforms(t.uniforms),this}draw(t){let{logPriority:e,drawMode:r=4,vertexCount:i,offset:s=0,start:o,end:a,isIndexed:c=!1,indexType:l=5123,instanceCount:u=0,isInstanced:h=u>0,vertexArray:g=null,transformFeedback:m,framebuffer:b,parameters:y={},uniforms:v,samplers:T}=t;if((v||T)&&(O.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(v||{})),O.priority>=e){const A=b?b.id:"default",S="mode=".concat(le(this.gl,r)," verts=").concat(i," ")+"instances=".concat(u," indexType=").concat(le(this.gl,l)," ")+"isInstanced=".concat(h," isIndexed=").concat(c," ")+"Framebuffer=".concat(A);O.log(e,S)()}return C(g),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||i===0||h&&u===0?!1:(g.bindForDraw(i,u,()=>{if(b!==void 0&&(y=Object.assign({},y,{framebuffer:b})),m){const A=n0(r);m.begin(A)}this._bindTextures(),Pt(this.gl,y,()=>{c&&h?this.gl2.drawElementsInstanced(r,i,l,s,u):c&&j(this.gl)&&!isNaN(o)&&!isNaN(a)?this.gl2.drawRangeElements(r,o,a,i,l,s):c?this.gl.drawElements(r,i,l,s):h?this.gl2.drawArraysInstanced(r,s,i,u):this.gl.drawArrays(r,s,i)}),m&&m.end()}),!0)}setUniforms(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};O.priority>=2&&Tm(t,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(const e in t){const r=t[e],i=this._uniformSetters[e];if(i){let s=r,o=!1;if(s instanceof Q&&(s=s.texture),s instanceof Ye)if(o=this.uniforms[e]!==r,o){i.textureIndex===void 0&&(i.textureIndex=this._textureIndexCounter++);const a=s,{textureIndex:c}=i;a.bind(c),s=c,this._textureUniforms[e]=a}else s=i.textureIndex;else this._textureUniforms[e]&&delete this._textureUniforms[e];(i(s)||o)&&Am(this.uniforms,e,r)}}return this}_areTexturesRenderable(){let t=!0;for(const e in this._textureUniforms){const r=this._textureUniforms[e];r.update(),t=t&&r.loaded}return t}_bindTextures(){for(const t in this._textureUniforms){const e=this._uniformSetters[t].textureIndex;this._textureUniforms[t].bind(e)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(t){const e=this.gl.getAttachedShaders(t),r={};for(const i of e)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:r.vs=new Mi({handle:i});break;case 35632:r.fs=new Li({handle:i});break}return r}_getParameter(t){return this.gl.getProgramParameter(this.handle,t)}_setId(t){if(!t){const e=this._getName();this.id=Ee(e)}}_getName(){let t=this.vs.getName()||this.fs.getName();return t=t.replace(/shader/i,""),t=t?"".concat(t,"-program"):"program",t}_compileAndLink(){const{gl:t}=this;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),O.time(Pa,"linkProgram for ".concat(this._getName()))(),t.linkProgram(this.handle),O.timeEnd(Pa,"linkProgram for ".concat(this._getName()))(),t.debug||O.level>0){if(!t.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(t.getProgramInfoLog(this.handle)));if(t.validateProgram(this.handle),!t.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(t.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){const{gl:t}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let e=0;e<this._uniformCount;e++){const r=this.gl.getActiveUniform(this.handle,e),{name:i}=Em(r.name);let s=t.getUniformLocation(this.handle,i);if(this._uniformSetters[i]=Aa(t,s,r),r.size>1)for(let o=0;o<r.size;o++)s=t.getUniformLocation(this.handle,"".concat(i,"[").concat(o,"]")),this._uniformSetters["".concat(i,"[").concat(o,"]")]=Aa(t,s,r)}this._textureIndexCounter=0}getActiveUniforms(t,e){return this.gl2.getActiveUniforms(this.handle,t,e)}getUniformBlockIndex(t){return this.gl2.getUniformBlockIndex(this.handle,t)}getActiveUniformBlockParameter(t,e){return this.gl2.getActiveUniformBlockParameter(this.handle,t,e)}uniformBlockBinding(t,e){this.gl2.uniformBlockBinding(this.handle,t,e)}}const o0=34918,a0=34919,c0=35007,l0=36795,u0=35976,h0=35887,f0=36202;class Mr extends ee{get[Symbol.toStringTag](){return"Query"}static isSupported(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];const r=j(t),i=Pl(t,q.TIMER_QUERY);let s=r||i;for(const o of e)switch(o){case"queries":s=s&&r;break;case"timers":s=s&&i;break;default:C(!1)}return s}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(t,e),this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(c0)}beginOcclusionQuery(){let{conservative:t=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.begin(t?f0:h0)}beginTransformFeedbackQuery(){return this.begin(u0)}begin(t){return this._queryPending?this:(this.target=t,this.gl2.beginQuery(this.target,this.handle),this)}end(){return this._queryPending?this:(this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this)}isResultAvailable(){if(!this._queryPending)return!1;const t=this.gl2.getQueryParameter(this.handle,a0);return t&&(this._queryPending=!1),t}isTimerDisjoint(){return this.gl2.getParameter(l0)}getResult(){return this.gl2.getQueryParameter(this.handle,o0)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Number.POSITIVE_INFINITY;if(this._pollingPromise)return this._pollingPromise;let e=0;return this._pollingPromise=new Promise((r,i)=>{const s=()=>{this.isResultAvailable()?(r(this.getResult()),this._pollingPromise=null):e++>t?(i("Timed out"),this._pollingPromise=null):requestAnimationFrame(s)};requestAnimationFrame(s)}),this._pollingPromise}_createHandle(){return Mr.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}}class Ol extends ee{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(t){return j(t)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};ft(t),super(t,e),this.initialize(e),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,Xe(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(t),this}setProps(t){"program"in t&&(this.configuration=t.program&&t.program.configuration),"configuration"in t&&(this.configuration=t.configuration),"bindOnUse"in t&&(t=t.bindOnUse),"buffers"in t&&this.setBuffers(t.buffers)}setBuffers(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.bind(()=>{for(const e in t)this.setBuffer(e,t[e])}),this}setBuffer(t,e){const r=this._getVaryingIndex(t),{buffer:i,byteSize:s,byteOffset:o}=this._getBufferParams(e);return r<0?(this.unused[t]=i,O.warn("".concat(this.id," unused varying buffer ").concat(t))(),this):(this.buffers[r]=e,this.bindOnUse||this._bindBuffer(r,i,o,s),this)}begin(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(t),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(t){let e,r,i;return t instanceof W?i=t:(i=t.buffer,r=t.byteSize,e=t.byteOffset),(e!==void 0||r!==void 0)&&(e=e||0,r=r||i.byteLength-e),{buffer:i,byteOffset:e,byteSize:r}}_getVaryingInfo(t){return this.configuration&&this.configuration.getVaryingInfo(t)}_getVaryingIndex(t){if(this.configuration)return this.configuration.getVaryingInfo(t).location;const e=Number(t);return Number.isFinite(e)?e:-1}_bindBuffers(){if(this.bindOnUse)for(const t in this.buffers){const{buffer:e,byteSize:r,byteOffset:i}=this._getBufferParams(this.buffers[t]);this._bindBuffer(t,e,i,r)}}_unbindBuffers(){if(this.bindOnUse)for(const t in this.buffers)this._bindBuffer(t,null)}_bindBuffer(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0;const s=e&&e.handle;return!s||i===void 0?this.gl.bindBufferBase(35982,t,s):this.gl.bindBufferRange(35982,t,s,r,i),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(t){this.gl.bindTransformFeedback(36386,this.handle)}}let rr=null;function d0(n){return(!rr||rr.byteLength<n)&&(rr=new ArrayBuffer(n)),rr}function g0(n,t){const e=d0(n.BYTES_PER_ELEMENT*t);return new n(e,0,t)}function p0(n){let{target:t,source:e,start:r=0,count:i=1}=n;const s=e.length,o=i*s;let a=0;for(let c=r;a<s;a++)t[c++]=e[a];for(;a<o;)a<o-a?(t.copyWithin(r+a,r,r+a),a*=2):(t.copyWithin(r+a,r,r+o-a),a=o);return t}const m0="elements must be GL.ELEMENT_ARRAY_BUFFER";class bt extends ee{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(t){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}).constantAttributeZero?j(t)||fl()==="Chrome":!0}static getDefaultArray(t){return t.luma=t.luma||{},t.luma.defaultVertexArray||(t.luma.defaultVertexArray=new bt(t,{handle:null,isDefaultArray:!0})),t.luma.defaultVertexArray}static getMaxAttributes(t){return bt.MAX_ATTRIBUTES=bt.MAX_ATTRIBUTES||t.getParameter(34921),bt.MAX_ATTRIBUTES}static setConstant(t,e,r){switch(r.constructor){case Float32Array:bt._setConstantFloatArray(t,e,r);break;case Int32Array:bt._setConstantIntArray(t,e,r);break;case Uint32Array:bt._setConstantUintArray(t,e,r);break;default:C(!1)}}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=e.id||e.program&&e.program.id;super(t,Object.assign({},e,{id:r})),this.buffer=null,this.bufferValue=null,this.isDefaultArray=e.isDefaultArray||!1,this.gl2=t,this.initialize(e),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return bt.getMaxAttributes(this.gl)}initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.setProps(t)}setProps(t){return this}setElementBuffer(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return C(!t||t.target===34963,m0),this.bind(()=>{this.gl.bindBuffer(34963,t?t.handle:null)}),this}setBuffer(t,e,r){if(e.target===34963)return this.setElementBuffer(e,r);const{size:i,type:s,stride:o,offset:a,normalized:c,integer:l,divisor:u}=r,{gl:h,gl2:g}=this;return t=Number(t),this.bind(()=>{h.bindBuffer(34962,e.handle),l?(C(j(h)),g.vertexAttribIPointer(t,i,s,o,a)):h.vertexAttribPointer(t,i,s,c,o,a),h.enableVertexAttribArray(t),g.vertexAttribDivisor(t,u||0)}),this}enable(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return!e&&t===0&&!bt.isSupported(this.gl,{constantAttributeZero:!0})||(t=Number(t),this.bind(()=>e?this.gl.enableVertexAttribArray(t):this.gl.disableVertexAttribArray(t))),this}getConstantBuffer(t,e){const r=this._normalizeConstantArrayValue(e),i=r.byteLength*t,s=r.length*t;let o=!this.buffer;if(this.buffer=this.buffer||new W(this.gl,i),o=o||this.buffer.reallocate(i),o=o||!this._compareConstantArrayValues(r,this.bufferValue),o){const a=g0(e.constructor,s);p0({target:a,source:r,start:0,count:s}),this.buffer.subData(a),this.bufferValue=e}return this.buffer}_normalizeConstantArrayValue(t){return Array.isArray(t)?new Float32Array(t):t}_compareConstantArrayValues(t,e){if(!t||!e||t.length!==e.length||t.constructor!==e.constructor)return!1;for(let r=0;r<t.length;++r)if(t[r]!==e[r])return!1;return!0}static _setConstantFloatArray(t,e,r){switch(r.length){case 1:t.vertexAttrib1fv(e,r);break;case 2:t.vertexAttrib2fv(e,r);break;case 3:t.vertexAttrib3fv(e,r);break;case 4:t.vertexAttrib4fv(e,r);break;default:C(!1)}}static _setConstantIntArray(t,e,r){switch(C(j(t)),r.length){case 1:t.vertexAttribI1iv(e,r);break;case 2:t.vertexAttribI2iv(e,r);break;case 3:t.vertexAttribI3iv(e,r);break;case 4:t.vertexAttribI4iv(e,r);break;default:C(!1)}}static _setConstantUintArray(t,e,r){switch(C(j(t)),r.length){case 1:t.vertexAttribI1uiv(e,r);break;case 2:t.vertexAttribI2uiv(e,r);break;case 3:t.vertexAttribI3uiv(e,r);break;case 4:t.vertexAttribI4uiv(e,r);break;default:C(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(t){return this.gl2.deleteVertexArray(t),[this.elements]}_bindHandle(t){this.gl2.bindVertexArray(t)}_getParameter(t,e){let{location:r}=e;return C(Number.isFinite(r)),this.bind(()=>{switch(t){case 34373:return this.gl.getVertexAttribOffset(r,t);default:return this.gl.getVertexAttrib(r,t)}})}}const _0="VertexArray: attributes must be Buffers or constants (i.e. typed array)",b0=/^(.+)__LOCATION_([0-9]+)$/,y0=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"];class v0{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=e.id||e.program&&e.program.id;this.id=r,this.gl=t,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new bt(t),vl(this,"VertexArray","v6.0",y0),this.initialize(e),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(t)}reset(){this.elements=null,this.elementsAccessor=null;const{MAX_ATTRIBUTES:t}=this.vertexArrayObject;return this.values=new Array(t).fill(null),this.accessors=new Array(t).fill(null),this.unused={},this.drawParams=null,this}setProps(t){return"program"in t&&(this.configuration=t.program&&t.program.configuration),"configuration"in t&&(this.configuration=t.configuration),"attributes"in t&&this.setAttributes(t.attributes),"elements"in t&&this.setElementBuffer(t.elements),"bindOnUse"in t&&(t=t.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(t){return Object.assign(this.attributes,t),this.vertexArrayObject.bind(()=>{for(const e in t){const r=t[e];this._setAttribute(e,r)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return this.elements=t,this.elementsAccessor=e,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(t,e),this}setBuffer(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(e.target===34963)return this.setElementBuffer(e,r);const{location:i,accessor:s}=this._resolveLocationAndAccessor(t,e,e.accessor,r);return i>=0&&(this.values[i]=e,this.accessors[i]=s,this.clearDrawParams(),this.vertexArrayObject.setBuffer(i,e,s)),this}setConstant(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const{location:i,accessor:s}=this._resolveLocationAndAccessor(t,e,Object.assign({size:e.length},r));return i>=0&&(e=this.vertexArrayObject._normalizeConstantArrayValue(e),this.values[i]=e,this.accessors[i]=s,this.clearDrawParams(),this.vertexArrayObject.enable(i,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new W(this.gl,{accessor:{size:4}});for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this.values[t]instanceof W&&(this.gl.disableVertexAttribArray(t),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(t,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++){const e=this.values[t];e instanceof W&&this.setBuffer(t,e)}}),this}bindForDraw(t,e,r){let i;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(t,e),i=r()}),i}_resolveLocationAndAccessor(t,e,r,i){const s={location:-1,accessor:null},{location:o,name:a}=this._getAttributeIndex(t);if(!Number.isFinite(o)||o<0)return this.unused[t]=e,O.once(3,()=>"unused value ".concat(t," in ").concat(this.id))(),s;const c=this._getAttributeInfo(a||o);if(!c)return s;const l=this.accessors[o]||{},u=vt.resolve(c.accessor,l,r,i),{size:h,type:g}=u;return C(Number.isFinite(h)&&Number.isFinite(g)),{location:o,accessor:u}}_getAttributeInfo(t){return this.configuration&&this.configuration.getAttributeInfo(t)}_getAttributeIndex(t){const e=Number(t);if(Number.isFinite(e))return{location:e};const r=b0.exec(t),i=r?r[1]:t,s=r?Number(r[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(i)+s,name:i}:{location:-1}}_setAttribute(t,e){if(e instanceof W)this.setBuffer(t,e);else if(Array.isArray(e)&&e.length&&e[0]instanceof W){const r=e[0],i=e[1];this.setBuffer(t,r,i)}else if(ArrayBuffer.isView(e)||Array.isArray(e)){const r=e;this.setConstant(t,r)}else if(e.buffer instanceof W){const r=e;this.setBuffer(t,r.buffer,r)}else throw new Error(_0)}_setConstantAttributes(t,e){const r=Math.max(t|0,e|0);let i=this.values[0];ArrayBuffer.isView(i)&&this._setConstantAttributeZero(i,r);for(let s=1;s<this.vertexArrayObject.MAX_ATTRIBUTES;s++)i=this.values[s],ArrayBuffer.isView(i)&&this._setConstantAttribute(s,i)}_setConstantAttributeZero(t,e){if(bt.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,t);return}const r=this.vertexArrayObject.getConstantBuffer(e,t);this.vertexArrayObject.setBuffer(0,r,this.accessors[0])}_setConstantAttribute(t,e){bt.setConstant(this.gl,t,e)}_updateDrawParams(){const t={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this._updateDrawParamsForLocation(t,e);return this.elements&&(t.elementCount=this.elements.getElementCount(this.elements.accessor),t.isIndexed=!0,t.indexType=this.elementsAccessor.type||this.elements.accessor.type,t.indexOffset=this.elementsAccessor.offset||0),t.indexCount===1/0&&(t.indexCount=0),t.vertexCount===1/0&&(t.vertexCount=0),t.instanceCount===1/0&&(t.instanceCount=0),t}_updateDrawParamsForLocation(t,e){const r=this.values[e],i=this.accessors[e];if(!r)return;const{divisor:s}=i,o=s>0;if(t.isInstanced=t.isInstanced||o,r instanceof W){const a=r;if(o){const c=a.getVertexCount(i);t.instanceCount=Math.min(t.instanceCount,c)}else{const c=a.getVertexCount(i);t.vertexCount=Math.min(t.vertexCount,c)}}}setElements(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return O.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(t,e)}}function E0(n,t){const{maxElts:e=16,size:r=1}=t;let i="[";for(let o=0;o<n.length&&o<e;++o)o>0&&(i+=",".concat(o%r===0?" ":"")),i+=Pn(n[o],t);const s=n.length>e?"...":"]";return"".concat(i).concat(s)}function Pn(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const e=1e-16,{isInteger:r=!1}=t;if(Array.isArray(n)||ArrayBuffer.isView(n))return E0(n,t);if(!Number.isFinite(n))return String(n);if(Math.abs(n)<e)return r?"0":"0.";if(r||Math.abs(n)>100&&Math.abs(n)<1e4)return n.toFixed(0);const i=n.toPrecision(2);return i.indexOf(".0")===i.length-2?i.slice(0,-1):i}function Ma(n){let{header:t="Uniforms",program:e,uniforms:r,undefinedOnly:i=!1}=n;C(e);const s=".*_.*",o=".*Matrix",a=e._uniformSetters,c={},l=Object.keys(a).sort();let u=0;for(const m of l)!m.match(s)&&!m.match(o)&&Ri({table:c,header:t,uniforms:r,uniformName:m,undefinedOnly:i})&&u++;for(const m of l)m.match(o)&&Ri({table:c,header:t,uniforms:r,uniformName:m,undefinedOnly:i})&&u++;for(const m of l)c[m]||Ri({table:c,header:t,uniforms:r,uniformName:m,undefinedOnly:i})&&u++;let h=0;const g={};if(!i)for(const m in r){const b=r[m];c[m]||(h++,g[m]={Type:"NOT USED: ".concat(b),[t]:Pn(b)})}return{table:c,count:u,unusedTable:g,unusedCount:h}}function Ri(n){let{table:t,header:e,uniforms:r,uniformName:i,undefinedOnly:s}=n;const o=r[i],a=T0(o);return!s||!a?(t[i]={[e]:a?Pn(o):"N/A","Uniform Type":a?o:"NOT PROVIDED"},!0):!1}function T0(n){return n!=null}function w0(n){let{vertexArray:t,header:e="Attributes"}=n;if(!t.configuration)return{};const r={};t.elements&&(r.ELEMENT_ARRAY_BUFFER=La(t,t.elements,null,e));const i=t.values;for(const s in i){const o=t._getAttributeInfo(s);if(o){let a="".concat(s,": ").concat(o.name);const c=t.accessors[o.location];c&&(a="".concat(s,": ").concat(A0(o.name,c))),r[a]=La(t,i[s],c,e)}}return r}function La(n,t,e,r){const{gl:i}=n;if(!t)return{[r]:"null","Format ":"N/A"};let s="NOT PROVIDED",o=1,a=0,c=0,l,u,h;if(e&&(s=e.type,o=e.size,s=String(s).replace("Array",""),l=s.indexOf("nt")!==-1),t instanceof W){const g=t,{data:m,changed:b}=g.getDebugData();u=b?"*":"",h=m,c=g.byteLength,a=c/m.BYTES_PER_ELEMENT/o;let y;if(e){const v=e.divisor>0;y="".concat(v?"I ":"P "," ").concat(a," (x").concat(o,"=").concat(c," bytes ").concat(le(i,s),")")}else l=!0,y="".concat(c," bytes");return{[r]:"".concat(u).concat(Pn(h,{size:o,isInteger:l})),"Format ":y}}return h=t,o=t.length,s=String(t.constructor.name).replace("Array",""),l=s.indexOf("nt")!==-1,{[r]:"".concat(Pn(h,{size:o,isInteger:l})," (constant)"),"Format ":"".concat(o,"x").concat(s," (constant)")}}function A0(n,t){const{type:e,size:r}=t,i=Il(e,r);return i?"".concat(n," (").concat(i.name,")"):n}function S0(n){const t={},e="Accessors for ".concat(n.id);for(const r of n.attributeInfos)if(r){const i=Ra(r);t["in ".concat(i)]={[e]:JSON.stringify(r.accessor)}}for(const r of n.varyingInfos)if(r){const i=Ra(r);t["out ".concat(i)]={[e]:JSON.stringify(r.accessor)}}return t}function Ra(n){const{type:t,size:e}=n.accessor,r=Il(t,e);return r?"".concat(r.name," ").concat(n.name):n.name}const Ia=te()&&typeof document<"u";let x0=0;class P0{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{onCreateContext:e=v=>yl(v),onAddHTML:r=null,onInitialize:i=()=>{},onRender:s=()=>{},onFinalize:o=()=>{},onError:a,gl:c=null,glOptions:l={},debug:u=!1,createFramebuffer:h=!1,autoResizeViewport:g=!0,autoResizeDrawingBuffer:m=!0,stats:b=ye.get("animation-loop-".concat(x0++))}=t;let{useDevicePixels:y=!0}=t;"useDevicePixelRatio"in t&&(O.deprecated("useDevicePixelRatio","useDevicePixels")(),y=t.useDevicePixelRatio),this.props={onCreateContext:e,onAddHTML:r,onInitialize:i,onRender:s,onFinalize:o,onError:a,gl:c,glOptions:l,debug:u,createFramebuffer:h},this.gl=c,this.needsRedraw=null,this.timeline=null,this.stats=b,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:g,autoResizeDrawingBuffer:m,useDevicePixels:y}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(t){return C(typeof t=="string"),this.needsRedraw=this.needsRedraw||t,this}setProps(t){return"autoResizeViewport"in t&&(this.autoResizeViewport=t.autoResizeViewport),"autoResizeDrawingBuffer"in t&&(this.autoResizeDrawingBuffer=t.autoResizeDrawingBuffer),"useDevicePixels"in t&&(this.useDevicePixels=t.useDevicePixels),this}start(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this._running)return this;this._running=!0;const e=this._getPageLoadPromise().then(()=>!this._running||this._initialized?null:(this._createWebGLContext(t),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=Mr.isSupported(this.gl,["timers"])?new Mr(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps))).then(r=>{this._running&&(this._addCallbackData(r||{}),r!==!1&&this._startLoop())});return this.props.onError&&e.catch(this.props.onError),this}redraw(){return this.isContextLost()?this:(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers(),this)}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(t){return this.timeline=t,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(t=>{this._resolveNextFrame=t})),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(){return this.props.onCreateContext(...arguments)}onInitialize(){return this.props.onInitialize(...arguments)}onRender(){return this.props.onRender(...arguments)}onFinalize(){return this.props.onFinalize(...arguments)}getHTMLControlValue(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const r=document.getElementById(t);return r?Number(r.value):e}setViewParameters(){return O.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){const t=()=>{!this._running||(this.redraw(),this._animationFrameId=this._requestAnimationFrame(t))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(t)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=Ia?new Promise((t,e)=>{if(Ia&&document.readyState==="complete"){t(document);return}window.addEventListener("load",()=>{t(document)})}):Promise.resolve({})),this._pageLoadPromise}_setDisplay(t){this.display&&(this.display.delete(),this.display.animationLoop=null),t&&(t.animationLoop=this),this.display=t}_cancelAnimationFrame(t){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(t):Op(t)}_requestAnimationFrame(t){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(t):Cp(t)}_renderFrame(){if(this.display){this.display._renderFrame(...arguments);return}this.onRender(...arguments)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){const{width:t,height:e,aspect:r}=this._getSizeAndAspect();(t!==this.animationProps.width||e!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),r!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=t,this.animationProps.height=e,this.animationProps.aspect=r,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(t){typeof t=="object"&&t!==null&&(this.animationProps=Object.assign({},this.animationProps,t))}_createWebGLContext(t){if(this.offScreen=t.canvas&&typeof OffscreenCanvas<"u"&&t.canvas instanceof OffscreenCanvas,t=Object.assign({},t,this.props.glOptions),this.gl=this.props.gl?Fs(this.props.gl,t):this.onCreateContext(t),!Xr(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");yp(this.gl),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){const t=document.createElement("div");document.body.appendChild(t),t.style.position="relative";const e=document.createElement("div");e.style.position="absolute",e.style.left="10px",e.style.bottom="10px",e.style.width="300px",e.style.background="white",t.appendChild(this.gl.canvas),t.appendChild(e);const r=this.props.onAddHTML(e);r&&(e.innerHTML=r)}}_getSizeAndAspect(){const t=this.gl.drawingBufferWidth,e=this.gl.drawingBufferHeight;let r=1;const{canvas:i}=this.gl;return i&&i.clientHeight?r=i.clientWidth/i.clientHeight:t>0&&e>0&&(r=t/e),{width:t,height:e,aspect:r}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&Ap(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new Q(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){const{canvas:t}=this.gl;t&&(t.addEventListener("mousemove",this._onMousemove),t.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(t){this.animationProps._mousePosition=[t.offsetX,t.offsetY]}_onMouseleave(t){this.animationProps._mousePosition=null}}const Dn="vs",zs="fs";function Et(n,t){if(!n)throw new Error(t||"shadertools: assertion failed.")}const Ii={number:{validate(n,t){return Number.isFinite(n)&&(!("max"in t)||n<=t.max)&&(!("min"in t)||n>=t.min)}},array:{validate(n,t){return Array.isArray(n)||ArrayBuffer.isView(n)}}};function M0(n){const t={};for(const e in n){const r=n[e],i=L0(r);t[e]=i}return t}function L0(n){let t=Ca(n);return t==="object"?n?"type"in n?Object.assign({},n,Ii[n.type]):"value"in n?(t=Ca(n.value),Object.assign({type:t},n,Ii[t])):{type:"object",value:n}:{type:"object",value:null}:Object.assign({type:t,value:n},Ii[t])}function Ca(n){return Array.isArray(n)||ArrayBuffer.isView(n)?"array":typeof n}const R0="vs",I0="fs";class Oa{constructor(t){let{name:e,vs:r,fs:i,dependencies:s=[],uniforms:o,getUniforms:a,deprecations:c=[],defines:l={},inject:u={},vertexShader:h,fragmentShader:g}=t;Et(typeof e=="string"),this.name=e,this.vs=r||h,this.fs=i||g,this.getModuleUniforms=a,this.dependencies=s,this.deprecations=this._parseDeprecationDefinitions(c),this.defines=l,this.injections=C0(u),o&&(this.uniforms=M0(o))}getModuleSource(t){let e;switch(t){case R0:e=this.vs||"";break;case I0:e=this.fs||"";break;default:Et(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),`
`).concat(e,"// END MODULE_").concat(this.name,`

`)}getUniforms(t,e){return this.getModuleUniforms?this.getModuleUniforms(t,e):this.uniforms?this._defaultGetUniforms(t):{}}getDefines(){return this.defines}checkDeprecations(t,e){this.deprecations.forEach(r=>{r.regex.test(t)&&(r.deprecated?e.deprecated(r.old,r.new)():e.removed(r.old,r.new)())})}_parseDeprecationDefinitions(t){return t.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp("\\b".concat(e.old,"\\("));break;default:e.regex=new RegExp("".concat(e.type," ").concat(e.old,";"))}}),t}_defaultGetUniforms(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e={},r=this.uniforms;for(const i in r){const s=r[i];i in t&&!s.private?(s.validate&&Et(s.validate(t[i],s),"".concat(this.name,": invalid ").concat(i)),e[i]=t[i]):e[i]=s.value}return e}}function C0(n){const t={vs:{},fs:{}};for(const e in n){let r=n[e];const i=e.slice(0,2);typeof r=="string"&&(r={order:0,injection:r}),t[i][e]=r}return t}function O0(n){return k0(Nl(n))}function k0(n){const t={},e={};return kl({modules:n,level:0,moduleMap:t,moduleDepth:e}),Object.keys(e).sort((r,i)=>e[i]-e[r]).map(r=>t[r])}function kl(n){let{modules:t,level:e,moduleMap:r,moduleDepth:i}=n;if(e>=5)throw new Error("Possible loop in shader dependency graph");for(const s of t)r[s.name]=s,(i[s.name]===void 0||i[s.name]<e)&&(i[s.name]=e);for(const s of t)s.dependencies&&kl({modules:s.dependencies,level:e+1,moduleMap:r,moduleDepth:i})}function Nl(n,t){return n.map(e=>(e instanceof Oa||(Et(typeof e!="string","Shader module use by name is deprecated. Import shader module '".concat(e,"' and use it directly.")),Et(e.name,"shader module has no name"),e=new Oa(e),e.dependencies=Nl(e.dependencies)),e))}function N0(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=typeof window<"u"?window.navigator||{}:{},e=n.userAgent||t.userAgent||"",r=e.indexOf("MSIE ")!==-1,i=e.indexOf("Trident/")!==-1;return r||i}const D0=7936,F0=7937,B0=7938,U0=35724,Gs={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},_e={};Object.keys(Gs).forEach(n=>{_e[n]=n});function V0(n){return typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&n._version===2)}function j0(n){const t=n.getExtension("WEBGL_debug_renderer_info"),e=n.getParameter(t&&t.UNMASKED_VENDOR_WEBGL||D0),r=n.getParameter(t&&t.UNMASKED_RENDERER_WEBGL||F0);return{gpuVendor:z0(e,r),vendor:e,renderer:r,version:n.getParameter(B0),shadingLanguageVersion:n.getParameter(U0)}}function z0(n,t){return n.match(/NVIDIA/i)||t.match(/NVIDIA/i)?"NVIDIA":n.match(/INTEL/i)||t.match(/INTEL/i)?"INTEL":n.match(/AMD/i)||t.match(/AMD/i)||n.match(/ATI/i)||t.match(/ATI/i)?"AMD":"UNKNOWN GPU"}const Ci={};function ka(n,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const r=Gs[t];if(Et(r,t),!N0(e))return!0;if(t in Ci)return Ci[t];const i=r[0],s=e.behavior||"enable",o="#extension GL_".concat(i," : ").concat(s,`
void main(void) {}`),a=n.createShader(35633);n.shaderSource(a,o),n.compileShader(a);const c=n.getShaderParameter(a,35713);return n.deleteShader(a),Ci[t]=c,c}function G0(n,t){const e=Gs[t];Et(e,t);const r=V0(n)&&e[1]||e[0],i=typeof r=="string"?Boolean(n.getExtension(r)):r;return Et(i===!1||i===!0),i}function ir(n,t){return t=Array.isArray(t)?t:[t],t.every(e=>G0(n,e))}function H0(n){switch(j0(n).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function W0(n,t,e){let r=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return ir(n,_e.GLSL_FRAG_DEPTH)&&(r+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),ir(n,_e.GLSL_DERIVATIVES)&&ka(n,_e.GLSL_DERIVATIVES)&&(r+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),ir(n,_e.GLSL_FRAG_DATA)&&ka(n,_e.GLSL_FRAG_DATA,{behavior:"require"})&&(r+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),ir(n,_e.GLSL_TEXTURE_LOD)&&(r+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),r}const X0=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,Y0=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,q0={[Dn]:X0,[zs]:Y0},_r="__LUMA_INJECT_DECLARATIONS__",Na=/void\s+main\s*\([^)]*\)\s*\{\n?/,Da=/}\n?[^{}]*$/,Oi=[];function Fa(n,t,e){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const i=t===Dn;for(const s in e){const o=e[s];o.sort((c,l)=>c.order-l.order),Oi.length=o.length;for(let c=0,l=o.length;c<l;++c)Oi[c]=o[c].injection;const a="".concat(Oi.join(`
`),`
`);switch(s){case"vs:#decl":i&&(n=n.replace(_r,a));break;case"vs:#main-start":i&&(n=n.replace(Na,c=>c+a));break;case"vs:#main-end":i&&(n=n.replace(Da,c=>a+c));break;case"fs:#decl":i||(n=n.replace(_r,a));break;case"fs:#main-start":i||(n=n.replace(Na,c=>c+a));break;case"fs:#main-end":i||(n=n.replace(Da,c=>a+c));break;default:n=n.replace(s,c=>c+a)}}return n=n.replace(_r,""),r&&(n=n.replace(/\}\s*$/,s=>s+q0[t])),n}function os(n){const t={};return Et(Array.isArray(n)&&n.length>1),n.forEach(e=>{for(const r in e)t[r]=t[r]?"".concat(t[r],`
`).concat(e[r]):e[r]}),t}function qe(n){return new RegExp("\\b".concat(n,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}const Dl=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],$0=[...Dl,[qe("attribute"),"in $1"],[qe("varying"),"out $1"]],Z0=[...Dl,[qe("varying"),"in $1"]],Fl=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],K0=[...Fl,[qe("in"),"attribute $1"],[qe("out"),"varying $1"]],Q0=[...Fl,[qe("in"),"varying $1"]],as="gl_FragColor",cs=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,J0=/void\s+main\s*\([^)]*\)\s*\{\n?/;function t_(n,t,e){switch(t){case 300:return e?Lr(n,$0):e_(n);case 100:return e?Lr(n,K0):n_(n);default:throw new Error("unknown GLSL version ".concat(t))}}function Lr(n,t){for(const[e,r]of t)n=n.replace(e,r);return n}function e_(n){n=Lr(n,Z0);const t=n.match(cs);if(t){const e=t[1];n=n.replace(new RegExp("\\b".concat(as,"\\b"),"g"),e)}else{const e="fragmentColor";n=n.replace(J0,r=>"out vec4 ".concat(e,`;
`).concat(r)).replace(new RegExp("\\b".concat(as,"\\b"),"g"),e)}return n}function n_(n){n=Lr(n,Q0);const t=n.match(cs);if(t){const e=t[1];n=n.replace(cs,"").replace(new RegExp("\\b".concat(e,"\\b"),"g"),as)}return n}const r_=`

`.concat(_r,`

`),Bl={[Dn]:"vertex",[zs]:"fragment"},i_=`precision highp float;

`;function s_(n,t){const{vs:e,fs:r}=t,i=O0(t.modules||[]);return{gl:n,vs:Ba(n,Object.assign({},t,{source:e,type:Dn,modules:i})),fs:Ba(n,Object.assign({},t,{source:r,type:zs,modules:i})),getUniforms:o_(i)}}function Ba(n,t){let{id:e,source:r,type:i,modules:s,defines:o={},hookFunctions:a=[],inject:c={},transpileToGLSL100:l=!1,prologue:u=!0,log:h}=t;Et(typeof r=="string","shader source must be a string");const g=i===Dn,m=r.split(`
`);let b=100,y="",v=r;m[0].indexOf("#version ")===0?(b=300,y=m[0],v=m.slice(1).join(`
`)):y="#version ".concat(b);const T={};s.forEach(N=>{Object.assign(T,N.getDefines())}),Object.assign(T,o);let A=u?"".concat(y,`
`).concat(c_({id:e,source:r,type:i}),`
`).concat(a_({type:i}),`
`).concat(H0(n),`
`).concat(W0(n),`
`).concat(l_(T),`
`).concat(g?"":i_,`
`):"".concat(y,`
`);const S=h_(a),x={},M={},R={};for(const N in c){const U=typeof c[N]=="string"?{injection:c[N],order:0}:c[N],k=N.match(/^(v|f)s:(#)?([\w-]+)$/);if(k){const D=k[2],F=k[3];D?F==="decl"?M[N]=[U]:R[N]=[U]:x[N]=[U]}else R[N]=[U]}for(const N of s){h&&N.checkDeprecations(v,h);const U=N.getModuleSource(i,b);A+=U;const k=N.injections[i];for(const D in k){const F=D.match(/^(v|f)s:#([\w-]+)$/);if(F){const et=F[2]==="decl"?M:R;et[D]=et[D]||[],et[D].push(k[D])}else x[D]=x[D]||[],x[D].push(k[D])}}return A+=r_,A=Fa(A,i,M),A+=u_(S[i],x),A+=v,A=Fa(A,i,R),A=t_(A,l?100:b,g),A}function o_(n){return function(e){const r={};for(const i of n){const s=i.getUniforms(e,r);Object.assign(r,s)}return r}}function a_(n){let{type:t}=n;return`
#define SHADER_TYPE_`.concat(Bl[t].toUpperCase(),`
`)}function c_(n){let{id:t,source:e,type:r}=n;return t&&typeof t=="string"&&e.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME `.concat(t,"_").concat(Bl[r],`

`):""}function l_(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=0,e="";for(const r in n){t===0&&(e+=`
// APPLICATION DEFINES
`),t++;const i=n[r];(i||Number.isFinite(i))&&(e+="#define ".concat(r.toUpperCase()," ").concat(n[r],`
`))}return t===0&&(e+=`
`),e}function u_(n,t){let e="";for(const r in n){const i=n[r];if(e+="void ".concat(i.signature,` {
`),i.header&&(e+="  ".concat(i.header)),t[r]){const s=t[r];s.sort((o,a)=>o.order-a.order);for(const o of s)e+="  ".concat(o.injection,`
`)}i.footer&&(e+="  ".concat(i.footer)),e+=`}
`}return e}function h_(n){const t={vs:{},fs:{}};return n.forEach(e=>{let r;typeof e!="string"?(r=e,e=r.hook):r={},e=e.trim();const[i,s]=e.split(":"),o=e.replace(/\(.+/,"");t[i][o]=Object.assign(r,{signature:s})}),t}const f_="void main() {gl_FragColor = vec4(0);}",Ul=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,d_=`#version 300 es
`.concat(Ul);function Vl(n,t){t=Array.isArray(t)?t:[t];const e=n.replace(/^\s+/,"").split(/\s+/),[r,i,s]=e;if(!t.includes(r)||!i||!s)return null;const o=s.split(";")[0];return{qualifier:r,type:i,name:o}}function jl(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{version:t=100,input:e,inputType:r,output:i}=n;if(!e)return t===300?d_:t>300?"#version ".concat(t,`
`).concat(Ul):f_;const s=m_(e,r);return t>=300?"#version ".concat(t," ").concat(t===300?"es":"",`
in `).concat(r," ").concat(e,`;
out vec4 `).concat(i,`;
void main() {
  `).concat(i," = ").concat(s,`;
}`):"varying ".concat(r," ").concat(e,`;
void main() {
  gl_FragColor = `).concat(s,`;
}`)}function g_(n){switch(n){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return Et(!1),null}}function p_(n){switch(n){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return Et(!1),null}}function m_(n,t){switch(t){case"float":return"vec4(".concat(n,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(n,", 0.0, 1.0)");case"vec3":return"vec4(".concat(n,", 1.0)");case"vec4":return n;default:return Et(!1),null}}const __=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,b_={name:"fp32",vs:__,fs:null};function Ua(n,t){if(!n)throw new Error("math.gl assertion ".concat(t))}const y_=1/Math.PI*180,v_=1/180*Math.PI,pt={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function zl(n,{precision:t=pt.precision}={}){return n=E_(n),"".concat(parseFloat(n.toPrecision(t)))}function $e(n){return Array.isArray(n)||ArrayBuffer.isView(n)&&!(n instanceof DataView)}function sr(n,t){return Hs(n,e=>e*v_,t)}function Oe(n,t){return Hs(n,e=>e*y_,t)}function Z(n,t,e){return Hs(n,r=>Math.max(t,Math.min(e,r)))}function Rr(n,t,e){return $e(n)?n.map((r,i)=>Rr(r,t[i],e)):e*t+(1-e)*n}function Yt(n,t,e){const r=pt.EPSILON;e&&(pt.EPSILON=e);try{if(n===t)return!0;if($e(n)&&$e(t)){if(n.length!==t.length)return!1;for(let i=0;i<n.length;++i)if(!Yt(n[i],t[i]))return!1;return!0}return n&&n.equals?n.equals(t):t&&t.equals?t.equals(n):typeof n=="number"&&typeof t=="number"?Math.abs(n-t)<=pt.EPSILON*Math.max(1,Math.abs(n),Math.abs(t)):!1}finally{pt.EPSILON=r}}function E_(n){return Math.round(n/pt.EPSILON)*pt.EPSILON}function T_(n){return n.clone?n.clone():new Array(n.length)}function Hs(n,t,e){if($e(n)){const r=n;e=e||T_(r);for(let i=0;i<e.length&&i<r.length;++i)e[i]=t(n[i],i,e);return e}return t(n)}function w_(n){function t(){var e=Reflect.construct(n,Array.from(arguments));return Object.setPrototypeOf(e,Object.getPrototypeOf(this)),e}return t.prototype=Object.create(n.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n,t}class Gl extends w_(Array){clone(){return new this.constructor().copy(this)}fromArray(t,e=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=t[r+e];return this.check()}toArray(t=[],e=0){for(let r=0;r<this.ELEMENTS;++r)t[e+r]=this[r];return t}from(t){return Array.isArray(t)?this.copy(t):this.fromObject(t)}to(t){return t===this?this:$e(t)?this.toArray(t):this.toObject(t)}toTarget(t){return t?this.to(t):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(pt)}formatString(t){let e="";for(let r=0;r<this.ELEMENTS;++r)e+=(r>0?", ":"")+zl(this[r],t);return"".concat(t.printTypes?this.constructor.name:"","[").concat(e,"]")}equals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(!Yt(this[e],t[e]))return!1;return!0}exactEquals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(this[e]!==t[e])return!1;return!0}negate(){for(let t=0;t<this.ELEMENTS;++t)this[t]=-this[t];return this.check()}lerp(t,e,r){if(r===void 0)return this.lerp(this,t,e);for(let i=0;i<this.ELEMENTS;++i){const s=t[i];this[i]=s+r*(e[i]-s)}return this.check()}min(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.min(t[e],this[e]);return this.check()}max(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.max(t[e],this[e]);return this.check()}clamp(t,e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],t[r]),e[r]);return this.check()}add(...t){for(const e of t)for(let r=0;r<this.ELEMENTS;++r)this[r]+=e[r];return this.check()}subtract(...t){for(const e of t)for(let r=0;r<this.ELEMENTS;++r)this[r]-=e[r];return this.check()}scale(t){if(typeof t=="number")for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;else for(let e=0;e<this.ELEMENTS&&e<t.length;++e)this[e]*=t[e];return this.check()}multiplyByScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}check(){if(pt.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let t=this.length===this.ELEMENTS;for(let e=0;e<this.ELEMENTS;++e)t=t&&Number.isFinite(this[e]);return t}sub(t){return this.subtract(t)}setScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=t;return this.check()}addScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]+=t;return this.check()}subScalar(t){return this.addScalar(-t)}multiplyScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}divideScalar(t){return this.multiplyByScalar(1/t)}clampScalar(t,e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],t),e);return this.check()}get elements(){return this}}function A_(n,t){if(n.length!==t)return!1;for(let e=0;e<n.length;++e)if(!Number.isFinite(n[e]))return!1;return!0}function yt(n){if(!Number.isFinite(n))throw new Error("Invalid number ".concat(n));return n}function ki(n,t,e=""){if(pt.debug&&!A_(n,t))throw new Error("math.gl: ".concat(e," some fields set to invalid numbers'"));return n}class S_ extends Gl{get x(){return this[0]}set x(t){this[0]=yt(t)}get y(){return this[1]}set y(t){this[1]=yt(t)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let t=0;for(let e=0;e<this.ELEMENTS;++e)t+=this[e]*this[e];return t}magnitudeSquared(){return this.lengthSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceSquared(t){let e=0;for(let r=0;r<this.ELEMENTS;++r){const i=this[r]-t[r];e+=i*i}return yt(e)}dot(t){let e=0;for(let r=0;r<this.ELEMENTS;++r)e+=this[r]*t[r];return yt(e)}normalize(){const t=this.magnitude();if(t!==0)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t;return this.check()}multiply(...t){for(const e of t)for(let r=0;r<this.ELEMENTS;++r)this[r]*=e[r];return this.check()}divide(...t){for(const e of t)for(let r=0;r<this.ELEMENTS;++r)this[r]/=e[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(t){return this.distance(t)}distanceToSquared(t){return this.distanceSquared(t)}getComponent(t){return Ua(t>=0&&t<this.ELEMENTS,"index is out of range"),yt(this[t])}setComponent(t,e){return Ua(t>=0&&t<this.ELEMENTS,"index is out of range"),this[t]=e,this.check()}addVectors(t,e){return this.copy(t).add(e)}subVectors(t,e){return this.copy(t).subtract(e)}multiplyVectors(t,e){return this.copy(t).multiply(e)}addScaledVector(t,e){return this.add(new this.constructor(t).multiplyScalar(e))}}var br=1e-6,Ze=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});function x_(){var n=new Ze(2);return Ze!=Float32Array&&(n[0]=0,n[1]=0),n}function Ir(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n}function Hl(n,t){return n[0]=-t[0],n[1]=-t[1],n}function Wl(n,t,e,r){var i=t[0],s=t[1];return n[0]=i+r*(e[0]-i),n[1]=s+r*(e[1]-s),n}function P_(n,t,e){var r=t[0],i=t[1];return n[0]=e[0]*r+e[4]*i+e[12],n[1]=e[1]*r+e[5]*i+e[13],n}(function(){var n=x_();return function(t,e,r,i,s,o){var a,c;for(e||(e=2),r||(r=0),i?c=Math.min(i*e+r,t.length):c=t.length,a=r;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],s(n,n,o),t[a]=n[0],t[a+1]=n[1];return t}})();function M_(n,t,e){const r=t[0],i=t[1],s=e[3]*r+e[7]*i||1;return n[0]=(e[0]*r+e[4]*i)/s,n[1]=(e[1]*r+e[5]*i)/s,n}function Xl(n,t,e){const r=t[0],i=t[1],s=t[2],o=e[3]*r+e[7]*i+e[11]*s||1;return n[0]=(e[0]*r+e[4]*i+e[8]*s)/o,n[1]=(e[1]*r+e[5]*i+e[9]*s)/o,n[2]=(e[2]*r+e[6]*i+e[10]*s)/o,n}function L_(n,t,e){const r=t[0],i=t[1];return n[0]=e[0]*r+e[2]*i,n[1]=e[1]*r+e[3]*i,n[2]=t[2],n}function R_(){var n=new Ze(3);return Ze!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function Yl(n){var t=n[0],e=n[1],r=n[2];return Math.hypot(t,e,r)}function I_(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n}function C_(n){var t=n[0],e=n[1],r=n[2];return t*t+e*e+r*r}function O_(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n}function k_(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function N_(n,t,e){var r=t[0],i=t[1],s=t[2],o=e[0],a=e[1],c=e[2];return n[0]=i*c-s*a,n[1]=s*o-r*c,n[2]=r*a-i*o,n}function D_(n,t,e,r){var i=t[0],s=t[1],o=t[2];return n[0]=i+r*(e[0]-i),n[1]=s+r*(e[1]-s),n[2]=o+r*(e[2]-o),n}function ql(n,t,e){var r=t[0],i=t[1],s=t[2],o=e[3]*r+e[7]*i+e[11]*s+e[15];return o=o||1,n[0]=(e[0]*r+e[4]*i+e[8]*s+e[12])/o,n[1]=(e[1]*r+e[5]*i+e[9]*s+e[13])/o,n[2]=(e[2]*r+e[6]*i+e[10]*s+e[14])/o,n}function F_(n,t,e){var r=t[0],i=t[1],s=t[2];return n[0]=r*e[0]+i*e[3]+s*e[6],n[1]=r*e[1]+i*e[4]+s*e[7],n[2]=r*e[2]+i*e[5]+s*e[8],n}function B_(n,t,e){var r=e[0],i=e[1],s=e[2],o=e[3],a=t[0],c=t[1],l=t[2],u=i*l-s*c,h=s*a-r*l,g=r*c-i*a,m=i*g-s*h,b=s*u-r*g,y=r*h-i*u,v=o*2;return u*=v,h*=v,g*=v,m*=2,b*=2,y*=2,n[0]=a+u+m,n[1]=c+h+b,n[2]=l+g+y,n}function U_(n,t,e,r){var i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[0],s[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),s[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function V_(n,t,e,r){var i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),s[1]=i[1],s[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function j_(n,t,e,r){var i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),s[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),s[2]=i[2],n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function z_(n,t){var e=n[0],r=n[1],i=n[2],s=t[0],o=t[1],a=t[2],c=Math.sqrt(e*e+r*r+i*i),l=Math.sqrt(s*s+o*o+a*a),u=c*l,h=u&&k_(n,t)/u;return Math.acos(Math.min(Math.max(h,-1),1))}var $l=I_,G_=Yl,Ni=C_;(function(){var n=R_();return function(t,e,r,i,s,o){var a,c;for(e||(e=3),r||(r=0),i?c=Math.min(i*e+r,t.length):c=t.length,a=r;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2];return t}})();const Di=[0,0,0];let or;class Mt extends S_{static get ZERO(){return or||(or=new Mt(0,0,0),Object.freeze(or)),or}constructor(t=0,e=0,r=0){super(-0,-0,-0),arguments.length===1&&$e(t)?this.copy(t):(pt.debug&&(yt(t),yt(e),yt(r)),this[0]=t,this[1]=e,this[2]=r)}set(t,e,r){return this[0]=t,this[1]=e,this[2]=r,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.check()}fromObject(t){return pt.debug&&(yt(t.x),yt(t.y),yt(t.z)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t}get ELEMENTS(){return 3}get z(){return this[2]}set z(t){this[2]=yt(t)}angle(t){return z_(this,t)}cross(t){return N_(this,this,t),this.check()}rotateX({radians:t,origin:e=Di}){return U_(this,this,e,t),this.check()}rotateY({radians:t,origin:e=Di}){return V_(this,this,e,t),this.check()}rotateZ({radians:t,origin:e=Di}){return j_(this,this,e,t),this.check()}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return ql(this,this,t),this.check()}transformAsVector(t){return Xl(this,this,t),this.check()}transformByMatrix3(t){return F_(this,this,t),this.check()}transformByMatrix2(t){return L_(this,this,t),this.check()}transformByQuaternion(t){return B_(this,this,t),this.check()}}class H_ extends Gl{toString(){let t="[";if(pt.printRowMajor){t+="row-major:";for(let e=0;e<this.RANK;++e)for(let r=0;r<this.RANK;++r)t+=" ".concat(this[r*this.RANK+e])}else{t+="column-major:";for(let e=0;e<this.ELEMENTS;++e)t+=" ".concat(this[e])}return t+="]",t}getElementIndex(t,e){return e*this.RANK+t}getElement(t,e){return this[e*this.RANK+t]}setElement(t,e,r){return this[e*this.RANK+t]=yt(r),this}getColumn(t,e=new Array(this.RANK).fill(-0)){const r=t*this.RANK;for(let i=0;i<this.RANK;++i)e[i]=this[r+i];return e}setColumn(t,e){const r=t*this.RANK;for(let i=0;i<this.RANK;++i)this[r+i]=e[i];return this}}function W_(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function X_(n,t){if(n===t){var e=t[1],r=t[2],i=t[3],s=t[6],o=t[7],a=t[11];n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=e,n[6]=t[9],n[7]=t[13],n[8]=r,n[9]=s,n[11]=t[14],n[12]=i,n[13]=o,n[14]=a}else n[0]=t[0],n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=t[1],n[5]=t[5],n[6]=t[9],n[7]=t[13],n[8]=t[2],n[9]=t[6],n[10]=t[10],n[11]=t[14],n[12]=t[3],n[13]=t[7],n[14]=t[11],n[15]=t[15];return n}function ls(n,t){var e=t[0],r=t[1],i=t[2],s=t[3],o=t[4],a=t[5],c=t[6],l=t[7],u=t[8],h=t[9],g=t[10],m=t[11],b=t[12],y=t[13],v=t[14],T=t[15],A=e*a-r*o,S=e*c-i*o,x=e*l-s*o,M=r*c-i*a,R=r*l-s*a,N=i*l-s*c,U=u*y-h*b,k=u*v-g*b,D=u*T-m*b,F=h*v-g*y,J=h*T-m*y,et=g*T-m*v,z=A*et-S*J+x*F+M*D-R*k+N*U;return z?(z=1/z,n[0]=(a*et-c*J+l*F)*z,n[1]=(i*J-r*et-s*F)*z,n[2]=(y*N-v*R+T*M)*z,n[3]=(g*R-h*N-m*M)*z,n[4]=(c*D-o*et-l*k)*z,n[5]=(e*et-i*D+s*k)*z,n[6]=(v*x-b*N-T*S)*z,n[7]=(u*N-g*x+m*S)*z,n[8]=(o*J-a*D+l*U)*z,n[9]=(r*D-e*J-s*U)*z,n[10]=(b*R-y*x+T*A)*z,n[11]=(h*x-u*R-m*A)*z,n[12]=(a*k-o*F-c*U)*z,n[13]=(e*F-r*k+i*U)*z,n[14]=(y*S-b*M-v*A)*z,n[15]=(u*M-h*S+g*A)*z,n):null}function Y_(n){var t=n[0],e=n[1],r=n[2],i=n[3],s=n[4],o=n[5],a=n[6],c=n[7],l=n[8],u=n[9],h=n[10],g=n[11],m=n[12],b=n[13],y=n[14],v=n[15],T=t*o-e*s,A=t*a-r*s,S=t*c-i*s,x=e*a-r*o,M=e*c-i*o,R=r*c-i*a,N=l*b-u*m,U=l*y-h*m,k=l*v-g*m,D=u*y-h*b,F=u*v-g*b,J=h*v-g*y;return T*J-A*F+S*D+x*k-M*U+R*N}function ve(n,t,e){var r=t[0],i=t[1],s=t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=t[8],g=t[9],m=t[10],b=t[11],y=t[12],v=t[13],T=t[14],A=t[15],S=e[0],x=e[1],M=e[2],R=e[3];return n[0]=S*r+x*a+M*h+R*y,n[1]=S*i+x*c+M*g+R*v,n[2]=S*s+x*l+M*m+R*T,n[3]=S*o+x*u+M*b+R*A,S=e[4],x=e[5],M=e[6],R=e[7],n[4]=S*r+x*a+M*h+R*y,n[5]=S*i+x*c+M*g+R*v,n[6]=S*s+x*l+M*m+R*T,n[7]=S*o+x*u+M*b+R*A,S=e[8],x=e[9],M=e[10],R=e[11],n[8]=S*r+x*a+M*h+R*y,n[9]=S*i+x*c+M*g+R*v,n[10]=S*s+x*l+M*m+R*T,n[11]=S*o+x*u+M*b+R*A,S=e[12],x=e[13],M=e[14],R=e[15],n[12]=S*r+x*a+M*h+R*y,n[13]=S*i+x*c+M*g+R*v,n[14]=S*s+x*l+M*m+R*T,n[15]=S*o+x*u+M*b+R*A,n}function Cr(n,t,e){var r=e[0],i=e[1],s=e[2],o,a,c,l,u,h,g,m,b,y,v,T;return t===n?(n[12]=t[0]*r+t[4]*i+t[8]*s+t[12],n[13]=t[1]*r+t[5]*i+t[9]*s+t[13],n[14]=t[2]*r+t[6]*i+t[10]*s+t[14],n[15]=t[3]*r+t[7]*i+t[11]*s+t[15]):(o=t[0],a=t[1],c=t[2],l=t[3],u=t[4],h=t[5],g=t[6],m=t[7],b=t[8],y=t[9],v=t[10],T=t[11],n[0]=o,n[1]=a,n[2]=c,n[3]=l,n[4]=u,n[5]=h,n[6]=g,n[7]=m,n[8]=b,n[9]=y,n[10]=v,n[11]=T,n[12]=o*r+u*i+b*s+t[12],n[13]=a*r+h*i+y*s+t[13],n[14]=c*r+g*i+v*s+t[14],n[15]=l*r+m*i+T*s+t[15]),n}function Ws(n,t,e){var r=e[0],i=e[1],s=e[2];return n[0]=t[0]*r,n[1]=t[1]*r,n[2]=t[2]*r,n[3]=t[3]*r,n[4]=t[4]*i,n[5]=t[5]*i,n[6]=t[6]*i,n[7]=t[7]*i,n[8]=t[8]*s,n[9]=t[9]*s,n[10]=t[10]*s,n[11]=t[11]*s,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function q_(n,t,e,r){var i=r[0],s=r[1],o=r[2],a=Math.hypot(i,s,o),c,l,u,h,g,m,b,y,v,T,A,S,x,M,R,N,U,k,D,F,J,et,z,ue;return a<br?null:(a=1/a,i*=a,s*=a,o*=a,c=Math.sin(e),l=Math.cos(e),u=1-l,h=t[0],g=t[1],m=t[2],b=t[3],y=t[4],v=t[5],T=t[6],A=t[7],S=t[8],x=t[9],M=t[10],R=t[11],N=i*i*u+l,U=s*i*u+o*c,k=o*i*u-s*c,D=i*s*u-o*c,F=s*s*u+l,J=o*s*u+i*c,et=i*o*u+s*c,z=s*o*u-i*c,ue=o*o*u+l,n[0]=h*N+y*U+S*k,n[1]=g*N+v*U+x*k,n[2]=m*N+T*U+M*k,n[3]=b*N+A*U+R*k,n[4]=h*D+y*F+S*J,n[5]=g*D+v*F+x*J,n[6]=m*D+T*F+M*J,n[7]=b*D+A*F+R*J,n[8]=h*et+y*z+S*ue,n[9]=g*et+v*z+x*ue,n[10]=m*et+T*z+M*ue,n[11]=b*et+A*z+R*ue,t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n)}function Zl(n,t,e){var r=Math.sin(e),i=Math.cos(e),s=t[4],o=t[5],a=t[6],c=t[7],l=t[8],u=t[9],h=t[10],g=t[11];return t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[4]=s*i+l*r,n[5]=o*i+u*r,n[6]=a*i+h*r,n[7]=c*i+g*r,n[8]=l*i-s*r,n[9]=u*i-o*r,n[10]=h*i-a*r,n[11]=g*i-c*r,n}function $_(n,t,e){var r=Math.sin(e),i=Math.cos(e),s=t[0],o=t[1],a=t[2],c=t[3],l=t[8],u=t[9],h=t[10],g=t[11];return t!==n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=s*i-l*r,n[1]=o*i-u*r,n[2]=a*i-h*r,n[3]=c*i-g*r,n[8]=s*r+l*i,n[9]=o*r+u*i,n[10]=a*r+h*i,n[11]=c*r+g*i,n}function Kl(n,t,e){var r=Math.sin(e),i=Math.cos(e),s=t[0],o=t[1],a=t[2],c=t[3],l=t[4],u=t[5],h=t[6],g=t[7];return t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=s*i+l*r,n[1]=o*i+u*r,n[2]=a*i+h*r,n[3]=c*i+g*r,n[4]=l*i-s*r,n[5]=u*i-o*r,n[6]=h*i-a*r,n[7]=g*i-c*r,n}function Z_(n,t){var e=t[0],r=t[1],i=t[2],s=t[3],o=e+e,a=r+r,c=i+i,l=e*o,u=r*o,h=r*a,g=i*o,m=i*a,b=i*c,y=s*o,v=s*a,T=s*c;return n[0]=1-h-b,n[1]=u+T,n[2]=g-v,n[3]=0,n[4]=u-T,n[5]=1-l-b,n[6]=m+y,n[7]=0,n[8]=g+v,n[9]=m-y,n[10]=1-l-h,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function K_(n,t,e,r,i,s,o){var a=1/(e-t),c=1/(i-r),l=1/(s-o);return n[0]=s*2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s*2*c,n[6]=0,n[7]=0,n[8]=(e+t)*a,n[9]=(i+r)*c,n[10]=(o+s)*l,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*s*2*l,n[15]=0,n}function Q_(n,t,e,r,i){var s=1/Math.tan(t/2),o;return n[0]=s/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==1/0?(o=1/(r-i),n[10]=(i+r)*o,n[14]=2*i*r*o):(n[10]=-1,n[14]=-2*r),n}var J_=Q_;function tb(n,t,e,r,i,s,o){var a=1/(t-e),c=1/(r-i),l=1/(s-o);return n[0]=-2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*l,n[11]=0,n[12]=(t+e)*a,n[13]=(i+r)*c,n[14]=(o+s)*l,n[15]=1,n}var eb=tb;function nb(n,t,e,r){var i,s,o,a,c,l,u,h,g,m,b=t[0],y=t[1],v=t[2],T=r[0],A=r[1],S=r[2],x=e[0],M=e[1],R=e[2];return Math.abs(b-x)<br&&Math.abs(y-M)<br&&Math.abs(v-R)<br?W_(n):(u=b-x,h=y-M,g=v-R,m=1/Math.hypot(u,h,g),u*=m,h*=m,g*=m,i=A*g-S*h,s=S*u-T*g,o=T*h-A*u,m=Math.hypot(i,s,o),m?(m=1/m,i*=m,s*=m,o*=m):(i=0,s=0,o=0),a=h*o-g*s,c=g*i-u*o,l=u*s-h*i,m=Math.hypot(a,c,l),m?(m=1/m,a*=m,c*=m,l*=m):(a=0,c=0,l=0),n[0]=i,n[1]=a,n[2]=u,n[3]=0,n[4]=s,n[5]=c,n[6]=h,n[7]=0,n[8]=o,n[9]=l,n[10]=g,n[11]=0,n[12]=-(i*b+s*y+o*v),n[13]=-(a*b+c*y+l*v),n[14]=-(u*b+h*y+g*v),n[15]=1,n)}function rb(){var n=new Ze(4);return Ze!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function Ql(n,t,e){return n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n[3]=t[3]*e,n}function Qe(n,t,e){var r=t[0],i=t[1],s=t[2],o=t[3];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12]*o,n[1]=e[1]*r+e[5]*i+e[9]*s+e[13]*o,n[2]=e[2]*r+e[6]*i+e[10]*s+e[14]*o,n[3]=e[3]*r+e[7]*i+e[11]*s+e[15]*o,n}(function(){var n=rb();return function(t,e,r,i,s,o){var a,c;for(e||(e=4),r||(r=0),i?c=Math.min(i*e+r,t.length):c=t.length,a=r;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],n[3]=t[a+3],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2],t[a+3]=n[3];return t}})();var us;(function(n){n[n.COL0ROW0=0]="COL0ROW0",n[n.COL0ROW1=1]="COL0ROW1",n[n.COL0ROW2=2]="COL0ROW2",n[n.COL0ROW3=3]="COL0ROW3",n[n.COL1ROW0=4]="COL1ROW0",n[n.COL1ROW1=5]="COL1ROW1",n[n.COL1ROW2=6]="COL1ROW2",n[n.COL1ROW3=7]="COL1ROW3",n[n.COL2ROW0=8]="COL2ROW0",n[n.COL2ROW1=9]="COL2ROW1",n[n.COL2ROW2=10]="COL2ROW2",n[n.COL2ROW3=11]="COL2ROW3",n[n.COL3ROW0=12]="COL3ROW0",n[n.COL3ROW1=13]="COL3ROW1",n[n.COL3ROW2=14]="COL3ROW2",n[n.COL3ROW3=15]="COL3ROW3"})(us||(us={}));const ib=45*Math.PI/180,sb=1,Fi=.1,Bi=500,ob=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class ct extends H_{static get IDENTITY(){return cb()}static get ZERO(){return ab()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return us}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15],this.check()}set(t,e,r,i,s,o,a,c,l,u,h,g,m,b,y,v){return this[0]=t,this[1]=e,this[2]=r,this[3]=i,this[4]=s,this[5]=o,this[6]=a,this[7]=c,this[8]=l,this[9]=u,this[10]=h,this[11]=g,this[12]=m,this[13]=b,this[14]=y,this[15]=v,this.check()}setRowMajor(t,e,r,i,s,o,a,c,l,u,h,g,m,b,y,v){return this[0]=t,this[1]=s,this[2]=l,this[3]=m,this[4]=e,this[5]=o,this[6]=u,this[7]=b,this[8]=r,this[9]=a,this[10]=h,this[11]=y,this[12]=i,this[13]=c,this[14]=g,this[15]=v,this.check()}toRowMajor(t){return t[0]=this[0],t[1]=this[4],t[2]=this[8],t[3]=this[12],t[4]=this[1],t[5]=this[5],t[6]=this[9],t[7]=this[13],t[8]=this[2],t[9]=this[6],t[10]=this[10],t[11]=this[14],t[12]=this[3],t[13]=this[7],t[14]=this[11],t[15]=this[15],t}identity(){return this.copy(ob)}fromObject(t){return this.check()}fromQuaternion(t){return Z_(this,t),this.check()}frustum(t){const{left:e,right:r,bottom:i,top:s,near:o=Fi,far:a=Bi}=t;return a===1/0?lb(this,e,r,i,s,o):K_(this,e,r,i,s,o,a),this.check()}lookAt(t){const{eye:e,center:r=[0,0,0],up:i=[0,1,0]}=t;return nb(this,e,r,i),this.check()}ortho(t){const{left:e,right:r,bottom:i,top:s,near:o=Fi,far:a=Bi}=t;return eb(this,e,r,i,s,o,a),this.check()}orthographic(t){const{fovy:e=ib,aspect:r=sb,focalDistance:i=1,near:s=Fi,far:o=Bi}=t;Va(e);const a=e/2,c=i*Math.tan(a),l=c*r;return this.ortho({left:-l,right:l,bottom:-c,top:c,near:s,far:o})}perspective(t){const{fovy:e=45*Math.PI/180,aspect:r=1,near:i=.1,far:s=500}=t;return Va(e),J_(this,e,r,i,s),this.check()}determinant(){return Y_(this)}getScale(t=[-0,-0,-0]){return t[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),t[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),t[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),t}getTranslation(t=[-0,-0,-0]){return t[0]=this[12],t[1]=this[13],t[2]=this[14],t}getRotation(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],e=e||[-0,-0,-0];const r=this.getScale(e),i=1/r[0],s=1/r[1],o=1/r[2];return t[0]=this[0]*i,t[1]=this[1]*s,t[2]=this[2]*o,t[3]=0,t[4]=this[4]*i,t[5]=this[5]*s,t[6]=this[6]*o,t[7]=0,t[8]=this[8]*i,t[9]=this[9]*s,t[10]=this[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getRotationMatrix3(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0],e=e||[-0,-0,-0];const r=this.getScale(e),i=1/r[0],s=1/r[1],o=1/r[2];return t[0]=this[0]*i,t[1]=this[1]*s,t[2]=this[2]*o,t[3]=this[4]*i,t[4]=this[5]*s,t[5]=this[6]*o,t[6]=this[8]*i,t[7]=this[9]*s,t[8]=this[10]*o,t}transpose(){return X_(this,this),this.check()}invert(){return ls(this,this),this.check()}multiplyLeft(t){return ve(this,t,this),this.check()}multiplyRight(t){return ve(this,this,t),this.check()}rotateX(t){return Zl(this,this,t),this.check()}rotateY(t){return $_(this,this,t),this.check()}rotateZ(t){return Kl(this,this,t),this.check()}rotateXYZ(t){return this.rotateX(t[0]).rotateY(t[1]).rotateZ(t[2])}rotateAxis(t,e){return q_(this,this,t,e),this.check()}scale(t){return Ws(this,this,Array.isArray(t)?t:[t,t,t]),this.check()}translate(t){return Cr(this,this,t),this.check()}transform(t,e){return t.length===4?(e=Qe(e||[-0,-0,-0,-0],t,this),ki(e,4),e):this.transformAsPoint(t,e)}transformAsPoint(t,e){const{length:r}=t;let i;switch(r){case 2:i=P_(e||[-0,-0],t,this);break;case 3:i=ql(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return ki(i,t.length),i}transformAsVector(t,e){let r;switch(t.length){case 2:r=M_(e||[-0,-0],t,this);break;case 3:r=Xl(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return ki(r,t.length),r}transformPoint(t,e){return this.transformAsPoint(t,e)}transformVector(t,e){return this.transformAsPoint(t,e)}transformDirection(t,e){return this.transformAsVector(t,e)}makeRotationX(t){return this.identity().rotateX(t)}makeTranslation(t,e,r){return this.identity().translate([t,e,r])}}let ar,cr;function ab(){return ar||(ar=new ct([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(ar)),ar}function cb(){return cr||(cr=new ct,Object.freeze(cr)),cr}function Va(n){if(n>Math.PI*2)throw Error("expected radians")}function lb(n,t,e,r,i,s){const o=2*s/(e-t),a=2*s/(i-r),c=(e+t)/(e-t),l=(i+r)/(i-r),u=-1,h=-1,g=-2*s;return n[0]=o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=c,n[9]=l,n[10]=u,n[11]=h,n[12]=0,n[13]=0,n[14]=g,n[15]=0,n}const ja=1e-6,ub=6371e3;class $r{constructor({phi:t=0,theta:e=0,radius:r=1,bearing:i,pitch:s,altitude:o,radiusScale:a=ub}={}){f(this,"phi",void 0),f(this,"theta",void 0),f(this,"radius",void 0),f(this,"radiusScale",void 0),this.phi=t,this.theta=e,this.radius=r||o||1,this.radiusScale=a||1,i!==void 0&&(this.bearing=i),s!==void 0&&(this.pitch=s),this.check()}toString(){return this.formatString(pt)}formatString({printTypes:t=!1}){const e=zl;return"".concat(t?"Spherical":"","[rho:").concat(e(this.radius),",theta:").concat(e(this.theta),",phi:").concat(e(this.phi),"]")}equals(t){return Yt(this.radius,t.radius)&&Yt(this.theta,t.theta)&&Yt(this.phi,t.phi)}exactEquals(t){return this.radius===t.radius&&this.theta===t.theta&&this.phi===t.phi}get bearing(){return 180-Oe(this.phi)}set bearing(t){this.phi=Math.PI-sr(t)}get pitch(){return Oe(this.theta)}set pitch(t){this.theta=sr(t)}get longitude(){return Oe(this.phi)}get latitude(){return Oe(this.theta)}get lng(){return Oe(this.phi)}get lat(){return Oe(this.theta)}get z(){return(this.radius-1)*this.radiusScale}set(t,e,r){return this.radius=t,this.phi=e,this.theta=r,this.check()}clone(){return new $r().copy(this)}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this.check()}fromLngLatZ([t,e,r]){return this.radius=1+r/this.radiusScale,this.phi=sr(e),this.theta=sr(t),this.check()}fromVector3(t){return this.radius=Yl(t),this.radius>0&&(this.theta=Math.atan2(t[0],t[1]),this.phi=Math.acos(Z(t[2]/this.radius,-1,1))),this.check()}toVector3(){return new Mt(0,0,this.radius).rotateX({radians:this.theta}).rotateZ({radians:this.phi})}makeSafe(){return this.phi=Math.max(ja,Math.min(Math.PI-ja,this.phi)),this}check(){if(!Number.isFinite(this.phi)||!Number.isFinite(this.theta)||!(this.radius>0))throw new Error("SphericalCoordinates: some fields set to invalid numbers");return this}}const hb=new Uint8Array([0,255,255,255]),fb={pickingSelectedColor:null,pickingHighlightColor:hb,pickingActive:!1,pickingAttribute:!1};function db(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:fb;const t={};if(n.pickingSelectedColor!==void 0)if(!n.pickingSelectedColor)t.picking_uSelectedColorValid=0;else{const e=n.pickingSelectedColor.slice(0,3);t.picking_uSelectedColorValid=1,t.picking_uSelectedColor=e}if(n.pickingHighlightColor){const e=Array.from(n.pickingHighlightColor,r=>r/255);Number.isFinite(e[3])||(e[3]=1),t.picking_uHighlightColor=e}return n.pickingActive!==void 0&&(t.picking_uActive=Boolean(n.pickingActive),t.picking_uAttribute=Boolean(n.pickingAttribute)),t}const gb=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,pb=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,mb={name:"picking",vs:gb,fs:pb,getUniforms:db},_b=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,bb={name:"transform",vs:_b,fs:null};class Fn{static getDefaultProgramManager(t){return t.luma=t.luma||{},t.luma.defaultProgramManager=t.luma.defaultProgramManager||new Fn(t),t.luma.defaultProgramManager}constructor(t){this.gl=t,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(t){this._defaultModules.find(e=>e.name===t.name)||this._defaultModules.push(t),this.stateHash++}removeDefaultModule(t){const e=typeof t=="string"?t:t.name;this._defaultModules=this._defaultModules.filter(r=>r.name!==e),this.stateHash++}addShaderHook(t,e){e&&(t=Object.assign(e,{hook:t})),this._hookFunctions.push(t),this.stateHash++}get(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{vs:e="",fs:r="",defines:i={},inject:s={},varyings:o=[],bufferMode:a=35981,transpileToGLSL100:c=!1}=t,l=this._getModuleList(t.modules),u=this._getHash(e),h=this._getHash(r),g=l.map(S=>this._getHash(S.name)).sort(),m=o.map(S=>this._getHash(S)),b=Object.keys(i).sort(),y=Object.keys(s).sort(),v=[],T=[];for(const S of b)v.push(this._getHash(S)),v.push(this._getHash(i[S]));for(const S of y)T.push(this._getHash(S)),T.push(this._getHash(s[S]));const A="".concat(u,"/").concat(h,"D").concat(v.join("/"),"M").concat(g.join("/"),"I").concat(T.join("/"),"V").concat(m.join("/"),"H").concat(this.stateHash,"B").concat(a).concat(c?"T":"");if(!this._programCache[A]){const S=s_(this.gl,{vs:e,fs:r,modules:l,inject:s,defines:i,hookFunctions:this._hookFunctions,transpileToGLSL100:c});this._programCache[A]=new Cl(this.gl,{hash:A,vs:S.vs,fs:S.fs,varyings:o,bufferMode:a}),this._getUniforms[A]=S.getUniforms||(x=>{}),this._useCounts[A]=0}return this._useCounts[A]++,this._programCache[A]}getUniforms(t){return this._getUniforms[t.hash]||null}release(t){const e=t.hash;this._useCounts[e]--,this._useCounts[e]===0&&(this._programCache[e].delete(),delete this._programCache[e],delete this._getUniforms[e],delete this._useCounts[e])}_getHash(t){return this._hashes[t]===void 0&&(this._hashes[t]=this._hashCounter++),this._hashes[t]}_getModuleList(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=new Array(this._defaultModules.length+t.length),r={};let i=0;for(let s=0,o=this._defaultModules.length;s<o;++s){const a=this._defaultModules[s],c=a.name;e[i++]=a,r[c]=!0}for(let s=0,o=t.length;s<o;++s){const a=t[s],c=a.name;r[c]||(e[i++]=a,r[c]=!0)}return e.length=i,e}}const yb={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function vb(n,t,e){const r={};let i=t.indices;for(const s in t.attributes){const o=t.attributes[s],a=Eb(s,e);if(s==="indices")i=o;else if(o.constant)r[a]=o.value;else{const c=o.value,l={...o};delete l.value,r[a]=[new W(n,c),l],Tb(s,l)}}if(i){const s=i.value||i;C(s instanceof Uint16Array||s instanceof Uint32Array,'attribute array for "indices" must be of integer type');const o={size:1,isIndexed:i.isIndexed===void 0?!0:i.isIndexed};r.indices=[new W(n,{data:s,target:34963}),o]}return r}function Eb(n,t){const{attributeMap:e=yb}=t||{};return e&&e[n]||n}function Tb(n,t){let e;switch(n){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":e="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":e="vectors";break}switch(e){case"vectors":t.size=t.size||3;break;case"uvs":t.size=t.size||2;break}C(Number.isFinite(t.size),"attribute ".concat(n," needs size"))}const ke=2,wb=1e4,Ab="Model needs drawMode and vertexCount",za=()=>{},Sb={};class xb{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{id:r=Ee("model")}=e;C(Xr(t)),this.id=r,this.gl=t,this.id=e.id||Ee("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(e)}initialize(t){this.props={},this.programManager=t.programManager||Fn.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;const{program:e=null,vs:r,fs:i,modules:s,defines:o,inject:a,varyings:c,bufferMode:l,transpileToGLSL100:u}=t;this.programProps={program:e,vs:r,fs:i,modules:s,defines:o,inject:a,varyings:c,bufferMode:l,transpileToGLSL100:u},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(t.moduleSettings))),this.drawMode=t.drawMode!==void 0?t.drawMode:4,this.vertexCount=t.vertexCount||0,this.geometryBuffers={},this.isInstanced=t.isInstanced||t.instanced||t.instanceCount>0,this._setModelProps(t),this.geometry={},C(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),Ab)}setProps(t){this._setModelProps(t)}delete(){for(const t in this._attributes)this._attributes[t]!==this.attributes[t]&&this._attributes[t].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(t){const{program:e,vs:r,fs:i,modules:s,defines:o,inject:a,varyings:c,bufferMode:l,transpileToGLSL100:u}=t;this.programProps={program:e,vs:r,fs:i,modules:s,defines:o,inject:a,varyings:c,bufferMode:l,transpileToGLSL100:u},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(t){return this.drawMode=t,this}setVertexCount(t){return C(Number.isFinite(t)),this.vertexCount=t,this}setInstanceCount(t){return C(Number.isFinite(t)),this.instanceCount=t,this}setGeometry(t){return this.drawMode=t.drawMode,this.vertexCount=t.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=vb(this.gl,t),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Xe(t))return this;const e={};for(const r in t){const i=t[r];e[r]=i.getValue?i.getValue():i}return this.vertexArray.setAttributes(e),this}setUniforms(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Object.assign(this.uniforms,t),this}getModuleUniforms(t){this._checkProgram();const e=this.programManager.getUniforms(this.program);return e?e(t):{}}updateModuleSettings(t){const e=this.getModuleUniforms(t||{});return this.setUniforms(e)}clear(t){return Vs(this.program.gl,t),this}draw(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._checkProgram();const{moduleSettings:e=null,framebuffer:r,uniforms:i={},attributes:s={},transformFeedback:o=this.transformFeedback,parameters:a={},vertexArray:c=this.vertexArray}=t;this.setAttributes(s),this.updateModuleSettings(e),this.setUniforms(i);let l;O.priority>=ke&&(l=this._logDrawCallStart(ke));const u=this.vertexArray.getDrawParams(),{isIndexed:h=u.isIndexed,indexType:g=u.indexType,indexOffset:m=u.indexOffset,vertexArrayInstanced:b=u.isInstanced}=this.props;b&&!this.isInstanced&&O.warn("Found instanced attributes on non-instanced model",this.id)();const{isInstanced:y,instanceCount:v}=this,{onBeforeRender:T=za,onAfterRender:A=za}=this.props;T(),this.program.setUniforms(this.uniforms);const S=this.program.draw(Object.assign(Sb,t,{logPriority:l,uniforms:null,framebuffer:r,parameters:a,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:c,transformFeedback:o,isIndexed:h,indexType:g,isInstanced:y,instanceCount:v,offset:h?m:0}));return A(),O.priority>=ke&&this._logDrawCallEnd(l,c,r),S}transform(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{discard:e=!0,feedbackBuffers:r,unbindModels:i=[]}=t;let{parameters:s}=t;r&&this._setFeedbackBuffers(r),e&&(s=Object.assign({},s,{[35977]:e})),i.forEach(o=>o.vertexArray.unbindBuffers());try{this.draw(Object.assign({},t,{parameters:s}))}finally{i.forEach(o=>o.vertexArray.bindBuffers())}return this}render(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return O.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(t).draw()}_setModelProps(t){Object.assign(this.props,t),"uniforms"in t&&this.setUniforms(t.uniforms),"pickable"in t&&(this.pickable=t.pickable),"instanceCount"in t&&(this.instanceCount=t.instanceCount),"geometry"in t&&this.setGeometry(t.geometry),"attributes"in t&&this.setAttributes(t.attributes),"_feedbackBuffers"in t&&this._setFeedbackBuffers(t._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:e}=this.programProps;if(e)this._managedProgram=!1;else{const{vs:r,fs:i,modules:s,inject:o,defines:a,varyings:c,bufferMode:l,transpileToGLSL100:u}=this.programProps;e=this.programManager.get({vs:r,fs:i,modules:s,inject:o,defines:a,varyings:c,bufferMode:l,transpileToGLSL100:u}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}C(e instanceof Cl,"Model needs a program"),this._programDirty=!1,e!==this.program&&(this.program=e,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new v0(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(const t in this.geometryBuffers){const e=this.geometryBuffers[t][0]||this.geometryBuffers[t];e instanceof W&&e.delete()}}_setAnimationProps(t){this.animated&&C(t,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Xe(t))return this;const{gl:e}=this.program;return this.transformFeedback=this.transformFeedback||new Ol(e,{program:this.program}),this.transformFeedback.setBuffers(t),this}_logDrawCallStart(t){const e=t>3?0:wb;if(!(Date.now()-this.lastLogTime<e))return this.lastLogTime=Date.now(),O.group(ke,">>> DRAWING MODEL ".concat(this.id),{collapsed:O.level<=2})(),t}_logDrawCallEnd(t,e,r,i){if(t===void 0)return;const s=w0({vertexArray:e,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:o,unusedTable:a,unusedCount:c}=Ma({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,r)}),{table:l,count:u}=Ma({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,r),undefinedOnly:!0});u>0&&O.log("MISSING UNIFORMS",Object.keys(l))(),c>0&&O.log("UNUSED UNIFORMS",Object.keys(a))();const h=S0(this.vertexArray.configuration);O.table(t,s)(),O.table(t,o)(),O.table(t+1,h)(),i&&i.log({logLevel:ke,message:"Rendered to ".concat(i.id)}),O.groupEnd(ke)()}}class Pb{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=t,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(e),Object.seal(this)}setupResources(t){for(const e of this.bindings)this._setupTransformFeedback(e,t)}updateModelProps(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{varyings:e}=this;return e.length>0&&(t=Object.assign({},t,{varyings:e})),t}getDrawOptions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=this.bindings[this.currentIndex],{sourceBuffers:r,transformFeedback:i}=e;return{attributes:Object.assign({},r,t.attributes),transformFeedback:i}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(t)}getBuffer(t){const{feedbackBuffers:e}=this.bindings[this.currentIndex],r=t?e[t]:null;return r?r instanceof W?r:r.buffer:null}getData(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{varyingName:e}=t,r=this.getBuffer(e);return r?r.getData():null}delete(){for(const t in this.resources)this.resources[t].delete()}_initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(t),this.varyings=t.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&C(j(this.gl))}_getFeedbackBuffers(t){const{sourceBuffers:e={}}=t,r={};if(this.bindings[this.currentIndex]&&Object.assign(r,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(const i in this.feedbackMap){const s=this.feedbackMap[i];i in e&&(r[s]=i)}Object.assign(r,t.feedbackBuffers);for(const i in r){const s=r[i];if(typeof s=="string"){const o=e[s],{byteLength:a,usage:c,accessor:l}=o;r[i]=this._createNewBuffer(i,{byteLength:a,usage:c,accessor:l})}}return r}_setupBuffers(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{sourceBuffers:e=null}=t;Object.assign(this.feedbackMap,t.feedbackMap);const r=this._getFeedbackBuffers(t);this._updateBindings({sourceBuffers:e,feedbackBuffers:r})}_setupTransformFeedback(t,e){let{model:r}=e;const{program:i}=r;t.transformFeedback=new Ol(this.gl,{program:i,buffers:t.feedbackBuffers})}_updateBindings(t){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t),this.feedbackMap){const{sourceBuffers:e,feedbackBuffers:r}=this._swapBuffers(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceBuffers:e,feedbackBuffers:r})}}_updateBinding(t,e){return t?(Object.assign(t.sourceBuffers,e.sourceBuffers),Object.assign(t.feedbackBuffers,e.feedbackBuffers),t.transformFeedback&&t.transformFeedback.setBuffers(t.feedbackBuffers),t):{sourceBuffers:Object.assign({},e.sourceBuffers),feedbackBuffers:Object.assign({},e.feedbackBuffers)}}_swapBuffers(t){if(!this.feedbackMap)return null;const e=Object.assign({},t.sourceBuffers),r=Object.assign({},t.feedbackBuffers);for(const i in this.feedbackMap){const s=this.feedbackMap[i];e[i]=t.feedbackBuffers[s],r[s]=t.sourceBuffers[i],C(r[s]instanceof W)}return{sourceBuffers:e,feedbackBuffers:r}}_createNewBuffer(t,e){const r=new W(this.gl,e);return this.resources[t]&&this.resources[t].delete(),this.resources[t]=r,r}_getNextIndex(){return(this.currentIndex+1)%2}}const Mb="transform_uSampler_",Or="transform_uSize_",Ga="transform_position";function Lb(n){let{vs:t,sourceTextureMap:e,targetTextureVarying:r,targetTexture:i}=n,o=Object.keys(e).length,a=null;const c={};let l=t,u={};if(o>0||r){const h=l.split(`
`),g=h.slice();if(h.forEach((m,b,y)=>{if(o>0){const v=kb(m,e);if(v){const{updatedLine:T,inject:A}=v;g[b]=T,u=os([u,A]),Object.assign(c,v.samplerTextureMap),o--}}r&&!a&&(a=Ob(m,r))}),r){C(i);const m="".concat(Or).concat(r),b="uniform vec2 ".concat(m,`;
`),y="     vec2 ".concat(Ga," = transform_getPos(").concat(m,`);
     gl_Position = vec4(`).concat(Ga,`, 0, 1.);
`);u=os([u,{"vs:#decl":b,"vs:#main-start":y}])}l=g.join(`
`)}return{vs:l,targetTextureType:a,inject:u,samplerTextureMap:c}}function Rb(n){let{sourceTextureMap:t,targetTextureVarying:e,targetTexture:r}=n;const i={};let s,o;e&&({width:s,height:o}=r,i["".concat(Or).concat(e)]=[s,o]);for(const a in t)({width:s,height:o}=t[a]),i["".concat(Or).concat(a)]=[s,o];return i}function Ib(n){return Vl(n,["attribute","in"])}function Cb(n){const t="".concat(Mb).concat(n),e="".concat(Or).concat(n),r="  uniform sampler2D ".concat(t,`;
  uniform vec2 `).concat(e,";");return{samplerName:t,sizeName:e,uniformDeclerations:r}}function Ob(n,t){const e=Vl(n,["varying","out"]);return e&&e.name===t?e.type:null}function kb(n,t){const e={},r=Ib(n);if(!r)return null;const{type:i,name:s}=r;if(s&&t[s]){const o="// ".concat(n," => Replaced by Transform with a sampler"),{samplerName:a,sizeName:c,uniformDeclerations:l}=Cb(s),u=g_(i),h="  ".concat(i," ").concat(s," = transform_getInput(").concat(a,", ").concat(c,").").concat(u,`;
`);return e[a]=s,{updatedLine:o,inject:{"vs:#decl":l,"vs:#main-start":h},samplerTextureMap:e}}return null}const Nb={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},Db="transform_output";class Fb{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=t,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(e),Object.seal(this)}updateModelProps(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=this._processVertexShader(t);return Object.assign({},t,e)}getDrawOptions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{sourceBuffers:e,sourceTextures:r,framebuffer:i,targetTexture:s}=this.bindings[this.currentIndex],o=Object.assign({},e,t.attributes),a=Object.assign({},t.uniforms),c=Object.assign({},t.parameters);let l=t.discard;if(this.hasSourceTextures||this.hasTargetTexture){o.transform_elementID=this.elementIDBuffer;for(const h in this.samplerTextureMap){const g=this.samplerTextureMap[h];a[h]=r[g]}this._setSourceTextureParameters();const u=Rb({sourceTextureMap:r,targetTextureVarying:this.targetTextureVarying,targetTexture:s});Object.assign(a,u)}return this.hasTargetTexture&&(l=!1,c.viewport=[0,0,i.width,i.height]),{attributes:o,framebuffer:i,uniforms:a,discard:l,parameters:c}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupTextures(t)}getTargetTexture(){const{targetTexture:t}=this.bindings[this.currentIndex];return t}getData(){let{packed:t=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{framebuffer:e}=this.bindings[this.currentIndex],r=qr(e);if(!t)return r;const i=r.constructor,s=p_(this.targetTextureType),o=new i(r.length*s/4);let a=0;for(let c=0;c<r.length;c+=4)for(let l=0;l<s;l++)o[a++]=r[c+l];return o}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{_targetTextureVarying:e,_swapTexture:r}=t;this._swapTexture=r,this.targetTextureVarying=e,this.hasTargetTexture=e,this._setupTextures(t)}_createTargetTexture(t){const{sourceTextures:e,textureOrReference:r}=t;if(r instanceof Tt)return r;const i=e[r];return i?(this._targetRefTexName=r,this._createNewTexture(i)):null}_setupTextures(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{sourceBuffers:e,_sourceTextures:r={},_targetTexture:i}=t,s=this._createTargetTexture({sourceTextures:r,textureOrReference:i});this.hasSourceTextures=this.hasSourceTextures||r&&Object.keys(r).length>0,this._updateBindings({sourceBuffers:e,sourceTextures:r,targetTexture:s}),"elementCount"in t&&this._updateElementIDBuffer(t.elementCount)}_updateElementIDBuffer(t){if(typeof t!="number"||this.elementCount>=t)return;const e=new Float32Array(t);e.forEach((r,i,s)=>{s[i]=i}),this.elementIDBuffer?this.elementIDBuffer.setData({data:e}):this.elementIDBuffer=new W(this.gl,{data:e,accessor:{size:1}}),this.elementCount=t}_updateBindings(t){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t),this._swapTexture){const{sourceTextures:e,targetTexture:r}=this._swapTextures(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceTextures:e,targetTexture:r})}}_updateBinding(t,e){const{sourceBuffers:r,sourceTextures:i,targetTexture:s}=e;if(t||(t={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(t.sourceTextures,i),Object.assign(t.sourceBuffers,r),s){t.targetTexture=s;const{width:o,height:a}=s,{framebuffer:c}=t;c?(c.update({attachments:{[36064]:s},resizeAttachments:!1}),c.resize({width:o,height:a})):t.framebuffer=new Q(this.gl,{id:"transform-framebuffer",width:o,height:a,attachments:{[36064]:s}})}return t}_setSourceTextureParameters(){const t=this.currentIndex,{sourceTextures:e}=this.bindings[t];for(const r in e)e[r].setParameters(Nb)}_swapTextures(t){if(!this._swapTexture)return null;const e=Object.assign({},t.sourceTextures);e[this._swapTexture]=t.targetTexture;const r=t.sourceTextures[this._swapTexture];return{sourceTextures:e,targetTexture:r}}_createNewTexture(t){const e=lm(t,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=e,e}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{sourceTextures:e,targetTexture:r}=this.bindings[this.currentIndex],{vs:i,uniforms:s,targetTextureType:o,inject:a,samplerTextureMap:c}=Lb({vs:t.vs,sourceTextureMap:e,targetTextureVarying:this.targetTextureVarying,targetTexture:r}),l=os([t.inject||{},a]);this.targetTextureType=o,this.samplerTextureMap=c;const u=t._fs||jl({version:Rl(i),input:this.targetTextureVarying,inputType:o,output:Db}),h=this.hasSourceTextures||this.targetTextureVarying?[bb].concat(t.modules||[]):t.modules;return{vs:i,fs:u,modules:h,uniforms:s,inject:l}}}class Xs{static isSupported(t){return j(t)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=t,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(e),Object.seal(this)}delete(){const{model:t,bufferTransform:e,textureTransform:r}=this;t&&t.delete(),e&&e.delete(),r&&r.delete()}run(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{clearRenderTarget:e=!0}=t,r=this._updateDrawOptions(t);e&&r.framebuffer&&r.framebuffer.clear({color:!0}),this.model.transform(r)}swap(){let t=!1;const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const r of e)t=t||r.swap();C(t,"Nothing to swap")}getBuffer(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return this.bufferTransform&&this.bufferTransform.getBuffer(t)}getData(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const r of e){const i=r.getData(t);if(i)return i}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};"elementCount"in t&&this.model.setVertexCount(t.elementCount);const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const r of e)r.update(t)}_initialize(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{gl:e}=this;this._buildResourceTransforms(e,t),t=this._updateModelProps(t),this.model=new xb(e,Object.assign({},t,{fs:t.fs||jl({version:Rl(t.vs)}),id:t.id||"transform-model",drawMode:t.drawMode||0,vertexCount:t.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(t){let e=Object.assign({},t);const r=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of r)e=i.updateModelProps(e);return e}_buildResourceTransforms(t,e){Bb(e)&&(this.bufferTransform=new Pb(t,e)),Ub(e)&&(this.textureTransform=new Fb(t,e)),C(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(t){let e=Object.assign({},t);const r=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of r)e=Object.assign(e,i.getDrawOptions(e));return e}}function Bb(n){return!!(!Xe(n.feedbackBuffers)||!Xe(n.feedbackMap)||n.varyings&&n.varyings.length>0)}function Ub(n){return!!(!Xe(n._sourceTextures)||n._targetTexture||n._targetTextureVarying)}let Vb=1,jb=1;class Jl{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(t){const{delay:e=0,duration:r=Number.POSITIVE_INFINITY,rate:i=1,repeat:s=1}=t,o=Vb++,a={time:0,delay:e,duration:r,rate:i,repeat:s};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(t){this.channels.delete(t);for(const[e,r]of this.animations)r.channel===t&&this.detachAnimation(e)}isFinished(t){const e=this.channels.get(t);return e===void 0?!1:this.time>=e.delay+e.duration*e.repeat}getTime(t){if(t===void 0)return this.time;const e=this.channels.get(t);return e===void 0?-1:e.time}setTime(t){this.time=Math.max(0,t);const e=this.channels.values();for(const i of e)this._setChannelTime(i,this.time);const r=this.animations.values();for(const i of r){const{animation:s,channel:o}=i;s.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(t,e){const r=jb++;return this.animations.set(r,{animation:t,channel:e}),t.setTime(this.getTime(e)),r}detachAnimation(t){this.animations.delete(t)}update(t){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=t),this.setTime(this.time+(t-this.lastEngineTime)),this.lastEngineTime=t)}_setChannelTime(t,e){const r=e-t.delay,i=t.duration*t.repeat;r>=i?t.time=t.duration*t.rate:(t.time=Math.max(0,r)%t.duration,t.time*=t.rate)}}const tu="#define SMOOTH_EDGE_RADIUS 0.5",zb=`
`.concat(tu,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),Gb=`
`.concat(tu,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),Hb={name:"geometry",vs:zb,fs:Gb},G={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(G,"IDENTITY",{get:()=>(H.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const Rt={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Ha={common:0,meters:1,pixels:2},Wa={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},Bn={DRAW:"draw",MASK:"mask"},Wb=Object.keys(G).map(n=>"const int COORDINATE_SYSTEM_".concat(n," = ").concat(G[n],";")).join(""),Xb=Object.keys(Rt).map(n=>"const int PROJECTION_MODE_".concat(n," = ").concat(Rt[n],";")).join(""),Yb=Object.keys(Ha).map(n=>"const int UNIT_".concat(n.toUpperCase()," = ").concat(Ha[n],";")).join(""),qb="".concat(Wb,`
`).concat(Xb,`
`).concat(Yb,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0; // meters
const float GLOBE_RADIUS = 256.0;

// returns an adjustment factor for uCommonUnitsPerMeter
float project_size_at_latitude(float lat) {
  float y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {

    // uCommonUnitsPerMeter in low-zoom Web Mercator is non-linear
    // Adjust by 1 / cos(latitude)
    // If geometry.position (vertex in common space) is populated, use it
    // Otherwise use geometry.worldPosition (anchor in world space)
    
    if (geometry.position.w == 0.0) {
      return project_size_at_latitude(geometry.worldPosition.y);
    }

    // latitude from common y: 2.0 * (atan(exp(y / TILE_SIZE * 2.0 * PI - PI)) - PI / 4.0)
    // Taylor series of 1 / cos(latitude)
    // Max error < 0.003
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

float project_size_at_latitude(float meters, float lat) {
  return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);
}

//
// Scaling offsets - scales meters to "world distance"
// Note the scalar version of project_size is for scaling the z component only
//
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}

// Get rotation matrix that aligns the z axis with the given up vector
// Find 3 unit vectors ux, uy, uz that are perpendicular to each other and uz == up
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  // Tangent on XY plane
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}

//
// Projecting normal - transform deltas from current coordinate system to
// normals in the worldspace
//
vec3 project_normal(vec3 vector) {
  // Apply model matrix
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

//
// Projecting positions - non-linear projection: lnglats => unit tile [0-1, 0-1]
//
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

//
// Projects positions (defined by project_uCoordinateSystem) to common space (defined by project_uProjectionMode)
//
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;

  // Work around for a Mac+NVIDIA bug https://github.com/visgl/deck.gl/issues/4145
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size_at_latitude(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        // Too far from the projection center for offset mode to be accurate
        // Only use high parts
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    // Subtract high part of 64 bit value. Convert remainder to float32, preserving precision.
    position_world.xyz -= project_uCoordinateOrigin;
  }

  // Translation is already added to the high parts
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}

//
// Projects from common space coordinates to clip space.
// Uses project_uViewProjectionMatrix
//
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}

// Returns a clip space offset that corresponds to a given number of screen pixels
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  // UNIT_PIXELS
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);function $b(n,t){if(n===t)return!0;if(Array.isArray(n)){const e=n.length;if(!t||t.length!==e)return!1;for(let r=0;r<e;r++)if(n[r]!==t[r])return!1;return!0}return!1}function Zr(n){let t={},e;return r=>{for(const i in r)if(!$b(r[i],t[i])){e=n(r),t=r;break}return e}}const Xa=[0,0,0,0],Zb=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],eu=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Kb=[0,0,0],nu=[0,0,0],Qb=Zr(ey);function ru(n,t,e=nu){e.length<3&&(e=[e[0],e[1],0]);let r=e,i,s=!0;switch(t===G.LNGLAT_OFFSETS||t===G.METER_OFFSETS?i=e:i=n.isGeospatial?[Math.fround(n.longitude),Math.fround(n.latitude),0]:null,n.projectionMode){case Rt.WEB_MERCATOR:(t===G.LNGLAT||t===G.CARTESIAN)&&(i=[0,0,0],s=!1);break;case Rt.WEB_MERCATOR_AUTO_OFFSET:t===G.LNGLAT?r=i:t===G.CARTESIAN&&(r=[Math.fround(n.center[0]),Math.fround(n.center[1]),0],i=n.unprojectPosition(r),r[0]-=e[0],r[1]-=e[1],r[2]-=e[2]);break;case Rt.IDENTITY:r=n.position.map(Math.fround),r[2]=r[2]||0;break;case Rt.GLOBE:s=!1,i=null;break;default:s=!1}return{geospatialOrigin:i,shaderCoordinateOrigin:r,offsetMode:s}}function Jb(n,t,e){const{viewMatrixUncentered:r,projectionMatrix:i}=n;let{viewMatrix:s,viewProjectionMatrix:o}=n,a=Xa,c=Xa,l=n.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:g}=ru(n,t,e);return g&&(c=n.projectPosition(u||h),l=[l[0]-c[0],l[1]-c[1],l[2]-c[2]],c[3]=1,a=Qe([],c,o),s=r||s,o=ve([],i,s),o=ve([],o,Zb)),{viewMatrix:s,viewProjectionMatrix:o,projectionCenter:a,originCommon:c,cameraPosCommon:l,shaderCoordinateOrigin:h,geospatialOrigin:u}}function ty({viewport:n,devicePixelRatio:t=1,modelMatrix:e=null,coordinateSystem:r=G.DEFAULT,coordinateOrigin:i=nu,autoWrapLongitude:s=!1}){r===G.DEFAULT&&(r=n.isGeospatial?G.LNGLAT:G.CARTESIAN);const o=Qb({viewport:n,devicePixelRatio:t,coordinateSystem:r,coordinateOrigin:i});return o.project_uWrapLongitude=s,o.project_uModelMatrix=e||eu,o}function ey({viewport:n,devicePixelRatio:t,coordinateSystem:e,coordinateOrigin:r}){const{projectionCenter:i,viewProjectionMatrix:s,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:c,geospatialOrigin:l}=Jb(n,e,r),u=n.getDistanceScales(),h=[n.width*t,n.height*t],g=Qe([],[0,0,-n.focalDistance,1],n.projectionMatrix)[3]||1,m={project_uCoordinateSystem:e,project_uProjectionMode:n.projectionMode,project_uCoordinateOrigin:c,project_uCommonOrigin:o.slice(0,3),project_uCenter:i,project_uPseudoMeters:Boolean(n._pseudoMeters),project_uViewportSize:h,project_uDevicePixelRatio:t,project_uFocalDistance:g,project_uCommonUnitsPerMeter:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:Kb,project_uScale:n.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:s,project_uModelMatrix:eu,project_uCameraPosition:a};if(l){const b=n.getDistanceScales(l);switch(e){case G.METER_OFFSETS:m.project_uCommonUnitsPerWorldUnit=b.unitsPerMeter,m.project_uCommonUnitsPerWorldUnit2=b.unitsPerMeter2;break;case G.LNGLAT:case G.LNGLAT_OFFSETS:n._pseudoMeters||(m.project_uCommonUnitsPerMeter=b.unitsPerMeter),m.project_uCommonUnitsPerWorldUnit=b.unitsPerDegree,m.project_uCommonUnitsPerWorldUnit2=b.unitsPerDegree2;break;case G.CARTESIAN:m.project_uCommonUnitsPerWorldUnit=[1,1,b.unitsPerMeter[2]],m.project_uCommonUnitsPerWorldUnit2=[0,0,b.unitsPerMeter2[2]];break}}return m}const ny={};function ry(n=ny){return"viewport"in n?ty(n):{}}const iu={name:"project",dependencies:[b_,Hb],vs:qb,getUniforms:ry};function iy(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function je(n,t){const e=Qe([],t,n);return Ql(e,e,1/e[3]),e}function Ya(n,t){const e=n%t;return e<0?t+e:e}function hs(n,t,e){return n<t?t:n>e?e:n}function sy(n){return Math.log(n)*Math.LOG2E}const Ys=Math.log2||sy;function Zt(n,t){if(!n)throw new Error(t||"@math.gl/web-mercator: assertion failed.")}const It=Math.PI,su=It/4,Ct=It/180,fs=180/It,Mn=512,ds=4003e4,lr=85.051129,oy=1.5;function ay(n){return Ys(n)}function kr(n){const[t,e]=n;Zt(Number.isFinite(t)),Zt(Number.isFinite(e)&&e>=-90&&e<=90,"invalid latitude");const r=t*Ct,i=e*Ct,s=Mn*(r+It)/(2*It),o=Mn*(It+Math.log(Math.tan(su+i*.5)))/(2*It);return[s,o]}function Ke(n){const[t,e]=n,r=t/Mn*(2*It)-It,i=2*(Math.atan(Math.exp(e/Mn*(2*It)-It))-su);return[r*fs,i*fs]}function ou(n){const{latitude:t}=n;Zt(Number.isFinite(t));const e=Math.cos(t*Ct);return ay(ds*e)-9}function gs(n){const{latitude:t,longitude:e,highPrecision:r=!1}=n;Zt(Number.isFinite(t)&&Number.isFinite(e));const i=Mn,s=Math.cos(t*Ct),o=i/360,a=o/s,c=i/ds/s,l={unitsPerMeter:[c,c,c],metersPerUnit:[1/c,1/c,1/c],unitsPerDegree:[o,a,c],degreesPerUnit:[1/o,1/a,1/c]};if(r){const u=Ct*Math.tan(t*Ct)/s,h=o*u/2,g=i/ds*u,m=g/a*c;l.unitsPerDegree2=[0,h,g],l.unitsPerMeter2=[m,0,m]}return l}function au(n,t){const[e,r,i]=n,[s,o,a]=t,{unitsPerMeter:c,unitsPerMeter2:l}=gs({longitude:e,latitude:r,highPrecision:!0}),u=kr(n);u[0]+=s*(c[0]+l[0]*o),u[1]+=o*(c[1]+l[1]*o);const h=Ke(u),g=(i||0)+(a||0);return Number.isFinite(i)||Number.isFinite(a)?[h[0],h[1],g]:h}function cy(n){const{height:t,pitch:e,bearing:r,altitude:i,scale:s,center:o}=n,a=iy();Cr(a,a,[0,0,-i]),Zl(a,a,-e*Ct),Kl(a,a,r*Ct);const c=s/t;return Ws(a,a,[c,c,c]),o&&Cr(a,a,O_([],o)),a}function ly(n){const{width:t,height:e,altitude:r,pitch:i=0,offset:s,center:o,scale:a,nearZMultiplier:c=1,farZMultiplier:l=1}=n;let{fovy:u=Nr(oy)}=n;r!==void 0&&(u=Nr(r));const h=u*Ct,g=i*Ct,m=qs(u);let b=m;o&&(b+=o[2]*a/Math.cos(g)/e);const y=h*(.5+(s?s[1]:0)/e),v=Math.sin(y)*b/Math.sin(hs(Math.PI/2-g-y,.01,Math.PI-.01)),T=Math.sin(g)*v+b,A=b*10,S=Math.min(T*l,A);return{fov:h,aspect:t/e,focalDistance:m,near:c,far:S}}function Nr(n){return 2*Math.atan(.5/n)*fs}function qs(n){return .5/Math.tan(.5*n*Ct)}function cu(n,t){const[e,r,i=0]=n;return Zt(Number.isFinite(e)&&Number.isFinite(r)&&Number.isFinite(i)),je(t,[e,r,i,1])}function Un(n,t,e=0){const[r,i,s]=n;if(Zt(Number.isFinite(r)&&Number.isFinite(i),"invalid pixel coordinate"),Number.isFinite(s))return je(t,[r,i,s,1]);const o=je(t,[r,i,0,1]),a=je(t,[r,i,1,1]),c=o[2],l=a[2],u=c===l?0:((e||0)-c)/(l-c);return Wl([],o,a,u)}function lu(n){const{width:t,height:e,bounds:r,minExtent:i=0,maxZoom:s=24,offset:o=[0,0]}=n,[[a,c],[l,u]]=r,h=uy(n.padding),g=kr([a,hs(u,-lr,lr)]),m=kr([l,hs(c,-lr,lr)]),b=[Math.max(Math.abs(m[0]-g[0]),i),Math.max(Math.abs(m[1]-g[1]),i)],y=[t-h.left-h.right-Math.abs(o[0])*2,e-h.top-h.bottom-Math.abs(o[1])*2];Zt(y[0]>0&&y[1]>0);const v=y[0]/b[0],T=y[1]/b[1],A=(h.right-h.left)/2/v,S=(h.top-h.bottom)/2/T,x=[(m[0]+g[0])/2+A,(m[1]+g[1])/2+S],M=Ke(x),R=Math.min(s,Ys(Math.abs(Math.min(v,T))));return Zt(Number.isFinite(R)),{longitude:M[0],latitude:M[1],zoom:R}}function uy(n=0){return typeof n=="number"?{top:n,bottom:n,left:n,right:n}:(Zt(Number.isFinite(n.top)&&Number.isFinite(n.bottom)&&Number.isFinite(n.left)&&Number.isFinite(n.right)),n)}const qa=Math.PI/180;function hy(n,t=0){const{width:e,height:r,unproject:i}=n,s={targetZ:t},o=i([0,r],s),a=i([e,r],s);let c,l;const u=n.fovy?.5*n.fovy*qa:Math.atan(.5/n.altitude),h=(90-n.pitch)*qa;return u>h-.01?(c=$a(n,0,t),l=$a(n,e,t)):(c=i([0,0],s),l=i([e,0],s)),[o,a,l,c]}function $a(n,t,e){const{pixelUnprojectionMatrix:r}=n,i=je(r,[t,0,1,1]),s=je(r,[t,n.height,1,1]),a=(e*n.distanceScales.unitsPerMeter[2]-i[2])/(s[2]-i[2]),c=Wl([],i,s,a),l=Ke(c);return l.push(e),l}const Za=512;function fy(n){const{width:t,height:e,pitch:r=0}=n;let{longitude:i,latitude:s,zoom:o,bearing:a=0}=n;(i<-180||i>180)&&(i=Ya(i+180,360)-180),(a<-180||a>180)&&(a=Ya(a+180,360)-180);const c=Ys(e/Za);if(o<=c)o=c,s=0;else{const l=e/2/Math.pow(2,o),u=Ke([0,l])[1];if(s<u)s=u;else{const h=Ke([0,Za-l])[1];s>h&&(s=h)}}return{width:t,height:e,longitude:i,latitude:s,zoom:o,pitch:r,bearing:a}}const dy=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,gy=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture2D(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,py=Zr(vy),my=Zr(Ey),_y=[0,0,0,1],by=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function yy(n,t){const[e,r,i]=n,s=Un([e,r,i],t);return Number.isFinite(i)?s:[s[0],s[1],0]}function vy({viewport:n,center:t}){return new ct(n.viewProjectionMatrix).invert().transform(t)}function Ey({viewport:n,shadowMatrices:t}){const e=[],r=n.pixelUnprojectionMatrix,i=n.isGeospatial?void 0:1,s=[[0,0,i],[n.width,0,i],[0,n.height,i],[n.width,n.height,i],[0,0,-1],[n.width,0,-1],[0,n.height,-1],[n.width,n.height,-1]].map(o=>yy(o,r));for(const o of t){const a=o.clone().translate(new Mt(n.center).negate()),c=s.map(u=>a.transform(u)),l=new ct().ortho({left:Math.min(...c.map(u=>u[0])),right:Math.max(...c.map(u=>u[0])),bottom:Math.min(...c.map(u=>u[1])),top:Math.max(...c.map(u=>u[1])),near:Math.min(...c.map(u=>-u[2])),far:Math.max(...c.map(u=>-u[2]))});e.push(l.multiplyRight(o))}return e}function Ty(n,t){const{shadowEnabled:e=!0}=n;if(!e||!n.shadowMatrices||!n.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1};const r={shadow_uDrawShadowMap:Boolean(n.drawToShadowMap),shadow_uUseShadowMap:n.shadowMaps?n.shadowMaps.length>0:!1,shadow_uColor:n.shadowColor||_y,shadow_uLightId:n.shadowLightId||0,shadow_uLightCount:n.shadowMatrices.length},i=py({viewport:n.viewport,center:t.project_uCenter}),s=[],o=my({shadowMatrices:n.shadowMatrices,viewport:n.viewport}).slice();for(let a=0;a<n.shadowMatrices.length;a++){const c=o[a],l=c.clone().translate(new Mt(n.viewport.center).negate());t.project_uCoordinateSystem===G.LNGLAT&&t.project_uProjectionMode===Rt.WEB_MERCATOR?(o[a]=l,s[a]=i):(o[a]=c.clone().multiplyRight(by),s[a]=l.transform(i))}for(let a=0;a<o.length;a++)r["shadow_uViewProjectionMatrices[".concat(a,"]")]=o[a],r["shadow_uProjectCenters[".concat(a,"]")]=s[a],n.shadowMaps&&n.shadowMaps.length>0?r["shadow_uShadowMap".concat(a)]=n.shadowMaps[a]:r["shadow_uShadowMap".concat(a)]=n.dummyShadowMap;return r}const Ui={name:"shadow",dependencies:[iu],vs:dy,fs:gy,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(n={},t={})=>"viewport"in n&&(n.drawToShadowMap||n.shadowMaps&&n.shadowMaps.length>0)?Ty(n,t):{}};({...mb});const wy=[iu],Ay=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function Sy(n){const t=Fn.getDefaultProgramManager(n);for(const e of wy)t.addDefaultModule(e);for(const e of Ay)t.addShaderHook(e);return t}const xy=[255,255,255],Py=1;let My=0;class Ly{constructor(t={}){f(this,"id",void 0),f(this,"color",void 0),f(this,"intensity",void 0),f(this,"type","ambient");const{color:e=xy}=t,{intensity:r=Py}=t;this.id=t.id||"ambient-".concat(My++),this.color=e,this.intensity=r}}const Ry=[255,255,255],Iy=1,Cy=[0,0,-1];let Oy=0;class Ka{constructor(t={}){f(this,"id",void 0),f(this,"color",void 0),f(this,"intensity",void 0),f(this,"type","directional"),f(this,"direction",void 0),f(this,"shadow",void 0);const{color:e=Ry}=t,{intensity:r=Iy}=t,{direction:i=Cy}=t,{_shadow:s=!1}=t;this.id=t.id||"directional-".concat(Oy++),this.color=e,this.intensity=r,this.type="directional",this.direction=new Mt(i).normalize().toArray(),this.shadow=s}getProjectedLight(t){return this}}class ky{constructor(t,e={id:"pass"}){f(this,"id",void 0),f(this,"gl",void 0),f(this,"props",void 0);const{id:r}=e;this.id=r,this.gl=t,this.props={...e}}setProps(t){Object.assign(this.props,t)}render(t){}cleanup(){}}class Kr extends ky{constructor(...t){super(...t),f(this,"_lastRenderIndex",-1)}render(t){const e=this.gl;return $t(e,{framebuffer:t.target}),this._drawLayers(t)}_drawLayers(t){const{target:e,moduleParameters:r,viewports:i,views:s,onViewportActive:o,clearStack:a=!0,clearCanvas:c=!0}=t;t.pass=t.pass||"unknown";const l=this.gl;c&&Dy(l),a&&(this._lastRenderIndex=-1);const u=[];for(const h of i){const g=s&&s[h.id];o(h);const m=this._getDrawLayerParams(h,t),b=h.subViewports||[h];for(const y of b){const v=this._drawLayersInViewport(l,{target:e,moduleParameters:r,viewport:y,view:g,pass:t.pass,layers:t.layers},m);u.push(v)}}return u}_getDrawLayerParams(t,{layers:e,pass:r,layerFilter:i,cullRect:s,effects:o,moduleParameters:a}){const c=[],l=uu(this._lastRenderIndex+1),u={layer:e[0],viewport:t,isPicking:r.startsWith("picking"),renderPass:r,cullRect:s},h={};for(let g=0;g<e.length;g++){const m=e[g],b=this._shouldDrawLayer(m,u,i,h),y={shouldDrawLayer:b};b&&(y.layerRenderIndex=l(m,b),y.moduleParameters=this._getModuleParameters(m,o,r,a),y.layerParameters=this.getLayerParameters(m,g,t)),c[g]=y}return c}_drawLayersInViewport(t,{layers:e,moduleParameters:r,pass:i,target:s,viewport:o,view:a},c){const l=Ny(t,{moduleParameters:r,target:s,viewport:o});if(a&&a.props.clear){const h=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;Pt(t,{scissorTest:!0,scissor:l},()=>Vs(t,h))}const u={totalCount:e.length,visibleCount:0,compositeCount:0,pickableCount:0};$t(t,{viewport:l});for(let h=0;h<e.length;h++){const g=e[h],{shouldDrawLayer:m,layerRenderIndex:b,moduleParameters:y,layerParameters:v}=c[h];if(m&&g.props.pickable&&u.pickableCount++,g.isComposite)u.compositeCount++;else if(m){u.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,b),y.viewport=o;try{g._drawLayer({moduleParameters:y,uniforms:{layerIndex:b},parameters:v})}catch(T){g.raiseError(T,"drawing ".concat(g," to ").concat(i))}}}return u}shouldDrawLayer(t){return!0}getModuleParameters(t,e){return null}getLayerParameters(t,e,r){return t.props.parameters}_shouldDrawLayer(t,e,r,i){if(!(t.props.visible&&this.shouldDrawLayer(t)))return!1;e.layer=t;let o=t.parent;for(;o;){if(!o.props.visible||!o.filterSubLayer(e))return!1;e.layer=o,o=o.parent}if(r){const a=e.layer.id;if(a in i||(i[a]=r(e)),!i[a])return!1}return t.activateViewport(e.viewport),!0}_getModuleParameters(t,e,r,i){var s;const o=Object.assign(Object.create(((s=t.internalState)===null||s===void 0?void 0:s.propsInTransition)||t.props),{autoWrapLongitude:t.wrapLongitude,viewport:t.context.viewport,mousePosition:t.context.mousePosition,pickingActive:0,devicePixelRatio:We(this.gl)});if(e)for(const c of e){var a;Object.assign(o,(a=c.getModuleParameters)===null||a===void 0?void 0:a.call(c,t))}return Object.assign(o,this.getModuleParameters(t,e),i)}}function uu(n=0,t={}){const e={},r=(i,s)=>{const o=i.props._offset,a=i.id,c=i.parent&&i.parent.id;let l;if(c&&!(c in t)&&r(i.parent,!1),c in e){const u=e[c]=e[c]||uu(t[c],t);l=u(i,s),e[a]=u}else Number.isFinite(o)?(l=o+(t[c]||0),e[a]=null):l=n;return s&&l>=n&&(n=l+1),t[a]=l,l};return r}function Ny(n,{moduleParameters:t,target:e,viewport:r}){const i=e&&e.id!=="default-framebuffer",s=t&&t.devicePixelRatio||We(n),o=i?e.height:n.drawingBufferHeight,a=r;return[a.x*s,o-(a.y+a.height)*s,a.width*s,a.height*s]}function Dy(n){const t=n.drawingBufferWidth,e=n.drawingBufferHeight;$t(n,{viewport:[0,0,t,e]}),n.clear(16640)}class Fy extends Kr{constructor(t,e){super(t,e),f(this,"shadowMap",void 0),f(this,"depthBuffer",void 0),f(this,"fbo",void 0),this.shadowMap=new Tt(t,{width:1,height:1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.depthBuffer=new Be(t,{format:33189,width:1,height:1}),this.fbo=new Q(t,{id:"shadowmap",width:1,height:1,attachments:{[36064]:this.shadowMap,[36096]:this.depthBuffer}})}render(t){const e=this.fbo;Pt(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},()=>{const r=t.viewports[0],i=We(this.gl),s=r.width*i,o=r.height*i;(s!==e.width||o!==e.height)&&e.resize({width:s,height:o}),super.render({...t,target:e,pass:"shadow"})})}shouldDrawLayer(t){return t.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}}const By={color:[255,255,255],intensity:1},Qa=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],Uy=[0,0,0,200/255];class hu{constructor(t={}){f(this,"id","lighting-effect"),f(this,"props",null),f(this,"shadowColor",Uy),f(this,"shadow",void 0),f(this,"ambientLight",null),f(this,"directionalLights",[]),f(this,"pointLights",[]),f(this,"shadowPasses",[]),f(this,"shadowMaps",[]),f(this,"dummyShadowMap",null),f(this,"programManager",void 0),f(this,"shadowMatrices",void 0);for(const e in t){const r=t[e];switch(r.type){case"ambient":this.ambientLight=r;break;case"directional":this.directionalLights.push(r);break;case"point":this.pointLights.push(r);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(e=>e.shadow)}preRender(t,{layers:e,layerFilter:r,viewports:i,onViewportActive:s,views:o}){if(!!this.shadow){this.shadowMatrices=this._calculateMatrices(),this.shadowPasses.length===0&&this._createShadowPasses(t),this.programManager||(this.programManager=Fn.getDefaultProgramManager(t),Ui&&this.programManager.addDefaultModule(Ui)),this.dummyShadowMap||(this.dummyShadowMap=new Tt(t,{width:1,height:1}));for(let a=0;a<this.shadowPasses.length;a++)this.shadowPasses[a].render({layers:e,layerFilter:r,viewports:i,onViewportActive:s,views:o,moduleParameters:{shadowLightId:a,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(t){const e=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return e.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(r=>r.getProjectedLight({layer:t})),pointLights:this.pointLights.map(r=>r.getProjectedLight({layer:t}))},e}cleanup(){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(Ui),this.programManager=null)}_calculateMatrices(){const t=[];for(const e of this.directionalLights){const r=new ct().lookAt({eye:new Mt(e.direction).negate()});t.push(r)}return t}_createShadowPasses(t){for(let e=0;e<this.directionalLights.length;e++){const r=new Fy(t);this.shadowPasses[e]=r,this.shadowMaps[e]=r.shadowMap}}_applyDefaultLights(){const{ambientLight:t,pointLights:e,directionalLights:r}=this;!t&&e.length===0&&r.length===0&&(this.ambientLight=new Ly(By),this.directionalLights.push(new Ka(Qa[0]),new Ka(Qa[1])))}}class Vy{constructor(t={}){f(this,"_pool",[]),f(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(t)}setOptions(t){Object.assign(this.opts,t)}allocate(t,e,{size:r=1,type:i,padding:s=0,copy:o=!1,initialize:a=!1,maxCount:c}){const l=i||t&&t.constructor||Float32Array,u=e*r+s;if(ArrayBuffer.isView(t)){if(u<=t.length)return t;if(u*t.BYTES_PER_ELEMENT<=t.buffer.byteLength)return new l(t.buffer,0,u)}let h=1/0;c&&(h=c*r+s);const g=this._allocate(l,u,a,h);return t&&o?g.set(t):a||g.fill(0,0,4),this._release(t),g}release(t){this._release(t)}_allocate(t,e,r,i){let s=Math.max(Math.ceil(e*this.opts.overAlloc),1);s>i&&(s=i);const o=this._pool,a=t.BYTES_PER_ELEMENT*s,c=o.findIndex(l=>l.byteLength>=a);if(c>=0){const l=new t(o.splice(c,1)[0],0,s);return r&&l.fill(0),l}return new t(s)}_release(t){if(!ArrayBuffer.isView(t))return;const e=this._pool,{buffer:r}=t,{byteLength:i}=r,s=e.findIndex(o=>o.byteLength>=i);s<0?e.push(r):(s>0||e.length<this.opts.poolSize)&&e.splice(s,0,r),e.length>this.opts.poolSize&&e.shift()}}const Ln=new Vy;function yn(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Dr(n,t){const e=n%t;return e<0?t+e:e}function jy(n){return[n[12],n[13],n[14]]}function zy(n){return{left:Ne(n[3]+n[0],n[7]+n[4],n[11]+n[8],n[15]+n[12]),right:Ne(n[3]-n[0],n[7]-n[4],n[11]-n[8],n[15]-n[12]),bottom:Ne(n[3]+n[1],n[7]+n[5],n[11]+n[9],n[15]+n[13]),top:Ne(n[3]-n[1],n[7]-n[5],n[11]-n[9],n[15]-n[13]),near:Ne(n[3]+n[2],n[7]+n[6],n[11]+n[10],n[15]+n[14]),far:Ne(n[3]-n[2],n[7]-n[6],n[11]-n[10],n[15]-n[14])}}const Ja=new Mt;function Ne(n,t,e,r){Ja.set(n,t,e);const i=Ja.len();return{distance:r/i,normal:new Mt(-n/i,-t/i,-e/i)}}function Gy(n){return n-Math.fround(n)}let pn;function Vi(n,t){const{size:e=1,startIndex:r=0}=t,i=t.endIndex!==void 0?t.endIndex:n.length,s=(i-r)/e;pn=Ln.allocate(pn,s,{type:Float32Array,size:e*2});let o=r,a=0;for(;o<i;){for(let c=0;c<e;c++){const l=n[o++];pn[a+c]=l,pn[a+c+e]=Gy(l)}a+=e*2}return pn.subarray(0,s*e*2)}const Hy=Math.PI/180,Wy=yn(),tc=[0,0,0],Xy={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function Yy({width:n,height:t,orthographic:e,fovyRadians:r,focalDistance:i,padding:s,near:o,far:a}){const c=n/t,l=e?new ct().orthographic({fovy:r,aspect:c,focalDistance:i,near:o,far:a}):new ct().perspective({fovy:r,aspect:c,near:o,far:a});if(s){const{left:u=0,right:h=0,top:g=0,bottom:m=0}=s,b=Z((u+n-h)/2,0,n)-n/2,y=Z((g+t-m)/2,0,t)-t/2;l[8]-=b*2/n,l[9]+=y*2/t}return l}class jt{constructor(t={}){f(this,"id",void 0),f(this,"x",void 0),f(this,"y",void 0),f(this,"width",void 0),f(this,"height",void 0),f(this,"isGeospatial",void 0),f(this,"zoom",void 0),f(this,"focalDistance",void 0),f(this,"position",void 0),f(this,"modelMatrix",void 0),f(this,"distanceScales",void 0),f(this,"scale",void 0),f(this,"center",void 0),f(this,"cameraPosition",void 0),f(this,"projectionMatrix",void 0),f(this,"viewMatrix",void 0),f(this,"viewMatrixUncentered",void 0),f(this,"viewMatrixInverse",void 0),f(this,"viewProjectionMatrix",void 0),f(this,"pixelProjectionMatrix",void 0),f(this,"pixelUnprojectionMatrix",void 0),f(this,"resolution",void 0),f(this,"_frustumPlanes",{}),this.id=t.id||this.constructor.displayName||"viewport",this.x=t.x||0,this.y=t.y||0,this.width=t.width||1,this.height=t.height||1,this.zoom=t.zoom||0,this.distanceScales=t.distanceScales||Xy,this.focalDistance=t.focalDistance||1,this.position=t.position||tc,this.modelMatrix=t.modelMatrix||null;const{longitude:e,latitude:r}=t;this.isGeospatial=Number.isFinite(r)&&Number.isFinite(e),this._initProps(t),this._initMatrices(t),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?Rt.WEB_MERCATOR:Rt.WEB_MERCATOR_AUTO_OFFSET:Rt.IDENTITY}equals(t){return t instanceof jt?this===t?!0:t.width===this.width&&t.height===this.height&&t.scale===this.scale&&Yt(t.projectionMatrix,this.projectionMatrix)&&Yt(t.viewMatrix,this.viewMatrix):!1}project(t,{topLeft:e=!0}={}){const r=this.projectPosition(t),i=cu(r,this.pixelProjectionMatrix),[s,o]=i,a=e?o:this.height-o;return t.length===2?[s,a]:[s,a,i[2]]}unproject(t,{topLeft:e=!0,targetZ:r}={}){const[i,s,o]=t,a=e?s:this.height-s,c=r&&r*this.distanceScales.unitsPerMeter[2],l=Un([i,a,o],this.pixelUnprojectionMatrix,c),[u,h,g]=this.unprojectPosition(l);return Number.isFinite(o)?[u,h,g]:Number.isFinite(r)?[u,h,r]:[u,h]}projectPosition(t){const[e,r]=this.projectFlat(t),i=(t[2]||0)*this.distanceScales.unitsPerMeter[2];return[e,r,i]}unprojectPosition(t){const[e,r]=this.unprojectFlat(t),i=(t[2]||0)*this.distanceScales.metersPerUnit[2];return[e,r,i]}projectFlat(t){if(this.isGeospatial){const e=kr(t);return e[1]=Z(e[1],-318,830),e}return t}unprojectFlat(t){return this.isGeospatial?Ke(t):t}getBounds(t={}){const e={targetZ:t.z||0},r=this.unproject([0,0],e),i=this.unproject([this.width,0],e),s=this.unproject([0,this.height],e),o=this.unproject([this.width,this.height],e);return[Math.min(r[0],i[0],s[0],o[0]),Math.min(r[1],i[1],s[1],o[1]),Math.max(r[0],i[0],s[0],o[0]),Math.max(r[1],i[1],s[1],o[1])]}getDistanceScales(t){return t?gs({longitude:t[0],latitude:t[1],highPrecision:!0}):this.distanceScales}containsPixel({x:t,y:e,width:r=1,height:i=1}){return t<this.x+this.width&&this.x<t+r&&e<this.y+this.height&&this.y<e+i}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,zy(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(t,e){return null}_initProps(t){const e=t.longitude,r=t.latitude;this.isGeospatial&&(Number.isFinite(t.zoom)||(this.zoom=ou({latitude:r})+Math.log2(this.focalDistance)),this.distanceScales=t.distanceScales||gs({latitude:r,longitude:e}));const i=Math.pow(2,this.zoom);this.scale=i;const{position:s,modelMatrix:o}=t;let a=tc;if(s&&(a=o?new ct(o).transformAsVector(s,[]):s),this.isGeospatial){const c=this.projectPosition([e,r,0]);this.center=new Mt(a).scale(this.distanceScales.unitsPerMeter).add(c)}else this.center=this.projectPosition(a)}_initMatrices(t){const{viewMatrix:e=Wy,projectionMatrix:r=null,orthographic:i=!1,fovyRadians:s,fovy:o=75,near:a=.1,far:c=1e3,padding:l=null,focalDistance:u=1}=t;this.viewMatrixUncentered=e,this.viewMatrix=new ct().multiplyRight(e).translate(new Mt(this.center).negate()),this.projectionMatrix=r||Yy({width:this.width,height:this.height,orthographic:i,fovyRadians:s||o*Hy,focalDistance:u,padding:l,near:a,far:c});const h=yn();ve(h,h,this.projectionMatrix),ve(h,h,this.viewMatrix),this.viewProjectionMatrix=h,this.viewMatrixInverse=ls([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=jy(this.viewMatrixInverse);const g=yn(),m=yn();Ws(g,g,[this.width/2,-this.height/2,1]),Cr(g,g,[1,-1,0]),ve(m,g,this.viewProjectionMatrix),this.pixelProjectionMatrix=m,this.pixelUnprojectionMatrix=ls(yn(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||H.warn("Pixel project matrix not invertible")()}}f(jt,"displayName","Viewport");const qy=512,$y=4003e4,Zy=Math.PI/180;function ec(n){const t=Math.cos(n*Zy);return qy/$y/t}class Kt extends jt{constructor(t={}){const{latitude:e=0,longitude:r=0,zoom:i=0,pitch:s=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:c=1.01,orthographic:l=!1,projectionMatrix:u,repeat:h=!1,worldOffset:g=0,legacyMeterSizes:m=!1}=t;let{width:b,height:y,altitude:v=1.5}=t;const T=Math.pow(2,i);b=b||1,y=y||1;let A,S=null;u?(v=u[5]/2,A=Nr(v)):(t.fovy?(A=t.fovy,v=qs(A)):A=Nr(v),S=ly({width:b,height:y,pitch:s,fovy:A,nearZMultiplier:a,farZMultiplier:c}));let x=cy({height:y,pitch:s,bearing:o,scale:T,altitude:v});g&&(x=new ct().translate([512*g,0,0]).multiplyLeft(x)),super({...t,width:b,height:y,viewMatrix:x,longitude:r,latitude:e,zoom:i,...S,fovy:A,focalDistance:v}),f(this,"longitude",void 0),f(this,"latitude",void 0),f(this,"pitch",void 0),f(this,"bearing",void 0),f(this,"altitude",void 0),f(this,"fovy",void 0),f(this,"orthographic",void 0),f(this,"_subViewports",void 0),f(this,"_pseudoMeters",void 0),this.latitude=e,this.longitude=r,this.zoom=i,this.pitch=s,this.bearing=o,this.altitude=v,this.fovy=A,this.orthographic=l,this._subViewports=h?[]:null,this._pseudoMeters=m,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const t=this.getBounds(),e=Math.floor((t[0]+180)/360),r=Math.ceil((t[2]-180)/360);for(let i=e;i<=r;i++){const s=i?new Kt({...this,worldOffset:i}):this;this._subViewports.push(s)}}return this._subViewports}projectPosition(t){if(this._pseudoMeters)return super.projectPosition(t);const[e,r]=this.projectFlat(t),i=(t[2]||0)*ec(t[1]);return[e,r,i]}unprojectPosition(t){if(this._pseudoMeters)return super.unprojectPosition(t);const[e,r]=this.unprojectFlat(t),i=(t[2]||0)/ec(r);return[e,r,i]}addMetersToLngLat(t,e){return au(t,e)}panByPosition(t,e){const r=Un(e,this.pixelUnprojectionMatrix),i=this.projectFlat(t),s=Ir([],i,Hl([],r)),o=Ir([],this.center,s),[a,c]=this.unprojectFlat(o);return{longitude:a,latitude:c}}getBounds(t={}){const e=hy(this,t.z||0);return[Math.min(e[0][0],e[1][0],e[2][0],e[3][0]),Math.min(e[0][1],e[1][1],e[2][1],e[3][1]),Math.max(e[0][0],e[1][0],e[2][0],e[3][0]),Math.max(e[0][1],e[1][1],e[2][1],e[3][1])]}fitBounds(t,e={}){const{width:r,height:i}=this,{longitude:s,latitude:o,zoom:a}=lu({width:r,height:i,bounds:t,...e});return new Kt({width:r,height:i,longitude:s,latitude:o,zoom:a})}}f(Kt,"displayName","WebMercatorViewport");function ji(n,t,e=!1){const r=t.projectPosition(n);if(e&&t instanceof Kt){const[i,s,o=0]=n,a=t.getDistanceScales([i,s]);r[2]=o*a.unitsPerMeter[2]}return r}function Ky(n){const{viewport:t,modelMatrix:e,coordinateOrigin:r}=n;let{coordinateSystem:i,fromCoordinateSystem:s,fromCoordinateOrigin:o}=n;return i===G.DEFAULT&&(i=t.isGeospatial?G.LNGLAT:G.CARTESIAN),s===void 0&&(s=i),o===void 0&&(o=r),{viewport:t,coordinateSystem:i,coordinateOrigin:r,modelMatrix:e,fromCoordinateSystem:s,fromCoordinateOrigin:o}}function fu(n,{viewport:t,modelMatrix:e,coordinateSystem:r,coordinateOrigin:i,offsetMode:s}){let[o,a,c=0]=n;switch(e&&([o,a,c]=Qe([],[o,a,c,1],e)),r){case G.LNGLAT:return ji([o,a,c],t,s);case G.LNGLAT_OFFSETS:return ji([o+i[0],a+i[1],c+(i[2]||0)],t,s);case G.METER_OFFSETS:return ji(au(i,[o,a,c]),t,s);case G.CARTESIAN:default:return t.isGeospatial?[o+i[0],a+i[1],c+i[2]]:t.projectPosition([o,a,c])}}function Qy(n,t){const{viewport:e,coordinateSystem:r,coordinateOrigin:i,modelMatrix:s,fromCoordinateSystem:o,fromCoordinateOrigin:a}=Ky(t),{geospatialOrigin:c,shaderCoordinateOrigin:l,offsetMode:u}=ru(e,r,i),h=fu(n,{viewport:e,modelMatrix:s,coordinateSystem:o,coordinateOrigin:a,offsetMode:u});if(u){const g=e.projectPosition(c||l);$l(h,h,g)}return h}const Fe={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Fr=Symbol.for("component"),ze=Symbol.for("asyncPropDefaults"),Te=Symbol.for("asyncPropOriginal"),ce=Symbol.for("asyncPropResolved");function $s(n,t=()=>!0){return Array.isArray(n)?du(n,t,[]):t(n)?[n]:[]}function du(n,t,e){let r=-1;for(;++r<n.length;){const i=n[r];Array.isArray(i)?du(i,t,e):t(i)&&e.push(i)}return e}function Jy({target:n,source:t,start:e=0,count:r=1}){const i=t.length,s=r*i;let o=0;for(let a=e;o<i;o++)n[a++]=t[o];for(;o<s;)o<s-o?(n.copyWithin(e+o,e,e+o),o*=2):(n.copyWithin(e+o,e,e+s-o),o=s);return n}class tv{constructor(t,e,r){f(this,"id",void 0),f(this,"context",void 0),f(this,"isLoaded",void 0),f(this,"persistent",void 0),f(this,"_loadCount",0),f(this,"_subscribers",new Set),f(this,"_data",void 0),f(this,"_loader",void 0),f(this,"_error",void 0),f(this,"_content",void 0),this.id=t,this.context=r,this.setData(e)}subscribe(t){this._subscribers.add(t)}unsubscribe(t){this._subscribers.delete(t)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(t,e){if(t===this._data&&!e)return;this._data=t;const r=++this._loadCount;let i=t;typeof t=="string"&&(i=Ki(t)),i instanceof Promise?(this.isLoaded=!1,this._loader=i.then(s=>{this._loadCount===r&&(this.isLoaded=!0,this._error=void 0,this._content=s)}).catch(s=>{this._loadCount===r&&(this.isLoaded=!0,this._error=s||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=t);for(const s of this._subscribers)s.onChange(this.getData())}}class ev{constructor({gl:t,protocol:e}){f(this,"protocol",void 0),f(this,"_context",void 0),f(this,"_resources",void 0),f(this,"_consumers",void 0),f(this,"_pruneRequest",void 0),this.protocol=e||"resource://",this._context={gl:t,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(t){return t.startsWith(this.protocol)?!0:t in this._resources}add({resourceId:t,data:e,forceUpdate:r=!1,persistent:i=!0}){let s=this._resources[t];s?s.setData(e,r):(s=new tv(t,e,this._context),this._resources[t]=s),s.persistent=i}remove(t){const e=this._resources[t];e&&(e.delete(),delete this._resources[t])}unsubscribe({consumerId:t}){const e=this._consumers[t];if(e){for(const r in e){const i=e[r],s=this._resources[i.resourceId];s&&s.unsubscribe(i)}delete this._consumers[t],this.prune()}}subscribe({resourceId:t,onChange:e,consumerId:r,requestId:i="default"}){const{_resources:s,protocol:o}=this;t.startsWith(o)&&(t=t.replace(o,""),s[t]||this.add({resourceId:t,data:null,persistent:!1}));const a=s[t];if(this._track(r,i,a,e),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const t in this._resources)this._resources[t].delete()}_track(t,e,r,i){const s=this._consumers,o=s[t]=s[t]||{},a=o[e]||{},c=a.resourceId&&this._resources[a.resourceId];c&&(c.unsubscribe(a),this.prune()),r&&(o[e]=a,a.onChange=i,a.resourceId=r.id,r.subscribe(a))}_prune(){this._pruneRequest=null;for(const t of Object.keys(this._resources)){const e=this._resources[t];!e.persistent&&!e.inUse()&&(e.delete(),delete this._resources[t])}}}const nv="layerManager.setLayers",rv="layerManager.activateViewport";class iv{constructor(t,{deck:e,stats:r,viewport:i,timeline:s}={}){f(this,"layers",void 0),f(this,"context",void 0),f(this,"resourceManager",void 0),f(this,"_lastRenderedLayers",[]),f(this,"_needsRedraw",!1),f(this,"_needsUpdate",!1),f(this,"_nextLayers",null),f(this,"_debug",!1),f(this,"activateViewport",o=>{at(rv,this,o),o&&(this.context.viewport=o)}),this.layers=[],this.resourceManager=new ev({gl:t,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,gl:t,deck:e,programManager:t&&Sy(t),stats:r||new Bs({id:"deck.gl"}),viewport:i||new jt({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:s||new Jl,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const t of this.layers)this._finalizeLayer(t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);for(const r of this.layers){const i=r.getNeedsRedraw(t);e=e||i}return e}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(t){this._needsRedraw=this._needsRedraw||t}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t}getLayers({layerIds:t}={}){return t?this.layers.filter(e=>t.find(r=>e.id.indexOf(r)===0)):this.layers}setProps(t){"debug"in t&&(this._debug=t.debug),"userData"in t&&(this.context.userData=t.userData),"layers"in t&&(this._nextLayers=t.layers),"onError"in t&&(this.context.onError=t.onError)}setLayers(t,e){at(nv,this,e,t),this._lastRenderedLayers=t;const r=$s(t,Boolean);for(const i of r)i.context=this.context;this._updateLayers(this.layers,r)}updateLayers(){const t=this.needsUpdate();t&&(this.setNeedsRedraw("updating layers: ".concat(t)),this.setLayers(this._nextLayers||this._lastRenderedLayers,t)),this._nextLayers=null}_handleError(t,e,r){r.raiseError(e,"".concat(t," of ").concat(r))}_updateLayers(t,e){const r={};for(const o of t)r[o.id]?H.warn("Multiple old layers with same id ".concat(o.id))():r[o.id]=o;const i=[];this._updateSublayersRecursively(e,r,i),this._finalizeOldLayers(r);let s=!1;for(const o of i)if(o.hasUniformTransition()){s="Uniform transition in ".concat(o);break}this._needsUpdate=s,this.layers=i}_updateSublayersRecursively(t,e,r){for(const i of t){i.context=this.context;const s=e[i.id];s===null&&H.warn("Multiple new layers with same id ".concat(i.id))(),e[i.id]=null;let o=null;try{this._debug&&s!==i&&i.validateProps(),s?(this._transferLayerState(s,i),this._updateLayer(i)):this._initializeLayer(i),r.push(i),o=i.isComposite?i.getSubLayers():null}catch(a){this._handleError("matching",a,i)}o&&this._updateSublayersRecursively(o,e,r)}}_finalizeOldLayers(t){for(const e in t){const r=t[e];r&&this._finalizeLayer(r)}}_initializeLayer(t){try{t._initialize(),t.lifecycle=Fe.INITIALIZED}catch(e){this._handleError("initialization",e,t)}}_transferLayerState(t,e){e._transferState(t),e.lifecycle=Fe.MATCHED,e!==t&&(t.lifecycle=Fe.AWAITING_GC)}_updateLayer(t){try{t._update()}catch(e){this._handleError("update",e,t)}}_finalizeLayer(t){this._needsRedraw=this._needsRedraw||"finalized ".concat(t),t.lifecycle=Fe.AWAITING_FINALIZATION;try{t._finalize(),t.lifecycle=Fe.FINALIZED}catch(e){this._handleError("finalization",e,t)}}}function xe(n,t){if(n===t)return!0;if(!n||!t)return!1;for(const e in n){const r=n[e],i=t[e];if(!(r===i||Array.isArray(r)&&Array.isArray(i)&&xe(r,i)))return!1}return!0}class sv{constructor(t){f(this,"width",void 0),f(this,"height",void 0),f(this,"views",void 0),f(this,"viewState",void 0),f(this,"controllers",void 0),f(this,"timeline",void 0),f(this,"_viewports",void 0),f(this,"_viewportMap",void 0),f(this,"_isUpdating",void 0),f(this,"_needsRedraw",void 0),f(this,"_needsUpdate",void 0),f(this,"_eventManager",void 0),f(this,"_eventCallbacks",void 0),this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=t.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=t.eventManager,this._eventCallbacks={onViewStateChange:t.onViewStateChange,onInteractionStateChange:t.onInteractionStateChange},Object.seal(this),this.setProps(t)}finalize(){for(const t in this.controllers){const e=this.controllers[t];e&&e.finalize()}this.controllers={}}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t,this._needsRedraw=this._needsRedraw||t}updateViewStates(){for(const t in this.controllers){const e=this.controllers[t];e&&e.updateTransition()}}getViewports(t){return t?this._viewports.filter(e=>e.containsPixel(t)):this._viewports}getViews(){const t={};return this.views.forEach(e=>{t[e.id]=e}),t}getView(t){return this.views.find(e=>e.id===t)}getViewState(t){const e=typeof t=="string"?this.getView(t):t,r=e&&this.viewState[e.getViewStateId()]||this.viewState;return e?e.filterViewState(r):r}getViewport(t){return this._viewportMap[t]}unproject(t,e){const r=this.getViewports(),i={x:t[0],y:t[1]};for(let s=r.length-1;s>=0;--s){const o=r[s];if(o.containsPixel(i)){const a=t.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,e)}}return null}setProps(t){t.views&&this._setViews(t.views),t.viewState&&this._setViewState(t.viewState),("width"in t||"height"in t)&&this._setSize(t.width,t.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(t,e){(t!==this.width||e!==this.height)&&(this.width=t,this.height=e,this.setNeedsUpdate("Size changed"))}_setViews(t){t=$s(t,Boolean),this._diffViews(t,this.views)&&this.setNeedsUpdate("views changed"),this.views=t}_setViewState(t){t?(!xe(t,this.viewState)&&this.setNeedsUpdate("viewState changed"),this.viewState=t):H.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(t,e){this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange({...e,viewId:t})}_createController(t,e){const r=e.type;return new r({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,e.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:s=>{var o;return(o=this.getView(t.id))===null||o===void 0?void 0:o.makeViewport({viewState:s,width:this.width,height:this.height})}})}_updateController(t,e,r,i){const s=t.controller;if(s){const o={...e,...s,id:t.id,x:r.x,y:r.y,width:r.width,height:r.height};return i||(i=this._createController(t,o)),i&&i.setProps(o),i}return null}_rebuildViewports(){const{views:t}=this,e=this.controllers;this._viewports=[],this.controllers={};let r=!1;for(let i=t.length;i--;){const s=t[i],o=this.getViewState(s),a=s.makeViewport({viewState:o,width:this.width,height:this.height});let c=e[s.id];const l=Boolean(s.controller);l&&!c&&(r=!0),(r||!l)&&c&&(c.finalize(),c=null),this.controllers[s.id]=this._updateController(s,o,a,c),this._viewports.unshift(a)}for(const i in e){const s=e[i];s&&!this.controllers[i]&&s.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(t=>{t.id&&(this._viewportMap[t.id]=this._viewportMap[t.id]||t)})}_diffViews(t,e){return t.length!==e.length?!0:t.some((r,i)=>!t[i].equals(e[i]))}}const ov=/([0-9]+\.?[0-9]*)(%|px)/;function se(n){switch(typeof n){case"number":return{position:n,relative:!1};case"string":const t=ov.exec(n);if(t&&t.length>=3){const e=t[2]==="%",r=parseFloat(t[1]);return{position:e?r/100:r,relative:e}}default:throw new Error("Could not parse position string ".concat(n))}}function oe(n,t){return n.relative?Math.round(n.position*t):n.position}function st(n,t){if(!n)throw new Error(t||"deck.gl: assertion failed.")}class Vt{constructor(t){f(this,"id",void 0),f(this,"viewportInstance",void 0),f(this,"_x",void 0),f(this,"_y",void 0),f(this,"_width",void 0),f(this,"_height",void 0),f(this,"_padding",void 0),f(this,"props",void 0);const{id:e,x:r=0,y:i=0,width:s="100%",height:o="100%",padding:a=null,viewportInstance:c}=t||{};st(!c||c instanceof jt),this.viewportInstance=c,this.id=e||this.constructor.displayName||"view",this.props={...t,id:this.id},this._x=se(r),this._y=se(i),this._width=se(s),this._height=se(o),this._padding=a&&{left:se(a.left||0),right:se(a.right||0),top:se(a.top||0),bottom:se(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(t){return this===t?!0:this.viewportInstance?t.viewportInstance?this.viewportInstance.equals(t.viewportInstance):!1:this.ViewportType===t.ViewportType&&xe(this.props,t.props)}makeViewport({width:t,height:e,viewState:r}){if(this.viewportInstance)return this.viewportInstance;r=this.filterViewState(r);const i=this.getDimensions({width:t,height:e});return new this.ViewportType({...r,...this.props,...i})}getViewStateId(){const{viewState:t}=this.props;return typeof t=="string"?t:(t==null?void 0:t.id)||this.id}filterViewState(t){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const e={...t};for(const r in this.props.viewState)r!=="id"&&(e[r]=this.props.viewState[r]);return e}return t}getDimensions({width:t,height:e}){const r={x:oe(this._x,t),y:oe(this._y,e),width:oe(this._width,t),height:oe(this._height,e)};return this._padding&&(r.padding={left:oe(this._padding.left,t),top:oe(this._padding.top,e),right:oe(this._padding.right,t),bottom:oe(this._padding.bottom,e)}),r}get controller(){const t=this.props.controller;return t?t===!0?{type:this.ControllerType}:typeof t=="function"?{type:t}:{type:this.ControllerType,...t}:null}}class Vn{constructor(t){f(this,"_inProgress",void 0),f(this,"_handle",void 0),f(this,"_timeline",void 0),f(this,"time",void 0),f(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=t,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(t){var e,r;this.cancel(),this.settings=t,this._inProgress=!0,(e=(r=this.settings).onStart)===null||e===void 0||e.call(r,this)}end(){if(this._inProgress){var t,e;this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(t=(e=this.settings).onEnd)===null||t===void 0||t.call(e,this)}}cancel(){if(this._inProgress){var t,e;(t=(e=this.settings).onInterrupt)===null||t===void 0||t.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1}}update(){var t,e;if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:r,settings:i}=this;this._handle=r.addChannel({delay:r.getTime(),duration:i.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(t=(e=this.settings).onUpdate)===null||t===void 0||t.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const nc=()=>{},ps={BREAK:1,SNAP_TO_END:2,IGNORE:3},av=n=>n,cv=ps.BREAK;class lv{constructor(t){f(this,"getControllerState",void 0),f(this,"props",void 0),f(this,"propsInTransition",void 0),f(this,"transition",void 0),f(this,"onViewStateChange",void 0),f(this,"onStateChange",void 0),f(this,"_onTransitionUpdate",e=>{const{time:r,settings:{interpolator:i,startProps:s,endProps:o,duration:a,easing:c}}=e,l=c(r/a),u=i.interpolateProps(s,o,l);this.propsInTransition=this.getControllerState({...this.props,...u}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})}),this.getControllerState=t.getControllerState,this.propsInTransition=null,this.transition=new Vn(t.timeline),this.onViewStateChange=t.onViewStateChange||nc,this.onStateChange=t.onStateChange||nc}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(t){let e=!1;const r=this.props;if(this.props=t,!r||this._shouldIgnoreViewportChange(r,t))return!1;if(this._isTransitionEnabled(t)){let i=r;if(this.transition.inProgress){const{interruption:s,endProps:o}=this.transition.settings;i={...r,...s===ps.SNAP_TO_END?o:this.propsInTransition||r}}this._triggerTransition(i,t),e=!0}else this.transition.cancel();return e}updateTransition(){this.transition.update()}_isTransitionEnabled(t){const{transitionDuration:e,transitionInterpolator:r}=t;return(e>0||e==="auto")&&Boolean(r)}_isUpdateDueToCurrentTransition(t){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(t,this.propsInTransition):!1}_shouldIgnoreViewportChange(t,e){return this.transition.inProgress?this.transition.settings.interruption===ps.IGNORE||this._isUpdateDueToCurrentTransition(e):this._isTransitionEnabled(e)?e.transitionInterpolator.arePropsEqual(t,e):!0}_triggerTransition(t,e){const r=this.getControllerState(t),i=this.getControllerState(e).shortestPathFrom(r),s=e.transitionInterpolator,o=s.getDuration?s.getDuration(t,e):e.transitionDuration;if(o===0)return;const a=s.initializeProps(t,i);this.propsInTransition={};const c={duration:o,easing:e.transitionEasing||av,interpolator:s,interruption:e.transitionInterruption||cv,startProps:a.start,endProps:a.end,onStart:e.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(e.onTransitionInterrupt),onEnd:this._onTransitionEnd(e.onTransitionEnd)};this.transition.start(c),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(t){return e=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),t==null||t(e)}}}class uv{constructor(t){f(this,"_propsToCompare",void 0),f(this,"_propsToExtract",void 0),f(this,"_requiredProps",void 0);const{compare:e,extract:r,required:i}=t;this._propsToCompare=e,this._propsToExtract=r||e,this._requiredProps=i}arePropsEqual(t,e){for(const r of this._propsToCompare)if(!(r in t)||!(r in e)||!Yt(t[r],e[r]))return!1;return!0}initializeProps(t,e){const r={},i={};for(const s of this._propsToExtract)(s in t||s in e)&&(r[s]=t[s],i[s]=e[s]);return this._checkRequiredProps(r),this._checkRequiredProps(i),{start:r,end:i}}getDuration(t,e){return e.transitionDuration}_checkRequiredProps(t){!this._requiredProps||this._requiredProps.forEach(e=>{const r=t[e];st(Number.isFinite(r)||Array.isArray(r),"".concat(e," is required for transition"))})}}const hv=["longitude","latitude","zoom","bearing","pitch"],fv=["longitude","latitude","zoom"];class Je extends uv{constructor(t={}){const e=Array.isArray(t)?t:t.transitionProps,r=Array.isArray(t)?{}:t;r.transitionProps=Array.isArray(e)?{compare:e,required:e}:e||{compare:hv,required:fv},super(r.transitionProps),f(this,"opts",void 0),this.opts=r}initializeProps(t,e){const r=super.initializeProps(t,e),{makeViewport:i,around:s}=this.opts;if(i&&s){const o=i(t),a=i(e),c=o.unproject(s);r.start.around=s,Object.assign(r.end,{around:a.project(c),aroundPosition:c,width:e.width,height:e.height})}return r}interpolateProps(t,e,r){const i={};for(const s of this._propsToExtract)i[s]=Rr(t[s]||0,e[s]||0,r);if(e.aroundPosition&&this.opts.makeViewport){const s=this.opts.makeViewport({...e,...i});Object.assign(i,s.panByPosition(e.aroundPosition,Rr(t.around,e.around,r)))}return i}}const ae={transitionDuration:0},dv=300,ur=n=>1-(1-n)*(1-n),De={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},pe={};class jn{constructor(t){f(this,"props",void 0),f(this,"state",{}),f(this,"transitionManager",void 0),f(this,"eventManager",void 0),f(this,"onViewStateChange",void 0),f(this,"onStateChange",void 0),f(this,"makeViewport",void 0),f(this,"_controllerState",void 0),f(this,"_events",{}),f(this,"_interactionState",{isDragging:!1}),f(this,"_customEvents",[]),f(this,"_eventStartBlocked",null),f(this,"_panMove",!1),f(this,"invertPan",!1),f(this,"dragMode","rotate"),f(this,"inertia",0),f(this,"scrollZoom",!0),f(this,"dragPan",!0),f(this,"dragRotate",!0),f(this,"doubleClickZoom",!0),f(this,"touchZoom",!0),f(this,"touchRotate",!1),f(this,"keyboard",!0),this.transitionManager=new lv({...t,getControllerState:e=>new this.ControllerState(e),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=t.eventManager,this.onViewStateChange=t.onViewStateChange||(()=>{}),this.onStateChange=t.onStateChange||(()=>{}),this.makeViewport=t.makeViewport}set events(t){this.toggleEvents(this._customEvents,!1),this.toggleEvents(t,!0),this._customEvents=t,this.props&&this.setProps(this.props)}finalize(){for(const e in this._events)if(this._events[e]){var t;(t=this.eventManager)===null||t===void 0||t.off(e,this.handleEvent)}this.transitionManager.finalize()}handleEvent(t){this._controllerState=void 0;const e=this._eventStartBlocked;switch(t.type){case"panstart":return e?!1:this._onPanStart(t);case"panmove":return this._onPan(t);case"panend":return this._onPanEnd(t);case"pinchstart":return e?!1:this._onPinchStart(t);case"pinchmove":return this._onPinch(t);case"pinchend":return this._onPinchEnd(t);case"tripanstart":return e?!1:this._onTriplePanStart(t);case"tripanmove":return this._onTriplePan(t);case"tripanend":return this._onTriplePanEnd(t);case"doubletap":return this._onDoubleTap(t);case"wheel":return this._onWheel(t);case"keydown":return this._onKeyDown(t);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(t){const{x:e,y:r}=this.props,{offsetCenter:i}=t;return[i.x-e,i.y-r]}isPointInBounds(t,e){const{width:r,height:i}=this.props;if(e&&e.handled)return!1;const s=t[0]>=0&&t[0]<=r&&t[1]>=0&&t[1]<=i;return s&&e&&e.stopPropagation(),s}isFunctionKeyPressed(t){const{srcEvent:e}=t;return Boolean(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(t){const e=setTimeout(()=>{this._eventStartBlocked===e&&(this._eventStartBlocked=null)},t);this._eventStartBlocked=e}setProps(t){t.dragMode&&(this.dragMode=t.dragMode),this.props=t,"transitionInterpolator"in t||(t.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(t);const{inertia:e}=t;this.inertia=Number.isFinite(e)?e:e===!0?dv:0;const{scrollZoom:r=!0,dragPan:i=!0,dragRotate:s=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:c=!1,keyboard:l=!0}=t,u=Boolean(this.onViewStateChange);this.toggleEvents(De.WHEEL,u&&r),this.toggleEvents(De.PAN,u&&(i||s)),this.toggleEvents(De.PINCH,u&&(a||c)),this.toggleEvents(De.TRIPLE_PAN,u&&c),this.toggleEvents(De.DOUBLE_TAP,u&&o),this.toggleEvents(De.KEYBOARD,u&&l),this.scrollZoom=r,this.dragPan=i,this.dragRotate=s,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=c,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(t,e){this.eventManager&&t.forEach(r=>{this._events[r]!==e&&(this._events[r]=e,e?this.eventManager.on(r,this.handleEvent):this.eventManager.off(r,this.handleEvent))})}updateViewport(t,e=null,r={}){const i={...t.getViewportProps(),...e},s=this.controllerState!==t;if(this.state=t.getState(),this._setInteractionState(r),s){const o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:i,interactionState:this._interactionState,oldViewState:o})}}_onTransition(t){this.onViewStateChange({...t,interactionState:this._interactionState})}_setInteractionState(t){Object.assign(this._interactionState,t),this.onStateChange(this._interactionState)}_onPanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let r=this.isFunctionKeyPressed(t)||t.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(r=!r);const i=this.controllerState[r?"panStart":"rotateStart"]({pos:e});return this._panMove=r,this.updateViewport(i,ae,{isDragging:!0}),!0}_onPan(t){return this.isDragging()?this._panMove?this._onPanMove(t):this._onPanRotate(t):!1}_onPanEnd(t){return this.isDragging()?this._panMove?this._onPanMoveEnd(t):this._onPanRotateEnd(t):!1}_onPanMove(t){if(!this.dragPan)return!1;const e=this.getCenter(t),r=this.controllerState.pan({pos:e});return this.updateViewport(r,ae,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(t){const{inertia:e}=this;if(this.dragPan&&e&&t.velocity){const r=this.getCenter(t),i=[r[0]+t.velocityX*e/2,r[1]+t.velocityY*e/2],s=this.controllerState.pan({pos:i}).panEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:ur},{isDragging:!1,isPanning:!0})}else{const r=this.controllerState.panEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(t){if(!this.dragRotate)return!1;const e=this.getCenter(t),r=this.controllerState.rotate({pos:e});return this.updateViewport(r,ae,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(t){const{inertia:e}=this;if(this.dragRotate&&e&&t.velocity){const r=this.getCenter(t),i=[r[0]+t.velocityX*e/2,r[1]+t.velocityY*e/2],s=this.controllerState.rotate({pos:i}).rotateEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:ur},{isDragging:!1,isRotating:!0})}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(t){if(!this.scrollZoom)return!1;t.srcEvent.preventDefault();const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const{speed:r=.01,smooth:i=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:s}=t;let o=2/(1+Math.exp(-Math.abs(s*r)));s<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:e,scale:o});return this.updateViewport(a,{...this._getTransitionProps({around:e}),transitionDuration:i?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const r=this.controllerState.rotateStart({pos:e});return this.updateViewport(r,ae,{isDragging:!0}),!0}_onTriplePan(t){if(!this.touchRotate||!this.isDragging())return!1;const e=this.getCenter(t);e[0]-=t.deltaX;const r=this.controllerState.rotate({pos:e});return this.updateViewport(r,ae,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this;if(this.touchRotate&&e&&t.velocityY){const r=this.getCenter(t),i=[r[0],r[1]+=t.velocityY*e/2],s=this.controllerState.rotate({pos:i});this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:ur},{isDragging:!1,isRotating:!0}),this.blockEvents(e)}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const r=this.controllerState.zoomStart({pos:e}).rotateStart({pos:e});return pe._startPinchRotation=t.rotation,pe._lastPinchEvent=t,this.updateViewport(r,ae,{isDragging:!0}),!0}_onPinch(t){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let e=this.controllerState;if(this.touchZoom){const{scale:r}=t,i=this.getCenter(t);e=e.zoom({pos:i,scale:r})}if(this.touchRotate){const{rotation:r}=t;e=e.rotate({deltaAngleX:pe._startPinchRotation-r})}return this.updateViewport(e,ae,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),pe._lastPinchEvent=t,!0}_onPinchEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this,{_lastPinchEvent:r}=pe;if(this.touchZoom&&e&&r&&t.scale!==r.scale){const i=this.getCenter(t);let s=this.controllerState.rotateEnd();const o=Math.log2(t.scale),a=(o-Math.log2(r.scale))/(t.deltaTime-r.deltaTime),c=Math.pow(2,o+a*e/2);s=s.zoom({pos:i,scale:c}).zoomEnd(),this.updateViewport(s,{...this._getTransitionProps({around:i}),transitionDuration:e,transitionEasing:ur},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(e)}else{const i=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return pe._startPinchRotation=null,pe._lastPinchEvent=null,!0}_onDoubleTap(t){if(!this.doubleClickZoom)return!1;const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const r=this.isFunctionKeyPressed(t),i=this.controllerState.zoom({pos:e,scale:r?.5:2});return this.updateViewport(i,this._getTransitionProps({around:e}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(t){if(!this.keyboard)return!1;const e=this.isFunctionKeyPressed(t),{zoomSpeed:r,moveSpeed:i,rotateSpeedX:s,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let c;const l={};switch(t.srcEvent.code){case"Minus":c=e?a.zoomOut(r).zoomOut(r):a.zoomOut(r),l.isZooming=!0;break;case"Equal":c=e?a.zoomIn(r).zoomIn(r):a.zoomIn(r),l.isZooming=!0;break;case"ArrowLeft":e?(c=a.rotateLeft(s),l.isRotating=!0):(c=a.moveLeft(i),l.isPanning=!0);break;case"ArrowRight":e?(c=a.rotateRight(s),l.isRotating=!0):(c=a.moveRight(i),l.isPanning=!0);break;case"ArrowUp":e?(c=a.rotateUp(o),l.isRotating=!0):(c=a.moveUp(i),l.isPanning=!0);break;case"ArrowDown":e?(c=a.rotateDown(o),l.isRotating=!0):(c=a.moveDown(i),l.isPanning=!0);break;default:return!1}return this.updateViewport(c,this._getTransitionProps(),l),!0}_getTransitionProps(t){const{transition:e}=this;return!e||!e.transitionInterpolator?ae:t?{...e,transitionInterpolator:new Je({...t,...e.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:e}}class Zs{constructor(t,e){f(this,"_viewportProps",void 0),f(this,"_state",void 0),this._viewportProps=this.applyConstraints(t),this._state=e}getViewportProps(){return this._viewportProps}getState(){return this._state}}const rc=5,gv=1.2;class gu extends Zs{constructor(t){const{width:e,height:r,latitude:i,longitude:s,zoom:o,bearing:a=0,pitch:c=0,altitude:l=1.5,position:u=[0,0,0],maxZoom:h=20,minZoom:g=0,maxPitch:m=60,minPitch:b=0,startPanLngLat:y,startZoomLngLat:v,startRotatePos:T,startBearing:A,startPitch:S,startZoom:x,normalize:M=!0}=t;st(Number.isFinite(s)),st(Number.isFinite(i)),st(Number.isFinite(o)),super({width:e,height:r,latitude:i,longitude:s,zoom:o,bearing:a,pitch:c,altitude:l,maxZoom:h,minZoom:g,maxPitch:m,minPitch:b,normalize:M,position:u},{startPanLngLat:y,startZoomLngLat:v,startRotatePos:T,startBearing:A,startPitch:S,startZoom:x}),f(this,"makeViewport",void 0),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanLngLat:this._unproject(t)})}pan({pos:t,startPos:e}){const r=this.getState().startPanLngLat||this._unproject(e);if(!r)return this;const s=this.makeViewport(this.getViewportProps()).panByPosition(r,t);return this._getUpdatedState(s)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:r=0}){const{startRotatePos:i,startBearing:s,startPitch:o}=this.getState();if(!i||s===void 0||o===void 0)return this;let a;return t?a=this._getNewRotation(t,i,o,s):a={bearing:s+e,pitch:o+r},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:t}){return this._getUpdatedState({startZoomLngLat:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:r}){let{startZoom:i,startZoomLngLat:s}=this.getState();if(s||(i=this.getViewportProps().zoom,s=this._unproject(e)||this._unproject(t)),!s)return this;const{maxZoom:o,minZoom:a}=this.getViewportProps();let c=i+Math.log2(r);c=Z(c,a,o);const l=this.makeViewport({...this.getViewportProps(),zoom:c});return this._getUpdatedState({zoom:c,...l.panByPosition(s,t)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(t=2){return this._zoomFromCenter(t)}zoomOut(t=2){return this._zoomFromCenter(1/t)}moveLeft(t=100){return this._panFromCenter([t,0])}moveRight(t=100){return this._panFromCenter([-t,0])}moveUp(t=100){return this._panFromCenter([0,t])}moveDown(t=100){return this._panFromCenter([0,-t])}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}shortestPathFrom(t){const e=t.getViewportProps(),r={...this.getViewportProps()},{bearing:i,longitude:s}=r;return Math.abs(i-e.bearing)>180&&(r.bearing=i<0?i+360:i-360),Math.abs(s-e.longitude)>180&&(r.longitude=s<0?s+360:s-360),r}applyConstraints(t){const{maxZoom:e,minZoom:r,zoom:i}=t;t.zoom=Z(i,r,e);const{maxPitch:s,minPitch:o,pitch:a}=t;t.pitch=Z(a,o,s);const{normalize:c=!0}=t;return c&&Object.assign(t,fy(t)),t}_zoomFromCenter(t){const{width:e,height:r}=this.getViewportProps();return this.zoom({pos:[e/2,r/2],scale:t})}_panFromCenter(t){const{width:e,height:r}=this.getViewportProps();return this.pan({startPos:[e/2,r/2],pos:[e/2+t[0],r/2+t[1]]})}_getUpdatedState(t){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...t})}_unproject(t){const e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_getNewRotation(t,e,r,i){const s=t[0]-e[0],o=t[1]-e[1],a=t[1],c=e[1],{width:l,height:u}=this.getViewportProps(),h=s/l;let g=0;o>0?Math.abs(u-c)>rc&&(g=o/(c-u)*gv):o<0&&c>rc&&(g=1-a/c),g=Z(g,-1,1);const{minPitch:m,maxPitch:b}=this.getViewportProps(),y=i+180*h;let v=r;return g>0?v=r+g*(b-r):g<0&&(v=r-g*(m-r)),{pitch:v,bearing:y}}}class pv extends jn{constructor(...t){super(...t),f(this,"ControllerState",gu),f(this,"transition",{transitionDuration:300,transitionInterpolator:new Je({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})}),f(this,"dragMode","pan")}setProps(t){t.position=t.position||[0,0,0];const e=this.props;super.setProps(t),(!e||e.height!==t.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...t,...this.state}))}}class pu extends Vt{get ViewportType(){return Kt}get ControllerType(){return pv}}f(pu,"displayName","MapView");class mv extends Kr{constructor(t,e){super(t,e),f(this,"maskMap",void 0),f(this,"fbo",void 0);const{mapSize:r=2048}=e;this.maskMap=new Tt(t,{width:r,height:r,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.fbo=new Q(t,{id:"maskmap",width:r,height:r,attachments:{[36064]:this.maskMap}})}render(t){const e=this.gl,r=[!1,!1,!1,!1];return r[t.channel]=!0,Pt(e,{clearColor:[255,255,255,255],blend:!0,blendFunc:[0,1],blendEquation:32778,colorMask:r,depthTest:!1},()=>super.render({...t,target:this.fbo,pass:"mask"}))}shouldDrawLayer(t){return t.props.operation===Bn.MASK}delete(){this.fbo.delete(),this.maskMap.delete()}}const _v=new ct().lookAt({eye:[0,0,1]});function bv({width:n,height:t,near:e,far:r,padding:i}){let s=-n/2,o=n/2,a=-t/2,c=t/2;if(i){const{left:l=0,right:u=0,top:h=0,bottom:g=0}=i,m=Z((l+n-u)/2,0,n)-n/2,b=Z((h+t-g)/2,0,t)-t/2;s-=m,o-=m,a+=b,c+=b}return new ct().ortho({left:s,right:o,bottom:a,top:c,near:e,far:r})}class yv extends jt{constructor(t){const{width:e,height:r,near:i=.1,far:s=1e3,zoom:o=0,target:a=[0,0,0],padding:c=null,flipY:l=!0}=t,u=Array.isArray(o)?o[0]:o,h=Array.isArray(o)?o[1]:o,g=Math.min(u,h),m=Math.pow(2,g);let b;if(u!==h){const y=Math.pow(2,u),v=Math.pow(2,h);b={unitsPerMeter:[y/m,v/m,1],metersPerUnit:[m/y,m/v,1]}}super({...t,longitude:void 0,position:a,viewMatrix:_v.clone().scale([m,m*(l?-1:1),m]),projectionMatrix:bv({width:e||1,height:r||1,padding:c,near:i,far:s}),zoom:g,distanceScales:b})}projectFlat([t,e]){const{unitsPerMeter:r}=this.distanceScales;return[t*r[0],e*r[1]]}unprojectFlat([t,e]){const{metersPerUnit:r}=this.distanceScales;return[t*r[0],e*r[1]]}panByPosition(t,e){const r=Un(e,this.pixelUnprojectionMatrix),i=this.projectFlat(t),s=Ir([],i,Hl([],r)),o=Ir([],this.center,s);return{target:this.unprojectFlat(o)}}}class mu extends Zs{constructor(t){const{width:e,height:r,rotationX:i=0,rotationOrbit:s=0,target:o=[0,0,0],zoom:a=0,minRotationX:c=-90,maxRotationX:l=90,minZoom:u=-1/0,maxZoom:h=1/0,startPanPosition:g,startRotatePos:m,startRotationX:b,startRotationOrbit:y,startZoomPosition:v,startZoom:T}=t;super({width:e,height:r,rotationX:i,rotationOrbit:s,target:o,zoom:a,minRotationX:c,maxRotationX:l,minZoom:u,maxZoom:h},{startPanPosition:g,startRotatePos:m,startRotationX:b,startRotationOrbit:y,startZoomPosition:v,startZoom:T}),f(this,"makeViewport",void 0),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanPosition:this._unproject(t)})}pan({pos:t,startPosition:e}){const r=this.getState().startPanPosition||e;if(!r)return this;const s=this.makeViewport(this.getViewportProps()).panByPosition(r,t);return this._getUpdatedState(s)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:r=0}){const{startRotatePos:i,startRotationX:s,startRotationOrbit:o}=this.getState(),{width:a,height:c}=this.getViewportProps();if(!i||s===void 0||o===void 0)return this;let l;if(t){let u=(t[0]-i[0])/a;const h=(t[1]-i[1])/c;(s<-90||s>90)&&(u*=-1),l={rotationX:s+h*180,rotationOrbit:o+u*180}}else l={rotationX:s+r,rotationOrbit:o+e};return this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(t){const e=t.getViewportProps(),r={...this.getViewportProps()},{rotationOrbit:i}=r;return Math.abs(i-e.rotationOrbit)>180&&(r.rotationOrbit=i<0?i+360:i-360),r}zoomStart({pos:t}){return this._getUpdatedState({startZoomPosition:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:r}){let{startZoom:i,startZoomPosition:s}=this.getState();if(s||(i=this.getViewportProps().zoom,s=this._unproject(e)||this._unproject(t)),!s)return this;const o=this._calculateNewZoom({scale:r,startZoom:i}),a=this.makeViewport({...this.getViewportProps(),zoom:o});return this._getUpdatedState({zoom:o,...a.panByPosition(s,t)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(t=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:t})})}zoomOut(t=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/t})})}moveLeft(t=50){return this._panFromCenter([-t,0])}moveRight(t=50){return this._panFromCenter([t,0])}moveUp(t=50){return this._panFromCenter([0,-t])}moveDown(t=50){return this._panFromCenter([0,t])}rotateLeft(t=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-t})}rotateRight(t=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+t})}rotateUp(t=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-t})}rotateDown(t=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+t})}_unproject(t){const e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_calculateNewZoom({scale:t,startZoom:e}){const{maxZoom:r,minZoom:i}=this.getViewportProps();e===void 0&&(e=this.getViewportProps().zoom);const s=e+Math.log2(t);return Z(s,i,r)}_panFromCenter(t){const{width:e,height:r,target:i}=this.getViewportProps();return this.pan({startPosition:i,pos:[e/2+t[0],r/2+t[1]]})}_getUpdatedState(t){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...t})}applyConstraints(t){const{maxZoom:e,minZoom:r,zoom:i,maxRotationX:s,minRotationX:o,rotationOrbit:a}=t;return t.zoom=Array.isArray(i)?[Z(i[0],r,e),Z(i[1],r,e)]:Z(i,r,e),t.rotationX=Z(t.rotationX,o,s),(a<-180||a>180)&&(t.rotationOrbit=Dr(a+180,360)-180),t}}class vv extends jn{constructor(...t){super(...t),f(this,"ControllerState",mu),f(this,"transition",{transitionDuration:300,transitionInterpolator:new Je({transitionProps:{compare:["target","zoom","rotationX","rotationOrbit"],required:["target","zoom"]}})})}}class Ev extends mu{constructor(t){super(t),f(this,"zoomAxis",void 0),this.zoomAxis=t.zoomAxis||"all"}_calculateNewZoom({scale:t,startZoom:e}){const{maxZoom:r,minZoom:i}=this.getViewportProps();e===void 0&&(e=this.getViewportProps().zoom);let s=Math.log2(t);if(Array.isArray(e)){let[o,a]=e;switch(this.zoomAxis){case"X":o=Z(o+s,i,r);break;case"Y":a=Z(a+s,i,r);break;default:let c=Math.min(o+s,a+s);c<i&&(s+=i-c),c=Math.max(o+s,a+s),c>r&&(s+=r-c),o+=s,a+=s}return[o,a]}return Z(e+s,i,r)}}class Tv extends jn{constructor(...t){super(...t),f(this,"ControllerState",Ev),f(this,"transition",{transitionDuration:300,transitionInterpolator:new Je(["target","zoom"])}),f(this,"dragMode","pan")}_onPanRotate(){return!1}}class _u extends Vt{get ViewportType(){return yv}get ControllerType(){return Tv}}f(_u,"displayName","OrthographicView");function wv({layers:n,viewport:t}){let e=null;for(const s of n){const o=s.getBounds();o&&(e?(e[0]=Math.min(e[0],o[0][0]),e[1]=Math.min(e[1],o[0][1]),e[2]=Math.max(e[2],o[1][0]),e[3]=Math.max(e[3],o[1][1])):e=[o[0][0],o[0][1],o[1][0],o[1][1]])}const r=t.getBounds();if(!e)return r;const i=Sv(r);return e[2]-e[0]<i[2]-i[0]||e[3]-e[1]<i[3]-i[1]||(e[0]=Math.max(e[0],i[0]),e[1]=Math.max(e[1],i[1]),e[2]=Math.min(e[2],i[2]),e[3]=Math.min(e[3],i[3])),e}function Av({bounds:n,viewport:t,width:e,height:r}){if(n[2]<=n[0]||n[3]<=n[1])return null;const i=1;if(e-=i*2,r-=i*2,t instanceof Kt){const{longitude:a,latitude:c,zoom:l}=lu({width:e,height:r,bounds:[[n[0],n[1]],[n[2],n[3]]],maxZoom:20});return new Kt({longitude:a,latitude:c,zoom:l,x:i,y:i,width:e,height:r})}const s=[(n[0]+n[2])/2,(n[1]+n[3])/2,0],o=Math.min(20,e/(n[2]-n[0]),r/(n[3]-n[1]));return new _u({x:i,y:i}).makeViewport({width:e,height:r,viewState:{target:s,zoom:Math.log2(o)}})}function Sv(n){const t={x:n[2]-n[0],y:n[3]-n[1]},e={x:n[0]+.5*t.x,y:n[1]+.5*t.y};return[e.x-t.x,e.y-t.y,e.x+t.x,e.y+t.y]}class xv{constructor(){f(this,"id","mask-effect"),f(this,"props",null),f(this,"useInPicking",!0),f(this,"dummyMaskMap",void 0),f(this,"channels",[]),f(this,"masks",null),f(this,"maskPass",void 0),f(this,"maskMap",void 0),f(this,"lastViewport",void 0)}preRender(t,{layers:e,layerFilter:r,viewports:i,onViewportActive:s,views:o}){this.dummyMaskMap||(this.dummyMaskMap=new Tt(t,{width:1,height:1}));const a=e.filter(h=>h.props.visible&&h.props.operation===Bn.MASK);if(a.length===0){this.masks=null,this.channels.length=0;return}this.masks={},this.maskPass||(this.maskPass=new mv(t,{id:"default-mask"}),this.maskMap=this.maskPass.maskMap);const c=this._sortMaskChannels(a),l=i[0],u=!this.lastViewport||!this.lastViewport.equals(l);for(const h in c)this._renderChannel(c[h],{layerFilter:r,onViewportActive:s,views:o,viewport:l,viewportChanged:u})}_renderChannel(t,{layerFilter:e,onViewportActive:r,views:i,viewport:s,viewportChanged:o}){const a=this.channels[t.index];if(!a)return;const c=t===a||a.layers.length!==t.layers.length||t.layerBounds.some((l,u)=>l!==a.layerBounds[u]);if(t.bounds=a.bounds,t.maskBounds=a.maskBounds,this.channels[t.index]=t,(c||o)&&(this.lastViewport=s,t.bounds=wv({layers:t.layers,viewport:s}),c||!Yt(t.bounds,a.bounds))){const{maskPass:l,maskMap:u}=this,h=Av({bounds:t.bounds,viewport:s,width:u.width,height:u.height});t.maskBounds=h?h.getBounds():[0,0,1,1],l.render({pass:"mask",channel:t.index,layers:t.layers,layerFilter:e,viewports:h?[h]:[],onViewportActive:r,views:i,moduleParameters:{devicePixelRatio:1}})}this.masks[t.id]={index:t.index,bounds:t.maskBounds,coordinateOrigin:t.coordinateOrigin,coordinateSystem:t.coordinateSystem}}_sortMaskChannels(t){const e={};let r=0;for(const i of t){const{id:s}=i.root;let o=e[s];if(!o){if(++r>4){H.warn("Too many mask layers. The max supported is 4")();continue}o={id:s,index:this.channels.findIndex(a=>(a==null?void 0:a.id)===s),layers:[],layerBounds:[],coordinateOrigin:i.root.props.coordinateOrigin,coordinateSystem:i.root.props.coordinateSystem},e[s]=o}o.layers.push(i),o.layerBounds.push(i.getBounds())}for(let i=0;i<4;i++){const s=this.channels[i];(!s||!(s.id in e))&&(this.channels[i]=null)}for(const i in e){const s=e[i];s.index<0&&(s.index=this.channels.findIndex(o=>!o),this.channels[s.index]=s)}return e}getModuleParameters(){return{maskMap:this.masks?this.maskMap:this.dummyMaskMap,maskChannels:this.masks}}cleanup(){this.dummyMaskMap&&(this.dummyMaskMap.delete(),this.dummyMaskMap=void 0),this.maskPass&&(this.maskPass.delete(),this.maskPass=void 0,this.maskMap=void 0),this.lastViewport=void 0,this.masks=null,this.channels.length=0}}const Pv=new hu;class Mv{constructor(){f(this,"effects",void 0),f(this,"_internalEffects",void 0),f(this,"_needsRedraw",void 0),this.effects=[],this._internalEffects=[],this._needsRedraw="Initial render",this.setEffects()}setProps(t){"effects"in t&&(t.effects.length!==this.effects.length||!xe(t.effects,this.effects))&&(this.setEffects(t.effects),this._needsRedraw="effects changed")}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}getEffects(){return this._internalEffects}finalize(){this.cleanup()}setEffects(t=[]){this.cleanup(),this.effects=t,this._internalEffects=t.slice(),this._internalEffects.push(new xv),t.some(e=>e instanceof hu)||this._internalEffects.push(Pv)}cleanup(){for(const t of this.effects)t.cleanup();for(const t of this._internalEffects)t.cleanup();this.effects.length=0,this._internalEffects.length=0}}class Lv extends Kr{shouldDrawLayer(t){return t.props.operation===Bn.DRAW}}const ic={blendFunc:[1,0,32771,0],blendEquation:32774};class bu extends Kr{constructor(...t){super(...t),f(this,"pickZ",void 0),f(this,"_colors",null)}render(t){return t.pickingFBO?this._drawPickingBuffer(t):super.render(t)}_drawPickingBuffer({layers:t,layerFilter:e,views:r,viewports:i,onViewportActive:s,pickingFBO:o,deviceRect:{x:a,y:c,width:l,height:u},cullRect:h,effects:g,pass:m="picking",pickZ:b}){const y=this.gl;this.pickZ=b;const v=b?null:{byLayer:new Map,byAlpha:[]};this._colors=v;const T=Pt(y,{scissorTest:!0,scissor:[a,c,l,u],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0],...ic,blend:!b},()=>super.render({target:o,layers:t,layerFilter:e,views:r,viewports:i,onViewportActive:s,cullRect:h,effects:g==null?void 0:g.filter(S=>S.useInPicking),pass:m}));return this._colors=null,{decodePickingColor:v&&Iv.bind(null,v),stats:T}}shouldDrawLayer(t){return t.props.pickable&&t.props.operation===Bn.DRAW}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(t,e,r){const i={...t.props.parameters};return this._colors?(Object.assign(i,ic),i.blend=!0,i.blendColor=Rv(this._colors,t,r)):i.blend=!1,i}}function Rv(n,t,e){const{byLayer:r,byAlpha:i}=n;let s,o=r.get(t);return o?(o.viewports.push(e),s=o.a):(s=r.size+1,s<=255?(o={a:s,layer:t,viewports:[e]},r.set(t,o),i[s]=o):(H.warn("Too many pickable layers, only picking the first 255")(),s=0)),[0,0,0,s/255]}function Iv(n,t){const e=n.byAlpha[t[3]];return e&&{pickedLayer:e.layer,pickedViewports:e.viewports,pickedObjectIndex:e.layer.decodePickingColor(t)}}const Cv="deckRenderer.renderLayers";class Ov{constructor(t){this.gl=t,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new Lv(t),this.pickLayersPass=new bu(t),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(t){"layerFilter"in t&&this.layerFilter!==t.layerFilter&&(this.layerFilter=t.layerFilter,this._needsRedraw="layerFilter changed"),"drawPickingColors"in t&&this.drawPickingColors!==t.drawPickingColors&&(this.drawPickingColors=t.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(t){const e=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass;t.layerFilter=t.layerFilter||this.layerFilter,t.effects=t.effects||[],t.target=t.target||Q.getDefaultFramebuffer(this.gl),this._preRender(t.effects,t);const r=this.lastPostProcessEffect?this.renderBuffers[0]:t.target,i=e.render({...t,target:r});this._postRender(t.effects,t),this.renderCount++,at(Cv,this,i,t)}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}finalize(){const{renderBuffers:t}=this;for(const e of t)e.delete();t.length=0}_preRender(t,e){let r=null;for(const i of t)i.preRender(this.gl,e),i.postRender&&(r=i);r&&this._resizeRenderBuffers(),this.lastPostProcessEffect=r}_resizeRenderBuffers(){const{renderBuffers:t}=this;t.length===0&&t.push(new Q(this.gl),new Q(this.gl));for(const e of t)e.resize()}_postRender(t,e){const{renderBuffers:r}=this,i={inputBuffer:r[0],swapBuffer:r[1],target:null};for(const s of t)if(s.postRender){if(s===this.lastPostProcessEffect){i.target=e.target,s.postRender(this.gl,i);break}const o=s.postRender(this.gl,i);i.inputBuffer=o,i.swapBuffer=o===r[0]?r[1]:r[0]}}}const kv={pickedColor:null,pickedObjectIndex:-1};function Nv({pickedColors:n,decodePickingColor:t,deviceX:e,deviceY:r,deviceRadius:i,deviceRect:s}){const{x:o,y:a,width:c,height:l}=s;let u=i*i,h=-1,g=0;for(let m=0;m<l;m++){const b=m+a-r,y=b*b;if(y>u)g+=4*c;else for(let v=0;v<c;v++){if(n[g+3]-1>=0){const A=v+o-e,S=A*A+y;S<=u&&(u=S,h=g)}g+=4}}if(h>=0){const m=n.slice(h,h+4),b=t(m);if(b){const y=Math.floor(h/4/c),v=h/4-y*c;return{...b,pickedColor:m,pickedX:o+v,pickedY:a+y}}H.error("Picked non-existent layer. Is picking buffer corrupt?")()}return kv}function Dv({pickedColors:n,decodePickingColor:t}){const e=new Map;if(n){for(let r=0;r<n.length;r+=4)if(n[r+3]-1>=0){const s=n.slice(r,r+4),o=s.join(",");if(!e.has(o)){const a=t(s);a?e.set(o,{...a,color:s}):H.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(e.values())}function yu({pickInfo:n,viewports:t,pixelRatio:e,x:r,y:i,z:s}){let o=t[0];t.length>1&&(o=Bv((n==null?void 0:n.pickedViewports)||t,{x:r,y:i}));let a;if(o){const c=[r-o.x,i-o.y];s!==void 0&&(c[2]=s),a=o.unproject(c)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:r,y:i,pixel:[r,i],coordinate:a,devicePixel:n&&"pickedX"in n?[n.pickedX,n.pickedY]:void 0,pixelRatio:e}}function Fv(n){const{pickInfo:t,lastPickedInfo:e,mode:r,layers:i}=n,{pickedColor:s,pickedLayer:o,pickedObjectIndex:a}=t,c=o?[o]:[];if(r==="hover"){const h=e.index,g=e.layerId,m=o?o.props.id:null;if(m!==g||a!==h){if(m!==g){const b=i.find(y=>y.props.id===g);b&&c.unshift(b)}e.layerId=m,e.index=a,e.info=null}}const l=yu(n),u=new Map;return u.set(null,l),c.forEach(h=>{let g={...l};h===o&&(g.color=s,g.index=a,g.picked=!0),g=vu({layer:h,info:g,mode:r});const m=g.layer;h===o&&r==="hover"&&(e.info=g),u.set(m.id,g),r==="hover"&&m.updateAutoHighlight(g)}),u}function vu({layer:n,info:t,mode:e}){for(;n&&t;){const r=t.layer||null;t.sourceLayer=r,t.layer=n,t=n.getPickingInfo({info:t,mode:e,sourceLayer:r}),n=n.parent}return t}function Bv(n,t){for(let e=n.length-1;e>=0;e--){const r=n[e];if(r.containsPixel(t))return r}return n[0]}class Uv{constructor(t){f(this,"gl",void 0),f(this,"pickingFBO",void 0),f(this,"depthFBO",void 0),f(this,"pickLayersPass",void 0),f(this,"layerFilter",void 0),f(this,"lastPickedInfo",void 0),f(this,"_pickable",!0),this.gl=t,this.pickLayersPass=new bu(t),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(t){"layerFilter"in t&&(this.layerFilter=t.layerFilter),"_pickable"in t&&(this._pickable=t._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(t){return this._pickClosestObject(t)}pickObjects(t){return this._pickVisibleObjects(t)}getLastPickedObject({x:t,y:e,layers:r,viewports:i},s=this.lastPickedInfo.info){const o=s&&s.layer&&s.layer.id,a=s&&s.viewport&&s.viewport.id,c=o?r.find(g=>g.id===o):null,l=a&&i.find(g=>g.id===a)||i[0],u=l&&l.unproject([t-l.x,e-l.y]);return{...s,...{x:t,y:e,viewport:l,coordinate:u,layer:c}}}_resizeBuffer(){var t,e;const{gl:r}=this;if(!this.pickingFBO&&(this.pickingFBO=new Q(r),Q.isSupported(r,{colorBufferFloat:!0}))){const i=new Q(r);i.attach({[36064]:new Tt(r,{format:j(r)?34836:6408,type:5126})}),this.depthFBO=i}(t=this.pickingFBO)===null||t===void 0||t.resize({width:r.canvas.width,height:r.canvas.height}),(e=this.depthFBO)===null||e===void 0||e.resize({width:r.canvas.width,height:r.canvas.height})}_getPickable(t){if(this._pickable===!1)return null;const e=t.filter(r=>r.isPickable()&&!r.isComposite);return e.length?e:null}_pickClosestObject({layers:t,views:e,viewports:r,x:i,y:s,radius:o=0,depth:a=1,mode:c="query",unproject3D:l,onViewportActive:u,effects:h}){const g=this._getPickable(t),m=We(this.gl);if(!g)return{result:[],emptyInfo:yu({viewports:r,x:i,y:s,pixelRatio:m})};this._resizeBuffer();const b=Si(this.gl,[i,s],!0),y=[b.x+Math.floor(b.width/2),b.y+Math.floor(b.height/2)],v=Math.round(o*m),{width:T,height:A}=this.pickingFBO,S=this._getPickingRect({deviceX:y[0],deviceY:y[1],deviceRadius:v,deviceWidth:T,deviceHeight:A}),x={x:i-o,y:s-o,width:o*2+1,height:o*2+1};let M;const R=[],N=new Set;for(let U=0;U<a;U++){let k;if(S){const F=this._drawAndSample({layers:g,views:e,viewports:r,onViewportActive:u,deviceRect:S,cullRect:x,effects:h,pass:"picking:".concat(c)});k=Nv({...F,deviceX:y[0],deviceY:y[1],deviceRadius:v,deviceRect:S})}else k={pickedColor:null,pickedObjectIndex:-1};let D;k.pickedLayer&&l&&this.depthFBO&&(D=this._drawAndSample({layers:[k.pickedLayer],views:e,viewports:r,onViewportActive:u,deviceRect:{x:k.pickedX,y:k.pickedY,width:1,height:1},cullRect:x,effects:h,pass:"picking:".concat(c,":z")},!0).pickedColors[0]),k.pickedLayer&&U+1<a&&(N.add(k.pickedLayer),k.pickedLayer.disablePickingIndex(k.pickedObjectIndex)),M=Fv({pickInfo:k,lastPickedInfo:this.lastPickedInfo,mode:c,layers:g,viewports:r,x:i,y:s,z:D,pixelRatio:m});for(const F of M.values())F.layer&&R.push(F);if(!k.pickedColor)break}for(const U of N)U.restorePickingColors();return{result:R,emptyInfo:M.get(null)}}_pickVisibleObjects({layers:t,views:e,viewports:r,x:i,y:s,width:o=1,height:a=1,mode:c="query",maxObjects:l=null,onViewportActive:u,effects:h}){const g=this._getPickable(t);if(!g)return[];this._resizeBuffer();const m=We(this.gl),b=Si(this.gl,[i,s],!0),y=b.x,v=b.y+b.height,T=Si(this.gl,[i+o,s+a],!0),A=T.x+T.width,S=T.y,x={x:y,y:S,width:A-y,height:v-S},M=this._drawAndSample({layers:g,views:e,viewports:r,onViewportActive:u,deviceRect:x,cullRect:{x:i,y:s,width:o,height:a},effects:h,pass:"picking:".concat(c)}),R=Dv(M),N=new Map,U=Number.isFinite(l);for(let k=0;k<R.length&&!(U&&l&&N.size>=l);k++){const D=R[k];let F={color:D.pickedColor,layer:null,index:D.pickedObjectIndex,picked:!0,x:i,y:s,pixelRatio:m};F=vu({layer:D.pickedLayer,info:F,mode:c}),N.has(F.object)||N.set(F.object,F)}return Array.from(N.values())}_drawAndSample({layers:t,views:e,viewports:r,onViewportActive:i,deviceRect:s,cullRect:o,effects:a,pass:c},l=!1){const u=l?this.depthFBO:this.pickingFBO,{decodePickingColor:h}=this.pickLayersPass.render({layers:t,layerFilter:this.layerFilter,views:e,viewports:r,onViewportActive:i,pickingFBO:u,deviceRect:s,cullRect:o,effects:a,pass:c,pickZ:l}),{x:g,y:m,width:b,height:y}=s,v=new(l?Float32Array:Uint8Array)(b*y*4);return qr(u,{sourceX:g,sourceY:m,sourceWidth:b,sourceHeight:y,target:v}),{pickedColors:v,decodePickingColor:h}}_getPickingRect({deviceX:t,deviceY:e,deviceRadius:r,deviceWidth:i,deviceHeight:s}){const o=Math.max(0,t-r),a=Math.max(0,e-r),c=Math.min(i,t+r+1)-o,l=Math.min(s,e+r+1)-a;return c<=0||l<=0?null:{x:o,y:a,width:c,height:l}}}const Vv={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class jv{constructor(t){f(this,"el",null),f(this,"isVisible",!1);const e=t.parentElement;e&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,Vv),e.appendChild(this.el))}setTooltip(t,e,r){const i=this.el;if(!!i){if(typeof t=="string")i.innerText=t;else if(t)t.text&&(i.innerText=t.text),t.html&&(i.innerHTML=t.html),t.className&&(i.className=t.className),Object.assign(i.style,t.style);else{this.isVisible=!1,i.style.display="none";return}this.isVisible=!0,i.style.display="block",i.style.transform="translate(".concat(e,"px, ").concat(r,"px)")}}remove(){this.el&&(this.el.remove(),this.el=null)}}var tn={exports:{}};/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */(function(n){(function(t,e,r,i){var s=["","webkit","Moz","MS","ms","o"],o=e.createElement("div"),a="function",c=Math.round,l=Math.abs,u=Date.now;function h(d,p,_){return setTimeout(S(d,_),p)}function g(d,p,_){return Array.isArray(d)?(m(d,_[p],_),!0):!1}function m(d,p,_){var E;if(!!d)if(d.forEach)d.forEach(p,_);else if(d.length!==i)for(E=0;E<d.length;)p.call(_,d[E],E,d),E++;else for(E in d)d.hasOwnProperty(E)&&p.call(_,d[E],E,d)}function b(d,p,_){var E="DEPRECATED METHOD: "+p+`
`+_+` AT 
`;return function(){var P=new Error("get-stack-trace"),I=P&&P.stack?P.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",V=t.console&&(t.console.warn||t.console.log);return V&&V.call(t.console,E,I),d.apply(this,arguments)}}var y;typeof Object.assign!="function"?y=function(p){if(p===i||p===null)throw new TypeError("Cannot convert undefined or null to object");for(var _=Object(p),E=1;E<arguments.length;E++){var P=arguments[E];if(P!==i&&P!==null)for(var I in P)P.hasOwnProperty(I)&&(_[I]=P[I])}return _}:y=Object.assign;var v=b(function(p,_,E){for(var P=Object.keys(_),I=0;I<P.length;)(!E||E&&p[P[I]]===i)&&(p[P[I]]=_[P[I]]),I++;return p},"extend","Use `assign`."),T=b(function(p,_){return v(p,_,!0)},"merge","Use `assign`.");function A(d,p,_){var E=p.prototype,P;P=d.prototype=Object.create(E),P.constructor=d,P._super=E,_&&y(P,_)}function S(d,p){return function(){return d.apply(p,arguments)}}function x(d,p){return typeof d==a?d.apply(p&&p[0]||i,p):d}function M(d,p){return d===i?p:d}function R(d,p,_){m(D(p),function(E){d.addEventListener(E,_,!1)})}function N(d,p,_){m(D(p),function(E){d.removeEventListener(E,_,!1)})}function U(d,p){for(;d;){if(d==p)return!0;d=d.parentNode}return!1}function k(d,p){return d.indexOf(p)>-1}function D(d){return d.trim().split(/\s+/g)}function F(d,p,_){if(d.indexOf&&!_)return d.indexOf(p);for(var E=0;E<d.length;){if(_&&d[E][_]==p||!_&&d[E]===p)return E;E++}return-1}function J(d){return Array.prototype.slice.call(d,0)}function et(d,p,_){for(var E=[],P=[],I=0;I<d.length;){var V=p?d[I][p]:d[I];F(P,V)<0&&E.push(d[I]),P[I]=V,I++}return _&&(p?E=E.sort(function(rt,ut){return rt[p]>ut[p]}):E=E.sort()),E}function z(d,p){for(var _,E,P=p[0].toUpperCase()+p.slice(1),I=0;I<s.length;){if(_=s[I],E=_?_+P:p,E in d)return E;I++}return i}var ue=1;function zu(){return ue++}function so(d){var p=d.ownerDocument||d;return p.defaultView||p.parentWindow||t}var Gu=/mobile|tablet|ip(ad|hone|od)|android/i,oo="ontouchstart"in t,Hu=z(t,"PointerEvent")!==i,Wu=oo&&Gu.test(navigator.userAgent),en="touch",Xu="pen",ri="mouse",Yu="kinect",qu=25,lt=1,he=2,K=4,dt=8,zn=1,nn=2,rn=4,sn=8,on=16,Ot=nn|rn,fe=sn|on,ao=Ot|fe,co=["x","y"],Gn=["clientX","clientY"];function wt(d,p){var _=this;this.manager=d,this.callback=p,this.element=d.element,this.target=d.options.inputTarget,this.domHandler=function(E){x(d.options.enable,[d])&&_.handler(E)},this.init()}wt.prototype={handler:function(){},init:function(){this.evEl&&R(this.element,this.evEl,this.domHandler),this.evTarget&&R(this.target,this.evTarget,this.domHandler),this.evWin&&R(so(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&N(this.element,this.evEl,this.domHandler),this.evTarget&&N(this.target,this.evTarget,this.domHandler),this.evWin&&N(so(this.element),this.evWin,this.domHandler)}};function $u(d){var p,_=d.options.inputClass;return _?p=_:Hu?p=si:Wu?p=Xn:oo?p=oi:p=Wn,new p(d,Zu)}function Zu(d,p,_){var E=_.pointers.length,P=_.changedPointers.length,I=p&lt&&E-P===0,V=p&(K|dt)&&E-P===0;_.isFirst=!!I,_.isFinal=!!V,I&&(d.session={}),_.eventType=p,Ku(d,_),d.emit("hammer.input",_),d.recognize(_),d.session.prevInput=_}function Ku(d,p){var _=d.session,E=p.pointers,P=E.length;_.firstInput||(_.firstInput=lo(p)),P>1&&!_.firstMultiple?_.firstMultiple=lo(p):P===1&&(_.firstMultiple=!1);var I=_.firstInput,V=_.firstMultiple,nt=V?V.center:I.center,rt=p.center=uo(E);p.timeStamp=u(),p.deltaTime=p.timeStamp-I.timeStamp,p.angle=ii(nt,rt),p.distance=Hn(nt,rt),Qu(_,p),p.offsetDirection=fo(p.deltaX,p.deltaY);var ut=ho(p.deltaTime,p.deltaX,p.deltaY);p.overallVelocityX=ut.x,p.overallVelocityY=ut.y,p.overallVelocity=l(ut.x)>l(ut.y)?ut.x:ut.y,p.scale=V?eh(V.pointers,E):1,p.rotation=V?th(V.pointers,E):0,p.maxPointers=_.prevInput?p.pointers.length>_.prevInput.maxPointers?p.pointers.length:_.prevInput.maxPointers:p.pointers.length,Ju(_,p);var Nt=d.element;U(p.srcEvent.target,Nt)&&(Nt=p.srcEvent.target),p.target=Nt}function Qu(d,p){var _=p.center,E=d.offsetDelta||{},P=d.prevDelta||{},I=d.prevInput||{};(p.eventType===lt||I.eventType===K)&&(P=d.prevDelta={x:I.deltaX||0,y:I.deltaY||0},E=d.offsetDelta={x:_.x,y:_.y}),p.deltaX=P.x+(_.x-E.x),p.deltaY=P.y+(_.y-E.y)}function Ju(d,p){var _=d.lastInterval||p,E=p.timeStamp-_.timeStamp,P,I,V,nt;if(p.eventType!=dt&&(E>qu||_.velocity===i)){var rt=p.deltaX-_.deltaX,ut=p.deltaY-_.deltaY,Nt=ho(E,rt,ut);I=Nt.x,V=Nt.y,P=l(Nt.x)>l(Nt.y)?Nt.x:Nt.y,nt=fo(rt,ut),d.lastInterval=p}else P=_.velocity,I=_.velocityX,V=_.velocityY,nt=_.direction;p.velocity=P,p.velocityX=I,p.velocityY=V,p.direction=nt}function lo(d){for(var p=[],_=0;_<d.pointers.length;)p[_]={clientX:c(d.pointers[_].clientX),clientY:c(d.pointers[_].clientY)},_++;return{timeStamp:u(),pointers:p,center:uo(p),deltaX:d.deltaX,deltaY:d.deltaY}}function uo(d){var p=d.length;if(p===1)return{x:c(d[0].clientX),y:c(d[0].clientY)};for(var _=0,E=0,P=0;P<p;)_+=d[P].clientX,E+=d[P].clientY,P++;return{x:c(_/p),y:c(E/p)}}function ho(d,p,_){return{x:p/d||0,y:_/d||0}}function fo(d,p){return d===p?zn:l(d)>=l(p)?d<0?nn:rn:p<0?sn:on}function Hn(d,p,_){_||(_=co);var E=p[_[0]]-d[_[0]],P=p[_[1]]-d[_[1]];return Math.sqrt(E*E+P*P)}function ii(d,p,_){_||(_=co);var E=p[_[0]]-d[_[0]],P=p[_[1]]-d[_[1]];return Math.atan2(P,E)*180/Math.PI}function th(d,p){return ii(p[1],p[0],Gn)+ii(d[1],d[0],Gn)}function eh(d,p){return Hn(p[0],p[1],Gn)/Hn(d[0],d[1],Gn)}var nh={mousedown:lt,mousemove:he,mouseup:K},rh="mousedown",ih="mousemove mouseup";function Wn(){this.evEl=rh,this.evWin=ih,this.pressed=!1,wt.apply(this,arguments)}A(Wn,wt,{handler:function(p){var _=nh[p.type];_&lt&&p.button===0&&(this.pressed=!0),_&he&&p.which!==1&&(_=K),this.pressed&&(_&K&&(this.pressed=!1),this.callback(this.manager,_,{pointers:[p],changedPointers:[p],pointerType:ri,srcEvent:p}))}});var sh={pointerdown:lt,pointermove:he,pointerup:K,pointercancel:dt,pointerout:dt},oh={2:en,3:Xu,4:ri,5:Yu},go="pointerdown",po="pointermove pointerup pointercancel";t.MSPointerEvent&&!t.PointerEvent&&(go="MSPointerDown",po="MSPointerMove MSPointerUp MSPointerCancel");function si(){this.evEl=go,this.evWin=po,wt.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}A(si,wt,{handler:function(p){var _=this.store,E=!1,P=p.type.toLowerCase().replace("ms",""),I=sh[P],V=oh[p.pointerType]||p.pointerType,nt=V==en,rt=F(_,p.pointerId,"pointerId");I&lt&&(p.button===0||nt)?rt<0&&(_.push(p),rt=_.length-1):I&(K|dt)&&(E=!0),!(rt<0)&&(_[rt]=p,this.callback(this.manager,I,{pointers:_,changedPointers:[p],pointerType:V,srcEvent:p}),E&&_.splice(rt,1))}});var ah={touchstart:lt,touchmove:he,touchend:K,touchcancel:dt},ch="touchstart",lh="touchstart touchmove touchend touchcancel";function mo(){this.evTarget=ch,this.evWin=lh,this.started=!1,wt.apply(this,arguments)}A(mo,wt,{handler:function(p){var _=ah[p.type];if(_===lt&&(this.started=!0),!!this.started){var E=uh.call(this,p,_);_&(K|dt)&&E[0].length-E[1].length===0&&(this.started=!1),this.callback(this.manager,_,{pointers:E[0],changedPointers:E[1],pointerType:en,srcEvent:p})}}});function uh(d,p){var _=J(d.touches),E=J(d.changedTouches);return p&(K|dt)&&(_=et(_.concat(E),"identifier",!0)),[_,E]}var hh={touchstart:lt,touchmove:he,touchend:K,touchcancel:dt},fh="touchstart touchmove touchend touchcancel";function Xn(){this.evTarget=fh,this.targetIds={},wt.apply(this,arguments)}A(Xn,wt,{handler:function(p){var _=hh[p.type],E=dh.call(this,p,_);!E||this.callback(this.manager,_,{pointers:E[0],changedPointers:E[1],pointerType:en,srcEvent:p})}});function dh(d,p){var _=J(d.touches),E=this.targetIds;if(p&(lt|he)&&_.length===1)return E[_[0].identifier]=!0,[_,_];var P,I,V=J(d.changedTouches),nt=[],rt=this.target;if(I=_.filter(function(ut){return U(ut.target,rt)}),p===lt)for(P=0;P<I.length;)E[I[P].identifier]=!0,P++;for(P=0;P<V.length;)E[V[P].identifier]&&nt.push(V[P]),p&(K|dt)&&delete E[V[P].identifier],P++;if(!!nt.length)return[et(I.concat(nt),"identifier",!0),nt]}var gh=2500,_o=25;function oi(){wt.apply(this,arguments);var d=S(this.handler,this);this.touch=new Xn(this.manager,d),this.mouse=new Wn(this.manager,d),this.primaryTouch=null,this.lastTouches=[]}A(oi,wt,{handler:function(p,_,E){var P=E.pointerType==en,I=E.pointerType==ri;if(!(I&&E.sourceCapabilities&&E.sourceCapabilities.firesTouchEvents)){if(P)ph.call(this,_,E);else if(I&&mh.call(this,E))return;this.callback(p,_,E)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function ph(d,p){d&lt?(this.primaryTouch=p.changedPointers[0].identifier,bo.call(this,p)):d&(K|dt)&&bo.call(this,p)}function bo(d){var p=d.changedPointers[0];if(p.identifier===this.primaryTouch){var _={x:p.clientX,y:p.clientY};this.lastTouches.push(_);var E=this.lastTouches,P=function(){var I=E.indexOf(_);I>-1&&E.splice(I,1)};setTimeout(P,gh)}}function mh(d){for(var p=d.srcEvent.clientX,_=d.srcEvent.clientY,E=0;E<this.lastTouches.length;E++){var P=this.lastTouches[E],I=Math.abs(p-P.x),V=Math.abs(_-P.y);if(I<=_o&&V<=_o)return!0}return!1}var yo=z(o.style,"touchAction"),vo=yo!==i,Eo="compute",To="auto",ai="manipulation",de="none",an="pan-x",cn="pan-y",Yn=bh();function ci(d,p){this.manager=d,this.set(p)}ci.prototype={set:function(d){d==Eo&&(d=this.compute()),vo&&this.manager.element.style&&Yn[d]&&(this.manager.element.style[yo]=d),this.actions=d.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var d=[];return m(this.manager.recognizers,function(p){x(p.options.enable,[p])&&(d=d.concat(p.getTouchAction()))}),_h(d.join(" "))},preventDefaults:function(d){var p=d.srcEvent,_=d.offsetDirection;if(this.manager.session.prevented){p.preventDefault();return}var E=this.actions,P=k(E,de)&&!Yn[de],I=k(E,cn)&&!Yn[cn],V=k(E,an)&&!Yn[an];if(P){var nt=d.pointers.length===1,rt=d.distance<2,ut=d.deltaTime<250;if(nt&&rt&&ut)return}if(!(V&&I)&&(P||I&&_&Ot||V&&_&fe))return this.preventSrc(p)},preventSrc:function(d){this.manager.session.prevented=!0,d.preventDefault()}};function _h(d){if(k(d,de))return de;var p=k(d,an),_=k(d,cn);return p&&_?de:p||_?p?an:cn:k(d,ai)?ai:To}function bh(){if(!vo)return!1;var d={},p=t.CSS&&t.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(_){d[_]=p?t.CSS.supports("touch-action",_):!0}),d}var qn=1,At=2,Pe=4,ne=8,zt=ne,ln=16,kt=32;function Gt(d){this.options=y({},this.defaults,d||{}),this.id=zu(),this.manager=null,this.options.enable=M(this.options.enable,!0),this.state=qn,this.simultaneous={},this.requireFail=[]}Gt.prototype={defaults:{},set:function(d){return y(this.options,d),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(d){if(g(d,"recognizeWith",this))return this;var p=this.simultaneous;return d=$n(d,this),p[d.id]||(p[d.id]=d,d.recognizeWith(this)),this},dropRecognizeWith:function(d){return g(d,"dropRecognizeWith",this)?this:(d=$n(d,this),delete this.simultaneous[d.id],this)},requireFailure:function(d){if(g(d,"requireFailure",this))return this;var p=this.requireFail;return d=$n(d,this),F(p,d)===-1&&(p.push(d),d.requireFailure(this)),this},dropRequireFailure:function(d){if(g(d,"dropRequireFailure",this))return this;d=$n(d,this);var p=F(this.requireFail,d);return p>-1&&this.requireFail.splice(p,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(d){return!!this.simultaneous[d.id]},emit:function(d){var p=this,_=this.state;function E(P){p.manager.emit(P,d)}_<ne&&E(p.options.event+wo(_)),E(p.options.event),d.additionalEvent&&E(d.additionalEvent),_>=ne&&E(p.options.event+wo(_))},tryEmit:function(d){if(this.canEmit())return this.emit(d);this.state=kt},canEmit:function(){for(var d=0;d<this.requireFail.length;){if(!(this.requireFail[d].state&(kt|qn)))return!1;d++}return!0},recognize:function(d){var p=y({},d);if(!x(this.options.enable,[this,p])){this.reset(),this.state=kt;return}this.state&(zt|ln|kt)&&(this.state=qn),this.state=this.process(p),this.state&(At|Pe|ne|ln)&&this.tryEmit(p)},process:function(d){},getTouchAction:function(){},reset:function(){}};function wo(d){return d&ln?"cancel":d&ne?"end":d&Pe?"move":d&At?"start":""}function Ao(d){return d==on?"down":d==sn?"up":d==nn?"left":d==rn?"right":""}function $n(d,p){var _=p.manager;return _?_.get(d):d}function Lt(){Gt.apply(this,arguments)}A(Lt,Gt,{defaults:{pointers:1},attrTest:function(d){var p=this.options.pointers;return p===0||d.pointers.length===p},process:function(d){var p=this.state,_=d.eventType,E=p&(At|Pe),P=this.attrTest(d);return E&&(_&dt||!P)?p|ln:E||P?_&K?p|ne:p&At?p|Pe:At:kt}});function Zn(){Lt.apply(this,arguments),this.pX=null,this.pY=null}A(Zn,Lt,{defaults:{event:"pan",threshold:10,pointers:1,direction:ao},getTouchAction:function(){var d=this.options.direction,p=[];return d&Ot&&p.push(cn),d&fe&&p.push(an),p},directionTest:function(d){var p=this.options,_=!0,E=d.distance,P=d.direction,I=d.deltaX,V=d.deltaY;return P&p.direction||(p.direction&Ot?(P=I===0?zn:I<0?nn:rn,_=I!=this.pX,E=Math.abs(d.deltaX)):(P=V===0?zn:V<0?sn:on,_=V!=this.pY,E=Math.abs(d.deltaY))),d.direction=P,_&&E>p.threshold&&P&p.direction},attrTest:function(d){return Lt.prototype.attrTest.call(this,d)&&(this.state&At||!(this.state&At)&&this.directionTest(d))},emit:function(d){this.pX=d.deltaX,this.pY=d.deltaY;var p=Ao(d.direction);p&&(d.additionalEvent=this.options.event+p),this._super.emit.call(this,d)}});function li(){Lt.apply(this,arguments)}A(li,Lt,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[de]},attrTest:function(d){return this._super.attrTest.call(this,d)&&(Math.abs(d.scale-1)>this.options.threshold||this.state&At)},emit:function(d){if(d.scale!==1){var p=d.scale<1?"in":"out";d.additionalEvent=this.options.event+p}this._super.emit.call(this,d)}});function ui(){Gt.apply(this,arguments),this._timer=null,this._input=null}A(ui,Gt,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[To]},process:function(d){var p=this.options,_=d.pointers.length===p.pointers,E=d.distance<p.threshold,P=d.deltaTime>p.time;if(this._input=d,!E||!_||d.eventType&(K|dt)&&!P)this.reset();else if(d.eventType&lt)this.reset(),this._timer=h(function(){this.state=zt,this.tryEmit()},p.time,this);else if(d.eventType&K)return zt;return kt},reset:function(){clearTimeout(this._timer)},emit:function(d){this.state===zt&&(d&&d.eventType&K?this.manager.emit(this.options.event+"up",d):(this._input.timeStamp=u(),this.manager.emit(this.options.event,this._input)))}});function hi(){Lt.apply(this,arguments)}A(hi,Lt,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[de]},attrTest:function(d){return this._super.attrTest.call(this,d)&&(Math.abs(d.rotation)>this.options.threshold||this.state&At)}});function fi(){Lt.apply(this,arguments)}A(fi,Lt,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Ot|fe,pointers:1},getTouchAction:function(){return Zn.prototype.getTouchAction.call(this)},attrTest:function(d){var p=this.options.direction,_;return p&(Ot|fe)?_=d.overallVelocity:p&Ot?_=d.overallVelocityX:p&fe&&(_=d.overallVelocityY),this._super.attrTest.call(this,d)&&p&d.offsetDirection&&d.distance>this.options.threshold&&d.maxPointers==this.options.pointers&&l(_)>this.options.velocity&&d.eventType&K},emit:function(d){var p=Ao(d.offsetDirection);p&&this.manager.emit(this.options.event+p,d),this.manager.emit(this.options.event,d)}});function Kn(){Gt.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}A(Kn,Gt,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ai]},process:function(d){var p=this.options,_=d.pointers.length===p.pointers,E=d.distance<p.threshold,P=d.deltaTime<p.time;if(this.reset(),d.eventType&lt&&this.count===0)return this.failTimeout();if(E&&P&&_){if(d.eventType!=K)return this.failTimeout();var I=this.pTime?d.timeStamp-this.pTime<p.interval:!0,V=!this.pCenter||Hn(this.pCenter,d.center)<p.posThreshold;this.pTime=d.timeStamp,this.pCenter=d.center,!V||!I?this.count=1:this.count+=1,this._input=d;var nt=this.count%p.taps;if(nt===0)return this.hasRequireFailures()?(this._timer=h(function(){this.state=zt,this.tryEmit()},p.interval,this),At):zt}return kt},failTimeout:function(){return this._timer=h(function(){this.state=kt},this.options.interval,this),kt},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==zt&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function Ht(d,p){return p=p||{},p.recognizers=M(p.recognizers,Ht.defaults.preset),new di(d,p)}Ht.VERSION="2.0.7",Ht.defaults={domEvents:!1,touchAction:Eo,enable:!0,inputTarget:null,inputClass:null,preset:[[hi,{enable:!1}],[li,{enable:!1},["rotate"]],[fi,{direction:Ot}],[Zn,{direction:Ot},["swipe"]],[Kn],[Kn,{event:"doubletap",taps:2},["tap"]],[ui]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var yh=1,So=2;function di(d,p){this.options=y({},Ht.defaults,p||{}),this.options.inputTarget=this.options.inputTarget||d,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=d,this.input=$u(this),this.touchAction=new ci(this,this.options.touchAction),xo(this,!0),m(this.options.recognizers,function(_){var E=this.add(new _[0](_[1]));_[2]&&E.recognizeWith(_[2]),_[3]&&E.requireFailure(_[3])},this)}di.prototype={set:function(d){return y(this.options,d),d.touchAction&&this.touchAction.update(),d.inputTarget&&(this.input.destroy(),this.input.target=d.inputTarget,this.input.init()),this},stop:function(d){this.session.stopped=d?So:yh},recognize:function(d){var p=this.session;if(!p.stopped){this.touchAction.preventDefaults(d);var _,E=this.recognizers,P=p.curRecognizer;(!P||P&&P.state&zt)&&(P=p.curRecognizer=null);for(var I=0;I<E.length;)_=E[I],p.stopped!==So&&(!P||_==P||_.canRecognizeWith(P))?_.recognize(d):_.reset(),!P&&_.state&(At|Pe|ne)&&(P=p.curRecognizer=_),I++}},get:function(d){if(d instanceof Gt)return d;for(var p=this.recognizers,_=0;_<p.length;_++)if(p[_].options.event==d)return p[_];return null},add:function(d){if(g(d,"add",this))return this;var p=this.get(d.options.event);return p&&this.remove(p),this.recognizers.push(d),d.manager=this,this.touchAction.update(),d},remove:function(d){if(g(d,"remove",this))return this;if(d=this.get(d),d){var p=this.recognizers,_=F(p,d);_!==-1&&(p.splice(_,1),this.touchAction.update())}return this},on:function(d,p){if(d!==i&&p!==i){var _=this.handlers;return m(D(d),function(E){_[E]=_[E]||[],_[E].push(p)}),this}},off:function(d,p){if(d!==i){var _=this.handlers;return m(D(d),function(E){p?_[E]&&_[E].splice(F(_[E],p),1):delete _[E]}),this}},emit:function(d,p){this.options.domEvents&&vh(d,p);var _=this.handlers[d]&&this.handlers[d].slice();if(!(!_||!_.length)){p.type=d,p.preventDefault=function(){p.srcEvent.preventDefault()};for(var E=0;E<_.length;)_[E](p),E++}},destroy:function(){this.element&&xo(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function xo(d,p){var _=d.element;if(!!_.style){var E;m(d.options.cssProps,function(P,I){E=z(_.style,I),p?(d.oldCssProps[E]=_.style[E],_.style[E]=P):_.style[E]=d.oldCssProps[E]||""}),p||(d.oldCssProps={})}}function vh(d,p){var _=e.createEvent("Event");_.initEvent(d,!0,!0),_.gesture=p,p.target.dispatchEvent(_)}y(Ht,{INPUT_START:lt,INPUT_MOVE:he,INPUT_END:K,INPUT_CANCEL:dt,STATE_POSSIBLE:qn,STATE_BEGAN:At,STATE_CHANGED:Pe,STATE_ENDED:ne,STATE_RECOGNIZED:zt,STATE_CANCELLED:ln,STATE_FAILED:kt,DIRECTION_NONE:zn,DIRECTION_LEFT:nn,DIRECTION_RIGHT:rn,DIRECTION_UP:sn,DIRECTION_DOWN:on,DIRECTION_HORIZONTAL:Ot,DIRECTION_VERTICAL:fe,DIRECTION_ALL:ao,Manager:di,Input:wt,TouchAction:ci,TouchInput:Xn,MouseInput:Wn,PointerEventInput:si,TouchMouseInput:oi,SingleTouchInput:mo,Recognizer:Gt,AttrRecognizer:Lt,Tap:Kn,Pan:Zn,Swipe:fi,Pinch:li,Rotate:hi,Press:ui,on:R,off:N,each:m,merge:T,extend:v,assign:y,inherit:A,bindFn:S,prefixed:z});var Eh=typeof t<"u"?t:typeof self<"u"?self:{};Eh.Hammer=Ht,typeof i=="function"&&i.amd?i(function(){return Ht}):n.exports?n.exports=Ht:t[r]=Ht})(window,document,"Hammer")})(tn);const zv=tn.exports,Ft=Zh({__proto__:null,default:zv},[tn.exports]),Eu=1,Tu=2,ms=4,Gv={mousedown:Eu,mousemove:Tu,mouseup:ms};function Hv(n,t){for(let e=0;e<n.length;e++)if(t(n[e]))return!0;return!1}function Wv(n){const t=n.prototype.handler;n.prototype.handler=function(r){const i=this.store;r.button>0&&r.type==="pointerdown"&&(Hv(i,s=>s.pointerId===r.pointerId)||i.push(r)),t.call(this,r)}}function Xv(n){n.prototype.handler=function(e){let r=Gv[e.type];r&Eu&&e.button>=0&&(this.pressed=!0),r&Tu&&e.which===0&&(r=ms),this.pressed&&(r&ms&&(this.pressed=!1),this.callback(this.manager,r,{pointers:[e],changedPointers:[e],pointerType:"mouse",srcEvent:e}))}}Wv(tn.exports.PointerEventInput);Xv(tn.exports.MouseInput);const Yv=tn.exports.Manager;class Qr{constructor(t,e,r){this.element=t,this.callback=e,this.options={enable:!0,...r}}}const qv=Ft?[[Ft.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[Ft.Rotate,{enable:!1}],[Ft.Pinch,{enable:!1}],[Ft.Swipe,{enable:!1}],[Ft.Pan,{threshold:0,enable:!1}],[Ft.Press,{enable:!1}],[Ft.Tap,{event:"doubletap",taps:2,enable:!1}],[Ft.Tap,{event:"anytap",enable:!1}],[Ft.Tap,{enable:!1}]]:null,sc={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},$v={doubletap:["tap"]},Zv={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},Ks={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},Kv={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},oc={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"},Qv=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",Ue=typeof window<"u"?window:global;let _s=!1;try{const n={get passive(){return _s=!0,!0}};Ue.addEventListener("test",null,n),Ue.removeEventListener("test",null)}catch{_s=!1}const Jv=Qv.indexOf("firefox")!==-1,{WHEEL_EVENTS:tE}=Ks,ac="wheel",cc=4.000244140625,eE=40,nE=.25;class rE extends Qr{constructor(t,e,r){super(t,e,r),this.handleEvent=i=>{if(!this.options.enable)return;let s=i.deltaY;Ue.WheelEvent&&(Jv&&i.deltaMode===Ue.WheelEvent.DOM_DELTA_PIXEL&&(s/=Ue.devicePixelRatio),i.deltaMode===Ue.WheelEvent.DOM_DELTA_LINE&&(s*=eE)),s!==0&&s%cc===0&&(s=Math.floor(s/cc)),i.shiftKey&&s&&(s=s*nE),this.callback({type:ac,center:{x:i.clientX,y:i.clientY},delta:-s,srcEvent:i,pointerType:"mouse",target:i.target})},this.events=(this.options.events||[]).concat(tE),this.events.forEach(i=>t.addEventListener(i,this.handleEvent,_s?{passive:!1}:!1))}destroy(){this.events.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t===ac&&(this.options.enable=e)}}const{MOUSE_EVENTS:iE}=Ks,lc="pointermove",uc="pointerover",hc="pointerout",fc="pointerenter",dc="pointerleave";class sE extends Qr{constructor(t,e,r){super(t,e,r),this.handleEvent=s=>{this.handleOverEvent(s),this.handleOutEvent(s),this.handleEnterEvent(s),this.handleLeaveEvent(s),this.handleMoveEvent(s)},this.pressed=!1;const{enable:i}=this.options;this.enableMoveEvent=i,this.enableLeaveEvent=i,this.enableEnterEvent=i,this.enableOutEvent=i,this.enableOverEvent=i,this.events=(this.options.events||[]).concat(iE),this.events.forEach(s=>t.addEventListener(s,this.handleEvent))}destroy(){this.events.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t===lc&&(this.enableMoveEvent=e),t===uc&&(this.enableOverEvent=e),t===hc&&(this.enableOutEvent=e),t===fc&&(this.enableEnterEvent=e),t===dc&&(this.enableLeaveEvent=e)}handleOverEvent(t){this.enableOverEvent&&t.type==="mouseover"&&this._emit(uc,t)}handleOutEvent(t){this.enableOutEvent&&t.type==="mouseout"&&this._emit(hc,t)}handleEnterEvent(t){this.enableEnterEvent&&t.type==="mouseenter"&&this._emit(fc,t)}handleLeaveEvent(t){this.enableLeaveEvent&&t.type==="mouseleave"&&this._emit(dc,t)}handleMoveEvent(t){if(this.enableMoveEvent)switch(t.type){case"mousedown":t.button>=0&&(this.pressed=!0);break;case"mousemove":t.which===0&&(this.pressed=!1),this.pressed||this._emit(lc,t);break;case"mouseup":this.pressed=!1;break}}_emit(t,e){this.callback({type:t,center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})}}const{KEY_EVENTS:oE}=Ks,gc="keydown",pc="keyup";class aE extends Qr{constructor(t,e,r){super(t,e,r),this.handleEvent=i=>{const s=i.target||i.srcElement;s.tagName==="INPUT"&&s.type==="text"||s.tagName==="TEXTAREA"||(this.enableDownEvent&&i.type==="keydown"&&this.callback({type:gc,srcEvent:i,key:i.key,target:i.target}),this.enableUpEvent&&i.type==="keyup"&&this.callback({type:pc,srcEvent:i,key:i.key,target:i.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(oE),t.tabIndex=this.options.tabIndex||0,t.style.outline="none",this.events.forEach(i=>t.addEventListener(i,this.handleEvent))}destroy(){this.events.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t===gc&&(this.enableDownEvent=e),t===pc&&(this.enableUpEvent=e)}}const mc="contextmenu";class cE extends Qr{constructor(t,e,r){super(t,e,r),this.handleEvent=i=>{!this.options.enable||this.callback({type:mc,center:{x:i.clientX,y:i.clientY},srcEvent:i,pointerType:"mouse",target:i.target})},t.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(t,e){t===mc&&(this.options.enable=e)}}const bs=1,Br=2,ys=4,lE={pointerdown:bs,pointermove:Br,pointerup:ys,mousedown:bs,mousemove:Br,mouseup:ys},uE=1,hE=2,fE=3,dE=0,gE=1,pE=2,mE=1,_E=2,bE=4;function yE(n){const t=lE[n.srcEvent.type];if(!t)return null;const{buttons:e,button:r,which:i}=n.srcEvent;let s=!1,o=!1,a=!1;return t===ys||t===Br&&!Number.isFinite(e)?(s=i===uE,o=i===hE,a=i===fE):t===Br?(s=Boolean(e&mE),o=Boolean(e&bE),a=Boolean(e&_E)):t===bs&&(s=r===dE,o=r===gE,a=r===pE),{leftButton:s,middleButton:o,rightButton:a}}function vE(n,t){const e=n.center;if(!e)return null;const r=t.getBoundingClientRect(),i=r.width/t.offsetWidth||1,s=r.height/t.offsetHeight||1,o={x:(e.x-r.left-t.clientLeft)/i,y:(e.y-r.top-t.clientTop)/s};return{center:e,offsetCenter:o}}const zi={srcElement:"root",priority:0};class EE{constructor(t){this.handleEvent=e=>{if(this.isEmpty())return;const r=this._normalizeEvent(e);let i=e.srcEvent.target;for(;i&&i!==r.rootElement;){if(this._emit(r,i),r.handled)return;i=i.parentNode}this._emit(r,"root")},this.eventManager=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(t,e,r,i=!1,s=!1){const{handlers:o,handlersByElement:a}=this;let c=zi;typeof r=="string"||r&&r.addEventListener?c={...zi,srcElement:r}:r&&(c={...zi,...r});let l=a.get(c.srcElement);l||(l=[],a.set(c.srcElement,l));const u={type:t,handler:e,srcElement:c.srcElement,priority:c.priority};i&&(u.once=!0),s&&(u.passive=!0),o.push(u),this._active=this._active||!u.passive;let h=l.length-1;for(;h>=0&&!(l[h].priority>=u.priority);)h--;l.splice(h+1,0,u)}remove(t,e){const{handlers:r,handlersByElement:i}=this;for(let s=r.length-1;s>=0;s--){const o=r[s];if(o.type===t&&o.handler===e){r.splice(s,1);const a=i.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&i.delete(o.srcElement)}}this._active=r.some(s=>!s.passive)}_emit(t,e){const r=this.handlersByElement.get(e);if(r){let i=!1;const s=()=>{t.handled=!0},o=()=>{t.handled=!0,i=!0},a=[];for(let c=0;c<r.length;c++){const{type:l,handler:u,once:h}=r[c];if(u({...t,type:l,stopPropagation:s,stopImmediatePropagation:o}),h&&a.push(r[c]),i)break}for(let c=0;c<a.length;c++){const{type:l,handler:u}=a[c];this.remove(l,u)}}}_normalizeEvent(t){const e=this.eventManager.getElement();return{...t,...yE(t),...vE(t,e),preventDefault:()=>{t.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:e}}}const TE={events:null,recognizers:null,recognizerOptions:{},Manager:Yv,touchAction:"none",tabIndex:0};class wE{constructor(t=null,e){this._onBasicInput=i=>{const{srcEvent:s}=i,o=Zv[s.type];o&&this.manager.emit(o,i)},this._onOtherEvent=i=>{this.manager.emit(i.type,i)},this.options={...TE,...e},this.events=new Map,this.setElement(t);const{events:r}=this.options;r&&this.on(r)}getElement(){return this.element}setElement(t){if(this.element&&this.destroy(),this.element=t,!t)return;const{options:e}=this,r=e.Manager;this.manager=new r(t,{touchAction:e.touchAction,recognizers:e.recognizers||qv}).on("hammer.input",this._onBasicInput),e.recognizers||Object.keys(sc).forEach(i=>{const s=this.manager.get(i);s&&sc[i].forEach(o=>{s.recognizeWith(o)})});for(const i in e.recognizerOptions){const s=this.manager.get(i);if(s){const o=e.recognizerOptions[i];delete o.enable,s.set(o)}}this.wheelInput=new rE(t,this._onOtherEvent,{enable:!1}),this.moveInput=new sE(t,this._onOtherEvent,{enable:!1}),this.keyInput=new aE(t,this._onOtherEvent,{enable:!1,tabIndex:e.tabIndex}),this.contextmenuInput=new cE(t,this._onOtherEvent,{enable:!1});for(const[i,s]of this.events)s.isEmpty()||(this._toggleRecognizer(s.recognizerName,!0),this.manager.on(i,s.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(t,e,r){this._addEventHandler(t,e,r,!1)}once(t,e,r){this._addEventHandler(t,e,r,!0)}watch(t,e,r){this._addEventHandler(t,e,r,!1,!0)}off(t,e){this._removeEventHandler(t,e)}_toggleRecognizer(t,e){const{manager:r}=this;if(!r)return;const i=r.get(t);if(i&&i.options.enable!==e){i.set({enable:e});const s=$v[t];s&&!this.options.recognizers&&s.forEach(o=>{const a=r.get(o);e?(a.requireFailure(t),i.dropRequireFailure(o)):a.dropRequireFailure(t)})}this.wheelInput.enableEventType(t,e),this.moveInput.enableEventType(t,e),this.keyInput.enableEventType(t,e),this.contextmenuInput.enableEventType(t,e)}_addEventHandler(t,e,r,i,s){if(typeof t!="string"){r=e;for(const u in t)this._addEventHandler(u,t[u],r,i,s);return}const{manager:o,events:a}=this,c=oc[t]||t;let l=a.get(c);l||(l=new EE(this),a.set(c,l),l.recognizerName=Kv[c]||c,o&&o.on(c,l.handleEvent)),l.add(t,e,r,i,s),l.isEmpty()||this._toggleRecognizer(l.recognizerName,!0)}_removeEventHandler(t,e){if(typeof t!="string"){for(const o in t)this._removeEventHandler(o,t[o]);return}const{events:r}=this,i=oc[t]||t,s=r.get(i);if(!!s&&(s.remove(t,e),s.isEmpty())){const{recognizerName:o}=s;let a=!1;for(const c of r.values())if(c.recognizerName===o&&!c.isEmpty()){a=!0;break}a||this._toggleRecognizer(o,!1)}}}function me(){}const AE=({isDragging:n})=>n?"grabbing":"grab",wu={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,glOptions:{},parameters:{},parent:null,gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,onWebGLInitialized:me,onResize:me,onViewStateChange:me,onInteractionStateChange:me,onBeforeRender:me,onAfterRender:me,onLoad:me,onError:n=>H.error(n.message)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:AE,getTooltip:null,debug:!1,drawPickingColors:!1};class Jr{constructor(t){f(this,"props",void 0),f(this,"width",0),f(this,"height",0),f(this,"userData",{}),f(this,"canvas",null),f(this,"viewManager",null),f(this,"layerManager",null),f(this,"effectManager",null),f(this,"deckRenderer",null),f(this,"deckPicker",null),f(this,"eventManager",null),f(this,"tooltip",null),f(this,"metrics",void 0),f(this,"animationLoop",void 0),f(this,"stats",void 0),f(this,"viewState",void 0),f(this,"cursorState",void 0),f(this,"_needsRedraw",void 0),f(this,"_pickRequest",void 0),f(this,"_lastPointerDownInfo",null),f(this,"_metricsCounter",void 0),f(this,"_onPointerMove",e=>{const{_pickRequest:r}=this;if(e.type==="pointerleave")r.x=-1,r.y=-1,r.radius=0;else{if(e.leftButton||e.rightButton)return;{const i=e.offsetCenter;if(!i)return;r.x=i.x,r.y=i.y,r.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:r.x,y:r.y}),r.event=e}),f(this,"_onEvent",e=>{const r=Wa[e.type],i=e.offsetCenter;if(!r||!i||!this.layerManager)return;const s=this.layerManager.getLayers(),o=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:s,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:a}=o,c=a&&(a[r.handler]||a.props[r.handler]),l=this.props[r.handler];let u=!1;c&&(u=c.call(a,o,e)),!u&&l&&l(o,e)}),f(this,"_onPointerDown",e=>{const r=e.offsetCenter,i=this._pick("pickObject","pickObject Time",{x:r.x,y:r.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=i.result[0]||i.emptyInfo}),this.props={...wu,...t},t=this.props,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this.cursorState={isHovering:!1,isDragging:!1},t.viewState&&t.initialViewState&&H.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),fl()==="IE"&&H.warn("IE 11 is not supported")(),this.viewState=t.initialViewState,t.gl||typeof document<"u"&&(this.canvas=this._createCanvas(t)),this.animationLoop=this._createAnimationLoop(t),this.stats=new Bs({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(t),t._typedArrayManagerProps&&Ln.setOptions(t._typedArrayManagerProps),this.animationLoop.start()}finalize(){var t,e,r,i,s,o,a;if(this.animationLoop.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,(t=this.layerManager)===null||t===void 0||t.finalize(),this.layerManager=null,(e=this.viewManager)===null||e===void 0||e.finalize(),this.viewManager=null,(r=this.effectManager)===null||r===void 0||r.finalize(),this.effectManager=null,(i=this.deckRenderer)===null||i===void 0||i.finalize(),this.deckRenderer=null,(s=this.deckPicker)===null||s===void 0||s.finalize(),this.deckPicker=null,(o=this.eventManager)===null||o===void 0||o.destroy(),this.eventManager=null,(a=this.tooltip)===null||a===void 0||a.remove(),this.tooltip=null,!this.props.canvas&&!this.props.gl&&this.canvas){var c;(c=this.canvas.parentElement)===null||c===void 0||c.removeChild(this.canvas),this.canvas=null}}setProps(t){this.stats.get("setProps Time").timeStart(),"onLayerHover"in t&&H.removed("onLayerHover","onHover")(),"onLayerClick"in t&&H.removed("onLayerClick","onClick")(),t.initialViewState&&!xe(this.props.initialViewState,t.initialViewState)&&(this.viewState=t.initialViewState),Object.assign(this.props,t),this._setCanvasSize(this.props);const e=Object.create(this.props);Object.assign(e,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(e),this.layerManager&&(this.viewManager.setProps(e),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(e),this.effectManager.setProps(e),this.deckRenderer.setProps(e),this.deckPicker.setProps(e)),this.stats.get("setProps Time").timeEnd()}needsRedraw(t={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);const r=this.viewManager.needsRedraw(t),i=this.layerManager.needsRedraw(t),s=this.effectManager.needsRedraw(t),o=this.deckRenderer.needsRedraw(t);return e=e||r||i||s||o,e}redraw(t){if(!this.layerManager)return;let e=this.needsRedraw({clearRedrawFlags:!0});e=t||e,e&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(e):this._drawLayers(e))}get isInitialized(){return this.viewManager!==null}getViews(){return st(this.viewManager),this.viewManager.views}getViewports(t){return st(this.viewManager),this.viewManager.getViewports(t)}pickObject(t){const e=this._pick("pickObject","pickObject Time",t).result;return e.length?e[0]:null}pickMultipleObjects(t){return t.depth=t.depth||10,this._pick("pickObject","pickMultipleObjects Time",t).result}pickObjects(t){return this._pick("pickObjects","pickObjects Time",t)}_addResources(t,e=!1){for(const r in t)this.layerManager.resourceManager.add({resourceId:r,data:t[r],forceUpdate:e})}_removeResources(t){for(const e of t)this.layerManager.resourceManager.remove(e)}_pick(t,e,r){st(this.deckPicker);const{stats:i}=this;i.get("Pick Count").incrementCount(),i.get(e).timeStart();const s=this.deckPicker[t]({layers:this.layerManager.getLayers(r),views:this.viewManager.getViews(),viewports:this.getViewports(r),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...r});return i.get(e).timeEnd(),s}_createCanvas(t){let e=t.canvas;return typeof e=="string"&&(e=document.getElementById(e),st(e)),e||(e=document.createElement("canvas"),e.id=t.id||"deckgl-overlay",(t.parent||document.body).appendChild(e)),Object.assign(e.style,t.style),e}_setCanvasSize(t){if(!this.canvas)return;const{width:e,height:r}=t;if(e||e===0){const s=Number.isFinite(e)?"".concat(e,"px"):e;this.canvas.style.width=s}if(r||r===0){var i;const s=Number.isFinite(r)?"".concat(r,"px"):r;this.canvas.style.position=((i=t.style)===null||i===void 0?void 0:i.position)||"absolute",this.canvas.style.height=s}}_updateCanvasSize(){const{canvas:t}=this;if(!t)return;const e=t.clientWidth||t.width,r=t.clientHeight||t.height;if(e!==this.width||r!==this.height){var i;this.width=e,this.height=r,(i=this.viewManager)===null||i===void 0||i.setProps({width:e,height:r}),this.props.onResize({width:e,height:r})}}_createAnimationLoop(t){const{width:e,height:r,gl:i,glOptions:s,debug:o,onError:a,onBeforeRender:c,onAfterRender:l,useDevicePixels:u}=t;return new P0({width:e,height:r,useDevicePixels:u,autoResizeViewport:!1,gl:i,onCreateContext:h=>yl({...s,...h,canvas:this.canvas,debug:o,onContextLost:()=>this._onContextLost()}),onInitialize:h=>this._setGLContext(h.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:c,onAfterRender:l,onError:a})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let t=this.props.views||[new pu({id:"default-view"})];return t=Array.isArray(t)?t:[t],t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:t}=this.props;this.animationLoop&&t&&t(new Error("WebGL context is lost"))}_pickAndCallback(){const{_pickRequest:t}=this;if(t.event){const{result:r,emptyInfo:i}=this._pick("pickObject","pickObject Time",t);this.cursorState.isHovering=r.length>0;let s=i,o=!1;for(const a of r){var e;s=a,o=((e=a.layer)===null||e===void 0?void 0:e.onHover(a,t.event))||o}if(!o&&this.props.onHover&&this.props.onHover(s,t.event),this.props.getTooltip&&this.tooltip){const a=this.props.getTooltip(s);this.tooltip.setTooltip(a,s.x,s.y)}t.event=null}}_updateCursor(){const t=this.props.parent||this.canvas;t&&(t.style.cursor=this.props.getCursor(this.cursorState))}_setGLContext(t){if(this.layerManager)return;this.canvas||(this.canvas=t.canvas,Fs(t,{enable:!0,copyState:!0})),this.tooltip=new jv(this.canvas),$t(t,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(t);const e=new Jl;e.play(),this.animationLoop.attachTimeline(e),this.eventManager=new wE(this.props.parent||t.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const i in Wa)this.eventManager.on(i,this._onEvent);this.viewManager=new sv({timeline:e,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const r=this.viewManager.getViewports()[0];this.layerManager=new iv(t,{deck:this,stats:this.stats,viewport:r,timeline:e}),this.effectManager=new Mv,this.deckRenderer=new Ov(t),this.deckPicker=new Uv(t),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(t,e){const{gl:r}=this.layerManager.context;$t(r,this.props.parameters),this.props.onBeforeRender({gl:r}),this.deckRenderer.renderLayers({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",redrawReason:t,effects:this.effectManager.getEffects(),...e}),this.props.onAfterRender({gl:r})}_onRenderFrame(t){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),H.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(t){const e=this.props.onViewStateChange(t)||t.viewState;this.viewState&&(this.viewState={...this.viewState,[t.viewId]:e},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(t){this.cursorState.isDragging=t.isDragging||!1,this.props.onInteractionStateChange(t)}_getFrameStats(){const{stats:t}=this;t.get("frameRate").timeEnd(),t.get("frameRate").timeStart();const e=this.animationLoop.stats;t.get("GPU Time").addTime(e.get("GPU Time").lastTiming),t.get("CPU Time").addTime(e.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:t,stats:e}=this;t.fps=e.get("frameRate").getHz(),t.setPropsTime=e.get("setProps Time").time,t.updateAttributesTime=e.get("Update Attributes").time,t.framesRedrawn=e.get("Redraw Count").count,t.pickTime=e.get("pickObject Time").time+e.get("pickMultipleObjects Time").time+e.get("pickObjects Time").time,t.pickCount=e.get("Pick Count").count,t.gpuTime=e.get("GPU Time").time,t.cpuTime=e.get("CPU Time").time,t.gpuTimePerFrame=e.get("GPU Time").getAverageTime(),t.cpuTimePerFrame=e.get("CPU Time").getAverageTime();const r=ye.get("Memory Usage");t.bufferMemory=r.get("Buffer Memory").count,t.textureMemory=r.get("Texture Memory").count,t.renderbufferMemory=r.get("Renderbuffer Memory").count,t.gpuMemory=r.get("GPU Memory").count}}f(Jr,"defaultProps",wu);f(Jr,"VERSION",Cg.VERSION);class Gi{constructor(t,e){f(this,"opts",void 0),f(this,"source",void 0),this.opts=e,this.source=t}get value(){return this.source.value}getValue(){const t=this.source.getBuffer(),e=this.getAccessor();if(t)return[t,e];const{value:r}=this.source,{size:i}=e;let s=r;if(r&&r.length!==i){s=new Float32Array(i);const o=e.elementOffset||0;for(let a=0;a<i;++a)s[a]=r[o+a]}return s}getAccessor(){return{...this.source.getAccessor(),...this.opts}}}function SE(n){switch(n){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function yr(n){return n.stride||n.size*n.bytesPerElement}function Au(n,t){t.offset&&H.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const e=yr(n),r=t.vertexOffset!==void 0?t.vertexOffset:n.vertexOffset||0,i=t.elementOffset||0,s=r*e+i*n.bytesPerElement+(n.offset||0);return{...t,offset:s,stride:e}}function xE(n,t){const e=Au(n,t);return{high:e,low:{...e,offset:e.offset+n.size*4}}}class PE{constructor(t,e,r){f(this,"gl",void 0),f(this,"id",void 0),f(this,"size",void 0),f(this,"settings",void 0),f(this,"value",void 0),f(this,"doublePrecision",void 0),f(this,"_buffer",void 0),f(this,"state",void 0),this.gl=t,this.id=e.id||"",this.size=e.size||1;const i=e.logicalType||e.type,s=i===5130;let{defaultValue:o}=e;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0);let a;s?a=5126:!i&&e.isIndexed?a=t&&rm(t,q.ELEMENT_INDEX_UINT32)?5125:5123:a=i||5126;let c=SE(i||a||5126);this.doublePrecision=s,s&&e.fp64===!1&&(c=Float32Array),this.value=null,this.settings={...e,defaultType:c,defaultValue:o,logicalType:i,type:a,size:this.size,bytesPerElement:c.BYTES_PER_ELEMENT},this.state={...r,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){const{isIndexed:t,type:e}=this.settings;this._buffer=new W(this.gl,{id:this.id,target:t?34963:34962,accessor:{type:e}})}return this._buffer}get byteOffset(){const t=this.getAccessor();return t.vertexOffset?t.vertexOffset*yr(t):0}get numInstances(){return this.state.numInstances}set numInstances(t){this.state.numInstances=t}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Ln.release(this.state.allocatedValue)}getShaderAttributes(t,e){if(this.doublePrecision){const r={},i=this.value instanceof Float64Array,s=xE(this.getAccessor(),e||{});return r[t]=new Gi(this,s.high),r["".concat(t,"64Low")]=i?new Gi(this,s.low):new Float32Array(this.size),r}if(e){const r=Au(this.getAccessor(),e);return{[t]:new Gi(this,r)}}return{[t]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let t=null;if(this.state.constant&&this.value){const e=Array.from(this.value);t=[e,e]}else{const{value:e,numInstances:r,size:i}=this,s=r*i;if(e&&s&&e.length>=s){const o=new Array(i).fill(1/0),a=new Array(i).fill(-1/0);for(let c=0;c<s;)for(let l=0;l<i;l++){const u=e[c++];u<o[l]&&(o[l]=u),u>a[l]&&(a[l]=u)}t=[o,a]}}return this.state.bounds=t,t}setData(t){const{state:e}=this;let r;ArrayBuffer.isView(t)?r={value:t}:t instanceof W?r={buffer:t}:r=t;const i={...this.settings,...r};if(e.bufferAccessor=i,e.bounds=null,r.constant){let s=r.value;if(s=this._normalizeValue(s,[],0),this.settings.normalized&&(s=this.normalizeConstant(s)),!(!e.constant||!this._areValuesEqual(s,this.value)))return!1;e.externalBuffer=null,e.constant=!0,this.value=s}else if(r.buffer){const s=r.buffer;e.externalBuffer=s,e.constant=!1,this.value=r.value||null;const o=r.value instanceof Float64Array;i.type=r.type||s.accessor.type,i.bytesPerElement=s.accessor.BYTES_PER_ELEMENT*(o?2:1),i.stride=yr(i)}else if(r.value){this._checkExternalBuffer(r);let s=r.value;e.externalBuffer=null,e.constant=!1,this.value=s,i.bytesPerElement=s.BYTES_PER_ELEMENT,i.stride=yr(i);const{buffer:o,byteOffset:a}=this;this.doublePrecision&&s instanceof Float64Array&&(s=Vi(s,i));const c=s.byteLength+a+i.stride*2;o.byteLength<c&&o.reallocate(c),o.setAccessor(null),o.subData({data:s,offset:a}),i.type=r.type||o.accessor.type}return!0}updateSubBuffer(t={}){this.state.bounds=null;const e=this.value,{startOffset:r=0,endOffset:i}=t;this.buffer.subData({data:this.doublePrecision&&e instanceof Float64Array?Vi(e,{size:this.size,startIndex:r,endIndex:i}):e.subarray(r,i),offset:r*e.BYTES_PER_ELEMENT+this.byteOffset})}allocate(t,e=!1){const{state:r}=this,i=r.allocatedValue,s=Ln.allocate(i,t+1,{size:this.size,type:this.settings.defaultType,copy:e});this.value=s;const{buffer:o,byteOffset:a}=this;return o.byteLength<s.byteLength+a&&(o.reallocate(s.byteLength+a),e&&i&&o.subData({data:i instanceof Float64Array?Vi(i,this):i,offset:a})),r.allocatedValue=s,r.constant=!1,r.externalBuffer=null,r.bufferAccessor=this.settings,!0}_checkExternalBuffer(t){const{value:e}=t;if(!ArrayBuffer.isView(e))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));const r=this.settings.defaultType;let i=!1;if(this.doublePrecision&&(i=e.BYTES_PER_ELEMENT<4),i)throw new Error("Attribute ".concat(this.id," does not support ").concat(e.constructor.name));!(e instanceof r)&&this.settings.normalized&&!("normalized"in t)&&H.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(t){switch(this.settings.type){case 5120:return new Float32Array(t).map(e=>(e+128)/255*2-1);case 5122:return new Float32Array(t).map(e=>(e+32768)/65535*2-1);case 5121:return new Float32Array(t).map(e=>e/255);case 5123:return new Float32Array(t).map(e=>e/65535);default:return t}}_normalizeValue(t,e,r){const{defaultValue:i,size:s}=this.settings;if(Number.isFinite(t))return e[r]=t,e;if(!t)return e[r]=i[0],e;switch(s){case 4:e[r+3]=Number.isFinite(t[3])?t[3]:i[3];case 3:e[r+2]=Number.isFinite(t[2])?t[2]:i[2];case 2:e[r+1]=Number.isFinite(t[1])?t[1]:i[1];case 1:e[r+0]=Number.isFinite(t[0])?t[0]:i[0];break;default:let o=s;for(;--o>=0;)e[r+o]=Number.isFinite(t[o])?t[o]:i[o]}return e}_areValuesEqual(t,e){if(!t||!e)return!1;const{size:r}=this;for(let i=0;i<r;i++)if(t[i]!==e[i])return!1;return!0}}const _c=[],bc=[];function ME(n,t=0,e=1/0){let r=_c;const i={index:-1,data:n,target:[]};return n?typeof n[Symbol.iterator]=="function"?r=n:n.length>0&&(bc.length=n.length,r=bc):r=_c,(t>0||Number.isFinite(e))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(t,e),i.index=t-1),{iterable:r,objectInfo:i}}function Su(n){return n&&n[Symbol.asyncIterator]}function LE(n,t){const{size:e,stride:r,offset:i,startIndices:s,nested:o}=t,a=n.BYTES_PER_ELEMENT,c=r?r/a:e,l=i?i/a:0,u=Math.floor((n.length-l)/c);return(h,{index:g,target:m})=>{if(!s){const T=g*c+l;for(let A=0;A<e;A++)m[A]=n[T+A];return m}const b=s[g],y=s[g+1]||u;let v;if(o){v=new Array(y-b);for(let T=b;T<y;T++){const A=T*c+l;m=new Array(e);for(let S=0;S<e;S++)m[S]=n[A+S];v[T-b]=m}}else if(c===e)v=n.subarray(b*e+l,y*e+l);else{v=new n.constructor((y-b)*e);let T=0;for(let A=b;A<y;A++){const S=A*c+l;for(let x=0;x<e;x++)v[T++]=n[S+x]}}return v}}const RE=[],vr=[[0,1/0]];function IE(n,t){if(n===vr||(t[0]<0&&(t[0]=0),t[0]>=t[1]))return n;const e=[],r=n.length;let i=0;for(let s=0;s<r;s++){const o=n[s];o[1]<t[0]?(e.push(o),i=s+1):o[0]>t[1]?e.push(o):t=[Math.min(o[0],t[0]),Math.max(o[1],t[1])]}return e.splice(i,0,t),e}function Hi(n){const{source:t,target:e,start:r=0,size:i,getData:s}=n,o=n.end||e.length,a=t.length,c=o-r;if(a>c){e.set(t.subarray(0,c),r);return}if(e.set(t,r),!s)return;let l=a;for(;l<c;){const u=s(l,t);for(let h=0;h<i;h++)e[r+l]=u[h]||0,l++}}function CE({source:n,target:t,size:e,getData:r,sourceStartIndices:i,targetStartIndices:s}){if(!Array.isArray(s))return Hi({source:n,target:t,size:e,getData:r}),t;let o=0,a=0;const c=r&&((u,h)=>r(u+a,h)),l=Math.min(i.length,s.length);for(let u=1;u<l;u++){const h=i[u]*e,g=s[u]*e;Hi({source:n.subarray(o,h),target:t,start:a,end:g,size:e,getData:c}),o=h,a=g}return a<t.length&&Hi({source:[],target:t,start:a,size:e,getData:c}),t}const OE={interpolation:{duration:0,easing:n=>n},spring:{stiffness:.05,damping:.5}};function xu(n,t){if(!n)return null;Number.isFinite(n)&&(n={type:"interpolation",duration:n});const e=n.type||"interpolation";return{...OE[e],...t,...n,type:e}}function Pu(n,t){const e=t.getBuffer();return e?[e,{divisor:0,size:t.size,normalized:t.settings.normalized}]:t.value}function Mu(n){switch(n){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(n,'"'))}}function Lu(n){n.push(n.shift())}function Qs(n,t){const{doublePrecision:e,settings:r,value:i,size:s}=n,o=e&&i instanceof Float64Array?2:1;return(r.noAlloc?i.length:t*s)*o}function Ru({buffer:n,numInstances:t,attribute:e,fromLength:r,fromStartIndices:i,getData:s=o=>o}){const o=e.doublePrecision&&e.value instanceof Float64Array?2:1,a=e.size*o,c=e.byteOffset,l=e.startIndices,u=i&&l,h=Qs(e,t),g=e.isConstant;if(!u&&r>=h)return;const m=g?e.value:e.getBuffer().getData({srcByteOffset:c});if(e.settings.normalized&&!g){const T=s;s=(A,S)=>e.normalizeConstant(T(A,S))}const b=g?(T,A)=>s(m,A):(T,A)=>s(m.subarray(T,T+a),A),y=n.getData({length:r}),v=new Float32Array(h);CE({source:y,target:v,sourceStartIndices:i,targetStartIndices:l,size:a,getData:b}),n.byteLength<v.byteLength+c&&n.reallocate(v.byteLength+c),n.subData({data:v,offset:c})}class Js extends PE{constructor(t,e){super(t,e,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:vr}),f(this,"constant",!1),this.settings.update=e.update||(e.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(t){this.state.startIndices=t}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:t=!1}={}){const e=this.state.needsRedraw;return this.state.needsRedraw=e&&!t,e}getUpdateTriggers(){const{accessor:t}=this.settings;return[this.id].concat(typeof t!="function"&&t||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(t){if(!t||!this.supportsTransition())return null;const{accessor:e}=this.settings,r=this.settings.transition,i=Array.isArray(e)?t[e.find(s=>t[s])]:t[e];return xu(i,r)}setNeedsUpdate(t=this.id,e){if(this.state.needsUpdate=this.state.needsUpdate||t,this.setNeedsRedraw(t),e){const{startRow:r=0,endRow:i=1/0}=e;this.state.updateRanges=IE(this.state.updateRanges,[r,i])}else this.state.updateRanges=vr}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=RE}setNeedsRedraw(t=this.id){this.state.needsRedraw=this.state.needsRedraw||t}allocate(t){const{state:e,settings:r}=this;return r.noAlloc?!1:r.update?(super.allocate(t,e.updateRanges!==vr),!0):!1}updateBuffer({numInstances:t,data:e,props:r,context:i}){if(!this.needsUpdate())return!1;const{state:{updateRanges:s},settings:{update:o,noAlloc:a}}=this;let c=!0;if(o){for(const[l,u]of s)o.call(i,this,{data:e,startRow:l,endRow:u,props:r,numInstances:t});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[l,u]of s){const h=Number.isFinite(l)?this.getVertexOffset(l):0,g=Number.isFinite(u)?this.getVertexOffset(u):a||!Number.isFinite(t)?this.value.length:t*this.size;super.updateSubBuffer({startOffset:h,endOffset:g})}this._checkAttributeArray()}else c=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),c}setConstantValue(t){return t===void 0||typeof t=="function"?!1:(this.setData({constant:!0,value:t})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(t){const{state:e}=this;return t?(this.clearNeedsUpdate(),e.lastExternalBuffer===t||(e.lastExternalBuffer=t,this.setNeedsRedraw(),this.setData(t)),!0):(e.lastExternalBuffer=null,!1)}setBinaryValue(t,e=null){const{state:r,settings:i}=this;if(!t)return r.binaryValue=null,r.binaryAccessor=null,!1;if(i.noAlloc)return!1;if(r.binaryValue===t)return this.clearNeedsUpdate(),!0;if(r.binaryValue=t,this.setNeedsRedraw(),i.transform||e!==this.startIndices){ArrayBuffer.isView(t)&&(t={value:t});const o=t;st(ArrayBuffer.isView(o.value),"invalid ".concat(i.accessor));const a=Boolean(o.size)&&o.size!==this.size;return r.binaryAccessor=LE(o.value,{size:o.size||this.size,stride:o.stride,offset:o.offset,startIndices:e,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(t),!0}getVertexOffset(t){const{startIndices:e}=this;return(e?e[t]:t)*this.size}getShaderAttributes(){const t=this.settings.shaderAttributes||{[this.id]:null},e={};for(const r in t)Object.assign(e,super.getShaderAttributes(r,t[r]));return e}_autoUpdater(t,{data:e,startRow:r,endRow:i,props:s,numInstances:o}){if(t.constant)return;const{settings:a,state:c,value:l,size:u,startIndices:h}=t,{accessor:g,transform:m}=a,b=c.binaryAccessor||(typeof g=="function"?g:s[g]);st(typeof b=="function",'accessor "'.concat(g,'" is not a function'));let y=t.getVertexOffset(r);const{iterable:v,objectInfo:T}=ME(e,r,i);for(const A of v){T.index++;let S=b(A,T);if(m&&(S=m.call(this,S)),h){const x=(T.index<h.length-1?h[T.index+1]:o)-h[T.index];if(S&&Array.isArray(S[0])){let M=y;for(const R of S)t._normalizeValue(R,l,M),M+=u}else S&&S.length>u?l.set(S,y):(t._normalizeValue(S,T.target,0),Jy({target:l,source:T.target,start:y,count:x}));y+=x*u}else t._normalizeValue(S,l,y),y+=u}}_validateAttributeUpdaters(){const{settings:t}=this;if(!(t.noAlloc||typeof t.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){const{value:t}=this,e=Math.min(4,this.size);if(t&&t.length>=e){let r=!0;switch(e){case 4:r=r&&Number.isFinite(t[3]);case 3:r=r&&Number.isFinite(t[2]);case 2:r=r&&Number.isFinite(t[1]);case 1:r=r&&Number.isFinite(t[0]);break;default:r=!1}if(!r)throw new Error("Illegal attribute generated for ".concat(this.id))}}}class kE{constructor({gl:t,attribute:e,timeline:r}){f(this,"gl",void 0),f(this,"type","interpolation"),f(this,"attributeInTransition",void 0),f(this,"settings",void 0),f(this,"attribute",void 0),f(this,"transition",void 0),f(this,"currentStartIndices",void 0),f(this,"currentLength",void 0),f(this,"transform",void 0),f(this,"buffers",void 0),this.gl=t,this.transition=new Vn(r),this.attribute=e,this.attributeInTransition=new Js(t,e.settings),this.currentStartIndices=e.startIndices,this.currentLength=0,this.transform=DE(t,e);const i={byteLength:0,usage:35050};this.buffers=[new W(t,i),new W(t,i)]}get inProgress(){return this.transition.inProgress}start(t,e){if(t.duration<=0){this.transition.cancel();return}this.settings=t;const{gl:r,buffers:i,attribute:s}=this;Lu(i);const o={numInstances:e,attribute:s,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:t.enter};for(const a of i)Ru({buffer:a,...o});this.currentStartIndices=s.startIndices,this.currentLength=Qs(s,e),this.attributeInTransition.setData({buffer:i[1],value:s.value}),this.transition.start(t),this.transform.update({elementCount:Math.floor(this.currentLength/s.size),sourceBuffers:{aFrom:i[0],aTo:Pu(r,s)},feedbackBuffers:{vCurrent:i[1]}})}update(){const t=this.transition.update();if(t){const{duration:e,easing:r}=this.settings,{time:i}=this.transition;let s=i/e;r&&(s=r(s)),this.transform.run({uniforms:{time:s}})}return t}cancel(){this.transition.cancel(),this.transform.delete();for(const t of this.buffers)t.delete();this.buffers.length=0}}const NE=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function DE(n,t){const e=Mu(t.size);return new Xs(n,{vs:NE,defines:{ATTRIBUTE_TYPE:e},varyings:["vCurrent"]})}class FE{constructor({gl:t,attribute:e,timeline:r}){f(this,"gl",void 0),f(this,"type","spring"),f(this,"attributeInTransition",void 0),f(this,"settings",void 0),f(this,"attribute",void 0),f(this,"transition",void 0),f(this,"currentStartIndices",void 0),f(this,"currentLength",void 0),f(this,"texture",void 0),f(this,"framebuffer",void 0),f(this,"transform",void 0),f(this,"buffers",void 0),this.gl=t,this.type="spring",this.transition=new Vn(r),this.attribute=e,this.attributeInTransition=new Js(t,{...e.settings,normalized:!1}),this.currentStartIndices=e.startIndices,this.currentLength=0,this.texture=UE(t),this.framebuffer=VE(t,this.texture),this.transform=BE(t,e,this.framebuffer);const i={byteLength:0,usage:35050};this.buffers=[new W(t,i),new W(t,i),new W(t,i)]}get inProgress(){return this.transition.inProgress}start(t,e){const{gl:r,buffers:i,attribute:s}=this,o={numInstances:e,attribute:s,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:t.enter};for(const a of i)Ru({buffer:a,...o});this.settings=t,this.currentStartIndices=s.startIndices,this.currentLength=Qs(s,e),this.attributeInTransition.setData({buffer:i[1],value:s.value}),this.transition.start({...t,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/s.size),sourceBuffers:{aTo:Pu(r,s)}})}update(){const{buffers:t,transform:e,framebuffer:r,transition:i}=this;if(!i.update())return!1;const o=this.settings;return e.update({sourceBuffers:{aPrev:t[0],aCur:t[1]},feedbackBuffers:{vNext:t[2]}}),e.run({framebuffer:r,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:o.stiffness,damping:o.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),Lu(t),this.attributeInTransition.setData({buffer:t[1],value:this.attribute.value}),qr(r)[0]>0||i.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(const t of this.buffers)t.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}}function BE(n,t,e){const r=Mu(t.size);return new Xs(n,{framebuffer:e,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:r},varyings:["vNext"]})}function UE(n){return new Tt(n,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function VE(n,t){return new Q(n,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:t}})}const jE={interpolation:kE,spring:FE};class zE{constructor(t,{id:e,timeline:r}){f(this,"id",void 0),f(this,"isSupported",void 0),f(this,"gl",void 0),f(this,"timeline",void 0),f(this,"transitions",void 0),f(this,"needsRedraw",void 0),f(this,"numInstances",void 0),this.id=e,this.gl=t,this.timeline=r,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=Xs.isSupported(t)}finalize(){for(const t in this.transitions)this._removeTransition(t)}update({attributes:t,transitions:e,numInstances:r}){this.numInstances=r||1;for(const i in t){const s=t[i],o=s.getTransitionSetting(e);!o||this._updateAttribute(i,s,o)}for(const i in this.transitions){const s=t[i];(!s||!s.getTransitionSetting(e))&&this._removeTransition(i)}}hasAttribute(t){const e=this.transitions[t];return e&&e.inProgress}getAttributes(){const t={};for(const e in this.transitions){const r=this.transitions[e];r.inProgress&&(t[e]=r.attributeInTransition)}return t}run(){if(!this.isSupported||this.numInstances===0)return!1;for(const e in this.transitions)this.transitions[e].update()&&(this.needsRedraw=!0);const t=this.needsRedraw;return this.needsRedraw=!1,t}_removeTransition(t){this.transitions[t].cancel(),delete this.transitions[t]}_updateAttribute(t,e,r){const i=this.transitions[t];let s=!i||i.type!==r.type;if(s){if(!this.isSupported){H.warn("WebGL2 not supported by this browser. Transition for ".concat(t," is disabled."))();return}i&&this._removeTransition(t);const o=jE[r.type];o?this.transitions[t]=new o({attribute:e,timeline:this.timeline,gl:this.gl}):(H.error("unsupported transition type '".concat(r.type,"'"))(),s=!1)}(s||e.needsRedraw())&&(this.needsRedraw=!0,this.transitions[t].start(r,this.numInstances))}}const yc="attributeManager.invalidate",GE="attributeManager.updateStart",HE="attributeManager.updateEnd",WE="attribute.updateStart",XE="attribute.allocate",YE="attribute.updateEnd";class qE{constructor(t,{id:e="attribute-manager",stats:r,timeline:i}={}){f(this,"id",void 0),f(this,"gl",void 0),f(this,"attributes",void 0),f(this,"updateTriggers",void 0),f(this,"needsRedraw",void 0),f(this,"userData",void 0),f(this,"stats",void 0),f(this,"attributeTransitionManager",void 0),this.id=e,this.gl=t,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=r,this.attributeTransitionManager=new zE(t,{id:"".concat(e,"-transitions"),timeline:i}),Object.seal(this)}finalize(){for(const t in this.attributes)this.attributes[t].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(t={clearRedrawFlags:!1}){const e=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!t.clearRedrawFlags,e&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(t){this._add(t)}addInstanced(t){this._add(t,{instanced:1})}remove(t){for(const e of t)this.attributes[e]!==void 0&&(this.attributes[e].delete(),delete this.attributes[e])}invalidate(t,e){const r=this._invalidateTrigger(t,e);at(yc,this,t,r)}invalidateAll(t){for(const e in this.attributes)this.attributes[e].setNeedsUpdate(e,t);at(yc,this,"all")}update({data:t,numInstances:e,startIndices:r=null,transitions:i,props:s={},buffers:o={},context:a={}}){let c=!1;at(GE,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const l in this.attributes){const u=this.attributes[l],h=u.settings.accessor;u.startIndices=r,u.numInstances=e,s[l]&&H.removed("props.".concat(l),"data.attributes.".concat(l))(),u.setExternalBuffer(o[l])||u.setBinaryValue(typeof h=="string"?o[h]:void 0,t.startIndices)||typeof h=="string"&&!o[h]&&u.setConstantValue(s[h])||u.needsUpdate()&&(c=!0,this._updateAttribute({attribute:u,numInstances:e,data:t,props:s,context:a})),this.needsRedraw=this.needsRedraw||u.needsRedraw()}c&&at(HE,this,e),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:e,transitions:i})}updateTransition(){const{attributeTransitionManager:t}=this,e=t.run();return this.needsRedraw=this.needsRedraw||e,e}getAttributes(){return this.attributes}getChangedAttributes(t={clearChangedFlags:!1}){const{attributes:e,attributeTransitionManager:r}=this,i={...r.getAttributes()};for(const s in e){const o=e[s];o.needsRedraw(t)&&!r.hasAttribute(s)&&(i[s]=o)}return i}getShaderAttributes(t,e={}){t||(t=this.getAttributes());const r={};for(const i in t)e[i]||Object.assign(r,t[i].getShaderAttributes());return r}_add(t,e={}){for(const r in t){const i=t[r];this.attributes[r]=this._createAttribute(r,i,e)}this._mapUpdateTriggersToAttributes()}_createAttribute(t,e,r){const i={...e,id:t,size:e.isIndexed&&1||e.size||1,divisor:r.instanced?1:e.divisor||0};return new Js(this.gl,i)}_mapUpdateTriggersToAttributes(){const t={};for(const e in this.attributes)this.attributes[e].getUpdateTriggers().forEach(i=>{t[i]||(t[i]=[]),t[i].push(e)});this.updateTriggers=t}_invalidateTrigger(t,e){const{attributes:r,updateTriggers:i}=this,s=i[t];return s&&s.forEach(o=>{const a=r[o];a&&a.setNeedsUpdate(a.id,e)}),s}_updateAttribute(t){const{attribute:e,numInstances:r}=t;if(at(WE,e),e.constant){e.setConstantValue(e.value);return}e.allocate(r)&&at(XE,e,r),e.updateBuffer(t)&&(this.needsRedraw=!0,at(YE,e,r))}}class $E extends Vn{get value(){return this._value}_onUpdate(){const{time:t,settings:{fromValue:e,toValue:r,duration:i,easing:s}}=this,o=s(t/i);this._value=Rr(e,r,o)}}const vc=1e-5;function Ec(n,t,e,r,i){const s=t-n,a=(e-t)*i,c=-s*r;return a+c+s+t}function ZE(n,t,e,r,i){if(Array.isArray(e)){const s=[];for(let o=0;o<e.length;o++)s[o]=Ec(n[o],t[o],e[o],r,i);return s}return Ec(n,t,e,r,i)}function Tc(n,t){if(Array.isArray(n)){let e=0;for(let r=0;r<n.length;r++){const i=n[r]-t[r];e+=i*i}return Math.sqrt(e)}return Math.abs(n-t)}class KE extends Vn{get value(){return this._currValue}_onUpdate(){const{fromValue:t,toValue:e,damping:r,stiffness:i}=this.settings,{_prevValue:s=t,_currValue:o=t}=this;let a=ZE(s,o,e,r,i);const c=Tc(a,e),l=Tc(a,o);c<vc&&l<vc&&(a=e,this.end()),this._prevValue=o,this._currValue=a}}const QE={interpolation:$E,spring:KE};class JE{constructor(t){this.transitions=new Map,this.timeline=t}get active(){return this.transitions.size>0}add(t,e,r,i){const{transitions:s}=this;if(s.has(t)){const c=s.get(t),{value:l=c.settings.fromValue}=c;e=l,this.remove(t)}if(i=xu(i),!i)return;const o=QE[i.type];if(!o){H.error("unsupported transition type '".concat(i.type,"'"))();return}const a=new o(this.timeline);a.start({...i,fromValue:e,toValue:r}),s.set(t,a)}remove(t){const{transitions:e}=this;e.has(t)&&(e.get(t).cancel(),e.delete(t))}update(){const t={};for(const[e,r]of this.transitions)r.update(),t[e]=r.value,r.inProgress||this.remove(e);return t}clear(){for(const t of this.transitions.keys())this.remove(t)}}function tT(n){const t=to(n);for(const e in t){const r=t[e],{validate:i}=r;if(i&&!i(n[e],r))throw new Error("Invalid prop ".concat(e,": ").concat(n[e]))}}function eT(n,t){const e=Iu({newProps:n,oldProps:t,propTypes:to(n),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=rT(n,t);let i=!1;return r||(i=iT(n,t)),{dataChanged:r,propsChanged:e,updateTriggersChanged:i,extensionsChanged:sT(n,t),transitionsChanged:nT(n,t)}}function nT(n,t){if(!n.transitions)return!1;const e={},r=to(n);let i=!1;for(const s in n.transitions){const o=r[s],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&vs(n[s],t[s],o)&&(e[s]=!0,i=!0)}return i?e:!1}function Iu({newProps:n,oldProps:t,ignoreProps:e={},propTypes:r={},triggerName:i="props"}){if(t===n)return!1;if(typeof n!="object"||n===null||typeof t!="object"||t===null)return"".concat(i," changed shallowly");for(const s of Object.keys(n))if(!(s in e)){if(!(s in t))return"".concat(i,".").concat(s," added");const o=vs(n[s],t[s],r[s]);if(o)return"".concat(i,".").concat(s," ").concat(o)}for(const s of Object.keys(t))if(!(s in e)){if(!(s in n))return"".concat(i,".").concat(s," dropped");if(!Object.hasOwnProperty.call(n,s)){const o=vs(n[s],t[s],r[s]);if(o)return"".concat(i,".").concat(s," ").concat(o)}}return!1}function vs(n,t,e){let r=e&&e.equal;return r&&!r(n,t,e)||!r&&(r=n&&t&&n.equals,r&&!r.call(n,t))?"changed deeply":!r&&t!==n?"changed shallowly":null}function rT(n,t){if(t===null)return"oldProps is null, initial diff";let e=!1;const{dataComparator:r,_dataDiff:i}=n;return r?r(n.data,t.data)||(e="Data comparator detected a change"):n.data!==t.data&&(e="A new data container was supplied"),e&&i&&(e=i(n.data,t.data)||e),e}function iT(n,t){if(t===null)return{all:!0};if("all"in n.updateTriggers&&wc(n,t,"all"))return{all:!0};const e={};let r=!1;for(const i in n.updateTriggers)i!=="all"&&wc(n,t,i)&&(e[i]=!0,r=!0);return r?e:!1}function sT(n,t){if(t===null)return!0;const e=t.extensions,{extensions:r}=n;if(r===e)return!1;if(!e||!r||r.length!==e.length)return!0;for(let i=0;i<r.length;i++)if(!r[i].equals(e[i]))return!0;return!1}function wc(n,t,e){let r=n.updateTriggers[e];r=r==null?{}:r;let i=t.updateTriggers[e];return i=i==null?{}:i,Iu({oldProps:i,newProps:r,triggerName:e})}function to(n){const t=n[Fr],e=t&&t.constructor;return e?e._propTypes:{}}const oT="count(): argument not an object",aT="count(): argument not a container";function cT(n){if(!uT(n))throw new Error(oT);if(typeof n.count=="function")return n.count();if(Number.isFinite(n.size))return n.size;if(Number.isFinite(n.length))return n.length;if(lT(n))return Object.keys(n).length;throw new Error(aT)}function lT(n){return n!==null&&typeof n=="object"&&n.constructor===Object}function uT(n){return n!==null&&typeof n=="object"}function hT(n,t){if(!t)return n;const e={...n,...t};if("defines"in t&&(e.defines={...n.defines,...t.defines}),"modules"in t&&(e.modules=(n.modules||[]).concat(t.modules),t.modules.some(r=>r.name==="project64"))){const r=e.modules.findIndex(i=>i.name==="project32");r>=0&&e.modules.splice(r,1)}if("inject"in t)if(!n.inject)e.inject=t.inject;else{const r={...n.inject};for(const i in t.inject)r[i]=(r[i]||"")+t.inject[i];e.inject=r}return e}const fT={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},Es={};function dT(n,t){const e=n.context&&n.context.gl;if(!e||!t)return null;if(t instanceof Tt)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let r=null;t.compressed&&(r={[10241]:t.data.length>1?9985:9729});const i=new Tt(e,{...t,parameters:{...fT,...r,...n.props.textureParameters}});return Es[i.id]=!0,i}function gT(n){!n||!(n instanceof Tt)||Es[n.id]&&(n.delete(),delete Es[n.id])}const pT={boolean:{validate(n,t){return!0},equal(n,t,e){return Boolean(n)===Boolean(t)}},number:{validate(n,t){return Number.isFinite(n)&&(!("max"in t)||n<=t.max)&&(!("min"in t)||n>=t.min)}},color:{validate(n,t){return t.optional&&!n||Rn(n)&&(n.length===3||n.length===4)},equal(n,t,e){return Wi(n,t)}},accessor:{validate(n,t){const e=Ur(n);return e==="function"||e===Ur(t.value)},equal(n,t,e){return typeof t=="function"?!0:Wi(n,t)}},array:{validate(n,t){return t.optional&&!n||Rn(n)},equal(n,t,e){return e.compare?Wi(n,t):n===t}},object:{equal(n,t,e){return e.compare?xe(n,t):n===t}},function:{validate(n,t){return t.optional&&!n||typeof n=="function"},equal(n,t,e){return!e.compare||n===t}},data:{transform:(n,t,e)=>{const{dataTransform:r}=e.props;return r&&n?r(n):n}},image:{transform:(n,t,e)=>dT(e,n),release:n=>{gT(n)}}};function Wi(n,t){if(n===t)return!0;if(!Rn(n)||!Rn(t))return!1;const e=n.length;if(e!==t.length)return!1;for(let r=0;r<e;r++)if(n[r]!==t[r])return!1;return!0}function mT(n){const t={},e={},r={};for(const[i,s]of Object.entries(n)){const o=s==null?void 0:s.deprecatedFor;if(o)r[i]=Array.isArray(o)?o:[o];else{const a=_T(i,s);t[i]=a,e[i]=a.value}}return{propTypes:t,defaultProps:e,deprecatedProps:r}}function _T(n,t){switch(Ur(t)){case"object":return mn(n,t);case"array":return mn(n,{type:"array",value:t,compare:!1});case"boolean":return mn(n,{type:"boolean",value:t});case"number":return mn(n,{type:"number",value:t});case"function":return mn(n,{type:"function",value:t,compare:!0});default:return{name:n,type:"unknown",value:t}}}function mn(n,t){return"type"in t?{name:n,...pT[t.type],...t}:"value"in t?{name:n,type:Ur(t.value),...t}:{name:n,type:"object",value:t}}function Rn(n){return Array.isArray(n)||ArrayBuffer.isView(n)}function Ur(n){return Rn(n)?"array":n===null?"null":typeof n}function bT(n,t){const e=Cu(n.constructor),r=Object.create(e);r[Fr]=n,r[Te]={},r[ce]={};for(let i=0;i<t.length;++i){const s=t[i];for(const o in s)r[o]=s[o]}return Object.freeze(r),r}function Cu(n){const t=Vr(n,"_mergedDefaultProps");return t||(yT(n),n._mergedDefaultProps)}function yT(n){if(!n.prototype)return;const e=Object.getPrototypeOf(n),r=Cu(e),i=Vr(n,"defaultProps")||{},s=mT(i),o=vT(s.defaultProps,r,n),a={...e._propTypes,...s.propTypes};TT(o,a);const c={...e._deprecatedProps,...s.deprecatedProps};ET(o,c),n._mergedDefaultProps=o,n._propTypes=a,n._deprecatedProps=c}function vT(n,t,e){const r=Object.create(null);Object.assign(r,t,n);const i=AT(e);return delete n.id,Object.defineProperties(r,{id:{writable:!0,value:i}}),r}function ET(n,t){for(const e in t)Object.defineProperty(n,e,{enumerable:!1,set(r){const i="".concat(this.id,": ").concat(e);for(const s of t[e])Ou(this,s)||(this[s]=r);H.deprecated(i,t[e].join("/"))()}})}function TT(n,t){const e={},r={};for(const i in t){const s=t[i],{name:o,value:a}=s;s.async&&(e[o]=a,r[o]=wT(o))}n[ze]=e,n[Te]={},Object.defineProperties(n,r)}function wT(n){return{enumerable:!0,set(t){typeof t=="string"||t instanceof Promise||Su(t)?this[Te][n]=t:this[ce][n]=t},get(){if(this[ce]){if(n in this[ce])return this[ce][n]||this[ze][n];if(n in this[Te]){const t=this[Fr]&&this[Fr].internalState;if(t&&t.hasAsyncProp(n))return t.getAsyncProp(n)||this[ze][n]}}return this[ze][n]}}}function Ou(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function Vr(n,t){return Ou(n,t)&&n[t]}function AT(n){const t=Vr(n,"layerName")||Vr(n,"componentName");return t||H.once(0,"".concat(n.name,".componentName not specified"))(),t||n.name}let ST=0;class eo{constructor(...t){f(this,"id",void 0),f(this,"props",void 0),f(this,"count",void 0),this.props=bT(this,t),this.id=this.props.id,this.count=ST++}clone(t){const{props:e}=this,r={};for(const i in e[ze])i in e[ce]?r[i]=e[ce][i]:i in e[Te]&&(r[i]=e[Te][i]);return new this.constructor({...e,...r,...t})}}f(eo,"componentName","Component");f(eo,"defaultProps",{});const xT=Object.freeze({});class PT{constructor(t){f(this,"component",void 0),f(this,"onAsyncPropUpdated",void 0),f(this,"asyncProps",void 0),f(this,"oldProps",void 0),f(this,"oldAsyncProps",void 0),this.component=t,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const t in this.asyncProps){const e=this.asyncProps[t];e&&e.type&&e.type.release&&e.type.release(e.resolvedValue,e.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||xT}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(t){return t in this.asyncProps}getAsyncProp(t){const e=this.asyncProps[t];return e&&e.resolvedValue}isAsyncPropLoading(t){if(t){const e=this.asyncProps[t];return Boolean(e&&e.pendingLoadCount>0&&e.pendingLoadCount!==e.resolvedLoadCount)}for(const e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(t,e){this._watchPromise(t,Promise.resolve(e))}setAsyncProps(t){const e=t[ce]||{},r=t[Te]||t,i=t[ze]||{};for(const s in e){const o=e[s];this._createAsyncPropData(s,i[s]),this._updateAsyncProp(s,o),e[s]=this.getAsyncProp(s)}for(const s in r){const o=r[s];this._createAsyncPropData(s,i[s]),this._updateAsyncProp(s,o)}}_fetch(t,e){return null}_onResolve(t,e){}_onError(t,e){}_updateAsyncProp(t,e){if(!!this._didAsyncInputValueChange(t,e)){if(typeof e=="string"&&(e=this._fetch(t,e)),e instanceof Promise){this._watchPromise(t,e);return}if(Su(e)){this._resolveAsyncIterable(t,e);return}this._setPropValue(t,e)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const t in this.asyncProps)Object.defineProperty(this.oldAsyncProps,t,{enumerable:!0,value:this.oldProps[t]})}}_didAsyncInputValueChange(t,e){const r=this.asyncProps[t];return e===r.resolvedValue||e===r.lastValue?!1:(r.lastValue=e,!0)}_setPropValue(t,e){this._freezeAsyncOldProps();const r=this.asyncProps[t];r&&(e=this._postProcessValue(r,e),r.resolvedValue=e,r.pendingLoadCount++,r.resolvedLoadCount=r.pendingLoadCount)}_setAsyncPropValue(t,e,r){const i=this.asyncProps[t];i&&r>=i.resolvedLoadCount&&e!==void 0&&(this._freezeAsyncOldProps(),i.resolvedValue=e,i.resolvedLoadCount=r,this.onAsyncPropUpdated(t,e))}_watchPromise(t,e){const r=this.asyncProps[t];if(r){r.pendingLoadCount++;const i=r.pendingLoadCount;e.then(s=>{s=this._postProcessValue(r,s),this._setAsyncPropValue(t,s,i),this._onResolve(t,s)}).catch(s=>{this._onError(t,s)})}}async _resolveAsyncIterable(t,e){if(t!=="data"){this._setPropValue(t,e);return}const r=this.asyncProps[t];if(!r)return;r.pendingLoadCount++;const i=r.pendingLoadCount;let s=[],o=0;for await(const a of e){const{dataTransform:c}=this.component.props;c?s=c(a,s):s=s.concat(a),Object.defineProperty(s,"__diff",{enumerable:!1,value:[{startRow:o,endRow:s.length}]}),o=s.length,this._setAsyncPropValue(t,s,i)}this._onResolve(t,s)}_postProcessValue(t,e){const r=t.type;return r&&(r.release&&r.release(t.resolvedValue,r,this.component),r.transform)?r.transform(e,r,this.component):e}_createAsyncPropData(t,e){if(!this.asyncProps[t]){const i=this.component&&this.component.constructor._propTypes;this.asyncProps[t]={type:i&&i[t],lastValue:null,resolvedValue:e,pendingLoadCount:0,resolvedLoadCount:0}}}}class MT extends PT{constructor({attributeManager:t,layer:e}){super(e),f(this,"attributeManager",void 0),f(this,"needsRedraw",void 0),f(this,"needsUpdate",void 0),f(this,"subLayers",void 0),f(this,"usesPickingColorCache",void 0),f(this,"changeFlags",void 0),f(this,"viewport",void 0),f(this,"uniformTransitions",void 0),f(this,"propsInTransition",void 0),this.attributeManager=t,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(t){this.component=t}_fetch(t,e){const r=this.component.props.fetch;return r?r(e,{propName:t,layer:this.layer}):super._fetch(t,e)}_onResolve(t,e){const r=this.component.props.onDataLoad;t==="data"&&r&&r(e,{propName:t,layer:this.layer})}_onError(t,e){this.layer.raiseError(e,"loading ".concat(t," of ").concat(this.layer))}}const LT="layer.changeFlag",RT="layer.initialize",IT="layer.update",CT="layer.finalize",OT="layer.matched",Ac=2**24-1,kT=Object.freeze([]),NT=Zr(({oldViewport:n,viewport:t})=>n.equals(t));let Bt=new Uint8ClampedArray(0);const DT={data:{type:"data",value:kT,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:n=>n&&n.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(n,{propName:t,layer:e,loaders:r,loadOptions:i,signal:s})=>{const{resourceManager:o}=e.context;if(i=i||e.getLoadOptions(),r=r||e.props.loaders,s){var a;i={...i,fetch:{...(a=i)===null||a===void 0?void 0:a.fetch,signal:s}}}let c=o.contains(n);return!c&&!i&&(o.add({resourceId:n,data:Ki(n,r),persistent:!1}),c=!0),c?o.subscribe({resourceId:n,onChange:l=>{var u;return(u=e.internalState)===null||u===void 0?void 0:u.reloadAsyncProp(t,l)},consumerId:e.id,requestId:t}):Ki(n,r,i)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:Bn.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:G.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:n})=>[0,-n*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class ti extends eo{constructor(...t){super(...t),f(this,"internalState",null),f(this,"lifecycle",Fe.NO_STATE),f(this,"context",void 0),f(this,"state",void 0),f(this,"parent",null)}get root(){let t=this;for(;t.parent;)t=t.parent;return t}toString(){const t=this.constructor.layerName||this.constructor.name;return"".concat(t,"({id: '").concat(this.props.id,"'})")}project(t){st(this.internalState);const e=this.internalState.viewport||this.context.viewport,r=fu(t,{viewport:e,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[i,s,o]=cu(r,e.pixelProjectionMatrix);return t.length===2?[i,s]:[i,s,o]}unproject(t){return st(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(t)}projectPosition(t,e){st(this.internalState);const r=this.internalState.viewport||this.context.viewport;return Qy(t,{viewport:r,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...e})}get isComposite(){return!1}setState(t){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,t),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(t){for(const e of this.getModels())e.updateModuleSettings(t)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:t}=this.props;return t===G.DEFAULT||t===G.LNGLAT||t===G.CARTESIAN}onHover(t,e){return this.props.onHover&&this.props.onHover(t,e)||!1}onClick(t,e){return this.props.onClick&&this.props.onClick(t,e)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(t,e=[]){return e[0]=t+1&255,e[1]=t+1>>8&255,e[2]=t+1>>8>>8&255,e}decodePickingColor(t){st(t instanceof Uint8Array);const[e,r,i]=t;return e+r*256+i*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:cT(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var t;const e=this.getAttributeManager();if(!e)return null;const{positions:r,instancePositions:i}=e.attributes;return(t=r||i)===null||t===void 0?void 0:t.getBounds()}getShaders(t){for(const e of this.props.extensions)t=hT(t,e.getShaders.call(this,e));return t}shouldUpdateState(t){return t.changeFlags.propsOrDataChanged}updateState(t){const e=this.getAttributeManager(),{dataChanged:r}=t.changeFlags;if(r&&e)if(Array.isArray(r))for(const c of r)e.invalidateAll(c);else e.invalidateAll();const{props:i,oldProps:s}=t,o=Number.isInteger(s.highlightedObjectIndex)||s.pickable,a=Number.isInteger(i.highlightedObjectIndex)||i.pickable;if(o!==a&&e){const{pickingColors:c,instancePickingColors:l}=e.attributes,u=c||l;u&&(a&&u.constant&&(u.constant=!1,e.invalidate(u.id)),!u.value&&!a&&(u.constant=!0,u.value=[0,0,0]))}}finalizeState(t){for(const r of this.getModels())r.delete();const e=this.getAttributeManager();e&&e.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(t){for(const e of this.getModels())e.draw(t)}getPickingInfo({info:t,mode:e,sourceLayer:r}){const{index:i}=t;return i>=0&&Array.isArray(this.props.data)&&(t.object=this.props.data[i]),t}raiseError(t,e){var r,i;if(e&&(t.message="".concat(e,": ").concat(t.message)),!((r=(i=this.props).onError)!==null&&r!==void 0&&r.call(i,t))){var s,o;(s=this.context)===null||s===void 0||(o=s.onError)===null||o===void 0||o.call(s,t,this)}}getNeedsRedraw(t={clearRedrawFlags:!1}){return this._getNeedsRedraw(t)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var t;return((t=this.internalState)===null||t===void 0?void 0:t.uniformTransitions.active)||!1}activateViewport(t){if(!this.internalState)return;const e=this.internalState.viewport;this.internalState.viewport=t,(!e||!NT({oldViewport:e,viewport:t}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(t="all"){const e=this.getAttributeManager();!e||(t==="all"?e.invalidateAll():e.invalidate(t))}updateAttributes(t){for(const e of this.getModels())this._setModelAttributes(e,t)}_updateAttributes(){const t=this.getAttributeManager();if(!t)return;const e=this.props,r=this.getNumInstances(),i=this.getStartIndices();t.update({data:e.data,numInstances:r,startIndices:i,props:e,transitions:e.transitions,buffers:e.data.attributes,context:this});const s=t.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(s)}_updateAttributeTransition(){const t=this.getAttributeManager();t&&t.updateTransition()}_updateUniformTransition(){const{uniformTransitions:t}=this.internalState;if(t.active){const e=t.update(),r=Object.create(this.props);for(const i in e)Object.defineProperty(r,i,{value:e[i]});return r}return this.props}calculateInstancePickingColors(t,{numInstances:e}){if(t.constant)return;const r=Math.floor(Bt.length/3);if(this.internalState.usesPickingColorCache=!0,r<e){e>Ac&&H.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Bt=Ln.allocate(Bt,e,{size:3,copy:!0,maxCount:Math.max(e,Ac)});const i=Math.floor(Bt.length/3),s=[];for(let o=r;o<i;o++)this.encodePickingColor(o,s),Bt[o*3+0]=s[0],Bt[o*3+1]=s[1],Bt[o*3+2]=s[2]}t.value=Bt.subarray(0,e*3)}_setModelAttributes(t,e){const r=this.getAttributeManager(),i=t.userData.excludeAttributes||{},s=r.getShaderAttributes(e,i);t.setAttributes(s)}disablePickingIndex(t){this._disablePickingIndex(t)}_disablePickingIndex(t){const{pickingColors:e,instancePickingColors:r}=this.getAttributeManager().attributes,i=e||r;if(!i)return;const s=i.getVertexOffset(t),o=i.getVertexOffset(t+1);i.buffer.subData({data:new Uint8Array(o-s),offset:s})}restorePickingColors(){const{pickingColors:t,instancePickingColors:e}=this.getAttributeManager().attributes,r=t||e;!r||(this.internalState.usesPickingColorCache&&r.value.buffer!==Bt.buffer&&(r.value=Bt.subarray(0,r.value.length)),r.updateSubBuffer({startOffset:0}))}_initialize(){st(!this.internalState),st(Number.isFinite(this.props.coordinateSystem)),at(RT,this);const t=this._getAttributeManager();t&&t.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new MT({attributeManager:t,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(H.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),t)}),this.internalState.layer=this,this.internalState.uniformTransitions=new JE(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const e of this.props.extensions)e.initializeState.call(this,this.context,e);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(t){at(OT,this,this===t);const{state:e,internalState:r}=t;this!==t&&(this.internalState=r,this.internalState.layer=this,this.state=e,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const t=this.needsUpdate();if(at(IT,this,t),!t)return;const e=this.props,r=this.context,i=this.internalState,s=r.viewport,o=this._updateUniformTransition();i.propsInTransition=o,r.viewport=i.viewport||s,this.props=o;try{const a=this._getUpdateParams(),c=this.getModels();if(r.gl)this.updateState(a);else try{this.updateState(a)}catch{}for(const u of this.props.extensions)u.updateState.call(this,a,u);const l=this.getModels()[0]!==c[0];this._postUpdate(a,l)}finally{r.viewport=s,this.props=e,this._clearChangeFlags(),i.needsUpdate=!1,i.resetOldProps()}}_finalize(){at(CT,this),this.finalizeState(this.context);for(const t of this.props.extensions)t.finalizeState.call(this,t)}_drawLayer({moduleParameters:t=null,uniforms:e={},parameters:r={}}){this._updateAttributeTransition();const i=this.props,s=this.context;this.props=this.internalState.propsInTransition||i;const o=this.props.opacity;e.opacity=Math.pow(o,1/2.2);try{t&&this.setModuleParameters(t);const{getPolygonOffset:a}=this.props,c=a&&a(e)||[0,0];$t(s.gl,{polygonOffset:c}),Pt(s.gl,r,()=>{const l={moduleParameters:t,uniforms:e,parameters:r,context:s};for(const u of this.props.extensions)u.draw.call(this,l,u);this.draw(l)})}finally{this.props=i}}getChangeFlags(){var t;return(t=this.internalState)===null||t===void 0?void 0:t.changeFlags}setChangeFlags(t){if(!this.internalState)return;const{changeFlags:e}=this.internalState;for(const i in t)if(t[i]){let s=!1;switch(i){case"dataChanged":const o=t[i],a=e[i];o&&Array.isArray(a)&&(e.dataChanged=Array.isArray(o)?a.concat(o):o,s=!0);default:e[i]||(e[i]=t[i],s=!0)}s&&at(LT,this,i,t)}const r=Boolean(e.dataChanged||e.updateTriggersChanged||e.propsChanged||e.extensionsChanged);e.propsOrDataChanged=r,e.somethingChanged=r||e.viewportChanged||e.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(t,e){const r=eT(t,e);if(r.updateTriggersChanged)for(const s in r.updateTriggersChanged)r.updateTriggersChanged[s]&&this.invalidateAttribute(s);if(r.transitionsChanged)for(const s in r.transitionsChanged){var i;this.internalState.uniformTransitions.add(s,e[s],t[s],(i=t.transitions)===null||i===void 0?void 0:i[s])}return this.setChangeFlags(r)}validateProps(){tT(this.props)}updateAutoHighlight(t){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(t)}_updateAutoHighlight(t){const e={pickingSelectedColor:t.picked?t.color:null},{highlightColor:r}=this.props;t.picked&&typeof r=="function"&&(e.pickingHighlightColor=r(t)),this.setModuleParameters(e),this.setNeedsRedraw()}_getAttributeManager(){const t=this.context;return new qE(t.gl,{id:this.props.id,stats:t.stats,timeline:t.timeline})}_postUpdate(t,e){const{props:r,oldProps:i}=t;this.setNeedsRedraw(),this._updateAttributes();const{model:s}=this.state;s==null||s.setInstanceCount(this.getNumInstances());const{autoHighlight:o,highlightedObjectIndex:a,highlightColor:c}=r;if(e||i.autoHighlight!==o||i.highlightedObjectIndex!==a||i.highlightColor!==c){const l={};o||(l.pickingSelectedColor=null),Array.isArray(c)&&(l.pickingHighlightColor=c),Number.isInteger(a)&&(l.pickingSelectedColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setModuleParameters(l)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(t){if(!this.internalState)return!1;let e=!1;e=e||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!t.clearRedrawFlags;const r=this.getAttributeManager(),i=r?r.getNeedsRedraw(t):!1;return e=e||i,e}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}f(ti,"defaultProps",DT);f(ti,"layerName","Layer");const FT="compositeLayer.renderLayers";class BT extends ti{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(t=>t.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(t){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo({info:t}){const{object:e}=t;return e&&e.__source&&e.__source.parent&&e.__source.parent.id===this.id&&(t.object=e.__source.object,t.index=e.__source.index),t}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){return e&&e.length}getSubLayerClass(t,e){const{_subLayerProps:r}=this.props;return r&&r[t]&&r[t].type||e}getSubLayerRow(t,e,r){return t.__source={parent:this,object:e,index:r},t}getSubLayerAccessor(t){if(typeof t=="function"){const e={index:-1,data:this.props.data,target:[]};return(r,i)=>r&&r.__source?(e.index=r.__source.index,t(r.__source.object,e)):t(r,i)}return t}getSubLayerProps(t={}){var e;const{opacity:r,pickable:i,visible:s,parameters:o,getPolygonOffset:a,highlightedObjectIndex:c,autoHighlight:l,highlightColor:u,coordinateSystem:h,coordinateOrigin:g,wrapLongitude:m,positionFormat:b,modelMatrix:y,extensions:v,fetch:T,operation:A,_subLayerProps:S}=this.props,x={id:"",updateTriggers:{},opacity:r,pickable:i,visible:s,parameters:o,getPolygonOffset:a,highlightedObjectIndex:c,autoHighlight:l,highlightColor:u,coordinateSystem:h,coordinateOrigin:g,wrapLongitude:m,positionFormat:b,modelMatrix:y,extensions:v,fetch:T,operation:A},M=S&&t.id&&S[t.id],R=M&&M.updateTriggers,N=t.id||"sublayer";if(M){const U=this.constructor._propTypes,k=t.type?t.type._propTypes:{};for(const D in M){const F=k[D]||U[D];F&&F.type==="accessor"&&(M[D]=this.getSubLayerAccessor(M[D]))}}Object.assign(x,t,M),x.id="".concat(this.props.id,"-").concat(N),x.updateTriggers={all:(e=this.props.updateTriggers)===null||e===void 0?void 0:e.all,...t.updateTriggers,...R};for(const U of v){const k=U.getSubLayerProps.call(this,U);k&&Object.assign(x,k,{updateTriggers:Object.assign(x.updateTriggers,k.updateTriggers)})}return x}_updateAutoHighlight(t){for(const e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_postUpdate(t,e){let r=this.internalState.subLayers;const i=!r||this.needsUpdate();if(i){const s=this.renderLayers();r=$s(s,Boolean),this.internalState.subLayers=r}at(FT,this,i,r);for(const s of r)s.parent=this}}f(BT,"layerName","CompositeLayer");const hr=Math.PI/180,Sc=180/Math.PI,Er=6370972,Ve=256;function UT(){const n=Ve/Er,t=Math.PI/180*Ve;return{unitsPerMeter:[n,n,n],unitsPerMeter2:[0,0,0],metersPerUnit:[1/n,1/n,1/n],unitsPerDegree:[t,t,n],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/t,1/t,1/n]}}class VT extends jt{constructor(t={}){const{latitude:e=0,longitude:r=0,zoom:i=0,nearZMultiplier:s=.1,farZMultiplier:o=2,resolution:a=10}=t;let{height:c,altitude:l=1.5}=t;c=c||1,l=Math.max(.75,l);const u=new ct().lookAt({eye:[0,-l,0],up:[0,0,1]}),h=Math.pow(2,i);u.rotateX(e*hr),u.rotateZ(-r*hr),u.scale(h/c);const g=Math.atan(.5/l),m=Ve*2*h/c;super({...t,height:c,viewMatrix:u,longitude:r,latitude:e,zoom:i,distanceScales:UT(),fovyRadians:g*2,focalDistance:l,near:s,far:Math.min(2,1/m+1)*l*o}),f(this,"longitude",void 0),f(this,"latitude",void 0),f(this,"resolution",void 0),this.latitude=e,this.longitude=r,this.resolution=a}get projectionMode(){return Rt.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(t={}){const e={targetZ:t.z||0},r=this.unproject([0,this.height/2],e),i=this.unproject([this.width/2,0],e),s=this.unproject([this.width,this.height/2],e),o=this.unproject([this.width/2,this.height],e);return s[0]<this.longitude&&(s[0]+=360),r[0]>this.longitude&&(r[0]-=360),[Math.min(r[0],s[0],i[0],o[0]),Math.min(r[1],s[1],i[1],o[1]),Math.max(r[0],s[0],i[0],o[0]),Math.max(r[1],s[1],i[1],o[1])]}unproject(t,{topLeft:e=!0,targetZ:r}={}){const[i,s,o]=t,a=e?s:this.height-s,{pixelUnprojectionMatrix:c}=this;let l;if(Number.isFinite(o))l=Xi(c,[i,a,o,1]);else{const m=Xi(c,[i,a,-1,1]),b=Xi(c,[i,a,1,1]),y=((r||0)/Er+1)*Ve,v=Ni($l([],m,b)),T=Ni(m),A=Ni(b),x=4*((4*T*A-(v-T-A)**2)/16)/v,M=Math.sqrt(T-x),R=Math.sqrt(Math.max(0,y*y-x)),N=(M-R)/Math.sqrt(v);l=D_([],m,b,N)}const[u,h,g]=this.unprojectPosition(l);return Number.isFinite(o)?[u,h,g]:Number.isFinite(r)?[u,h,r]:[u,h]}projectPosition(t){const[e,r,i=0]=t,s=e*hr,o=r*hr,a=Math.cos(o),c=(i/Er+1)*Ve;return[Math.sin(s)*a*c,-Math.cos(s)*a*c,Math.sin(o)*c]}unprojectPosition(t){const[e,r,i]=t,s=G_(t),o=Math.asin(i/s),c=Math.atan2(e,-r)*Sc,l=o*Sc,u=(s/Ve-1)*Er;return[c,l,u]}projectFlat(t){return t}unprojectFlat(t){return t}panByPosition(t,e){const r=this.unproject(e);return{longitude:t[0]-r[0]+this.longitude,latitude:t[1]-r[1]+this.latitude}}}function Xi(n,t){const e=Qe([],t,n);return Ql(e,e,1/e[3]),e}const Yi=Math.PI/180;function jT({height:n,focalDistance:t,orbitAxis:e,rotationX:r,rotationOrbit:i,zoom:s}){const o=e==="Z"?[0,0,1]:[0,1,0],a=e==="Z"?[0,-t,0]:[0,0,t],c=new ct().lookAt({eye:a,up:o});c.rotateX(r*Yi),e==="Z"?c.rotateZ(i*Yi):c.rotateY(i*Yi);const l=Math.pow(2,s)/n;return c.scale(l),c}class zT extends jt{constructor(t){const{height:e,projectionMatrix:r,fovy:i=50,orbitAxis:s="Z",target:o=[0,0,0],rotationX:a=0,rotationOrbit:c=0,zoom:l=0}=t,u=r?r[5]/2:qs(i);super({...t,longitude:void 0,viewMatrix:jT({height:e||1,focalDistance:u,orbitAxis:s,rotationX:a,rotationOrbit:c,zoom:l}),fovy:i,focalDistance:u,position:o,zoom:l}),f(this,"projectedCenter",void 0),this.projectedCenter=this.project(this.center)}unproject(t,{topLeft:e=!0}={}){const[r,i,s=this.projectedCenter[2]]=t,o=e?i:this.height-i,[a,c,l]=Un([r,o,s],this.pixelUnprojectionMatrix);return[a,c,l]}panByPosition(t,e){const r=this.project(t),i=[this.width/2+r[0]-e[0],this.height/2+r[1]-e[1],this.projectedCenter[2]];return{target:this.unproject(i)}}}class GT extends jt{constructor(t){const{longitude:e,latitude:r,modelMatrix:i,bearing:s=0,pitch:o=0,up:a=[0,0,1]}=t,l=new $r({bearing:s,pitch:o===-90?1e-4:90+o}).toVector3().normalize(),u=i?new ct(i).transformAsVector(l):l,h=Number.isFinite(r)?ou({latitude:r}):0,g=Math.pow(2,h),m=new ct().lookAt({eye:[0,0,0],center:u,up:a}).scale(g);super({...t,zoom:h,viewMatrix:m}),f(this,"longitude",void 0),f(this,"latitude",void 0),this.latitude=r,this.longitude=e}}const _n=20;class no extends Zs{constructor(t){const{width:e,height:r,position:i=[0,0,0],bearing:s=0,pitch:o=0,longitude:a=null,latitude:c=null,maxPitch:l=90,minPitch:u=-90,startRotatePos:h,startBearing:g,startPitch:m,startZoomPosition:b}=t;super({width:e,height:r,position:i,bearing:s,pitch:o,longitude:a,latitude:c,maxPitch:l,minPitch:u},{startRotatePos:h,startBearing:g,startPitch:m,startZoomPosition:b})}panStart(){return this}pan(){return this}panEnd(){return this}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:r=0}){const{startRotatePos:i,startBearing:s,startPitch:o}=this.getState(),{width:a,height:c}=this.getViewportProps();if(!i||s===void 0||o===void 0)return this;let l;if(t){const u=(t[0]-i[0])/a,h=(t[1]-i[1])/c;l={bearing:s-u*180,pitch:o-h*90}}else l={bearing:s-e,pitch:o-r};return this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startRotatePos:null,startBearing:null,startPitch:null})}zoomStart(){return this._getUpdatedState({startZoomPosition:this.getViewportProps().position})}zoom({scale:t}){let{startZoomPosition:e}=this.getState();e||(e=this.getViewportProps().position);const r=this.getDirection();return this._move(r,Math.log2(t)*_n,e)}zoomEnd(){return this._getUpdatedState({startZoomPosition:null})}moveLeft(t=_n){const e=this.getDirection(!0);return this._move(e.rotateZ({radians:Math.PI/2}),t)}moveRight(t=_n){const e=this.getDirection(!0);return this._move(e.rotateZ({radians:-Math.PI/2}),t)}moveUp(t=_n){const e=this.getDirection(!0);return this._move(e,t)}moveDown(t=_n){const e=this.getDirection(!0);return this._move(e.negate(),t)}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}zoomIn(t=2){return this.zoom({scale:t})}zoomOut(t=2){return this.zoom({scale:1/t})}shortestPathFrom(t){const e=t.getViewportProps(),r={...this.getViewportProps()},{bearing:i,longitude:s}=r;return Math.abs(i-e.bearing)>180&&(r.bearing=i<0?i+360:i-360),s!==null&&e.longitude!==null&&Math.abs(s-e.longitude)>180&&(r.longitude=s<0?s+360:s-360),r}_move(t,e,r=this.getViewportProps().position){const i=t.scale(e);return this._getUpdatedState({position:new Mt(r).add(i)})}getDirection(t=!1){return new $r({bearing:this.getViewportProps().bearing,pitch:t?90:90+this.getViewportProps().pitch}).toVector3().normalize()}_getUpdatedState(t){return new no({...this.getViewportProps(),...this.getState(),...t})}applyConstraints(t){const{pitch:e,maxPitch:r,minPitch:i,longitude:s,bearing:o}=t;return t.pitch=Z(e,i,r),s!==null&&(s<-180||s>180)&&(t.longitude=Dr(s+180,360)-180),(o<-180||o>180)&&(t.bearing=Dr(o+180,360)-180),t}}class HT extends jn{constructor(...t){super(...t),f(this,"ControllerState",no),f(this,"transition",{transitionDuration:300,transitionInterpolator:new Je(["position","pitch","bearing"])})}}class WT extends Vt{get ViewportType(){return GT}get ControllerType(){return HT}}f(WT,"displayName","FirstPersonView");class XT extends Vt{constructor(t={}){super(t),this.props.orbitAxis=t.orbitAxis||"Z"}get ViewportType(){return zT}get ControllerType(){return vv}}f(XT,"displayName","OrbitView");class YT extends gu{applyConstraints(t){const{maxZoom:e,minZoom:r,zoom:i}=t;t.zoom=Z(i,r,e);const{longitude:s,latitude:o}=t;return(s<-180||s>180)&&(t.longitude=Dr(s+180,360)-180),t.latitude=Z(o,-89,89),t}}class qT extends jn{constructor(...t){super(...t),f(this,"ControllerState",YT),f(this,"transition",{transitionDuration:300,transitionInterpolator:new Je(["longitude","latitude","zoom"])}),f(this,"dragMode","pan")}setProps(t){super.setProps(t),this.dragRotate=!1,this.touchRotate=!1}}class $T extends Vt{get ViewportType(){return VT}get ControllerType(){return qT}}f($T,"displayName","GlobeView");class ZT{constructor(t){f(this,"opts",void 0),t&&(this.opts=t)}equals(t){return this===t?!0:this.constructor===t.constructor&&xe(this.opts,t.opts)}getShaders(t){return null}getSubLayerProps(t){const{defaultProps:e}=t.constructor,r={updateTriggers:{}};for(const i in e)if(i in this.props){const s=e[i],o=this.props[i];r[i]=o,s&&s.type==="accessor"&&(r.updateTriggers[i]=this.props.updateTriggers[i],typeof o=="function"&&(r[i]=this.getSubLayerAccessor(o)))}return r}initializeState(t,e){}updateState(t,e){}draw(t,e){}finalizeState(t,e){}}f(ZT,"defaultProps",{});const ku=(n,t)=>{const{offsetWidth:e,offsetHeight:r}=t;return new Kt({width:e,height:r}).fitBounds(n,{})};const KT=n=>{const t=L.exports.useRef(null),e=L.exports.useRef(null),r=Jt(),[i,s]=He(Hr),[o,a]=He(of),{search:c}=In(),l=Gr(),[u,h]=L.exports.useState();L.exports.useEffect(()=>{if(t.current&&!Tr(i)){const T=ku(n.defaultBounds,t.current);s(T)}},[t.current]);const g=L.exports.useMemo(()=>{var T;return(c==null?void 0:c.status)==="OK"&&((T=c.result)==null?void 0:T.items.length)?{type:"FeatureCollection",features:c.result.items.map(A=>({...A,properties:{id:A.id,...A.properties}}))}:null},[c]),m=L.exports.useMemo(()=>gi.Children.map(n.children,T=>T.props.id)||[],[n.children]),b=L.exports.useCallback(T=>{var S;if(!e.current)return;const A=e.current.queryRenderedFeatures(T).filter(x=>m.find(M=>x.layer.id.startsWith(M)));if(A.length>0){const x=A[0];return{node:l.getNodeById((S=x.properties)==null?void 0:S.id),feature:x}}},[n.children,l,e.current,m]),y=L.exports.useCallback(T=>{var x,M;const{point:A}=T,S=b(A);if(S){const{node:R,feature:N}=S,U=u&&(R==null?void 0:R.id)===(u==null?void 0:u.node.id)?{...u,...A}:{node:R,feature:N,...A};(x=t.current)==null||x.classList.add("hover"),h(U)}else(M=t.current)==null||M.classList.remove("hover"),h(void 0)},[b,u]),v=T=>{const A=b(T.point);if(A){const S=JSON.parse(JSON.stringify(A));h(null),a(S)}else a(null)};return B("div",{ref:t,className:"p6o-map-container",children:[Tr(i)&&w(kc,{clickTolerance:r.isTouchDevice?10:3,ref:e,initialViewState:i,mapStyle:n.mapStyle,onClick:v,onMouseMove:y,onMove:T=>s(T.viewState),children:gi.Children.map(n.children,T=>gi.cloneElement(T,{data:g}))}),n.tooltip&&u&&w(bw,{...u,tooltip:n.tooltip}),n.popup&&e.current&&o&&w(_w,{selected:o,viewState:i,map:e.current,popup:n.popup,onClose:()=>a(null)})]})},QT=typeof window<"u"?L.exports.useLayoutEffect:L.exports.useEffect;function jr(n,t){for(;n;){if(n===t)return!0;n=Object.getPrototypeOf(n)}return!1}const JT={position:"absolute",zIndex:-1};function Nu(n,t){if(typeof n=="function")return n(t);if(Array.isArray(n))return n.map(e=>Nu(e,t));if(ei(n)){if(tw(n))return t.style=JT,L.exports.cloneElement(n,t);if(ew(n))return L.exports.cloneElement(n,t)}return n}function ei(n){return n&&typeof n=="object"&&"type"in n||!1}function tw(n){const t=n.type,e=t&&t.defaultProps;return e&&e.mapStyle}function ew(n){const t=n.type;return t&&t.deckGLViewProps}function Ts(n){if(typeof n=="function")return L.exports.createElement(Vt,{},n);if(Array.isArray(n))return n.map(Ts);if(ei(n)){if(n.type===L.exports.Fragment)return Ts(n.props.children);if(jr(n.type,Vt))return n}return n}function nw({children:n,layers:t=[],views:e=null}){const r=[],i=[],s={};return L.exports.Children.forEach(Ts(n),o=>{if(ei(o)){const a=o.type;if(jr(a,ti)){const c=rw(a,o.props);i.push(c)}else r.push(o);if(jr(a,Vt)&&a!==Vt&&o.props.id){const c=new a(o.props);s[c.id]=c}}else o&&r.push(o)}),Object.keys(s).length>0&&(Array.isArray(e)?e.forEach(o=>{s[o.id]=o}):e&&(s[e.id]=e),e=Object.values(s)),t=i.length>0?[...i,...t]:t,{layers:t,children:r,views:e}}function rw(n,t){const e={},r=n.defaultProps||{};for(const i in t)r[i]!==t[i]&&(e[i]=t[i]);return new n(e)}function iw({children:n,deck:t,ContextProvider:e}){const{viewManager:r}=t||{};if(!r||!r.views.length)return[];const i={},s=r.views[0].id;for(const o of n){let a=s,c=o;ei(o)&&jr(o.type,Vt)&&(a=o.props.id||s,c=o.props.children);const l=r.getViewport(a),u=r.getViewState(a);if(l){const{x:h,y:g,width:m,height:b}=l;c=Nu(c,{x:h,y:g,width:m,height:b,viewport:l,viewState:u}),i[a]||(i[a]={viewport:l,children:[]}),i[a].children.push(c)}}return Object.keys(i).map(o=>{const{viewport:a,children:c}=i[o],{x:l,y:u,width:h,height:g}=a,m={position:"absolute",left:l,top:u,width:h,height:g},b="view-".concat(o),y=L.exports.createElement("div",{key:b,id:b,style:m},...c);if(e){const v={viewport:a,container:t.canvas.offsetParent,eventManager:t.eventManager,onViewStateChange:T=>{T.viewId=o,t._onViewStateChange(T)}};return L.exports.createElement(e,{key:b,value:v},y)}return y})}const sw={mixBlendMode:null};function ow({width:n,height:t,style:e}){const r={position:"absolute",zIndex:0,left:0,top:0,width:n,height:t},i={left:0,top:0};if(e)for(const s in e)s in sw?i[s]=e[s]:r[s]=e[s];return{containerStyle:r,canvasStyle:i}}function aw(n){return{get deck(){return n.deck},pickObject:t=>n.deck.pickObject(t),pickMultipleObjects:t=>n.deck.pickMultipleObjects(t),pickObjects:t=>n.deck.pickObjects(t)}}function Du(n){n.redrawReason&&(n.deck._drawLayers(n.redrawReason),n.redrawReason=null)}function cw(n,t,e){const r=new t({...e,_customRender:i=>{n.redrawReason=i;const s=r.getViewports();n.lastRenderedViewports!==s?n.forceUpdate():Du(n)}});return r}const Fu=L.exports.forwardRef((n,t)=>{const[e,r]=L.exports.useState(0),s=L.exports.useRef({control:null,version:e,forceUpdate:()=>r(M=>M+1)}).current,o=L.exports.useRef(null),a=L.exports.useRef(null),c=L.exports.useMemo(()=>nw(n),[n.layers,n.views,n.children]);let l=!0;const u=M=>{var R;return l&&n.viewState?(s.viewStateUpdateRequested=M,null):(s.viewStateUpdateRequested=null,(R=n.onViewStateChange)===null||R===void 0?void 0:R.call(n,M))},h=M=>{if(l)s.interactionStateUpdateRequested=M;else{var R;s.interactionStateUpdateRequested=null,(R=n.onInteractionStateChange)===null||R===void 0||R.call(n,M)}},g=L.exports.useMemo(()=>{const M={...n,style:null,width:"100%",height:"100%",parent:o.current,canvas:a.current,layers:c.layers,views:c.views,onViewStateChange:u,onInteractionStateChange:h};return delete M._customRender,s.deck&&s.deck.setProps(M),M},[n]);L.exports.useEffect(()=>{const M=n.Deck||Jr;return s.deck=cw(s,M,{...g,parent:o.current,canvas:a.current}),()=>{var R;return(R=s.deck)===null||R===void 0?void 0:R.finalize()}},[]),QT(()=>{Du(s);const{viewStateUpdateRequested:M,interactionStateUpdateRequested:R}=s;M&&u(M),R&&h(R)}),L.exports.useImperativeHandle(t,()=>aw(s),[]);const m=s.deck&&s.deck.isInitialized?s.deck.getViewports():void 0,{ContextProvider:b,width:y,height:v,id:T,style:A}=n,{containerStyle:S,canvasStyle:x}=L.exports.useMemo(()=>ow({width:y,height:v,style:A}),[y,v,A]);if(!s.viewStateUpdateRequested&&s.lastRenderedViewports===m||s.version!==e){s.lastRenderedViewports=m,s.version=e;const M=iw({children:c.children,deck:s.deck,ContextProvider:b}),R=L.exports.createElement("canvas",{key:"canvas",id:T||"deckgl-overlay",ref:a,style:x});s.control=L.exports.createElement("div",{id:"".concat(T||"deckgl","-wrapper"),ref:o,style:S},[R,M])}return l=!1,s.control});Fu.defaultProps=Jr.defaultProps;const lw=n=>{const t=L.exports.useRef(null),{search:e}=In(),r=Gr(),i=L.exports.useMemo(()=>(e==null?void 0:e.result)&&e.status==="OK"&&e.result.items.length>0?e.result.items:null,[e]),s=L.exports.useMemo(()=>n.layers&&i?n.layers.reduce((a,c)=>{const l=c(i,r);return Array.isArray(l)?[...a,...l]:[...a,l]},[]):[],[i,n.layers]),o=L.exports.useCallback(a=>{const{offsetX:c,offsetY:l}=a.nativeEvent,u=t.current.pickObject({x:c,y:l,radius:3});u&&n.onClick&&n.onClick(u)},[n.onClick,t]);return w("div",{onClick:o,children:w(Fu,{ref:t,initialViewState:n.initialViewState,controller:!0,onViewStateChange:n.onViewStateChange,layers:s,getTooltip:n.tooltip?a=>n.tooltip({...a,graph:r,search:e}):null,children:w(kc,{mapStyle:n.mapStyle})})})},uw=n=>{const t=L.exports.useRef(null),[e,r]=He(Hr),[i,s]=L.exports.useState(Tr(e)?e:null),[o,a]=L.exports.useState(),[c]=Nc(o,200);return L.exports.useEffect(()=>{c&&r(c)},[c]),L.exports.useEffect(()=>{if(t.current&&!i){const l=ku(n.defaultBounds,t.current);s(l)}},[t.current]),L.exports.useEffect(()=>{t.current&&i&&Tr(e)&&s(e)},[e]),w("div",{ref:t,className:"p6o-map-container",children:i&&w(lw,{...n,initialViewState:i,onViewStateChange:l=>a(l.viewState)})})},hw=[0,"rgba(49, 54, 149, 0)",.1,"#313695",.2,"#4575b4",.3,"#74add1",.4,"#abd9e9",.5,"#e0f3f8",.6,"#fee090",.7,"#fdae61",.8,"#f46d43",.9,"#d73027",1,"#a50026"],fw=n=>({type:"heatmap",paint:{"heatmap-weight":1,"heatmap-intensity":["interpolate",["linear"],["zoom"],0,.2,9,2.5],"heatmap-color":["interpolate",["linear"],["heatmap-density"],...n],"heatmap-radius":["interpolate",["linear"],["zoom"],0,1,12,28],"heatmap-opacity":["interpolate",["linear"],["zoom"],8,1,10,0]}}),dw=n=>({type:"circle",paint:{"circle-radius":["interpolate",["linear"],["number",["get","count"],0],0,5,4e3,20],"circle-color":["case",["==",["get","is_centroid"],!0],"#808080",n],"circle-stroke-color":["case",["==",["get","is_centroid"],!0],qi("#808080").darken().hex(),qi(n).darken().hex()],"circle-stroke-width":1,"circle-opacity":["interpolate",["linear"],["zoom"],7,0,10,["case",["==",["get","is_centroid"],!0],.5,1]],"circle-stroke-opacity":["interpolate",["linear"],["zoom"],7,0,10,["case",["==",["get","is_centroid"],!0],.5,1]]}}),gw=n=>({type:"circle",paint:{"circle-radius":n,"circle-color":"transparent","circle-stroke-width":0,"circle-opacity":.5,"circle-stroke-opacity":0}}),pw=n=>{const t=Jt(),e=fw(hw),r=dw(n.color),i=t.isTouchDevice?gw(15):null;return B(Lh,{type:"geojson",data:n.data,children:[i&&w(pi,{id:`${n.id}-clickbuffer`,...i}),w(pi,{id:`${n.id}-ht`,...e}),w(pi,{id:`${n.id}-pt`,...r})]})},mw={MapLibre:KT,MapLibreDeckGL:uw};const Bu=(n,t,e,r=[15,0,0,15])=>{var c;const[i,s]=L.exports.useState(t+r[3]),[o,a]=L.exports.useState(e+r[0]);return L.exports.useEffect(()=>s(t),[t]),L.exports.useEffect(()=>a(e),[e]),L.exports.useEffect(()=>{var l,u;if(n.current){const h=(l=n.current.firstChild)==null?void 0:l.getBoundingClientRect(),g=(u=n.current.closest(".p6o-map-container"))==null?void 0:u.getBoundingClientRect();if(h&&g){const m=h.right+r[1]>g.right,b=h.bottom+r[2]>g.bottom;m&&s(g.right-h.width-r[1]-r[3]),b&&a(g.bottom-h.height-r[0]-r[2])}}},[(c=n.current)==null?void 0:c.getBoundingClientRect()]),{top:o,left:i}},_w=n=>{const t=Jt(),e=L.exports.useRef(null),{selected:r,viewState:i,map:s,popup:o}=n,[a,c]=L.exports.useState({left:0,top:0}),{top:l,left:u}=t.size===gt.DESKTOP?Bu(e,a.left,a.top):{top:0,left:0};L.exports.useEffect(()=>{var g;if(r&&t.size===gt.DESKTOP){const m=(g=Rh(r.feature))==null?void 0:g.geometry.coordinates,{x:b,y}=s.project(m);c({left:b,top:y})}else r&&c({left:0,top:0})},[r,i,t.size]);const h=L.exports.useMemo(()=>r?o({...n,onClose:n.onClose}):null,[r]);return h&&B("div",{className:t.size===gt.DESKTOP?"p6o-map-popup-container":"p6o-map-popup-container-mobile",style:{zIndex:9,position:"absolute",top:l,left:u},children:[w("button",{className:"p6o-map-popup-close",onClick:n.onClose,children:w(As,{})}),w("main",{ref:e,children:h})]})},bw=n=>{const t=L.exports.useRef(null),{x:e,y:r,node:i,feature:s,tooltip:o}=n,{left:a,top:c}=Bu(t,e,r),l=L.exports.useMemo(()=>i?o({node:i,feature:s}):null,[i,s]);return l&&w("div",{ref:t,className:"p6o-map-tooltip-container",style:{left:a,top:c,zIndex:1},children:l})},ni=()=>{const{current:n,...t}=Ih();return Object.values(t)[0]},Uu=()=>{const n=ni(),[t,e]=He(Hr);return{viewState:t,setViewState:e,getMapBounds:()=>{if(n)return n.getBounds().toArray()}}};const yw=()=>{const n=ni(),{setViewState:t}=Uu(),e=s=>{const{latitude:o,longitude:a}=s.coords;t({latitude:o,longitude:a,zoom:12}),n==null||n.easeTo({center:[a,o],zoom:12})},r=s=>console.warn("Error fetching location: "+s.message);return w("button",{className:"p6o-controls-btn p6o-my-location",tabIndex:40,"aria-label":"Go to my location",onClick:()=>navigator.geolocation.getCurrentPosition(e,r,{enableHighAccuracy:!0}),children:w(Dc,{})})};const vw=n=>w("div",{className:"p6o-controls-container",children:n.children}),Ew=n=>w("div",{className:"p6o-scrollable-container",children:n.children});const Tw=()=>{const n=ni(),[t,e]=He(Hr),r=i=>()=>{n&&e({...t,zoom:t.zoom+i,transitionDuration:200}),n==null||n.easeTo({zoom:n.getZoom()+i})};return B("div",{className:"p6o-zoom-container",children:[w("button",{className:"p6o-controls-btn p6o-zoom p6o-zoom-in",tabIndex:31,"aria-label":"Zoom in",onClick:r(1),children:w(Ch,{})}),w("button",{className:"p6o-controls-btn p6o-zoom p6o-zoom-out",tabIndex:32,"aria-label":"Zoom out",onClick:r(-1),children:w(Oh,{})})]})},zr={ARCHIVE:"#7eb0d5",BOOK:"#ede15b",EPHEMERA:"#ef9b20","GENIZA MANUSCRIPT":"#8a3800",KETUBBA:"#b2e061",MANUSCRIPT:"#bdcf32",MAP:"#edbf33",MOVIE:"#b33dc6",MUSIC:"#f46a9b",NEWSPAPER:"#bd7ebe",ORAL:"#87bc45",PHOTOGRAPH:"#ea5545",PICTURE:"#fd7f6f",SCORE:"#27aeef"};const ww=n=>/^[\u04c7-\u0591\u05D0-\u05EA\u05F0-\u05F4\u0600-\u06FF\u0750-\u077f]/.test(n),Aw=n=>{const{record:t}=n,{title:e,thumbnailURI:r,type:i}=t;return B("div",{className:"kima-listpreview-card",onClick:n.onClick,children:[w("h5",{style:ww(e)?{direction:"rtl"}:null,children:e}),r&&w("div",{className:"kima-listpreview-image-wrapper",style:{backgroundImage:`url(${r})`,borderColor:zr[i.label]}})]})},xc=[45,25],Sw=(n,t,e)=>{var c;const r=Jt(),[i,s]=L.exports.useState(t),[o,a]=L.exports.useState(e);return L.exports.useEffect(()=>s(t),[t]),L.exports.useEffect(()=>a(e),[e]),L.exports.useEffect(()=>{n.current&&r.size==="DESKTOP"&&setTimeout(()=>{var h,g;const l=(h=n.current)==null?void 0:h.getBoundingClientRect(),u=(g=n.current.closest(".p6o-map-container"))==null?void 0:g.getBoundingClientRect();if(l&&u){const m=l.right>u.right,b=l.bottom>u.bottom;m&&s(u.right-l.width-xc[0]),b&&a(u.bottom-l.bottom-xc[1])}},1)},[(c=n.current)==null?void 0:c.getBoundingClientRect()]),{top:o,left:i}};const xw=n=>{const{image:t}=n;return w(kh,{mainSrc:t,onCloseRequest:n.onClose})},Pw=n=>{if(!!n.descriptions&&!!Array.isArray(n.descriptions))return n.descriptions[0].value},Pc={ARCHIVE:w(Nh,{}),BOOK:w(Dh,{}),EPHEMERA:w(Fh,{}),"GENIZA MANUSCRIPT":w(mi,{}),KETUBBA:w(mi,{}),MANUSCRIPT:w(mi,{}),MAP:w(Bh,{}),MOVIE:w(Uh,{}),MUSIC:w(Po,{}),NEWSPAPER:w(Mo,{}),"NEWSPAPER ARTICLE":w(Mo,{}),ORAL:w(Vh,{}),PHOTOGRAPH:w(jh,{}),PICTURE:w(zh,{}),SCORE:w(Po,{})},Qt=Gh();var Ic;const fr=(Ic=document.querySelector('meta[name="api.base"]'))==null?void 0:Ic.getAttribute("content"),ro=fr?fr.endsWith("/")?fr.slice(0,-1):fr:"/api";var Cc;const Mc=(Cc=document.querySelector('meta[name="maptiler.key"]'))==null?void 0:Cc.getAttribute("content"),Mw=Mc?`https://api.maptiler.com/maps/voyager/style.json?key=${Mc}`:"https://api.maptiler.com/maps/voyager/style.json?key=RFavxpVJ82EHyrN2kxsF";const Lc=n=>/^[\u04c7-\u0591\u05D0-\u05EA\u05F0-\u05F4\u0600-\u06FF\u0750-\u077f]/.test(n),Lw=(n,t)=>fetch(`${ro}/RequestedAsset`,{headers:{Accept:"application/json","Content-Type":"application/json","X-Kima-Session-Key":Qt},method:"POST",body:JSON.stringify({RecordType:n,id:t})}),Rc=n=>{const t=L.exports.useRef(),{record:e}=n,{id:r,presentationURI:i,thumbnailURI:s,title:o,type:a}=e,c=L.exports.useMemo(()=>Pw(e),[e]),[l,u]=L.exports.useState(!1),[h,g]=L.exports.useState(!1),[m,b]=L.exports.useState(),y=(a==null?void 0:a.label)==="ORAL"||(a==null?void 0:a.label)==="MUSIC",[v,T]=L.exports.useState(!1),{top:A,left:S}=Sw(t,10,-10);return L.exports.useEffect(()=>{if(y&&i&&fetch(`${ro}/cors-proxy`,{method:"POST",headers:{"X-Kima-Session-Key":Qt},body:i}).then(x=>x.text()).then(x=>{console.log("proxy response",x),window.setTimeout(()=>b(x),2e3)}),i||s){const x=document.createElement("img");x.onerror=()=>T(!0),x.src=i||s}},[i]),L.exports.useEffect(()=>{Lw(a.label,r)},[a.label,r]),w("div",{className:"kima-selected-card-wrapper",children:B("div",{ref:t,className:"kima-selected-card",style:{top:A,left:S},onClick:n.onClick,children:[w("header",{children:(i||s)&&!v?y&&m?w("audio",{controls:!0,crossOrigin:"anonymous",children:w("source",{src:m})}):B(Ss,{children:[w("div",{className:"kima-selected-preview-loading",children:w(Fc,{})}),w("div",{className:"kima-selected-preview",style:{backgroundImage:`url("${i||s}")`}}),i&&w("button",{className:"kima-selected-fullscreen",onClick:()=>u(!0),children:w(Bc,{})})]}):w("div",{className:"kima-selected-preview",children:Pc[a.label]})}),B("main",{children:[B("div",{style:Lc(o)?{direction:"rtl"}:null,children:[w("h1",{children:o}),B("h2",{className:"type",children:[Pc[a.label],w("span",{className:"label",children:a.label})]})]}),c&&w("p",{style:Lc(c)?{direction:"rtl"}:null,children:c})]}),B("footer",{children:[w("a",{href:r,target:"_blank",children:B("section",{className:"details",children:[w("span",{children:"Details"}),w("span",{children:w(Hh,{})})]})}),B("section",{className:"close",style:{borderBottomColor:zr[a.label]},children:[w("button",{className:"share",onClick:()=>g(!0),children:w(Wh,{})}),w("button",{className:"close",onClick:n.onClose,children:"Close"})]})]}),i&&l&&w(xw,{image:i,onClose:()=>u(!1)}),h&&w(zc,{onClose:()=>g(!1),children:w("div",{className:"easter-egg",children:B("main",{children:[w("h1",{children:"Vote for us!"}),w("p",{children:"If the NLI Heritage Browser makes it to the winner's podium, we will build lots of additional great features - such as the ability to share items and maps on social media."})]})})})]})})},Rw=n=>{var c;const t=Gr(),{node:e}=n.selected,[r,i]=L.exports.useState([]),[s,o]=L.exports.useState(),a=((c=e.descriptions)==null?void 0:c.length)>0?e.descriptions[0].value:null;return L.exports.useEffect(()=>{o(null),i([]);const l=h=>{const g=new Set(u.map(b=>b.id)),m=h.records.filter(b=>!g.has(b.id));m.length>0&&i([...u,...m.slice(0,500)])},u=t.getConnected(e.id,!0,l);i(u)},[e]),B("div",{className:"kima-popup-wrapper",children:[B("div",{className:"kima-popup-expanded",children:[r.length===1&&w(Rc,{record:r[0],onClose:n.onClose}),s&&w(Rc,{record:s,onClose:()=>o(null)})]}),r.length>1&&B("div",{className:"kima-popup-multilist",children:[B("header",{children:[B("h1",{children:[w("a",{href:e.id,target:"_blank",title:"This place in KIMA",children:e.properties.title}),e.externalURI&&w("a",{href:e.externalURI,target:"_blank",title:"This place in Wikidata",children:w(Xh,{title:"This place in Wikidata"})})]}),w("p",{className:"kima-description",children:a})]}),w("div",{className:"kima-popup-multilist-list",children:r.map(l=>w(Aw,{record:l,onClick:()=>o(l)},l.id))})]})]})},Vu={headers:{Accept:"application/json","Content-Type":"application/json","X-Kima-Session-Key":Qt},method:"POST"};class Iw extends Error{constructor(t,e){super(t),this.status=e}}const Ge=n=>{if(n.status===200)return n.json();throw new Iw("API Error",n.status)},io=n=>{const t={};return n.forEach(({name:e,values:r})=>t[e]=r),Object.keys(t.length>0)?t:null},Cw=n=>(t=null,e=[],r)=>{if(t){const[[i,s],[o,a]]=t;return e.length>0?fetch(`${n}/BoxPlaces/${i}/${s}/${o}/${a}`,{signal:r,...Vu,body:JSON.stringify(io(e))}).then(Ge):new Promise(c=>setTimeout(c,50)).then(()=>fetch(`${n}/BoxPlaces/${i}/${s}/${o}/${a}`,{headers:{"X-Kima-Session-Key":Qt},signal:r})).then(Ge)}else return fetch(`${n}/Places`,{headers:{"X-Kima-Session-Key":Qt},signal:r}).then(Ge)},Ow=n=>(t=null,e=[],r)=>{if(t){const[[i,s],[o,a]]=t;return e.length>0?fetch(`${n}/BoxRecords/${i}/${s}/${o}/${a}`,{signal:r,...Vu,body:JSON.stringify(io(e))}).then(Ge):fetch(`${n}/BoxRecords/${i}/${s}/${o}/${a}`,{headers:{"X-Kima-Session-Key":Qt},signal:r}).then(Ge)}else return fetch(`${n}/Records`,{headers:{"X-Kima-Session-Key":Qt},signal:r}).then(Ge)},kw=n=>{const{search:t,setSearchState:e}=In(),[r,i]=L.exports.useState(),s=Cw(n.api),o=Ow(n.api);return L.exports.useEffect(()=>{if(t.status===be.PENDING){n.onLoad(),r&&r.abort();const a=new AbortController;i(a);const{signal:c}=a;Promise.all([s(n.bounds,t.args.filters,c),o(n.bounds,t.args.filters,c)]).then(([l,u])=>{i(null);const h=l.features.reduce((m,b)=>m+(b.properties.total_records||1),0),g=l.features.map(m=>({...m,properties:{id:m.id,count:m.properties.total_records,...m.properties}}));e({args:{...t.args},status:be.OK,result:{total:h,items:g,aggregations:Object.entries(u.facetsInfo).reduce((m,[b,y])=>(m[b]={buckets:y.map(v=>({label:v.label,count:v.countFaceted}))},m),{})}}),n.onLoadDone(),n.onSearchResult({places:l,records:u})}).catch(l=>{console.log(l),l.status===500&&e({...t,status:be.FAILED})})}},[t]),L.exports.useEffect(()=>{n.bounds&&e({args:t.args,status:be.PENDING,result:t.result})},[n.bounds]),n.children},ju=n=>n.substring(n.lastIndexOf("=")+1),Nw=n=>{const{records:t}=n,e={};return t.forEach(r=>{const{places:i}=r;i.forEach(s=>{const o=ju(s.id);e[o]?e[o].push(r):e[o]=[r]})}),e},Dw=n=>{const[t,e]=L.exports.useState(),{search:r}=In(),{api:i,results:s}=n,o=s==null?void 0:s.places.features,a=s==null?void 0:s.records,c=L.exports.useMemo(()=>a?Nw(a):null,[n.results]),l=u=>c?c[u]||[]:[];return L.exports.useEffect(()=>{e({getNodeById:g=>o==null?void 0:o.find(m=>m.id===g),getConnected:(g,m,b)=>{var v;const y=ju(g);return m?((((v=r.args.filters)==null?void 0:v.length)>0?fetch(`${i}/Records/${y}`,{headers:{Accept:"application/json","Content-Type":"application/json","X-Kima-Session-Key":Qt},method:"POST",body:JSON.stringify(io(r.args.filters))}):fetch(`${i}/Records/${y}`,{headers:{"X-Kima-Session-Key":Qt}})).then(A=>A.json()).then(A=>b(A)),l(y)):new Promise(T=>T(l(y)))}})},[n.results]),w(jc.Provider,{value:t,children:n.children})},Fw=n=>{const{longitude:t,latitude:e,zoom:r}=n;return!!(t&&e&&r)},Bw=n=>{const{viewState:t,getMapBounds:e}=Uu(),[r]=Nc(t,250),i=ni(),s=L.exports.useMemo(()=>{if(Fw(r))return e()},[i,r]),[o,a]=L.exports.useState();return w(kw,{api:n.api,bounds:s,onLoad:n.onLoad,onLoadDone:n.onLoadDone,onSearchResult:c=>a(c),children:w(Dw,{api:n.api,bounds:s,results:o,children:n.children})})},Uw=n=>{var c,l;const t=Gr(),e=Jt(),[r,i]=L.exports.useState([]),{node:s}=n;L.exports.useEffect(()=>{t.getConnected(s.id,!1).then(i)},[]);const o=((c=s.descriptions)==null?void 0:c.length)>0?s.descriptions[0].value:null,a=s.properties.total_records;return e.size==="DESKTOP"?B("div",{dir:"rtl",className:"kima-tooltip",children:[B("main",{children:[w("h1",{children:s.properties.title}),w("p",{className:"kima-description",children:o})]}),a===1&&r.length>0&&B("div",{className:"kima-tooltip-footer kima-first-connected",children:[r[0].title," ",((l=r[0].type)==null?void 0:l.label)&&B("span",{children:["(",r[0].type.label,")"]})]}),a>1&&r.length>0&&B("div",{className:"kima-tooltip-footer kima-connected-count",dir:"ltr",children:[a.toLocaleString()," Objects"]})]}):null};const Vw=n=>{const t=Jt();return w("div",{className:t.size==="DESKTOP"?"kima-load-indicator p6o-controls-btn":"kima-load-indicator p6o-controls-btn mobile",children:w(Fc,{})})};window.global||(window.global=window);const jw=new Yh,zw=()=>{const[n,t]=L.exports.useState(!0);return w($h,{client:jw,children:w(Qh,{children:B(Bw,{api:ro,onLoad:()=>t(!0),onLoadDone:()=>t(!1),children:[w(mw.MapLibre,{mapStyle:Mw,defaultBounds:[[32,27.1],[38.2,35.7]],tooltip:e=>w(Uw,{...e}),popup:e=>w(Rw,{...e}),children:w(pw,{id:"kima-layer-places",color:"#9d00d1"})}),B(vw,{children:[w(Io,{children:w(sf,{items:[w(Lo,{colors:zr,fullscreen:!0,displayFacets:["RecordTypes","RelationshipTypes"],facetLabels:["Record Types","Relationships"]})]})}),w(Ro,{children:w(Ew,{children:w(Lo,{colors:zr,responsive:!0,displayFacets:["RecordTypes","RelationshipTypes"],facetLabels:["Record Types","Relationships"]})})}),w(Tw,{}),w(yw,{}),B(rf,{className:"kima-welcome",children:[w("h1",{children:"Welcome to the Heritage Browser!"}),w("p",{children:"Discover the digitally available treasures of the National Library of Israel displayed on a map according to where they were created or locations they describe."}),B("ul",{children:[w("li",{children:"Move the map around by dragging it and use the buttons on the right or your mouse to zoom in and out."}),w("li",{children:"Click on a place to see the number of items related to it, as well as links to wikidata and the Kima Gazetteer. Another click will open a list of related items."}),B("li",{children:["After opening an item, use the ",w(Bc,{})," icon to enlarge the image. Click Details to view the item's details at the library's website."]}),w(Ro,{children:w("li",{children:"Use the left bar to filter the types of items that interest you, or change the bar from Record Types to Relationship Types to filter items according to their relation to the place."})}),w(Io,{children:B("li",{children:["Click the ",w(Oc,{})," icon to filter the types of items that interest you, or change the bar from Record Types to Relationship Types to filter items according to their relation to the place."]})}),B("li",{children:["The ",w(Dc,{})," button on the right of the screen will focus the map on your current location."]})]}),B("p",{children:["Created by ",w("a",{href:"mailto:sinai.rusinek@mail.huji.ac.il",children:"Sinai Rusinek"}),", ",w("a",{href:"mailto:gil.shalit@gmail.com",children:"Gil Shalit"})," and ",w("a",{href:"mailto:hello@rainersimon.io",children:"Rainer Simon"})," and was a finalist in the ",w("a",{href:"https://tarboot.org/",target:"_blank",children:"tarboot"})," competition's general track."]})]}),n&&w(Vw,{})]})]})})})};window.onload=function(){qh.createRoot(document.getElementById("app")).render(w(zw,{}))};
//# sourceMappingURL=index.8e594465.js.map
