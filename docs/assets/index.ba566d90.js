import{r as a,j as o,R as Ce,M as ve,a as I,b as N,c as m,H as xe,d as ke,e as V,f as oe,I as $,F as K,g as we,h as Ee,C as Ne,W as Pe,i as B,k as ne,D as Oe,o as Ie,S as Le,L as F,l as Re,u as se,T as Ae,m as Te,n as Me,p as $e,q as De,s as Be,t as Fe,v as z,w as ze,x as Ve,y as W,z as Q,A as Ke,B as Ge,E as He,G as ie,J as re,K as Ue,N as _e,O as je,P as We,Q as Qe,U as Ze,V as qe,X as Je,Y as Ye}from"./vendor.0d794a92.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();var v=(e=>(e.MOBILE="MOBILE",e.DESKTOP="DESKTOP",e))(v||{});const ae="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,ce=a.exports.createContext({size:v.DESKTOP,isTouchDevice:ae}),Xe=e=>{const[t,n]=a.exports.useState({size:window.innerWidth>e.breakPoint?v.DESKTOP:v.MOBILE,isTouchDevice:ae});return a.exports.useLayoutEffect(()=>{const i=s=>{const r=window.innerWidth;r>e.breakPoint&&t.size===v.MOBILE?n({...t,size:v.DESKTOP}):r<e.breakPoint&&t.size===v.DESKTOP&&n({...t,size:v.MOBILE})};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[e.breakPoint,t]),o(ce.Provider,{value:t,children:e.children})},P=()=>a.exports.useContext(ce),et=e=>o(Ce,{children:o(Xe,{breakPoint:e.breakPoint||540,children:o(ve,{children:e.children})})});const tt=a.exports.createContext({}),le=()=>a.exports.useContext(tt);var G=(e=>(e.PENDING="PENDING",e.OK="OK",e.FAILED="FAILED",e))(G||{});const ot=I({key:"search",default:{args:{},status:G.OK}}),H=()=>{const[e,t]=N(ot),n=(l={})=>t({args:l,status:G.PENDING,result:e.result});return{changeSearchQuery:l=>n({...e.args,query:l}),clearSearchQuery:()=>n({...e.args,query:void 0}),refreshSearch:()=>n({...e.args}),search:e,setActiveAggregation:l=>t({args:{...e.args,activeAggregation:l},status:e.status,result:e.result}),setFilter:l=>{const u=[...(e.args.filters||[]).filter(h=>h.name!==l.name),l];n({...e.args,filters:u})},setSearchState:t}},nt=e=>{const t=e.activeAggregation||e.aggregations[0]||"",n=e.labels?e.labels[e.aggregations.indexOf(t)]:t,i=s=>()=>{const{length:r}=e.aggregations,c=(e.aggregations.indexOf(t)+s+r)%r;e.onChangeAggregation(e.aggregations[c])};return m("div",{className:"p6o-aggs-carousel",children:[o("button",{tabIndex:4,"aria-label":"Previous filter category",onClick:i(-1),children:o(xe,{})}),o("h3",{"aria-live":"polite","aria-atomic":!0,children:n}),o("button",{tabIndex:5,"aria-label":"Next filter category",onClick:i(1),children:o(ke,{})})]})},st=e=>e>1e3?(e/1e3).toFixed(1)+"k":e>1e6?(e/1e6).toFixed(1)+"M":e,it=e=>o("div",{className:"p6o-aggs-values",children:o("ul",{children:e.buckets.map(({label:t,count:n})=>o("li",{className:e.filterValues.length>0&&!e.filterValues.includes(t)?"p6o-value-unselected":"",onClick:e.onToggleFilterValue(t),children:m("div",{className:"p6o-agg-value-wrapper",children:[o("span",{className:"p6o-agg-value-count",style:{backgroundColor:e.colors&&e.colors[t],borderColor:e.colors&&e.colors[t]&&V(e.colors[t]).alpha(.8).hex()},children:st(n)}),o("span",{className:"p6o-agg-value-label",children:t})]})},t))})});const Z=e=>{var u,h,f,p;const{search:t,setFilter:n,setActiveAggregation:i}=H(),s=(u=t.result)!=null&&u.aggregations?Object.keys(t.result.aggregations):[],r=e.displayFacets||s,d=t.args.activeAggregation||r[0]||"",c=((f=(h=t.args.filters)==null?void 0:h.find(g=>g.name===d))==null?void 0:f.values)||[],l=g=>()=>{const b=c.includes(g)?{name:d,values:c.filter(x=>x!==g)}:{name:d,values:[...c,g]};n(b)};return m("div",{className:e.fullscreen?"p6o-aggs p6o-aggs-overlay fullscreen":"p6o-aggs p6o-aggs-overlay",children:[o(nt,{aggregations:r,labels:e.facetLabels,activeAggregation:d,onChangeAggregation:i}),((p=t.result)==null?void 0:p.aggregations)&&o(it,{buckets:t.result.aggregations[d].buckets,colors:e.colors,filterValues:c,onToggleFilterValue:l})]})},q=e=>P().size===v.DESKTOP?e.children:null,rt=e=>{const t=a.exports.useRef(null),n=P();a.exports.useEffect(()=>{const s=r=>{r.key==="Escape"&&e.onClose(null)};return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]);const i=s=>{s.target===t.current&&e.onClose(s)};return oe.createPortal(m("div",{ref:t,className:e.className?`p6o-info-modal-bg ${e.className}`:"p6o-info-modal-bg",onClick:i,children:[o("button",{className:n.size===v.DESKTOP?"p6o-info-modal-close":"p6o-info-modal-close mobile",onClick:e.onClose,children:o($,{})}),o("main",{className:"p6o-info-modal-main",children:e.children})]}),document.body)};const at=e=>{const[t,n]=a.exports.useState(!1);return m(K,{children:[o("button",{className:"p6o-controls-btn p6o-info",tabIndex:41,"aria-label":"Information",onClick:()=>n(!0),children:o(we,{})}),t&&o(rt,{className:e.className,onClose:()=>n(!1),children:e.children})]})},J=e=>P().size===v.MOBILE?e.children:null;const ct=e=>{const[t,n]=a.exports.useState(!1);return m(K,{children:[o("button",{className:"p6o-controls-btn p6o-mobile-menu-btn",tabIndex:42,"aria-label":"Open menu",onClick:()=>n(!0),children:o(Ee,{})}),o(Ne,{in:t,className:"p6o-mobile-menu",classNames:"p6o-mobile-menu",timeout:200,unmountOnExit:!0,children:m("div",{className:"p6o-mobile-menu",children:[o("button",{className:"p6o-mobile-menu-close",onClick:()=>n(!1),children:o($,{})}),o("main",{children:e.items.length===1?e.items[0]:null})]})})]})},D=I({key:"mapView",default:{}}),A=e=>{const{longitude:t,latitude:n,zoom:i}=e,s=r=>r!==void 0;return s(t)&&s(n)&&s(i)},lt=I({key:"selected",default:null}),de=(e,t)=>{const{offsetWidth:n,offsetHeight:i}=t;return new Pe({width:n,height:i}).fitBounds(e,{})};const dt=e=>{const t=a.exports.useRef(null),n=a.exports.useRef(null),i=P(),[s,r]=N(D),[d,c]=N(lt),{search:l}=H(),u=le(),[h,f]=a.exports.useState();a.exports.useEffect(()=>{if(t.current&&!A(s)){const y=de(e.defaultBounds,t.current);r(y)}},[t.current]);const p=a.exports.useMemo(()=>{var y;return(l==null?void 0:l.status)==="OK"&&((y=l.result)==null?void 0:y.items.length)?{type:"FeatureCollection",features:l.result.items.map(S=>({...S,properties:{id:S.id,...S.properties}}))}:null},[l]),g=a.exports.useMemo(()=>B.Children.map(e.children,y=>y.props.id)||[],[e.children]),b=a.exports.useCallback(y=>{var w;if(!n.current)return;const S=n.current.queryRenderedFeatures(y).filter(C=>g.find(L=>C.layer.id.startsWith(L)));if(S.length>0){const C=S[0];return{node:u.getNodeById((w=C.properties)==null?void 0:w.id),feature:C}}},[e.children,u,n.current,g]),x=a.exports.useCallback(y=>{var C,L;const{point:S}=y,w=b(S);if(w){const{node:R,feature:ye}=w,Se=h&&(R==null?void 0:R.id)===(h==null?void 0:h.node.id)?{...h,...S}:{node:R,feature:ye,...S};(C=t.current)==null||C.classList.add("hover"),f(Se)}else(L=t.current)==null||L.classList.remove("hover"),f(void 0)},[b,h]),k=y=>{const S=b(y.point);if(S){const w=JSON.parse(JSON.stringify(S));f(null),c(w)}else c(null)};return m("div",{ref:t,className:"p6o-map-container",children:[A(s)&&o(ne,{clickTolerance:i.isTouchDevice?10:3,ref:n,initialViewState:s,mapStyle:e.mapStyle,onClick:k,onMouseMove:x,onMove:y=>r(y.viewState),children:B.Children.map(e.children,y=>B.cloneElement(y,{data:p}))}),e.tooltip&&h&&o(Ct,{...h,tooltip:e.tooltip}),e.popup&&n.current&&d&&o(St,{selected:d,viewState:s,map:n.current,popup:e.popup,onClose:()=>c(null)})]})},ut=e=>{const t=a.exports.useRef(null),{search:n}=H(),i=le(),s=a.exports.useMemo(()=>(n==null?void 0:n.result)&&n.status==="OK"&&n.result.items.length>0?n.result.items:null,[n]),r=a.exports.useMemo(()=>e.layers&&s?e.layers.reduce((c,l)=>{const u=l(s,i);return Array.isArray(u)?[...c,...u]:[...c,u]},[]):[],[s,e.layers]),d=a.exports.useCallback(c=>{const{offsetX:l,offsetY:u}=c.nativeEvent,h=t.current.pickObject({x:l,y:u,radius:3});h&&e.onClick&&e.onClick(h)},[e.onClick,t]);return o("div",{onClick:d,children:o(Oe,{ref:t,initialViewState:e.initialViewState,controller:!0,onViewStateChange:e.onViewStateChange,layers:r,getTooltip:e.tooltip?c=>e.tooltip({...c,graph:i,search:n}):null,children:o(ne,{mapStyle:e.mapStyle})})})},ht=e=>{const t=a.exports.useRef(null),[n,i]=N(D),[s,r]=a.exports.useState(A(n)?n:null),[d,c]=a.exports.useState(),[l]=Ie(d,200);return a.exports.useEffect(()=>{l&&i(l)},[l]),a.exports.useEffect(()=>{if(t.current&&!s){const u=de(e.defaultBounds,t.current);r(u)}},[t.current]),a.exports.useEffect(()=>{t.current&&s&&A(n)&&r(n)},[n]),o("div",{ref:t,className:"p6o-map-container",children:s&&o(ut,{...e,initialViewState:s,onViewStateChange:u=>c(u.viewState)})})},mt=[0,"rgba(49, 54, 149, 0)",.1,"#313695",.2,"#4575b4",.3,"#74add1",.4,"#abd9e9",.5,"#e0f3f8",.6,"#fee090",.7,"#fdae61",.8,"#f46d43",.9,"#d73027",1,"#a50026"],gt=e=>({type:"heatmap",paint:{"heatmap-weight":1,"heatmap-intensity":["interpolate",["linear"],["zoom"],0,.2,9,2.5],"heatmap-color":["interpolate",["linear"],["heatmap-density"],...e],"heatmap-radius":["interpolate",["linear"],["zoom"],0,1,12,28],"heatmap-opacity":["interpolate",["linear"],["zoom"],8,1,10,0]}}),ft=e=>({type:"circle",paint:{"circle-radius":["interpolate",["linear"],["number",["get","count"],0],0,5,4e3,20],"circle-color":["case",["==",["get","is_centroid"],!0],"#808080",e],"circle-stroke-color":["case",["==",["get","is_centroid"],!0],V("#808080").darken().hex(),V(e).darken().hex()],"circle-stroke-width":1,"circle-opacity":["interpolate",["linear"],["zoom"],7,0,10,["case",["==",["get","is_centroid"],!0],.5,1]],"circle-stroke-opacity":["interpolate",["linear"],["zoom"],7,0,10,["case",["==",["get","is_centroid"],!0],.5,1]]}}),pt=e=>({type:"circle",paint:{"circle-radius":e,"circle-color":"transparent","circle-stroke-width":0,"circle-opacity":.5,"circle-stroke-opacity":0}}),bt=e=>{const t=P(),n=gt(mt),i=ft(e.color),s=t.isTouchDevice?pt(15):null;return m(Le,{type:"geojson",data:e.data,children:[s&&o(F,{id:`${e.id}-clickbuffer`,...s}),o(F,{id:`${e.id}-ht`,...n}),o(F,{id:`${e.id}-pt`,...i})]})},yt={MapLibre:dt,MapLibreDeckGL:ht};const ue=(e,t,n,i=[15,0,0,15])=>{var l;const[s,r]=a.exports.useState(t+i[3]),[d,c]=a.exports.useState(n+i[0]);return a.exports.useEffect(()=>r(t),[t]),a.exports.useEffect(()=>c(n),[n]),a.exports.useEffect(()=>{var u,h;if(e.current){const f=(u=e.current.firstChild)==null?void 0:u.getBoundingClientRect(),p=(h=e.current.closest(".p6o-map-container"))==null?void 0:h.getBoundingClientRect();if(f&&p){const g=f.right+i[1]>p.right,b=f.bottom+i[2]>p.bottom;g&&r(p.right-f.width-i[1]-i[3]),b&&c(p.bottom-f.height-i[0]-i[2])}}},[(l=e.current)==null?void 0:l.getBoundingClientRect()]),{top:d,left:s}},St=e=>{const t=P(),n=a.exports.useRef(null),{selected:i,viewState:s,map:r,popup:d}=e,[c,l]=a.exports.useState({left:0,top:0}),{top:u,left:h}=t.size===v.DESKTOP?ue(n,c.left,c.top):{top:0,left:0};a.exports.useEffect(()=>{var p;if(i&&t.size===v.DESKTOP){const g=(p=Re(i.feature))==null?void 0:p.geometry.coordinates,{x:b,y:x}=r.project(g);l({left:b,top:x})}else i&&l({left:0,top:0})},[i,s,t.size]);const f=a.exports.useMemo(()=>i?d({...e,onClose:e.onClose}):null,[i]);return f&&m("div",{className:t.size===v.DESKTOP?"p6o-map-popup-container":"p6o-map-popup-container-mobile",style:{zIndex:9,position:"absolute",top:u,left:h},children:[o("button",{className:"p6o-map-popup-close",onClick:e.onClose,children:o($,{})}),o("main",{ref:n,children:f})]})},Ct=e=>{const t=a.exports.useRef(null),{x:n,y:i,node:s,feature:r,tooltip:d}=e,{left:c,top:l}=ue(t,n,i),u=a.exports.useMemo(()=>s?d({node:s,feature:r}):null,[s,r]);return u&&o("div",{ref:t,className:"p6o-map-tooltip-container",style:{left:c,top:l,zIndex:1},children:u})},U=()=>{const{current:e,...t}=se();return Object.values(t)[0]},vt=()=>{const e=U(),[t,n]=N(D);return{viewState:t,setViewState:n,getMapBounds:()=>{if(e)return e.getBounds().toArray()}}};const xt=()=>{const e=U(),{setViewState:t}=vt(),n=r=>{const{latitude:d,longitude:c}=r.coords;t({latitude:d,longitude:c,zoom:12}),e==null||e.easeTo({center:[c,d],zoom:12})},i=r=>console.warn("Error fetching location: "+r.message);return o("button",{className:"p6o-controls-btn p6o-my-location",tabIndex:40,"aria-label":"Go to my location",onClick:()=>navigator.geolocation.getCurrentPosition(n,i,{enableHighAccuracy:!0}),children:o(Ae,{})})};const kt=e=>o("div",{className:"p6o-controls-container",children:e.children});const wt=()=>{const e=U(),[t,n]=N(D),i=s=>()=>{e&&n({...t,zoom:t.zoom+s,transitionDuration:200}),e==null||e.easeTo({zoom:e.getZoom()+s})};return m("div",{className:"p6o-zoom-container",children:[o("button",{className:"p6o-controls-btn p6o-zoom p6o-zoom-in",tabIndex:31,"aria-label":"Zoom in",onClick:i(1),children:o(Te,{})}),o("button",{className:"p6o-controls-btn p6o-zoom p6o-zoom-out",tabIndex:32,"aria-label":"Zoom out",onClick:i(-1),children:o(Me,{})})]})};var T;(function(e){e.MOBILE="MOBILE",e.DESKTOP="DESKTOP"})(T||(T={}));const Et="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,Nt=a.exports.createContext({size:T.DESKTOP,isTouchDevice:Et}),_=()=>a.exports.useContext(Nt);const he=a.exports.createContext({}),me=()=>a.exports.useContext(he);var E;(function(e){e.PENDING="PENDING",e.OK="OK",e.FAILED="FAILED"})(E||(E={}));const Pt=I({key:"search",default:{args:{},status:E.OK}}),ge=()=>{const[e,t]=N(Pt),n=(l={})=>t({args:l,status:E.PENDING,result:e.result});return{changeSearchQuery:l=>n({...e.args,query:l}),clearSearchQuery:()=>n({...e.args,query:void 0}),refreshSearch:()=>n({...e.args}),search:e,setActiveAggregation:l=>t({args:{...e.args,activeAggregation:l},status:e.status,result:e.result}),setFilter:l=>{const u=[...(e.args.filters||[]).filter(h=>h.name!==l.name),l];n({...e.args,filters:u})},setSearchState:t}};const Ot=e=>{const t=a.exports.useRef(null),n=_();a.exports.useEffect(()=>{const s=r=>{r.key==="Escape"&&e.onClose(null)};return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[]);const i=s=>{s.target===t.current&&e.onClose(s)};return oe.createPortal(m("div",{ref:t,className:e.className?`p6o-info-modal-bg ${e.className}`:"p6o-info-modal-bg",onClick:i,children:[o("button",{className:n.size===T.DESKTOP?"p6o-info-modal-close":"p6o-info-modal-close mobile",onClick:e.onClose,children:o($,{})}),o("main",{className:"p6o-info-modal-main",children:e.children})]}),document.body)};const It=I({key:"mapView",default:{}});I({key:"selected",default:null});const fe=()=>{const{current:e,...t}=se();return Object.values(t)[0]},Lt=()=>{const e=fe(),[t,n]=N(It);return{viewState:t,setViewState:n,getMapBounds:()=>{if(e)return e.getBounds().toArray()}}};const M={ARCHIVE:"#7eb0d5",BOOK:"#ede15b",EPHEMERA:"#ef9b20","GENIZA MANUSCRIPT":"#8a3800",KETUBBA:"#b2e061",MANUSCRIPT:"#bdcf32",MAP:"#edbf33",MOVIE:"#b33dc6",MUSIC:"#f46a9b",NEWSPAPER:"#bd7ebe",ORAL:"#87bc45",PHOTOGRAPH:"#ea5545",PICTURE:"#fd7f6f",SCORE:"#27aeef"};const Rt=e=>/^[\u04c7-\u0591\u05D0-\u05EA\u05F0-\u05F4\u0600-\u06FF\u0750-\u077f]/.test(e),At=e=>{const{record:t}=e,{title:n,thumbnailURI:i,type:s}=t;return m("div",{className:"kima-listpreview-card",onClick:e.onClick,children:[o("h5",{style:Rt(n)?{direction:"rtl"}:null,children:n}),i&&o("div",{className:"kima-listpreview-image-wrapper",style:{backgroundImage:`url(${i})`,borderColor:M[s.label]}})]})},Y=[45,25],Tt=(e,t,n)=>{var l;const i=_(),[s,r]=a.exports.useState(t),[d,c]=a.exports.useState(n);return a.exports.useEffect(()=>r(t),[t]),a.exports.useEffect(()=>c(n),[n]),a.exports.useEffect(()=>{e.current&&i.size==="DESKTOP"&&setTimeout(()=>{var f,p;const u=(f=e.current)==null?void 0:f.getBoundingClientRect(),h=(p=e.current.closest(".p6o-map-container"))==null?void 0:p.getBoundingClientRect();if(u&&h){const g=u.right>h.right,b=u.bottom>h.bottom;g&&r(h.right-u.width-Y[0]),b&&c(h.bottom-u.bottom-Y[1])}},1)},[(l=e.current)==null?void 0:l.getBoundingClientRect()]),{top:d,left:s}};const Mt=e=>{const{image:t}=e;return o($e,{mainSrc:t,onCloseRequest:e.onClose})},$t=e=>{if(!!e.descriptions&&!!Array.isArray(e.descriptions))return e.descriptions[0].value},X={ARCHIVE:o(De,{}),BOOK:o(Be,{}),EPHEMERA:o(Fe,{}),"GENIZA MANUSCRIPT":o(z,{}),KETUBBA:o(z,{}),MANUSCRIPT:o(z,{}),MAP:o(ze,{}),MOVIE:o(Ve,{}),MUSIC:o(W,{}),NEWSPAPER:o(Q,{}),"NEWSPAPER ARTICLE":o(Q,{}),ORAL:o(Ke,{}),PHOTOGRAPH:o(Ge,{}),PICTURE:o(He,{}),SCORE:o(W,{})};const ee=e=>/^[\u04c7-\u0591\u05D0-\u05EA\u05F0-\u05F4\u0600-\u06FF\u0750-\u077f]/.test(e),te=e=>{const t=a.exports.useRef(),{record:n}=e,{id:i,presentationURI:s,thumbnailURI:r,title:d,type:c}=n,l=a.exports.useMemo(()=>$t(n),[n]),[u,h]=a.exports.useState(!1),[f,p]=a.exports.useState(!1),[g,b]=a.exports.useState(),x=(c==null?void 0:c.label)==="ORAL"||(c==null?void 0:c.label)==="MUSIC",[k,y]=a.exports.useState(!1),{top:S,left:w}=Tt(t,10,-10);return a.exports.useEffect(()=>{if(x&&s&&fetch("https://kimanli.azurewebsites.net/api/cors-proxy",{method:"POST",body:s}).then(C=>C.text()).then(C=>{console.log("proxy response",C),window.setTimeout(()=>b(C),2e3)}),s||r){const C=document.createElement("img");C.onerror=()=>y(!0),C.src=s||r}},[s]),o("div",{className:"kima-selected-card-wrapper",children:m("div",{ref:t,className:"kima-selected-card",style:{top:S,left:w},onClick:e.onClick,children:[o("header",{children:(s||r)&&!k?x&&g?o("audio",{controls:!0,crossOrigin:"anonymous",children:o("source",{src:g})}):m(K,{children:[o("div",{className:"kima-selected-preview-loading",children:o(ie,{})}),o("div",{className:"kima-selected-preview",style:{backgroundImage:`url("${s||r}")`}}),s&&o("button",{className:"kima-selected-fullscreen",onClick:()=>h(!0),children:o(re,{})})]}):o("div",{className:"kima-selected-preview",children:X[c.label]})}),m("main",{children:[m("div",{style:ee(d)?{direction:"rtl"}:null,children:[o("h1",{children:d}),m("h2",{className:"type",children:[X[c.label],o("span",{className:"label",children:c.label})]})]}),l&&o("p",{style:ee(l)?{direction:"rtl"}:null,children:l})]}),m("footer",{children:[o("a",{href:i,target:"_blank",children:m("section",{className:"details",children:[o("span",{children:"Details"}),o("span",{children:o(Ue,{})})]})}),m("section",{className:"close",style:{borderBottomColor:M[c.label]},children:[o("button",{className:"share",onClick:()=>p(!0),children:o(_e,{})}),o("button",{className:"close",onClick:e.onClose,children:"Close"})]})]}),s&&u&&o(Mt,{image:s,onClose:()=>h(!1)}),f&&o(Ot,{onClose:()=>p(!1),children:o("div",{className:"easter-egg",children:m("main",{children:[o("h1",{children:"Vote for us!"}),o("p",{children:"If the NLI Heritage Browser makes it to the winner's podium, we will build lots of additional great features - such as the ability to share items and maps on social media."})]})})})]})})},Dt=e=>{var l;const t=me(),{node:n}=e.selected,[i,s]=a.exports.useState([]),[r,d]=a.exports.useState(),c=((l=n.descriptions)==null?void 0:l.length)>0?n.descriptions[0].value:null;return a.exports.useEffect(()=>{d(null),s([]);const u=f=>{const p=new Set(h.map(b=>b.id)),g=f.records.filter(b=>!p.has(b.id));g.length>0&&s([...h,...g.slice(0,500)])},h=t.getConnected(n.id,!0,u);s(h)},[n]),m("div",{className:"kima-popup-wrapper",children:[m("div",{className:"kima-popup-expanded",children:[i.length===1&&o(te,{record:i[0],onClose:e.onClose}),r&&o(te,{record:r,onClose:()=>d(null)})]}),i.length>1&&m("div",{className:"kima-popup-multilist",children:[m("header",{children:[m("h1",{children:[o("a",{href:n.id,target:"_blank",title:"This place in KIMA",children:n.properties.title}),n.externalURI&&o("a",{href:n.externalURI,target:"_blank",title:"This place in Wikidata",children:o(je,{title:"This place in Wikidata"})})]}),o("p",{className:"kima-description",children:c})]}),o("div",{className:"kima-popup-multilist-list",children:i.map(u=>o(At,{record:u,onClick:()=>d(u)},u.id))})]})]})},pe={headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST"};class Bt extends Error{constructor(t,n){super(t),this.status=n}}const O=e=>{if(e.status===200)return e.json();throw new Bt("API Error",e.status)},j=e=>{const t={};return e.forEach(({name:n,values:i})=>t[n]=i),Object.keys(t.length>0)?t:null},Ft=e=>(t=null,n=[],i)=>{if(t){const[[s,r],[d,c]]=t;return n.length>0?fetch(`${e}/BoxPlaces/${s}/${r}/${d}/${c}`,{signal:i,...pe,body:JSON.stringify(j(n))}).then(O):new Promise(l=>setTimeout(l,50)).then(()=>fetch(`${e}/BoxPlaces/${s}/${r}/${d}/${c}`,{signal:i})).then(O)}else return fetch(`${e}/Places`,{signal:i}).then(O)},zt=e=>(t=null,n=[],i)=>{if(t){const[[s,r],[d,c]]=t;return n.length>0?fetch(`${e}/BoxRecords/${s}/${r}/${d}/${c}`,{signal:i,...pe,body:JSON.stringify(j(n))}).then(O):fetch(`${e}/BoxRecords/${s}/${r}/${d}/${c}`,{signal:i}).then(O)}else return fetch(`${e}/Records`,{signal:i}).then(O)},Vt=e=>{const{search:t,setSearchState:n}=ge(),[i,s]=a.exports.useState(),r=Ft(e.api),d=zt(e.api);return a.exports.useEffect(()=>{if(t.status===E.PENDING){e.onLoad(),i&&i.abort();const c=new AbortController;s(c),console.log("Running search");const{signal:l}=c;Promise.all([r(e.bounds,t.args.filters,l),d(e.bounds,t.args.filters,l)]).then(([u,h])=>{s(null),console.log("Places",u),console.log("Records",h);const f=u.features.reduce((g,b)=>g+(b.properties.total_records||1),0),p=u.features.map(g=>({...g,properties:{id:g.id,count:g.properties.total_records,...g.properties}}));n({args:{...t.args},status:E.OK,result:{total:f,items:p,aggregations:Object.entries(h.facetsInfo).reduce((g,[b,x])=>(g[b]={buckets:x.map(k=>({label:k.label,count:k.countFaceted}))},g),{})}}),e.onLoadDone(),e.onSearchResult({places:u,records:h})}).catch(u=>{console.log(u),u.status===500&&n({...t,status:E.PENDING})})}},[t]),a.exports.useEffect(()=>{e.bounds&&n({args:t.args,status:E.PENDING,result:t.result})},[e.bounds]),e.children},be=e=>e.substring(e.lastIndexOf("=")+1),Kt=e=>{const{records:t}=e,n={};return t.forEach(i=>{const{places:s}=i;s.forEach(r=>{const d=be(r.id);n[d]?n[d].push(i):n[d]=[i]})}),n},Gt=e=>{const[t,n]=a.exports.useState(),{search:i}=ge(),{results:s}=e,r=s==null?void 0:s.places.features,d=s==null?void 0:s.records,c=a.exports.useMemo(()=>d?Kt(d):null,[e.results]),l=u=>c?c[u]||[]:[];return a.exports.useEffect(()=>{n({getNodeById:f=>r==null?void 0:r.find(p=>p.id===f),getConnected:(f,p,g)=>{var x;const b=be(f);return p?((((x=i.args.filters)==null?void 0:x.length)>0?fetch("https://kimanli.azurewebsites.net/api/Records/"+b,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",body:JSON.stringify(j(i.args.filters))}):fetch("https://kimanli.azurewebsites.net/api/Records/"+b)).then(y=>y.json()).then(y=>g(y)),l(b)):new Promise(k=>k(l(b)))}})},[e.results]),o(he.Provider,{value:t,children:e.children})},Ht=e=>{const{longitude:t,latitude:n,zoom:i}=e;return!!(t&&n&&i)},Ut=e=>{const{viewState:t,setViewState:n,getMapBounds:i}=Lt(),[s]=We(t,250),r=fe(),d=a.exports.useMemo(()=>{if(Ht(s))return i()},[r,s]),[c,l]=a.exports.useState();return o(Vt,{api:e.api,bounds:d,onLoad:e.onLoad,onLoadDone:e.onLoadDone,onSearchResult:u=>l(u),children:o(Gt,{api:e.api,bounds:d,results:c,children:e.children})})},_t=e=>{var l,u;const t=me(),n=_(),[i,s]=a.exports.useState([]),{node:r}=e;a.exports.useEffect(()=>{t.getConnected(r.id,!1).then(s)},[]);const d=((l=r.descriptions)==null?void 0:l.length)>0?r.descriptions[0].value:null,c=r.properties.total_records;return n.size==="DESKTOP"?m("div",{dir:"rtl",className:"kima-tooltip",children:[m("main",{children:[o("h1",{children:r.properties.title}),o("p",{className:"kima-description",children:d})]}),c===1&&i.length>0&&m("div",{className:"kima-tooltip-footer kima-first-connected",children:[i[0].title," ",((u=i[0].type)==null?void 0:u.label)&&m("span",{children:["(",i[0].type.label,")"]})]}),c>1&&i.length>0&&m("div",{className:"kima-tooltip-footer kima-connected-count",dir:"ltr",children:[c.toLocaleString()," Objects"]})]}):null};const jt=e=>{const t=P();return o("div",{className:t.size===v.DESKTOP?"kima-load-indicator p6o-controls-btn":"kima-load-indicator p6o-controls-btn mobile",children:o(ie,{})})};window.global||(window.global=window);const Wt=new Qe,Qt=()=>{const[e,t]=a.exports.useState(!0);return o(qe,{client:Wt,children:o(et,{children:m(Ut,{api:"https://kimanli.azurewebsites.net/api",onLoad:()=>t(!0),onLoadDone:()=>t(!1),children:[o(yt.MapLibre,{mapStyle:"https://api.maptiler.com/maps/voyager/style.json?key=RFavxpVJ82EHyrN2kxsF",defaultBounds:[[32,27.1],[38.2,35.7]],tooltip:n=>o(_t,{...n}),popup:n=>o(Dt,{...n}),children:o(bt,{id:"kima-layer-places",color:"#9d00d1"})}),m(kt,{children:[o(J,{children:o(ct,{items:[o(Z,{colors:M,fullscreen:!0,displayFacets:["RecordTypes","RelationshipTypes"],facetLabels:["Record Types","Relationships"]})]})}),o(q,{children:o(Z,{colors:M,responsive:!0,displayFacets:["RecordTypes","RelationshipTypes"],facetLabels:["Record Types","Relationships"]})}),o(wt,{}),o(xt,{}),m(at,{className:"kima-welcome",children:[o("h1",{children:"Welcome to the Heritage Browser!"}),o("p",{children:"Discover the digitally available treasures of the National Library of Israel displayed on a map according to where they were created or locations they describe."}),m("ul",{children:[o("li",{children:"Move the map around by dragging it and use the buttons on the right or your mouse to zoom in and out."}),o("li",{children:"Click on a place to see the number of items related to it, as well as links to wikidata and the Kima Gazetteer. Another click will open a list of related items."}),m("li",{children:["After opening an item, use the ",o(re,{})," icon to enlarge the image. Click Details to view the item's details at the library's website."]}),o(q,{children:o("li",{children:"Use the left bar to filter the types of items that interest you, or change the bar from Record Types to Relationship Types to filter items according to their relation to the place."})}),o(J,{children:m("li",{children:["Click the ",o(Je,{})," icon to filter the types of items that interest you, or change the bar from Record Types to Relationship Types to filter items according to their relation to the place."]})}),m("li",{children:["The ",o(Ye,{})," button on the right of the screen will focus the map on your current location."]})]}),m("p",{children:["Created by ",o("a",{href:"mailto:sinai.rusinek@mail.huji.ac.il",children:"Sinai Rusinek"}),", ",o("a",{href:"mailto:gil.shalit@gmail.com",children:"Gil Shalit"})," and ",o("a",{href:"mailto:hello@rainersimon.io",children:"Rainer Simon"})," and was a finalist in the ",o("a",{href:"https://tarboot.org/",target:"_blank",children:"tarboot"})," competition's general track."]})]}),e&&o(jt,{})]})]})})})};window.onload=function(){Ze.createRoot(document.getElementById("app")).render(o(Qt,{}))};
